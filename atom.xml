<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>HelloDog</title>
  
  <subtitle>Keep Calm and Carry On</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://wsgzao.github.io/"/>
  <updated>2019-05-24T11:02:01.266Z</updated>
  <id>https://wsgzao.github.io/</id>
  
  <author>
    <name>wsgzao</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Cisco AnyConnect 配置和修改默认地址</title>
    <link href="https://wsgzao.github.io/post/cisco-anyconnect/"/>
    <id>https://wsgzao.github.io/post/cisco-anyconnect/</id>
    <published>2019-05-24T06:59:49.000Z</published>
    <updated>2019-05-24T11:02:01.266Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Cisco AnyConnect 为思科推出的 VPN 客户端，当前已有 Windows、Android、iOS、OS X、Ubuntu、WebOS 等操作系统的客户端。AnyConnect 主要作用是方便员工在任何设备上安全地办公。</p><blockquote><p>Cisco AnyConnect 配置和修改默认地址</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 05 月 24 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/cisco-anyconnect/">https://wsgzao.github.io/post/cisco-anyconnect/</a></p><p><strong> 扩展阅读 </strong></p><p>Cisco AnyConnect Secure Mobility Client</p><ul><li><a href="https://www.cisco.com/c/en/us/products/security/anyconnect-secure-mobility-client/index.html" target="_blank" rel="noopener">https://www.cisco.com/c/en/us/products/security/anyconnect-secure-mobility-client/index.html</a></li></ul><hr><h2 id="Cisco-AnyConnect-简介"><a href="#Cisco-AnyConnect-简介" class="headerlink" title="Cisco AnyConnect 简介"></a>Cisco AnyConnect 简介</h2><blockquote><p>无需介绍</p></blockquote><h2 id="Cisco-AnyConnect-配置"><a href="#Cisco-AnyConnect-配置" class="headerlink" title="Cisco AnyConnect 配置"></a>Cisco AnyConnect 配置</h2><ol><li>macOS 系统安装只安装 VPN 组件 , 其他功能都不需要安装</li><li>macOS 和 Windows 都建议取消勾选 <code>Block Connections to untrusted servers</code></li></ol><p><img src="https://wx1.sinaimg.cn/large/7207510dgy1g3cgyfti5ej20yg0ocwlc.jpg" alt=""><br><img src="https://ws3.sinaimg.cn/large/7207510dgy1g3ch1s6wa8j20mg0cojus.jpg" alt=""></p><h2 id="Cisco-AnyConnect-修改默认链接地址"><a href="#Cisco-AnyConnect-修改默认链接地址" class="headerlink" title="Cisco AnyConnect 修改默认链接地址"></a>Cisco AnyConnect 修改默认链接地址</h2><p>Change Local Policy Parameters Manually</p><p><strong>Step 1</strong><br>Retrieve a copy of the AnyConnect Local Policy file (AnyConnectLocalPolicy.xml) from a client installation.</p><p>Table 1. Operating System and AnyConnect Local Policy File Installation Path<br>Operating System</p><table><thead><tr><th></th><th>Operating System</th><th>Installation Path</th></tr></thead><tbody><tr><td></td><td>Windows</td><td>C:\ProgramData\Cisco\Cisco AnyConnect Secure Mobility Client</td><td></td></tr><tr><td></td><td>Linux</td><td>/opt/cisco/anyconnect</td><td></td></tr><tr><td></td><td>macOS</td><td>/opt/cisco/anyconnect</td><td></td></tr></tbody></table><p><strong>Step 2</strong><br>Edit the parameter settings. You can either edit the AnyConnectLocalPolicy file manually, or use the VPN Local Policy editor, which is distributed with the AnyConnect Profile Editor installer.</p><p><strong>Step 3</strong><br>Save the file as AnyConnectLocalPolicy.xml and deploy the file to remote computers using a corporate software deployment system.</p><p><strong>Step 4</strong><br>Reboot the remote computers so that the changes to the local policy file take effect.</p><p><a href="https://www.cisco.com/c/en/us/td/docs/security/vpn_client/anyconnect/anyconnect40/administration/guide/b_AnyConnect_Administrator_Guide_4-0/anyconnect-profile-editor.html" target="_blank" rel="noopener">https://www.cisco.com/c/en/us/td/docs/security/vpn_client/anyconnect/anyconnect40/administration/guide/b_AnyConnect_Administrator_Guide_4-0/anyconnect-profile-editor.html</a></p><h3 id="macOS"><a href="#macOS" class="headerlink" title="macOS"></a>macOS</h3><p>注意修改 <code>中文备注</code></p><p>vim /opt/cisco/anyconnect/profile/Profile.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">AnyConnectProfile</span> <span class="attr">xmlns</span>=<span class="string">"http://schemas.xmlsoap.org/encoding/"</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">ServerList</span>&gt;</span> </span><br><span class="line">     <span class="tag">&lt;<span class="name">HostEntry</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">User</span>&gt;</span> 用户名称 < span class="tag">&lt;/<span class="name">User</span>&gt;</span><br><span class="line">          <span class="tag">&lt;<span class="name">HostName</span>&gt;</span> 自定义显示名称 < span class="tag">&lt;/<span class="name">HostName</span>&gt;</span><br><span class="line">          <span class="tag">&lt;<span class="name">HostAddress</span>&gt;</span> 服务器地址 < span class="tag">&lt;/<span class="name">HostAddress</span>&gt;</span><br><span class="line">     <span class="tag">&lt;/<span class="name">HostEntry</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">HostEntry</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">User</span>&gt;</span> 用户名称 < span class="tag">&lt;/<span class="name">User</span>&gt;</span><br><span class="line">          <span class="tag">&lt;<span class="name">HostName</span>&gt;</span> 自定义显示名称 < span class="tag">&lt;/<span class="name">HostName</span>&gt;</span><br><span class="line">          <span class="tag">&lt;<span class="name">HostAddress</span>&gt;</span> 服务器地址 < span class="tag">&lt;/<span class="name">HostAddress</span>&gt;</span><br><span class="line">     <span class="tag">&lt;/<span class="name">HostEntry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ServerList</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">AnyConnectProfile</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>注意修改 <code>中文备注</code></p><p>C:\Users \ 你的用户名 \ AppData\Local\Cisco\Cisco AnyConnect Secure Mobility Client 目录下的 <code>preferences.xml</code> 文件</p><p>比如</p><p>C:\Users\wangao\AppData\Local\Cisco\Cisco AnyConnect Secure Mobility Client</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">AnyConnectPreferences</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DefaultUser</span>&gt;</span> 默认用户名 <span class="tag">&lt;/<span class="name">DefaultUser</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DefaultSecondUser</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ClientCertificateThumbprint</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ServerCertificateThumbprint</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DefaultHostName</span>&gt;</span> 默认 VPN 地址 <span class="tag">&lt;/<span class="name">DefaultHostName</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DefaultHostAddress</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">DefaultGroup</span>&gt;</span> 默认组 <span class="tag">&lt;/<span class="name">DefaultGroup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ProxyHost</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ProxyPort</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SDITokenType</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ControllablePreferences</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">EnableAutomaticServerSelection</span>&gt;</span>false<span class="tag">&lt;/<span class="name">EnableAutomaticServerSelection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LocalLanAccess</span>&gt;</span>false<span class="tag">&lt;/<span class="name">LocalLanAccess</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">BlockUntrustedServers</span>&gt;</span>false<span class="tag">&lt;/<span class="name">BlockUntrustedServers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ControllablePreferences</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">AnyConnectPreferences</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      Cisco AnyConnect 配置和修改默认地址
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>rsync 安装配置实践</title>
    <link href="https://wsgzao.github.io/post/rsync/"/>
    <id>https://wsgzao.github.io/post/rsync/</id>
    <published>2019-05-23T06:59:49.000Z</published>
    <updated>2019-05-24T07:04:59.373Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Rsync 代表 “remote sync”，它是本地和远程主机文件同步工具。它只同步更改的文件，以此实现最小化传输数据。rsync 的使用场景非常丰富，相信大家会经常使用，这里做下简单的总结。</p><blockquote><p>rsync 安装配置实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 05 月 23 日 - 更新 rsync 中文帮助和相关实践配置<br>2019 年 03 月 01 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/rsync/">https://wsgzao.github.io/post/rsync/</a></p><p><strong> 扩展阅读 </strong></p><p>rsync - <a href="https://www.samba.org/rsync/" target="_blank" rel="noopener">https://www.samba.org/rsync/</a></p><hr><h2 id="rsync-简介"><a href="#rsync-简介" class="headerlink" title="rsync 简介"></a>rsync 简介</h2><p>rsync is a file transfer program capable of efficient remote update via a fast differencing algorithm.</p><p>rsync 是类 unix 系统下的数据镜像备份工具，从软件的命名上就可以看出来了 ——remote sync。它的特性如下：</p><ol><li>可以镜像保存整个目录树和文件系统</li><li>可以很容易做到保持原来文件的权限、时间、软硬链接等等</li><li>无须特殊权限即可安装</li><li>优化的流程，文件传输效率高</li><li>可以使用 rsh、ssh 等方式来传输文件，当然也可以通过直接的 socket 连接</li><li>支持匿名传输</li></ol><p>在使用 rsync 进行远程同步时，可以使用两种方式：远程 Shell 方式（用户验证由 ssh 负责）和 C/S 方式（即客户连接远程 rsync 服务器，用户验证由 rsync 服务器负责）。</p><p>无论本地同步目录还是远程同步数据，首次运行时将会把全部文件拷贝一次，以后再运行时将只拷贝有变化的文件（对于新文件）或文件的变化部分（对于原有文件）。</p><h2 id="rsync-源配置文件示例"><a href="#rsync-源配置文件示例" class="headerlink" title="rsync 源配置文件示例"></a>rsync 源配置文件示例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 rsync 配置文件 </span></span><br><span class="line">vim /etc/rsync.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># /etc/rsyncd: configuration file for rsync daemon mode</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See rsyncd.conf man page for more options.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration example:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># uid = nobody</span></span><br><span class="line"><span class="comment"># gid = nobody</span></span><br><span class="line"><span class="comment"># use chroot = yes</span></span><br><span class="line"><span class="comment"># max connections = 4</span></span><br><span class="line"><span class="comment"># pid file = /var/run/rsyncd.pid</span></span><br><span class="line"><span class="comment"># exclude = lost+found/</span></span><br><span class="line"><span class="comment"># transfer logging = yes</span></span><br><span class="line"><span class="comment"># timeout = 900</span></span><br><span class="line"><span class="comment"># ignore nonreadable = yes</span></span><br><span class="line"><span class="comment"># dont compress   = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [ftp]</span></span><br><span class="line"><span class="comment">#        path = /home/ftp</span></span><br><span class="line"><span class="comment">#        comment = ftp export area</span></span><br></pre></td></tr></table></figure><p>rsyncd.conf 官方文档请参考 - <a href="https://www.samba.org/ftp/rsync/rsyncd.conf.html" target="_blank" rel="noopener">https://www.samba.org/ftp/rsync/rsyncd.conf.html</a></p><h2 id="rsync-常用参数"><a href="#rsync-常用参数" class="headerlink" title="rsync 常用参数"></a>rsync 常用参数</h2><p>注: 在指定复制源时，路径是否有最后的 “/” 有不同的含义，例如：</p><p>/data  表示将整个 /data 目录复制到目标目录<br>/data/ 表示将 /data/ 目录中的所有内容复制到目标目录</p><p>man rsync 翻译 (rsync 命令中文手册)<br><a href="http://www.cnblogs.com/f-ck-need-u/p/7221713.html" target="_blank" rel="noopener">http://www.cnblogs.com/f-ck-need-u/p/7221713.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">rsync is a file transfer program capable of efficient remote update via a fast differencing algorithm.</span><br><span class="line"></span><br><span class="line">Usage: rsync [OPTION]... SRC [SRC]... DEST</span><br><span class="line">  or   rsync [OPTION]... SRC [SRC]... [USER@]HOST:DEST</span><br><span class="line">  or   rsync [OPTION]... SRC [SRC]... [USER@]HOST::DEST</span><br><span class="line">  or   rsync [OPTION]... SRC [SRC]... rsync://[USER@]HOST[:PORT]/DEST</span><br><span class="line">  or   rsync [OPTION]... [USER@]HOST:SRC [DEST]</span><br><span class="line">  or   rsync [OPTION]... [USER@]HOST::SRC [DEST]</span><br><span class="line">  or   rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]</span><br><span class="line">The <span class="string">':'</span> usages connect via remote shell, <span class="keyword">while</span> <span class="string">'::'</span> &amp; <span class="string">'rsync://'</span> usages connect</span><br><span class="line">to an rsync daemon, and require SRC or DEST to start with a module name.</span><br><span class="line"></span><br><span class="line">Options</span><br><span class="line"> -v, --verbose               increase verbosity</span><br><span class="line">     --info=FLAGS            fine-grained informational verbosity</span><br><span class="line">     --debug=FLAGS           fine-grained debug verbosity</span><br><span class="line">     --msgs2stderr           special output handling <span class="keyword">for</span> debugging</span><br><span class="line"> -q, --quiet                 suppress non-error messages</span><br><span class="line">     --no-motd               suppress daemon-mode MOTD (see manpage caveat)</span><br><span class="line"> -c, --checksum              skip based on checksum, not mod-time &amp; size</span><br><span class="line"> -a, --archive               archive mode; equals -rlptgoD (no -H,-A,-X)</span><br><span class="line">     --no-OPTION             turn off an implied OPTION (e.g. --no-D)</span><br><span class="line"> -r, --recursive             recurse into directories</span><br><span class="line"> -R, --relative              use relative path names</span><br><span class="line">     --no-implied-dirs       don<span class="string">'t send implied dirs with --relative</span></span><br><span class="line"><span class="string"> -b, --backup                make backups (see --suffix &amp; --backup-dir)</span></span><br><span class="line"><span class="string">     --backup-dir=DIR        make backups into hierarchy based in DIR</span></span><br><span class="line"><span class="string">     --suffix=SUFFIX         set backup suffix (default ~ w/o --backup-dir)</span></span><br><span class="line"><span class="string"> -u, --update                skip files that are newer on the receiver</span></span><br><span class="line"><span class="string">     --inplace               update destination files in-place (SEE MAN PAGE)</span></span><br><span class="line"><span class="string">     --append                append data onto shorter files</span></span><br><span class="line"><span class="string">     --append-verify         like --append, but with old data in file checksum</span></span><br><span class="line"><span class="string"> -d, --dirs                  transfer directories without recursing</span></span><br><span class="line"><span class="string"> -l, --links                 copy symlinks as symlinks</span></span><br><span class="line"><span class="string"> -L, --copy-links            transform symlink into referent file/dir</span></span><br><span class="line"><span class="string">     --copy-unsafe-links     only"unsafe"symlinks are transformed</span></span><br><span class="line"><span class="string">     --safe-links            ignore symlinks that point outside the source tree</span></span><br><span class="line"><span class="string">     --munge-links           munge symlinks to make them safer (but unusable)</span></span><br><span class="line"><span class="string"> -k, --copy-dirlinks         transform symlink to a dir into referent dir</span></span><br><span class="line"><span class="string"> -K, --keep-dirlinks         treat symlinked dir on receiver as dir</span></span><br><span class="line"><span class="string"> -H, --hard-links            preserve hard links</span></span><br><span class="line"><span class="string"> -p, --perms                 preserve permissions</span></span><br><span class="line"><span class="string"> -E, --executability         preserve the file'</span>s executability</span><br><span class="line">     --chmod=CHMOD           affect file and/or directory permissions</span><br><span class="line"> -A, --acls                  preserve ACLs (implies --perms)</span><br><span class="line"> -X, --xattrs                preserve extended attributes</span><br><span class="line"> -o, --owner                 preserve owner (super-user only)</span><br><span class="line"> -g, --group                 preserve group</span><br><span class="line">     --devices               preserve device files (super-user only)</span><br><span class="line">     --copy-devices          copy device contents as regular file</span><br><span class="line">     --specials              preserve special files</span><br><span class="line"> -D                          same as --devices --specials</span><br><span class="line"> -t, --<span class="built_in">times</span>                 preserve modification <span class="built_in">times</span></span><br><span class="line"> -O, --omit-dir-times        omit directories from --<span class="built_in">times</span></span><br><span class="line"> -J, --omit-link-times       omit symlinks from --<span class="built_in">times</span></span><br><span class="line">     --super                 receiver attempts super-user activities</span><br><span class="line">     --fake-super            store/recover privileged attrs using xattrs</span><br><span class="line"> -S, --sparse                handle sparse files efficiently</span><br><span class="line">     --preallocate           allocate dest files before writing them</span><br><span class="line"> -n, --dry-run               perform a trial run with no changes made</span><br><span class="line"> -W, --whole-file            copy files whole (without delta-xfer algorithm)</span><br><span class="line"> -x, --one-file-system       don<span class="string">'t cross filesystem boundaries</span></span><br><span class="line"><span class="string"> -B, --block-size=SIZE       force a fixed checksum block-size</span></span><br><span class="line"><span class="string"> -e, --rsh=COMMAND           specify the remote shell to use</span></span><br><span class="line"><span class="string">     --rsync-path=PROGRAM    specify the rsync to run on the remote machine</span></span><br><span class="line"><span class="string">     --existing              skip creating new files on receiver</span></span><br><span class="line"><span class="string">     --ignore-existing       skip updating files that already exist on receiver</span></span><br><span class="line"><span class="string">     --remove-source-files   sender removes synchronized files (non-dirs)</span></span><br><span class="line"><span class="string">     --del                   an alias for --delete-during</span></span><br><span class="line"><span class="string">     --delete                delete extraneous files from destination dirs</span></span><br><span class="line"><span class="string">     --delete-before         receiver deletes before transfer, not during</span></span><br><span class="line"><span class="string">     --delete-during         receiver deletes during the transfer</span></span><br><span class="line"><span class="string">     --delete-delay          find deletions during, delete after</span></span><br><span class="line"><span class="string">     --delete-after          receiver deletes after transfer, not during</span></span><br><span class="line"><span class="string">     --delete-excluded       also delete excluded files from destination dirs</span></span><br><span class="line"><span class="string">     --ignore-missing-args   ignore missing source args without error</span></span><br><span class="line"><span class="string">     --delete-missing-args   delete missing source args from destination</span></span><br><span class="line"><span class="string">     --ignore-errors         delete even if there are I/O errors</span></span><br><span class="line"><span class="string">     --force                 force deletion of directories even if not empty</span></span><br><span class="line"><span class="string">     --max-delete=NUM        don'</span>t delete more than NUM files</span><br><span class="line">     --max-size=SIZE         don<span class="string">'t transfer any file larger than SIZE</span></span><br><span class="line"><span class="string">     --min-size=SIZE         don'</span>t transfer any file smaller than SIZE</span><br><span class="line">     --partial               keep partially transferred files</span><br><span class="line">     --partial-dir=DIR       put a partially transferred file into DIR</span><br><span class="line">     --delay-updates         put all updated files into place at transfer<span class="string">'s end</span></span><br><span class="line"><span class="string"> -m, --prune-empty-dirs      prune empty directory chains from the file-list</span></span><br><span class="line"><span class="string">     --numeric-ids           don'</span>t map uid/gid values by user/group name</span><br><span class="line">     --usermap=STRING        custom username mapping</span><br><span class="line">     --groupmap=STRING       custom groupname mapping</span><br><span class="line">     --chown=USER:GROUP      simple username/groupname mapping</span><br><span class="line">     --timeout=SECONDS       <span class="built_in">set</span> I/O timeout <span class="keyword">in</span> seconds</span><br><span class="line">     --contimeout=SECONDS    <span class="built_in">set</span> daemon connection timeout <span class="keyword">in</span> seconds</span><br><span class="line"> -I, --ignore-times          don<span class="string">'t skip files that match in size and mod-time</span></span><br><span class="line"><span class="string"> -M, --remote-option=OPTION  send OPTION to the remote side only</span></span><br><span class="line"><span class="string">     --size-only             skip files that match in size</span></span><br><span class="line"><span class="string">     --modify-window=NUM     compare mod-times with reduced accuracy</span></span><br><span class="line"><span class="string"> -T, --temp-dir=DIR          create temporary files in directory DIR</span></span><br><span class="line"><span class="string"> -y, --fuzzy                 find similar file for basis if no dest file</span></span><br><span class="line"><span class="string">     --compare-dest=DIR      also compare destination files relative to DIR</span></span><br><span class="line"><span class="string">     --copy-dest=DIR         ... and include copies of unchanged files</span></span><br><span class="line"><span class="string">     --link-dest=DIR         hardlink to files in DIR when unchanged</span></span><br><span class="line"><span class="string"> -z, --compress              compress file data during the transfer</span></span><br><span class="line"><span class="string">     --compress-level=NUM    explicitly set compression level</span></span><br><span class="line"><span class="string">     --skip-compress=LIST    skip compressing files with a suffix in LIST</span></span><br><span class="line"><span class="string"> -C, --cvs-exclude           auto-ignore files the same way CVS does</span></span><br><span class="line"><span class="string"> -f, --filter=RULE           add a file-filtering RULE</span></span><br><span class="line"><span class="string"> -F                          same as --filter='</span>dir-merge /.rsync-filter<span class="string">'</span></span><br><span class="line"><span class="string">                             repeated: --filter='</span>- .rsync-filter<span class="string">'</span></span><br><span class="line"><span class="string">     --exclude=PATTERN       exclude files matching PATTERN</span></span><br><span class="line"><span class="string">     --exclude-from=FILE     read exclude patterns from FILE</span></span><br><span class="line"><span class="string">     --include=PATTERN       don'</span>t exclude files matching PATTERN</span><br><span class="line">     --include-from=FILE     <span class="built_in">read</span> include patterns from FILE</span><br><span class="line">     --files-from=FILE       <span class="built_in">read</span> list of <span class="built_in">source</span>-file names from FILE</span><br><span class="line"> -0, --from0                 all *-from/filter files are delimited by 0s</span><br><span class="line"> -s, --protect-args          no space-splitting; only wildcard special-chars</span><br><span class="line">     --address=ADDRESS       <span class="built_in">bind</span> address <span class="keyword">for</span> outgoing socket to daemon</span><br><span class="line">     --port=PORT             specify double-colon alternate port number</span><br><span class="line">     --sockopts=OPTIONS      specify custom TCP options</span><br><span class="line">     --blocking-io           use blocking I/O <span class="keyword">for</span> the remote shell</span><br><span class="line">     --stats                 give some file-transfer stats</span><br><span class="line"> -8, --8-bit-output          leave high-bit chars unescaped <span class="keyword">in</span> output</span><br><span class="line"> -h, --human-readable        output numbers <span class="keyword">in</span> a human-readable format</span><br><span class="line">     --progress              show progress during transfer</span><br><span class="line"> -P                          same as --partial --progress</span><br><span class="line"> -i, --itemize-changes       output a change-summary <span class="keyword">for</span> all updates</span><br><span class="line">     --out-format=FORMAT     output updates using the specified FORMAT</span><br><span class="line">     --<span class="built_in">log</span>-file=FILE         <span class="built_in">log</span> what we<span class="string">'re doing to the specified FILE</span></span><br><span class="line"><span class="string">     --log-file-format=FMT   log updates using the specified FMT</span></span><br><span class="line"><span class="string">     --password-file=FILE    read daemon-access password from FILE</span></span><br><span class="line"><span class="string">     --list-only             list the files instead of copying them</span></span><br><span class="line"><span class="string">     --bwlimit=RATE          limit socket I/O bandwidth</span></span><br><span class="line"><span class="string">     --outbuf=N|L|B          set output buffering to None, Line, or Block</span></span><br><span class="line"><span class="string">     --write-batch=FILE      write a batched update to FILE</span></span><br><span class="line"><span class="string">     --only-write-batch=FILE like --write-batch but w/o updating destination</span></span><br><span class="line"><span class="string">     --read-batch=FILE       read a batched update from FILE</span></span><br><span class="line"><span class="string">     --protocol=NUM          force an older protocol version to be used</span></span><br><span class="line"><span class="string">     --iconv=CONVERT_SPEC    request charset conversion of filenames</span></span><br><span class="line"><span class="string">     --checksum-seed=NUM     set block/file checksum seed (advanced)</span></span><br><span class="line"><span class="string"> -4, --ipv4                  prefer IPv4</span></span><br><span class="line"><span class="string"> -6, --ipv6                  prefer IPv6</span></span><br><span class="line"><span class="string">     --version               print version number</span></span><br><span class="line"><span class="string">(-h) --help                  show this help (-h is --help only if used alone)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Use"rsync --daemon --help"to see the daemon-mode command-line options.</span></span><br><span class="line"><span class="string">Please see the rsync(1) and rsyncd.conf(5) man pages for full documentation.</span></span><br><span class="line"><span class="string">See http://rsync.samba.org/ for updates, bug reports, and answers</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rsync 常用参数 </span></span><br><span class="line">-v : 展示详细的同步信息 </span><br><span class="line">-a : 归档模式，相当于 -rlptgoD</span><br><span class="line">    -r : 递归目录 </span><br><span class="line">    -l : 同步软连接文件 </span><br><span class="line">    -p : 保留权限 </span><br><span class="line">    -t : 将源文件的 < span class="string">"modify time"</span> 同步到目标机器 <br><span class="line">    -g : 保持文件属组 </span><br><span class="line">    -o : 保持文件属主 </span><br><span class="line">    -D : 和 --devices --specials 一样，保持设备文件和特殊文件 </span><br><span class="line">-z : 发送数据前，先压缩再传输 </span><br><span class="line">-H : 保持硬链接 </span><br><span class="line">-n : 进行试运行，不作任何更改 </span><br><span class="line">-P same as --partial --progress</span><br><span class="line">    --partial : 支持断点续传 </span><br><span class="line">    --progress : 展示传输的进度 </span><br><span class="line">--delete : 如果源文件消失，目标文件也会被删除 </span><br><span class="line">--delete-excluded : 指定要在目的端删除的文件 </span><br><span class="line">--delete-after : 默认情况下，rsync 是先清理目的端的文件再开始数据同步；如果使用此选项，则 rsync 会先进行数据同步，都完成后再删除那些需要清理的文件。</span><br><span class="line">--exclude=PATTERN : 排除匹配 PATTERN 的文件 </span><br><span class="line">--exclude-from=FILE : 如果要排除的文件很多，可以统一写在某一文件中 </span><br><span class="line">-e ssh : 使用 SSH 加密隧道传输 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 远程 Shell 方式 </span></span><br><span class="line">rsync [OPTION]... SRC [SRC]... [USER@]HOST:DEST <span class="comment"># 执行 “推” 操作 </span></span><br><span class="line">or   rsync [OPTION]... [USER@]HOST:SRC [DEST]   <span class="comment"># 执行 “拉” 操作 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 远程 C/S 方式 </span></span><br><span class="line">rsync [OPTION]... SRC [SRC]... [USER@]HOST::DEST                    <span class="comment"># 执行 “推” 操作 </span></span><br><span class="line">or   rsync [OPTION]... SRC [SRC]... rsync://[USER@]HOST[:PORT]/DEST <span class="comment"># 执行 “推” 操作 </span></span><br><span class="line">or   rsync [OPTION]... [USER@]HOST::SRC [DEST]                      <span class="comment"># 执行 “拉” 操作 </span></span><br><span class="line">or   rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]        <span class="comment"># 执行 “拉” 操作 </span></span><br></pre></td></tr></table></figure><h2 id="rsync-同步方式"><a href="#rsync-同步方式" class="headerlink" title="rsync 同步方式"></a>rsync 同步方式</h2><p>Rsync 远程同步主要有两种方式：使用远程 shell（ssh 或 rsh） 或使用 rsync 的 daemon 方式</p><p>rsync 命令和 ssh，scp 命令有点相似。</p><p>我们创建两个测试目录和一些文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mkdir dir1</span><br><span class="line">mkdir dir2</span><br><span class="line">touch dir1/somefile&#123;1..100&#125;</span><br><span class="line"><span class="comment"># dir1 中有 100 文件，dir2 中为空。使用 rsync 把 dir1 内容同步到 dir2，-r 选项代表递归，在同步目录时使用。</span></span><br><span class="line">rsync -r dir1/ dir2</span><br><span class="line"><span class="comment"># 你也可以使用 -a 选项，代表同步所有，包括修改时间、群组、权限、特殊文件、也包括递归。</span></span><br><span class="line">rsync -anv dir1/ dir2</span><br><span class="line"><span class="comment"># 注意上面的 dir1 / 中的 “/” 不能少，它代表同步目录下文件， 如果没有 “/” 代表同步这个目录。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 和远程主机进行同步目录首先，你要确保有远程主机的 SSH 访问权限 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把本地目录同步到远程主机：</span></span><br><span class="line">rsync -a dir1/ root@linux:~/dir2</span><br><span class="line"><span class="comment"># 把远程主机目录同步到本地：</span></span><br><span class="line">rsync -a root@linux:~/dir2/ dir1</span><br></pre></td></tr></table></figure><h3 id="本地文件同步"><a href="#本地文件同步" class="headerlink" title="本地文件同步"></a>本地文件同步</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果没有 desc 目录，会自动创建 </span></span><br><span class="line">rsync -avH /opt/resource/ /tmp/desc/</span><br></pre></td></tr></table></figure><h3 id="远程文件同步-–shell-方式"><a href="#远程文件同步-–shell-方式" class="headerlink" title="远程文件同步 –shell 方式"></a>远程文件同步 –shell 方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从本地传到远端，目标文件会被写成 ssh 登录用户的属组和属主（如下 www）</span></span><br><span class="line">rsync -avH /opt/nginx-1.12.1/ www@172.18.50.125:/tmp/nginx/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 ssh 加密隧道方式传输，保障数据的安全性 </span></span><br><span class="line">rsync -avHe ssh /opt/nginx-1.12.1/ www@172.18.50.125:/tmp/nginx/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从远端传到本地，只要对目标文件有读的权限，就可以同步到本地 </span></span><br><span class="line">rsync -avH www@172.18.50.125:/tmp/nginx/ /tmp/nginx/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果远程服务器 ssh 端口不是默认的 22</span></span><br><span class="line">rsync -avHe <span class="string">"ssh -p 11222"</span> /opt/nginx-1.12.1/ www@172.18.50.125:/tmp/nginx/</span><br></pre></td></tr></table></figure><h3 id="远程文件同步-–daemon-方式"><a href="#远程文件同步-–daemon-方式" class="headerlink" title="远程文件同步 –daemon 方式"></a>远程文件同步 –daemon 方式</h3><blockquote><p>rsync 服务端配置</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 rsync 服务的目录和配置文件 (可选)</span></span><br><span class="line">mkdir /etc/rsync </span><br><span class="line"><span class="built_in">cd</span> /etc/rsync</span><br><span class="line">touch rsyncd.conf</span><br><span class="line">touch rsyncd.secrets</span><br><span class="line">touch rsyncd.motd</span><br><span class="line">chmod 600 rsyncd.secrets</span><br><span class="line"></span><br><span class="line"><span class="comment">### rsyncd.conf 文件的配置 </span></span><br><span class="line">vim /etc/rsync/rsyncd.conf</span><br><span class="line"><span class="comment"># /etc/rsyncd: configuration file for rsync daemon mode</span></span><br><span class="line"><span class="comment"># See rsyncd.conf man page for more options.</span></span><br><span class="line"><span class="comment"># 传输文件使用的用户和用户组，如果是从服务器 =&gt; 客户端，要保证 www 用户对文件有读取的权限；如果是从客户端 =&gt; 服务端，要保证 www 对文件有写权限。</span></span><br><span class="line">uid = www</span><br><span class="line">gid = www</span><br><span class="line"><span class="comment"># 允许 chroot，提升安全性，客户端连接模块，首先 chroot 到模块 path 参数指定的目录下，chroot 为 yes 时必须使用 root 权限，且不能备份 path 路径外的链接文件 </span></span><br><span class="line">use chroot = yes</span><br><span class="line"><span class="comment"># 只读 </span></span><br><span class="line"><span class="built_in">read</span> only = no</span><br><span class="line"><span class="comment"># 只写 </span></span><br><span class="line">write only = no</span><br><span class="line"><span class="comment"># 设定白名单，可以指定 IP 段（172.18.50.1/255.255.255.0）, 各个 Ip 段用空格分开 </span></span><br><span class="line">hosts allow = 172.18.50.110 172.18.50.111</span><br><span class="line">hosts deny = *</span><br><span class="line"><span class="comment"># 允许的客户端最大连接数 </span></span><br><span class="line">max connections = 4</span><br><span class="line"><span class="comment"># 欢迎文件的路径，非必须 </span></span><br><span class="line">motd file = /etc/rsync/rsyncd.motd</span><br><span class="line"><span class="comment"># pid 文件路径 </span></span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line"><span class="comment"># 记录传输文件日志 </span></span><br><span class="line">transfer logging = yes</span><br><span class="line"><span class="comment"># 日志文件格式 </span></span><br><span class="line"><span class="built_in">log</span> format = %t %a %m %f %b</span><br><span class="line"><span class="comment"># 指定日志文件 </span></span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/rsync.log</span><br><span class="line"><span class="comment"># 剔除某些文件或目录，不同步 </span></span><br><span class="line">exclude = lost+found/</span><br><span class="line"><span class="comment"># 设置超时时间 </span></span><br><span class="line">timeout = 900</span><br><span class="line">ignore nonreadable = yes</span><br><span class="line"><span class="comment"># 设置不需要压缩的文件 </span></span><br><span class="line">dont compress   = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模块，可以配置多个，使用如: sate@172.18.50.125::125to110</span></span><br><span class="line">[125to110]</span><br><span class="line"><span class="comment"># 模块的根目录，同步目录，要注意权限 </span></span><br><span class="line">path = /tmp/nginx</span><br><span class="line"><span class="comment"># 是否允许列出模块内容 </span></span><br><span class="line">list = no</span><br><span class="line"><span class="comment"># 忽略错误 </span></span><br><span class="line">ignore errors</span><br><span class="line"><span class="comment"># 添加注释 </span></span><br><span class="line">comment = ftp <span class="built_in">export</span> area</span><br><span class="line"><span class="comment"># 模块验证的用户名称，可使用空格或者逗号隔开多个用户名 </span></span><br><span class="line">auth users = sate</span><br><span class="line"><span class="comment"># 模块验证密码文件 可放在全局配置里 </span></span><br><span class="line">secrets file = /etc/rsync/rsyncd.secrets</span><br><span class="line"><span class="comment"># 剔除某些文件或目录，不同步 </span></span><br><span class="line">exclude = lost+found/ conf/ man/</span><br><span class="line"></span><br><span class="line"><span class="comment">### rsyncd.secrets 文件的配置 </span></span><br><span class="line">cat rsyncd.secrets </span><br><span class="line"><span class="comment"># 用户名: 密码 </span></span><br><span class="line">sate:111111</span><br><span class="line"></span><br><span class="line"><span class="comment">### rsync 启动 </span></span><br><span class="line">rsync --daemon --config=/etc/rsync/rsyncd.conf</span><br></pre></td></tr></table></figure><blockquote><p>rsync 客户端配置</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从 服务端 =&gt; 客户端 同步数据，会提示输入密码 </span></span><br><span class="line">rsync -avzP --delete sate@172.18.50.125::125to110 /tmp/sync/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 客户端 =&gt; 服务端 同步数据，会提示输入密码 </span></span><br><span class="line">rsync -avzP --delete /tmp/sync/ sate@172.18.50.125::125to110</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注: 如果是 /tmp/sync，则同步 sync 目录；如果 /tmp/sync/，则同步 sync 目录下的文件 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 免密码同步，将密码写到文件，再通过 --password-file 指定该文件，注：该文件的权限必须是 600</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"111111"</span> &gt; /tmp/secrets.file</span><br><span class="line">chmod 600 /tmp/secrets.file</span><br><span class="line">rsync -avzP --delete --password-file=/tmp/secrets.file sate@172.18.50.125::125to110 /tmp/sync/</span><br><span class="line"></span><br><span class="line"><span class="comment"># --exclude 排除文件目录时，如果有多个同名目录的情况 </span></span><br><span class="line"><span class="comment"># 目录结构 </span></span><br><span class="line">tree</span><br><span class="line">.</span><br><span class="line">├── dir1</span><br><span class="line">│   └── <span class="built_in">test</span></span><br><span class="line">│       ├── 3.file</span><br><span class="line">│       ├── 4.file</span><br><span class="line">│       └── 5.file</span><br><span class="line">├── dir2</span><br><span class="line">└── <span class="built_in">test</span></span><br><span class="line">    ├── 1.file</span><br><span class="line">    ├── 2.file</span><br><span class="line">    └── 3.file</span><br><span class="line"></span><br><span class="line"><span class="comment"># 情况一 ： 排除 /test 目录，同步其他目录（同步的是 / tmp/sync/ 下边的文件）</span></span><br><span class="line">rsync -avP --delete --password-file=/tmp/secrets.file --exclude=<span class="built_in">test</span>  /tmp/sync/ sate@172.18.50.125::125to110 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 会发现，该目录下所有 test 目录都被排除了，如果想只排除第一层目录的 test，可以如下（/ 代表所同步目录第一层）：</span></span><br><span class="line">rsync -avP --delete --password-file=/tmp/secrets.file --exclude=/<span class="built_in">test</span>/  /tmp/sync/ sate@172.18.50.125::125to110 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 情况二 ： 和情况一不同的是 同步的 /tmp/sync 这个目录（同步的是 / tmp/sync 目录本身，导致 exclude 后边的参数也会变化）</span></span><br><span class="line">rsync -avP --delete --password-file=/tmp/secrets.file --exclude=/sync/<span class="built_in">test</span>/  /tmp/sync sate@172.18.50.125::125to110</span><br></pre></td></tr></table></figure><h2 id="rsync-简化配置实践"><a href="#rsync-简化配置实践" class="headerlink" title="rsync 简化配置实践"></a>rsync 简化配置实践</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置服务端 rsyncd.conf</span></span><br><span class="line">vim /etc/rsyncd.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> only = no</span><br><span class="line">list = yes</span><br><span class="line">uid = root</span><br><span class="line">gid = root</span><br><span class="line"></span><br><span class="line">[backup]</span><br><span class="line">path= /data/</span><br><span class="line">hosts allow = 10.71.12.0/23</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置服务 </span></span><br><span class="line">systemctl start rsyncd</span><br><span class="line">systemctl <span class="built_in">enable</span> rsyncd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 rsync 客户端 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑 backup.sh 同步脚本 </span></span><br><span class="line">vim backup.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">SOURCE=<span class="variable">$1</span></span><br><span class="line">DEST=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line">CMD=<span class="string">"rsync -ravz --bwlimit=2000 <span class="variable">$1</span> rsync://&#123;&#123;log_server_ip&#125;&#125;:873/backup/<span class="variable">$2</span>"</span></span><br><span class="line"></span><br><span class="line">PROCS=$(pgrep -f <span class="string">"&#123;&#123;log_server_ip&#125;&#125;:873/backup/<span class="variable">$2</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"x"</span> != <span class="string">"x<span class="variable">$PROCS</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">       <span class="built_in">echo</span> <span class="string">"not finished"</span></span><br><span class="line">       <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$CMD</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 crontab</span></span><br><span class="line">vim /etc/crontab</span><br><span class="line">15 * * * * root <span class="built_in">cd</span> /opt/sa_scripts/ &amp;&amp; ./backup.sh /var/<span class="built_in">log</span>/ocha/pos_python_server/  10.71.12.89/$(date +\%Y-\%m)</span><br></pre></td></tr></table></figure><h2 id="rsync-有用的选项和注意事项"><a href="#rsync-有用的选项和注意事项" class="headerlink" title="rsync 有用的选项和注意事项"></a>rsync 有用的选项和注意事项</h2><p>-z 选项，压缩传输的文件，对于已经压缩过的文件不建议添加该参数，针对大文件压缩包传输效率会降低 8 倍，且消耗 CPU</p><pre><code>rsync -az source dest</code></pre><p>-P 选项非常有用，它是 -progress 和 -partial 的组合。第一个选项是用来显示传输进度条，第二个选项允许断点续传和增量传输：</p><pre><code>rsync -azP source dest</code></pre><p>–bwlimit 选项，限制传输带宽，参数值的默认单位是 KBPS，也就是每秒多少 KB</p><pre><code>rsync -avzP --bwlimit=100 source dest</code></pre><p>–remove-source-files 该选项告诉 rsync 移除 sender 端已经成功传输到 receiver 端的文件 (不包括任何目录文件)。</p><pre><code>rsync -avP --remove-source-files source dest</code></pre><p>rsync 过滤模块比较复杂，建议参考官网和 Google 实例测试<br>–exclude 选项如果只有前者可以单独使用，多个规则需要写多条<br>–include 选项通常需要配合 –exclude 同时使用<br>过滤规则比较多可以写在文件里读取，由于 rsync 不支持正则表达式，复杂的逻辑建议先使用 bash shell 过滤</p><p><a href="https://rsync.samba.org/documentation.html" target="_blank" rel="noopener">https://rsync.samba.org/documentation.html</a></p><p>rsync (一)：基本命令和用法 - <a href="https://www.cnblogs.com/f-ck-need-u/p/7220009.html" target="_blank" rel="noopener">https://www.cnblogs.com/f-ck-need-u/p/7220009.html</a></p>]]></content>
    
    <summary type="html">
    
      rsync安装配置实践
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>sysctl.conf 和 limits.conf 学习和调优</title>
    <link href="https://wsgzao.github.io/post/sysctl/"/>
    <id>https://wsgzao.github.io/post/sysctl/</id>
    <published>2019-05-13T07:42:19.000Z</published>
    <updated>2019-05-14T08:20:15.476Z</updated>
    
    <content type="html"><![CDATA[<p><img src="//i.v2ex.co/jS8VtmPl.jpeg" alt=""></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>记得第一次接触 <code>/etc/security/limits.conf</code> 和 <code>/etc/sysctl.conf</code> 时是因为部署 Oracle 时要按需修改内核参数。limits.conf 文件实际是 Linux PAM（插入式认证模块，Pluggable Authentication Modules）中 pam_limits.so 的配置文件，突破系统的默认限制，对系统访问资源有一定保护作用。 limits.conf 和 sysctl.conf 区别在于 limits.conf 是针对用户，而 sysctl.conf 是针对整个系统参数配置。 </p><blockquote><p>sysctl.conf 和 limits.conf 学习和调优</p></blockquote><hr><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 05 月 13 日 - 更新 limits.conf 的最佳实践<br>2015 年 08 月 10 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/sysctl/">https://wsgzao.github.io/post/sysctl/</a></p><p>扩展阅读</p><p>设置 Sysctl.conf 用以提高 Linux 的性能(最完整的 sysctl.conf 优化方案) - <a href="http://blog.csdn.net/21aspnet/article/details/6584792" target="_blank" rel="noopener">http://blog.csdn.net/21aspnet/article/details/6584792</a><br>limits.conf 工作原理 - <a href="http://my.oschina.net/987openlab/blog/94634" target="_blank" rel="noopener">http://my.oschina.net/987openlab/blog/94634</a><br>ulimit 命令 - <a href="http://man.linuxde.net/ulimit" target="_blank" rel="noopener">http://man.linuxde.net/ulimit</a><br>Sysctl 学习 - <a href="http://pengyao.org/sysctl-1.html" target="_blank" rel="noopener">http://pengyao.org/sysctl-1.html</a><br>Kernel sysctl configuration file for Linux - <a href="https://klaver.it/linux/sysctl.conf" target="_blank" rel="noopener">https://klaver.it/linux/sysctl.conf</a><br>LTMP 索引 - <a href="https://wsgzao.github.io/index/#LTMP">https://wsgzao.github.io/index/#LTMP</a></p><hr><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><h3 id="limits-conf-工作原理"><a href="#limits-conf-工作原理" class="headerlink" title="limits.conf 工作原理"></a>limits.conf 工作原理</h3><p>limits.conf 是 <code>pam_limits.so</code> 的配置文件，然后 <code>/etc/pam.d/</code> 下的应用程序调用 <code>pam_***.so</code> 模块。譬如说，当用户访问服务器，服务程序将请求发送到 PAM 模块，PAM 模块根据服务名称在 <code>/etc/pam.d</code> 目录下选择一个对应的服务文件，然后根据服务文件的内容选择具体的 PAM 模块进行处理。</p><h3 id="limits-conf-文件格式"><a href="#limits-conf-文件格式" class="headerlink" title="limits.conf 文件格式"></a>limits.conf 文件格式</h3><pre><code>username|@groupname   type  resource  limit </code></pre><p>1）username|@groupname<br>设置需要被限制的用户名，组名前面加 @和用户名区别。也可用通配符 * 来做所有用户的限制 </p><p>2）type<br>类型有 soft，hard 和 -，其中 soft 指的是当前系统生效的设置值。hard 表明系统中所能设定的最大值。soft 的限制不能比 hard 限制高。用 - 就表明同时设置了 soft 和 hard 的值 </p><p>3）resource： 表示要限制的资源</p><ol><li>nofile - 打开文件的最大数目 </li><li>noproc - 进程的最大数目 </li></ol><h3 id="ulimit-命令"><a href="#ulimit-命令" class="headerlink" title="ulimit 命令"></a>ulimit 命令</h3><blockquote><p>ulimit 命令用来限制系统用户对 shell 资源的访问，常用参数解释如下</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span>(选项)</span><br><span class="line"></span><br><span class="line">-a：显示目前资源限制的设定；</span><br><span class="line">-c &lt;core 文件上限 & gt;：设定 core 文件的最大值，单位为区块；</span><br><span class="line">-d &lt; 数据节区大小 & gt;：程序数据节区的最大值，单位为 KB；</span><br><span class="line">-f &lt; 文件大小 & gt;：shell 所能建立的最大文件，单位为区块；</span><br><span class="line">-H：设定资源的硬性限制，也就是管理员所设下的限制；</span><br><span class="line">-m &lt; 内存大小 & gt;：指定可使用内存的上限，单位为 KB；</span><br><span class="line">-n &lt; 文件数目 & gt;：指定同一时间最多可开启的文件数；</span><br><span class="line">-p &lt; 缓冲区大小 & gt;：指定管道缓冲区的大小，单位 512 字节；</span><br><span class="line">-s &lt; 堆叠大小 & gt;：指定堆叠的上限，单位为 KB；</span><br><span class="line">-S：设定资源的弹性限制；</span><br><span class="line">-t &lt;CPU 时间 & gt;：指定 CPU 使用时间的上限，单位为秒；</span><br><span class="line">-u &lt; 程序数目 & gt;：用户最多可开启的程序数目；</span><br><span class="line">-v &lt; 虚拟内存大小 & gt;：指定可使用的虚拟内存上限，单位为 KB。</span><br></pre></td></tr></table></figure><h3 id="sysctl-conf-工作原理"><a href="#sysctl-conf-工作原理" class="headerlink" title="sysctl.conf 工作原理"></a>sysctl.conf 工作原理</h3><p>sysctl 命令被用于在内核运行时动态地修改内核的运行参数，可用的内核参数在目录 <code>/proc/sys</code> 中。它包含一些 TCP/IP 堆栈和虚拟内存系统的高级选项， 这可以让有经验的管理员提高引人注目的系统性能。用 sysctl 可以读取设置超过五百个系统变量。</p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="limits-conf-设置"><a href="#limits-conf-设置" class="headerlink" title="limits.conf 设置"></a>limits.conf 设置</h3><p>1）暂时生效，适用于通过 <code>ulimit</code> 命令登录 shell 会话期间</p><pre><code>ulimit -SHn 65535</code></pre><p>2）永久生效，通过将一个相应的 ulimit 语句添加到由登录 shell 读取的文件之一（例如 ~/.profile），即特定于 shell 的用户资源文件；或者通过编辑 <code>/etc/security/limits.conf</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 比如添加到 / etc/profile</span></span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">ulimit</span> -SHn 65535 &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改最大进程和最大文件打开数限制</span></span><br><span class="line">vi /etc/security/limits.conf</span><br><span class="line">*       soft    nofile  655350</span><br><span class="line">*       hard    nofile  655350</span><br><span class="line">*       soft    nproc   unlimited</span><br><span class="line">*       hard    nproc   unlimited</span><br><span class="line">*       soft    core    unlimited</span><br><span class="line">*       hard    core    unlimited</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生产环境中的配置，同时兼容 RedHat/CentOS/Ubuntu</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 / etc/security/limits.conf</span></span><br><span class="line">cat /etc/security/limits.conf</span><br><span class="line">*       soft    nofile  655350</span><br><span class="line">*       hard    nofile  655350</span><br><span class="line">*       soft    nproc   unlimited</span><br><span class="line">*       hard    nproc   unlimited</span><br><span class="line">*       soft    core    unlimited</span><br><span class="line">*       hard    core    unlimited</span><br><span class="line">root    soft    nofile  655350</span><br><span class="line">root    hard    nofile  655350</span><br><span class="line">root    soft    nproc   unlimited</span><br><span class="line">root    hard    nproc   unlimited</span><br><span class="line">root    soft    core    unlimited</span><br><span class="line">root    hard    core    unlimited</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建软链接</span></span><br><span class="line">[root@localhost wangao]<span class="comment"># cd /etc/security/limits.d/</span></span><br><span class="line">[root@localhost limits.d]<span class="comment"># ll</span></span><br><span class="line">total 4</span><br><span class="line">-rw-r--r--. 1 root root 191 Apr 11  2018 20-nproc.conf</span><br><span class="line">lrwxrwxrwx  1 root root  25 May 10 19:57 99-garena-server.conf -&gt; /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 system.conf 中 DefaultLimitNOFILE=655350</span></span><br><span class="line">cat /etc/systemd/system.conf</span><br><span class="line"><span class="comment">#  This file is part of systemd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  systemd is free software; you can redistribute it and/or modify it</span></span><br><span class="line"><span class="comment">#  under the terms of the GNU Lesser General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2.1 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Entries in this file show the compile time defaults.</span></span><br><span class="line"><span class="comment"># You can change settings by editing this file.</span></span><br><span class="line"><span class="comment"># Defaults can be restored by simply deleting this file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See systemd-system.conf(5) for details.</span></span><br><span class="line"></span><br><span class="line">[Manager]</span><br><span class="line"><span class="comment">#LogLevel=info</span></span><br><span class="line"><span class="comment">#LogTarget=journal-or-kmsg</span></span><br><span class="line"><span class="comment">#LogColor=yes</span></span><br><span class="line"><span class="comment">#LogLocation=no</span></span><br><span class="line"><span class="comment">#DumpCore=yes</span></span><br><span class="line"><span class="comment">#CrashShell=no</span></span><br><span class="line"><span class="comment">#ShowStatus=yes</span></span><br><span class="line"><span class="comment">#CrashChVT=1</span></span><br><span class="line"><span class="comment">#CtrlAltDelBurstAction=reboot-force</span></span><br><span class="line"><span class="comment">#CPUAffinity=1 2</span></span><br><span class="line"><span class="comment">#JoinControllers=cpu,cpuacct net_cls,net_prio</span></span><br><span class="line"><span class="comment">#RuntimeWatchdogSec=0</span></span><br><span class="line"><span class="comment">#ShutdownWatchdogSec=10min</span></span><br><span class="line"><span class="comment">#CapabilityBoundingSet=</span></span><br><span class="line"><span class="comment">#SystemCallArchitectures=</span></span><br><span class="line"><span class="comment">#TimerSlackNSec=</span></span><br><span class="line"><span class="comment">#DefaultTimerAccuracySec=1min</span></span><br><span class="line"><span class="comment">#DefaultStandardOutput=journal</span></span><br><span class="line"><span class="comment">#DefaultStandardError=inherit</span></span><br><span class="line"><span class="comment">#DefaultTimeoutStartSec=90s</span></span><br><span class="line"><span class="comment">#DefaultTimeoutStopSec=90s</span></span><br><span class="line"><span class="comment">#DefaultRestartSec=100ms</span></span><br><span class="line"><span class="comment">#DefaultStartLimitInterval=10s</span></span><br><span class="line"><span class="comment">#DefaultStartLimitBurst=5</span></span><br><span class="line"><span class="comment">#DefaultEnvironment=</span></span><br><span class="line"><span class="comment">#DefaultCPUAccounting=no</span></span><br><span class="line"><span class="comment">#DefaultBlockIOAccounting=no</span></span><br><span class="line"><span class="comment">#DefaultMemoryAccounting=no</span></span><br><span class="line"><span class="comment">#DefaultTasksAccounting=no</span></span><br><span class="line"><span class="comment">#DefaultTasksMax=</span></span><br><span class="line"><span class="comment">#DefaultLimitCPU=</span></span><br><span class="line"><span class="comment">#DefaultLimitFSIZE=</span></span><br><span class="line"><span class="comment">#DefaultLimitDATA=</span></span><br><span class="line"><span class="comment">#DefaultLimitSTACK=</span></span><br><span class="line"><span class="comment">#DefaultLimitCORE=</span></span><br><span class="line"><span class="comment">#DefaultLimitRSS=</span></span><br><span class="line"><span class="comment">#DefaultLimitNOFILE=</span></span><br><span class="line"><span class="comment">#DefaultLimitAS=</span></span><br><span class="line"><span class="comment">#DefaultLimitNPROC=</span></span><br><span class="line"><span class="comment">#DefaultLimitMEMLOCK=</span></span><br><span class="line"><span class="comment">#DefaultLimitLOCKS=</span></span><br><span class="line"><span class="comment">#DefaultLimitSIGPENDING=</span></span><br><span class="line"><span class="comment">#DefaultLimitMSGQUEUE=</span></span><br><span class="line"><span class="comment">#DefaultLimitNICE=</span></span><br><span class="line"><span class="comment">#DefaultLimitRTPRIO=</span></span><br><span class="line"><span class="comment">#DefaultLimitRTTIME=</span></span><br><span class="line">DefaultLimitNOFILE=655350</span><br></pre></td></tr></table></figure><h3 id="sysctl-conf-设置"><a href="#sysctl-conf-设置" class="headerlink" title="sysctl.conf 设置"></a>sysctl.conf 设置</h3><blockquote><p>这是一个在网络上流传已久的 sysctl.conf 优化配置</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 优化 TCP</span></span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line"><span class="comment"># 禁用包过滤功能 </span></span><br><span class="line">net.ipv4.ip_forward = 0  </span><br><span class="line"><span class="comment"># 启用源路由核查功能 </span></span><br><span class="line">net.ipv4.conf.default.rp_filter = 1  </span><br><span class="line"><span class="comment"># 禁用所有 IP 源路由 </span></span><br><span class="line">net.ipv4.conf.default.accept_source_route = 0  </span><br><span class="line"><span class="comment"># 使用 sysrq 组合键是了解系统目前运行情况，为安全起见设为 0 关闭 </span></span><br><span class="line">kernel.sysrq = 0  </span><br><span class="line"><span class="comment"># 控制 core 文件的文件名是否添加 pid 作为扩展</span></span><br><span class="line">kernel.core_uses_pid = 1  </span><br><span class="line"><span class="comment"># 开启 SYN Cookies，当出现 SYN 等待队列溢出时，启用 cookies 来处理</span></span><br><span class="line">net.ipv4.tcp_syncookies = 1  </span><br><span class="line"><span class="comment"># 每个消息队列的大小（单位：字节）限制</span></span><br><span class="line">kernel.msgmnb = 65536  </span><br><span class="line"><span class="comment"># 整个系统最大消息队列数量限制</span></span><br><span class="line">kernel.msgmax = 65536  </span><br><span class="line"><span class="comment"># 单个共享内存段的大小（单位：字节）限制，计算公式 64G*1024*1024*1024(字节)</span></span><br><span class="line">kernel.shmmax = 68719476736  </span><br><span class="line"><span class="comment"># 所有内存大小（单位：页，1 页 = 4Kb），计算公式 16G*1024*1024*1024/4KB(页)</span></span><br><span class="line">kernel.shmall = 4294967296  </span><br><span class="line"><span class="comment">#timewait 的数量，默认是 180000</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 6000  </span><br><span class="line"><span class="comment"># 开启有选择的应答</span></span><br><span class="line">net.ipv4.tcp_sack = 1  </span><br><span class="line"><span class="comment"># 支持更大的 TCP 窗口. 如果 TCP 窗口最大超过 65535(64K), 必须设置该数值为 1</span></span><br><span class="line">net.ipv4.tcp_window_scaling = 1  </span><br><span class="line"><span class="comment">#TCP 读 buffer</span></span><br><span class="line">net.ipv4.tcp_rmem = 4096 131072 1048576</span><br><span class="line"><span class="comment">#TCP 写 buffer</span></span><br><span class="line">net.ipv4.tcp_wmem = 4096 131072 1048576   </span><br><span class="line"><span class="comment"># 为 TCP socket 预留用于发送缓冲的内存默认值（单位：字节）</span></span><br><span class="line">net.core.wmem_default = 8388608</span><br><span class="line"><span class="comment"># 为 TCP socket 预留用于发送缓冲的内存最大值（单位：字节）</span></span><br><span class="line">net.core.wmem_max = 16777216  </span><br><span class="line"><span class="comment"># 为 TCP socket 预留用于接收缓冲的内存默认值（单位：字节）  </span></span><br><span class="line">net.core.rmem_default = 8388608</span><br><span class="line"><span class="comment"># 为 TCP socket 预留用于接收缓冲的内存最大值（单位：字节）</span></span><br><span class="line">net.core.rmem_max = 16777216</span><br><span class="line"><span class="comment"># 每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目</span></span><br><span class="line">net.core.netdev_max_backlog = 262144  </span><br><span class="line"><span class="comment">#web 应用中 listen 函数的 backlog 默认会给我们内核参数的 net.core.somaxconn 限制到 128，而 nginx 定义的 NGX_LISTEN_BACKLOG 默认为 511，所以有必要调整这个值</span></span><br><span class="line">net.core.somaxconn = 262144  </span><br><span class="line"><span class="comment"># 系统中最多有多少个 TCP 套接字不被关联到任何一个用户文件句柄上。这个限制仅仅是为了防止简单的 DoS 攻击，不能过分依靠它或者人为地减小这个值，更应该增加这个值(如果增加了内存之后)</span></span><br><span class="line">net.ipv4.tcp_max_orphans = 3276800  </span><br><span class="line"><span class="comment"># 记录的那些尚未收到客户端确认信息的连接请求的最大值。对于有 128M 内存的系统而言，缺省值是 1024，小内存的系统则是 128</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 262144  </span><br><span class="line"><span class="comment"># 时间戳可以避免序列号的卷绕。一个 1Gbps 的链路肯定会遇到以前用过的序列号。时间戳能够让内核接受这种“异常” 的数据包。这里需要将其关掉</span></span><br><span class="line">net.ipv4.tcp_timestamps = 0  </span><br><span class="line"><span class="comment"># 为了打开对端的连接，内核需要发送一个 SYN 并附带一个回应前面一个 SYN 的 ACK。也就是所谓三次握手中的第二次握手。这个设置决定了内核放弃连接之前发送 SYN+ACK 包的数量</span></span><br><span class="line">net.ipv4.tcp_synack_retries = 1  </span><br><span class="line"><span class="comment"># 在内核放弃建立连接之前发送 SYN 包的数量</span></span><br><span class="line">net.ipv4.tcp_syn_retries = 1  </span><br><span class="line"><span class="comment"># 开启 TCP 连接中 time_wait sockets 的快速回收</span></span><br><span class="line">net.ipv4.tcp_tw_recycle = 1  </span><br><span class="line"><span class="comment"># 开启 TCP 连接复用功能，允许将 time_wait sockets 重新用于新的 TCP 连接（主要针对 time_wait 连接）</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1  </span><br><span class="line"><span class="comment">#1st 低于此值, TCP 没有内存压力, 2nd 进入内存压力阶段, 3rdTCP 拒绝分配 socket(单位：内存页)</span></span><br><span class="line">net.ipv4.tcp_mem = 94500000 915000000 927000000   </span><br><span class="line"><span class="comment"># 如果套接字由本端要求关闭，这个参数决定了它保持在 FIN-WAIT-2 状态的时间。对端可以出错并永远不关闭连接，甚至意外当机。缺省值是 60 秒。2.2 内核的通常值是 180 秒，你可以按这个设置，但要记住的是，即使你的机器是一个轻载的 WEB 服务器，也有因为大量的死套接字而内存溢出的风险，FIN- WAIT-2 的危险性比 FIN-WAIT-1 要小，因为它最多只能吃掉 1.5K 内存，但是它们的生存期长些。</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = 15  </span><br><span class="line"><span class="comment"># 表示当 keepalive 起用的时候，TCP 发送 keepalive 消息的频度（单位：秒）</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = 30  </span><br><span class="line"><span class="comment"># 对外连接端口范围</span></span><br><span class="line">net.ipv4.ip_local_port_range = 2048 65000</span><br><span class="line"><span class="comment"># 表示文件句柄的最大数量</span></span><br><span class="line">fs.file-max = 102400</span><br></pre></td></tr></table></figure><blockquote><p>这是我在实际生产系统自动化部署中用的配置，不做过渡优化</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sysctl settings are defined through files in</span></span><br><span class="line"><span class="comment"># /usr/lib/sysctl.d/, /run/sysctl.d/, and /etc/sysctl.d/.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Vendors settings live in /usr/lib/sysctl.d/.</span></span><br><span class="line"><span class="comment"># To override a whole file, create a new file with the same in</span></span><br><span class="line"><span class="comment"># /etc/sysctl.d/ and put new settings there. To override</span></span><br><span class="line"><span class="comment"># only specific settings, add a file with a lexically later</span></span><br><span class="line"><span class="comment"># name in /etc/sysctl.d/ and put new settings there.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information, see sysctl.conf(5) and sysctl.d(5).</span></span><br><span class="line">vm.dirty_writeback_centisecs=100</span><br><span class="line">vm.dirty_expire_centisecs=100</span><br><span class="line">vm.swappiness=1</span><br><span class="line">net.ipv4.ip_local_port_range=10000    65001</span><br><span class="line">net.ipv4.tcp_max_orphans=4000000</span><br><span class="line">net.ipv4.tcp_timestamps=0</span><br><span class="line">net.core.somaxconn=1024</span><br><span class="line">net.netfilter.nf_conntrack_max=121005752</span><br><span class="line">kernel.core_pattern=/var/coredump/core.%e.%p.%t</span><br></pre></td></tr></table></figure><blockquote><p>最后记得刷新立即生效</p></blockquote><pre><code>/sbin/sysctl -p</code></pre>]]></content>
    
    <summary type="html">
    
      sysctl.conf和limits.conf学习和调优
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>使用 rsyslog 单独保存 iptables log 日志实践</title>
    <link href="https://wsgzao.github.io/post/iptables-log/"/>
    <id>https://wsgzao.github.io/post/iptables-log/</id>
    <published>2019-05-09T06:59:49.000Z</published>
    <updated>2019-05-14T08:52:34.147Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>iptables 作为经典的软件防火墙大家已经很熟悉了，不过各位应该比较少会使用到 log 日志记录保存的功能。这次因为 Ngnix stream 模块的编译和获取 realip(ngx_http_realip_module / ngx_stream_realip_module) 的方案改动成本过高，退而求其次的方式是通过 iptables 做转发，需要解决的问题就是如何保存日志和按时间 rotate。原本计划使用 Filebeat 直接接入 EFK 但因为某些原因暂时搁浅了，最后选择比较简单的 rsyslog 在本地服务器上做处理。</p><blockquote><p>使用 rsyslog 单独保存 iptables log 日志实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 05 月 09 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/iptables-log/">https://wsgzao.github.io/post/iptables-log/</a></p><p><strong> 扩展阅读 </strong></p><p>rsyslog - <a href="https://www.rsyslog.com/guides/" target="_blank" rel="noopener">https://www.rsyslog.com/guides/</a><br>How to Enable Logging in Iptables on Linux - <a href="https://tecadmin.net/enable-logging-in-iptables-on-linux/" target="_blank" rel="noopener">https://tecadmin.net/enable-logging-in-iptables-on-linux/</a></p><hr><h2 id="RedHat-官方教程"><a href="#RedHat-官方教程" class="headerlink" title="RedHat 官方教程"></a>RedHat 官方教程</h2><blockquote><p>How to configure syslog to log the iptables messages to a different log file in Red Hat Enterprise Linux 5/6/7</p></blockquote><h3 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h3><p>Red Hat Enterprise Linux 5<br>Red Hat Enterprise Linux 6<br>Red Hat Enterprise Linux 7<br>syslog</p><h3 id="Issue"><a href="#Issue" class="headerlink" title="Issue"></a>Issue</h3><ul><li>How to modify the iptables rules to let it log at the appropriate level?</li><li>How to configure syslog to log the iptables messages to a different log file?</li><li>To stop iptables messages to get logged into /var/log/messages ?</li></ul><h3 id="Resolution"><a href="#Resolution" class="headerlink" title="Resolution"></a>Resolution</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Make a backup of /etc/syslog.conf before making any changes to it.</span></span><br><span class="line">cp /etc/syslog.conf /etc/syslog.conf.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># Edit /etc/syslog.conf with an editor such as vi and add lines:</span></span><br><span class="line"><span class="comment"># comment iptables log</span></span><br><span class="line">kern.warning                    /var/<span class="built_in">log</span>/iptables</span><br><span class="line"></span><br><span class="line"><span class="comment"># Make sure the iptables rule is logging at the appropriate level. This can be done by using the log-level switch. Default log-level is warning.</span></span><br><span class="line"><span class="comment"># Below example will log ssh attempts:</span></span><br><span class="line">iptables -I INPUT -p tcp --dport 22 -j LOG --<span class="built_in">log</span>-level 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># Note: Log Levels can be found using command:</span></span><br><span class="line">man syslog</span><br><span class="line"></span><br><span class="line"><span class="comment"># Note: Consider adding a prefix to your iptables rule. This makes it easier to separate the firewall message from the few random messages that the kernel puts out. </span></span><br><span class="line"><span class="comment"># Below example use to log ping and add the prefix "#### Firewall ####".</span></span><br><span class="line">iptables -I INPUT -p icmp --icmp-type ping -j LOG --<span class="built_in">log</span>-prefix <span class="string">"#### Firewall ####"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Note:- Follow below steps if iptables print all the logs on the console:-</span></span><br><span class="line"><span class="comment"># Step1:- Add below entry in /etc/sysctl.conf</span></span><br><span class="line">kernel.printk = 4 1 1 7</span><br><span class="line"><span class="comment"># Step2:- Run below command to make changes effectively at runtime.</span></span><br><span class="line">/sbin/sysctl -p /etc/sysctl.conf</span><br><span class="line"><span class="comment"># Step3:- Check the changes at below file.</span></span><br><span class="line">cat /proc/sys/kernel/printk</span><br></pre></td></tr></table></figure><h2 id="个人实践过程"><a href="#个人实践过程" class="headerlink" title="个人实践过程"></a>个人实践过程</h2><h3 id="iptables-防火墙日志"><a href="#iptables-防火墙日志" class="headerlink" title="iptables 防火墙日志"></a>iptables 防火墙日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改防火墙 NAT 表中的 PREROUTING 和 POSTROUTING 链，添加自定义 log-prefix</span></span><br><span class="line">vim /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line">*nat</span><br><span class="line">:PREROUTING ACCEPT [0:0]</span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [0:0]</span><br><span class="line">:POSTROUTING ACCEPT [0:0]</span><br><span class="line">-A PREROUTING -p tcp -d &lt;IP&gt; --dport 443 -j LOG --<span class="built_in">log</span>-prefix seatalk:</span><br><span class="line">-A PREROUTING -p tcp -d &lt;IP&gt; --dport 443 -j DNAT --to-destination 10.71.19.142:443</span><br><span class="line">-A POSTROUTING -j MASQUERADE</span><br><span class="line">COMMIT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 iptables</span></span><br><span class="line">service iptables reload</span><br></pre></td></tr></table></figure><h3 id="配置-rsyslog-读取和保存-iptables-日志"><a href="#配置-rsyslog-读取和保存-iptables-日志" class="headerlink" title="配置 rsyslog 读取和保存 iptables 日志"></a>配置 rsyslog 读取和保存 iptables 日志</h3><p>rsyslog 是一个 syslogd 的多线程增强版。现在 Fedora / RHEL / CentOS / Ubuntu 默认的日志系统都是 rsyslog 了。</p><p>rsyslog 负责写入日志，logrotate 负责备份和删除旧日志，以及更新日志文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 iptables 日志目录 </span></span><br><span class="line">mkdir -p /var/<span class="built_in">log</span>/iptables/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑 rsyslog.conf</span></span><br><span class="line">vim /etc/rsyslog.conf</span><br><span class="line"><span class="comment"># Save iptables log</span></span><br><span class="line">kern.warning /var/<span class="built_in">log</span>/iptables/iptables.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 rsyslog</span></span><br><span class="line">service rsyslog restart</span><br></pre></td></tr></table></figure><h3 id="配置-log-rotate"><a href="#配置-log-rotate" class="headerlink" title="配置 log rotate"></a>配置 log rotate</h3><p>rotate 轮换，日志切换</p><p>logrotate 是一个日志管理程序，用来把旧的日志文件删除（备份），并创建新的日志文件，这个过程称为 “转储”。我们可以根据日志的大小，或者根据其使用的天数来转储。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加 iptables log rotate 策略 </span></span><br><span class="line">vim /etc/logrotate.d/iptables</span><br><span class="line"></span><br><span class="line">/var/<span class="built_in">log</span>/iptables/iptables.log &#123;</span><br><span class="line">        daily</span><br><span class="line">        rotate 7</span><br><span class="line">        compress</span><br><span class="line">        delaycompress</span><br><span class="line">        missingok</span><br><span class="line">        notifempty</span><br><span class="line">        create 0664 root root</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 rsyslog</span></span><br><span class="line">service rsyslog restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这篇文章有更多实例 </span></span><br><span class="line">rsyslog 和 logrotate 服务 - http://xstarcd.github.io/wiki/Linux/rsyslog_logrotate.html</span><br></pre></td></tr></table></figure><h3 id="检查日志输出"><a href="#检查日志输出" class="headerlink" title="检查日志输出"></a>检查日志输出</h3><blockquote><p>如果条件允许建议直接采用 EFK 一步到位</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/<span class="built_in">log</span>/iptables</span><br><span class="line">iptables.log</span><br><span class="line">iptables.log-20190512.gz</span><br><span class="line">iptables.log-20190513</span><br><span class="line"></span><br><span class="line">cat iptables.log</span><br><span class="line"></span><br><span class="line">May 14 15:08:35 &lt;localhost&gt; kernel: IN=em1 OUT= MAC=14:18:77:28:56:59:a0:f8:49:5f:b2:c3:08:00 SRC=&lt;IP&gt; DST=&lt;IP&gt; LEN=60 TOS=0x00 PREC=0x00 TTL=57 ID=43701 DF PROTO=TCP SPT=4150 DPT=443 WINDOW=65535 RES=0x00 SYN URGP=0</span><br><span class="line">May 14 15:09:00 &lt;localhost&gt; kernel: IN=em1 OUT= MAC=14:18:77:28:56:59:00:f8:2c:91:79:43:08:00 SRC=&lt;IP&gt; DST=&lt;IP&gt; LEN=60 TOS=0x00 PREC=0x00 TTL=54 ID=31497 DF PROTO=TCP SPT=43586 DPT=443 WINDOW=65535 RES=0x00 SYN URGP=0</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      使用rsyslog单独保存iptables log日志实践
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>InfluxDB 安装部署</title>
    <link href="https://wsgzao.github.io/post/influxdb/"/>
    <id>https://wsgzao.github.io/post/influxdb/</id>
    <published>2019-04-05T06:59:49.000Z</published>
    <updated>2019-04-08T10:33:58.566Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>InfluxDB 是专为时序数据设计的数据库，能支撑大量的读写负载，是一个高性能的时序数据 datastore。</p><blockquote><p>InfluxDB is the Time Series Database in the TICK Stack</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 04 月 05 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/influxdb/">https://wsgzao.github.io/post/influxdb/</a></p><p><strong> 扩展阅读 </strong></p><p>InfluxDB - <a href="https://www.influxdata.com/time-series-platform/influxdb/" target="_blank" rel="noopener">https://www.influxdata.com/time-series-platform/influxdb/</a></p><hr><h2 id="InfluxDB-简介"><a href="#InfluxDB-简介" class="headerlink" title="InfluxDB 简介"></a>InfluxDB 简介</h2><blockquote><p>InfluxDB is the Time Series Database in the TICK Stack</p></blockquote><p>InfluxData’s TICK Stack is built around InfluxDB to handle massive amounts of time-stamped information. This time series database provides support for your metrics analysis needs, from DevOps Monitoring, IoT Sensor data, and Real-Time Analytics. Users can adapt their SQL skills with InfluxQL, so they can get up to speed on this time series database.</p><p><img src="https://www.influxdata.com/wp-content/uploads/Tick-Stack-InfluxDB-2.png" alt=""></p><p>默认预留端口:</p><p>8086，HTTP API<br>8088，RPC 端口，用于备份和恢复</p><p>NTP 服务:<br>InfluxDB 使用机器本地时间作为 timestamp，需要机器之间使用 NTP 进行同步；如果没有同步的话，写入的时间序列数据可能会不准确</p><h2 id="InfluxDB-安装"><a href="#InfluxDB-安装" class="headerlink" title="InfluxDB 安装"></a>InfluxDB 安装</h2><p>InfluxDB 里存储的数据被称为时间序列数据, InfluxDB 存储方式跟传统关系型数据库不同的是：传统关系型数据库通过数据库 + 表 + 字段组织数据，InfluxDB 通过指标、标签、字段组织数据，时间戳是默认的索引列，标签跟字段其实就相当于关系型数据库中的字段，只不过标签会被索引，而字段不会。</p><p>Grafana 默认支持的数据源：Graphite，InfluxDB，OpenTSDB，Prometheus，Elasticsearch，CloudWatch<br>Grafana 支持同时绑定多套数据源，根据自己需求管理即可，这里以 InfluxDB 为例。</p><p><a href="https://portal.influxdata.com/downloads" target="_blank" rel="noopener">https://portal.influxdata.com/downloads</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install influxdb</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/influxdb.repo &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">[influxdb]</span><br><span class="line">name = InfluxDB Repository - RHEL \<span class="variable">$releasever</span></span><br><span class="line">baseurl = https://repos.influxdata.com/rhel/\<span class="variable">$releasever</span>/\<span class="variable">$basearch</span>/stable</span><br><span class="line">enabled = 1</span><br><span class="line">gpgcheck = 1</span><br><span class="line">gpgkey = https://repos.influxdata.com/influxdb.key</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># yum install influxdb</span></span><br><span class="line">yum install -y influxdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># start and enable influxdb</span></span><br><span class="line">sudo systemctl start influxdb</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> influxdb</span><br><span class="line">sudo systemctl status influxdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 influx 命令进入 cli 命令行 </span></span><br><span class="line">influx</span><br><span class="line">Connected to http://localhost:8086 version 1.4.2</span><br><span class="line">InfluxDB shell version: 1.4.2</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看用户 </span></span><br><span class="line">SHOW USERS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户 </span></span><br><span class="line">CREATE USER influx WITH PASSWORD <span class="string">'influx'</span> WITH ALL PRIVILEGES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看用户 </span></span><br><span class="line">SHOW USERS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库 </span></span><br><span class="line">CREATE DATABASE <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据库 </span></span><br><span class="line">SHOW DATABASES</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using 数据库 </span></span><br><span class="line">USE <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入数据 </span></span><br><span class="line">INSERT cpu,host=192.168.1.1 load=0.1,usage=0.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询所有数据 </span></span><br><span class="line">SELECT * FROM <span class="string">"cpu"</span></span><br><span class="line">SELECT <span class="string">"host"</span>,<span class="string">"load"</span>,<span class="string">"usage"</span> FROM <span class="string">"cpu"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据条件查询 </span></span><br><span class="line">SELECT <span class="string">"host"</span>,<span class="string">"load"</span>,<span class="string">"usage"</span> FROM <span class="string">"cpu"</span> WHERE <span class="string">"host"</span> = <span class="string">'192.168.1.1'</span></span><br><span class="line">SELECT <span class="string">"host"</span>,<span class="string">"load"</span>,<span class="string">"usage"</span> FROM <span class="string">"cpu"</span> WHERE <span class="string">"usage"</span> &gt; 0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库 </span></span><br><span class="line">CREATE DATABASE <span class="string">"db_name"</span></span><br><span class="line"><span class="comment"># 显示所有数据库 </span></span><br><span class="line">SHOW DATABASES</span><br><span class="line"><span class="comment"># 删除数据库 </span></span><br><span class="line">DROP DATABASE <span class="string">"db_name"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用数据库 </span></span><br><span class="line">USE mydb</span><br><span class="line"><span class="comment"># 显示该数据库中的表 </span></span><br><span class="line">SHOW MEASUREMENTS</span><br><span class="line"><span class="comment"># 删除表 </span></span><br><span class="line">DROP MEASUREMENT <span class="string">"t_name"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库 API</span></span><br><span class="line">curl -i -XPOST http://localhost:8086/query --data-urlencode <span class="string">"q=CREATE DATABASE test"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入数据 API</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入单条 </span></span><br><span class="line">curl -i -XPOST http://localhost:8086/write?db=<span class="built_in">test</span> --data-binary <span class="string">"cpu,host=192.168.1.3 load=0.1,usage=0.33"</span></span><br><span class="line">curl -i -XPOST http://localhost:8086/write?db=<span class="built_in">test</span> --data-binary <span class="string">"cpu,host=192.168.1.3 load=0.1,usage=0.33 6666666666666666666"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入多条 </span></span><br><span class="line">curl -i -XPOST http://localhost:8086/write?db=<span class="built_in">test</span> --data-binary <span class="string">"cpu,host=192.168.1.2 load=0.1,usage=0.22 1666666666666666661 </span></span><br><span class="line"><span class="string">cpu,host=192.168.1.3 load=0.1,usage=0.33 1666666666666666661 </span></span><br><span class="line"><span class="string">cpu,host=192.168.1.2 load=0.2,usage=0.22 1666666666666666662 </span></span><br><span class="line"><span class="string">cpu,host=192.168.1.3 load=0.2,usage=0.33 1666666666666666662"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询数据 API</span></span><br><span class="line">curl -G http://localhost:8086/query?db=<span class="built_in">test</span> --data-urlencode <span class="string">"q=SELECT * FROM  \"cpu\""</span></span><br></pre></td></tr></table></figure><h2 id="InfluxDB-配置优化"><a href="#InfluxDB-配置优化" class="headerlink" title="InfluxDB 配置优化"></a>InfluxDB 配置优化</h2><p>配置文件默认全部注释掉，使用默认的配置项，可以根据需要配置。每个配置项有对应的、相同功能的环境变量。</p><p>配置文件：/etc/influxdb/influxdb.conf</p><p>查看配置：influxd config</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[meta]                                <span class="comment"># 元数据 </span></span><br><span class="line">dir = /var/lib/influxdb/meta  </span><br><span class="line"></span><br><span class="line">[data]                                <span class="comment"># 数据 / WAL</span></span><br><span class="line">dir = /var/lib/influxdb/data  </span><br><span class="line">wal-dir = /var/lib/influxdb/wal  </span><br><span class="line">cache-max-memory-size = <span class="string">"1g"</span>          <span class="comment"># Cache 最大可用内存 </span></span><br><span class="line"></span><br><span class="line">[coordinator]                         <span class="comment"># 查询相关 </span></span><br><span class="line">query-timeout = <span class="string">"0s"</span>                  <span class="comment"># 查询最大执行时间  </span></span><br><span class="line"><span class="built_in">log</span>-queries-after = <span class="string">"0s"</span>              <span class="comment"># 打印慢查询 </span></span><br><span class="line"></span><br><span class="line">[http]           <span class="comment"># HTTP 服务 </span></span><br><span class="line">auth-enabled = <span class="literal">false</span>                  <span class="comment"># 启用安全认证  </span></span><br><span class="line">max-connection-limit = 0              <span class="comment"># 最大连接数 </span></span><br></pre></td></tr></table></figure><p>更多帮助信息请参考官网<br>InfluxDB documentation - <a href="https://docs.influxdata.com/platform/introduction" target="_blank" rel="noopener">https://docs.influxdata.com/platform/introduction</a></p>]]></content>
    
    <summary type="html">
    
      InfluxDB is the Time Series Database in the TICK Stack
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Prometheus 监控 Nginx</title>
    <link href="https://wsgzao.github.io/post/prometheus-nginx/"/>
    <id>https://wsgzao.github.io/post/prometheus-nginx/</id>
    <published>2019-03-25T06:59:49.000Z</published>
    <updated>2019-03-28T09:29:34.462Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Nginx 官网有介绍各种监控方案，以前我们常用 stub_status 和 Log 日志来实现 Nginx 监控。本文主要介绍基于 Prometheus 的 2 种监控方案 nginx-lua-prometheus 和 nginx-vts-exporter，在真实的生产环境中你可能需要研究和选择哪种方法才是适合你的，F5 收购 Nginx 后的未来让我们一起拭目以待。</p><blockquote><p>Prometheus 监控 Nginx</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 03 月 25 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/prometheus-nginx/">https://wsgzao.github.io/post/prometheus-nginx/</a></p><p><strong> 扩展阅读 </strong></p><p>Monitoring NGINX - <a href="https://www.nginx.com/blog/monitoring-nginx/" target="_blank" rel="noopener">https://www.nginx.com/blog/monitoring-nginx/</a></p><hr><h2 id="Nginx-监控"><a href="#Nginx-监控" class="headerlink" title="Nginx 监控"></a>Nginx 监控</h2><p>官网介绍的监控方案 - <a href="https://www.nginx.com/blog/monitoring-nginx/" target="_blank" rel="noopener">https://www.nginx.com/blog/monitoring-nginx/</a></p><p>Prometheus 集成的 HTTP exporter 方案 - <a href="https://prometheus.io/docs/instrumenting/exporters/#http" target="_blank" rel="noopener">https://prometheus.io/docs/instrumenting/exporters/#http</a></p><p>聊聊 Nginx 的监控 - <a href="https://zhuanlan.zhihu.com/p/34050716" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/34050716</a></p><p>使用 rpmbuild 制作 Nginx 的 RPM 包 - <a href="https://wsgzao.github.io/post/rpmbuild/">https://wsgzao.github.io/post/rpmbuild/</a></p><h2 id="Prometheus-监控-Nginx"><a href="#Prometheus-监控-Nginx" class="headerlink" title="Prometheus 监控 Nginx"></a>Prometheus 监控 Nginx</h2><h3 id="nginx-lua-prometheus"><a href="#nginx-lua-prometheus" class="headerlink" title="nginx-lua-prometheus"></a>nginx-lua-prometheus</h3><blockquote><p>Nginx 需要添加 Lua 扩展</p></blockquote><p><a href="https://github.com/knyar/nginx-lua-prometheus" target="_blank" rel="noopener">https://github.com/knyar/nginx-lua-prometheus</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 redis_exporter</span></span><br><span class="line">https://github.com/knyar/nginx-lua-prometheus/releases</span><br><span class="line">wget https://github.com/knyar/nginx-lua-prometheus/archive/0.20181120.tar.gz</span><br><span class="line">tar xf 0.20181120.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nginx-lua-prometheus-0.20181120</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 prometheus.lua 目录 </span></span><br><span class="line">mkdir -p /etc/nginx/lua/</span><br><span class="line">cp prometheus.lua /etc/nginx/lua/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑 nginx 配置文件修改，注意修改 lua_package_path "/etc/nginx/lua/prometheus.lua";</span></span><br><span class="line">vim /etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">lua_shared_dict prometheus_metrics 10M;</span><br><span class="line">lua_package_path <span class="string">"/etc/nginx/lua/prometheus.lua"</span>;</span><br><span class="line">init_by_lua <span class="string">'</span></span><br><span class="line"><span class="string">  prometheus = require("prometheus").init("prometheus_metrics")</span></span><br><span class="line"><span class="string">  metric_requests = prometheus:counter(</span></span><br><span class="line"><span class="string">"nginx_http_requests_total","Number of HTTP requests", &#123;"host","status"&#125;)</span></span><br><span class="line"><span class="string">  metric_latency = prometheus:histogram(</span></span><br><span class="line"><span class="string">"nginx_http_request_duration_seconds","HTTP request latency", &#123;"host"&#125;)</span></span><br><span class="line"><span class="string">  metric_connections = prometheus:gauge(</span></span><br><span class="line"><span class="string">"nginx_http_connections","Number of HTTP connections", &#123;"state"&#125;)</span></span><br><span class="line"><span class="string">'</span>;</span><br><span class="line">log_by_lua <span class="string">'</span></span><br><span class="line"><span class="string">  metric_requests:inc(1, &#123;ngx.var.server_name, ngx.var.status&#125;)</span></span><br><span class="line"><span class="string">  metric_latency:observe(tonumber(ngx.var.request_time), &#123;ngx.var.server_name&#125;)</span></span><br><span class="line"><span class="string">'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 nginx-lua-prometheus</span></span><br><span class="line">vim /etc/nginx/sites-available/nginx-lua-prometheus</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 9145;</span><br><span class="line">  location /metrics &#123;</span><br><span class="line">    content_by_lua <span class="string">'</span></span><br><span class="line"><span class="string">      metric_connections:set(ngx.var.connections_reading, &#123;"reading"&#125;)</span></span><br><span class="line"><span class="string">      metric_connections:set(ngx.var.connections_waiting, &#123;"waiting"&#125;)</span></span><br><span class="line"><span class="string">      metric_connections:set(ngx.var.connections_writing, &#123;"writing"&#125;)</span></span><br><span class="line"><span class="string">      prometheus:collect()</span></span><br><span class="line"><span class="string">'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建软链接 </span></span><br><span class="line"><span class="built_in">cd</span> /etc/nginx/sites-enabled/</span><br><span class="line">ln -s ../sites-available/nginx-lua-prometheus</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 Nginx 语法并 reload 测试 metrics</span></span><br><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br><span class="line">curl http://127.0.0.1:9145/metrics</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables rule for Prometheus Nginx </span></span><br><span class="line">-A INPUT -s xxx -p tcp --dport 9145 -j ACCEPT</span><br></pre></td></tr></table></figure><h3 id="nginx-vts-exporter"><a href="#nginx-vts-exporter" class="headerlink" title="nginx-vts-exporter"></a>nginx-vts-exporter</h3><p><a href="https://github.com/hnlq715/nginx-vts-exporter" target="_blank" rel="noopener">https://github.com/hnlq715/nginx-vts-exporter</a></p><p>对方正在输入中</p><h2 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h2><h3 id="nginx-lua-prometheus-1"><a href="#nginx-lua-prometheus-1" class="headerlink" title="nginx-lua-prometheus"></a>nginx-lua-prometheus</h3><p><a href="https://grafana.com/dashboards/462" target="_blank" rel="noopener">https://grafana.com/dashboards/462</a></p><h3 id="nginx-vts-exporter-1"><a href="#nginx-vts-exporter-1" class="headerlink" title="nginx-vts-exporter"></a>nginx-vts-exporter</h3><p><a href="https://grafana.com/dashboards/2949" target="_blank" rel="noopener">https://grafana.com/dashboards/2949</a></p><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a href="https://prometheus.io/docs/instrumenting/exporters/#http" target="_blank" rel="noopener">https://prometheus.io/docs/instrumenting/exporters/#http</a></p>]]></content>
    
    <summary type="html">
    
      Prometheus 监控 Nginx
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Prometheus 监控 Redis</title>
    <link href="https://wsgzao.github.io/post/prometheus-redis/"/>
    <id>https://wsgzao.github.io/post/prometheus-redis/</id>
    <published>2019-03-23T06:59:49.000Z</published>
    <updated>2019-03-26T11:19:08.142Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Prometheus Exporter for Redis Metrics. Supports Redis 2.x, 3.x, 4.x, and 5.x</p><blockquote><p>Prometheus 监控 Redis</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 03 月 23 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/prometheus-redis/">https://wsgzao.github.io/post/prometheus-redis/</a></p><p><strong> 扩展阅读 </strong></p><p>redis_exporter - <a href="https://github.com/oliver006/redis_exporter" target="_blank" rel="noopener">https://github.com/oliver006/redis_exporter</a></p><hr><h2 id="Redis-export-安装和使用"><a href="#Redis-export-安装和使用" class="headerlink" title="Redis export 安装和使用"></a>Redis export 安装和使用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 redis_exporter</span></span><br><span class="line">https://github.com/oliver006/redis_exporter/releases</span><br><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">wget https://github.com/oliver006/redis_exporter/releases/download/v0.30.0/redis_exporter-v0.30.0.linux-amd64.tar.gz </span><br><span class="line">tar xf redis_exporter-v0.30.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后台启动 redis_exporter</span></span><br><span class="line">nohup ./redis_exporter -redis.addr redis://&lt;IP&gt;:&lt;PORT&gt; &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables rule for Prometheus Redis </span></span><br><span class="line">-A INPUT -s xxx -p tcp --dport 9121 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 URL 获取 metrics</span></span><br><span class="line">curl http://&lt;IP&gt;:9121/metrics</span><br></pre></td></tr></table></figure><h2 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h2><blockquote><p>Memory Usage 中 redis_config_maxmemory 如果无法获取到数据请自行定义 value</p></blockquote><p><a href="https://grafana.com/dashboards/763" target="_blank" rel="noopener">https://grafana.com/dashboards/763</a></p><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a href="https://prometheus.io/docs/instrumenting/exporters/#databases" target="_blank" rel="noopener">https://prometheus.io/docs/instrumenting/exporters/#databases</a></p>]]></content>
    
    <summary type="html">
    
      Prometheus 监控 Redis
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>MacBook macOS 从小白到入门</title>
    <link href="https://wsgzao.github.io/post/macbook/"/>
    <id>https://wsgzao.github.io/post/macbook/</id>
    <published>2019-03-16T08:59:49.000Z</published>
    <updated>2019-04-04T03:07:38.532Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><img src="https://i.v2ex.co/y2JB0IAD.png" alt=""></p><p>这里做下 MacBook macOS 从小白到入门的持续更新记录</p><blockquote><p>MacBook macOS 从小白到入门</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 03 月 16 日 - 更新 macOS vim 语法高亮的设置方法<br>2019 年 02 月 28 日 - 更新 Mac 开启关闭 SIP<br>2019 年 01 月 24 日 - 增加开启 HiDPI 和解决黑屏问题<br>2018 年 10 月 19 日 - 更新升级 macOS Mojave 后的各种小问题解决方法<br>2018 年 07 月 25 日 - 补充细节<br>2018 年 07 月 05 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/macbook/">https://wsgzao.github.io/post/macbook/</a></p><p><strong> 扩展阅读 </strong></p><p>Awesome Mac - <a href="http://wangchujiang.com/awesome-mac/index.zh.html" target="_blank" rel="noopener">http://wangchujiang.com/awesome-mac/index.zh.html</a><br>BestApp - <a href="https://github.com/hzlzh/Best-App" target="_blank" rel="noopener">https://github.com/hzlzh/Best-App</a></p><hr><h2 id="System-Preferences"><a href="#System-Preferences" class="headerlink" title="System Preferences"></a>System Preferences</h2><blockquote><p>在任何的操作系统中，首先你需要做一件事就是更新系统，点击窗口左上角的  &gt; 关于本机 &gt; 软件更新 。此外，如果这是一部新的电脑，你还需要到系统设置进行一些适当调整。如何调整，取决于个人喜好。</p></blockquote><h3 id="触控板"><a href="#触控板" class="headerlink" title="触控板"></a>触控板</h3><p>系统设置 &gt; 触控板</p><p>光标与点击</p><ul><li>轻拍来点按</li><li>辅助点按</li><li>查找</li><li>三指拖移</li></ul><p>滚动缩放</p><ul><li>默认全选</li></ul><p>更多手势</p><ul><li>默认全选</li></ul><h3 id="Dock"><a href="#Dock" class="headerlink" title="Dock"></a>Dock</h3><p>置于屏幕上的位置：左边<br>设置 Dock 图标更小（大小随个人喜好）</p><ul><li>自动显示和隐藏 Dock</li></ul><h3 id="Finder"><a href="#Finder" class="headerlink" title="Finder"></a>Finder</h3><p>Finder &gt; 显示</p><ul><li>显示标签页栏</li><li>显示路径栏</li><li>显示状态栏</li><li>自定工具栏 &gt; 去除所有按钮，仅剩搜索栏</li></ul><p>Finder &gt; 偏好设置</p><p>通用</p><ul><li>开启新 Finder 窗口时打开：HOME「用户名」目录</li></ul><p>边栏</p><ul><li>添加 HOME「用户名」目录 和 创建代码文件目录</li><li>将 共享的(shared) 和 标记(tags) 目录去掉</li></ul><h3 id="菜单栏"><a href="#菜单栏" class="headerlink" title="菜单栏"></a>菜单栏</h3><ul><li>去掉蓝牙等无需经常使用的图标</li><li>将电池显示设置为百分比</li></ul><h3 id="Spotlight"><a href="#Spotlight" class="headerlink" title="Spotlight"></a>Spotlight</h3><ul><li>去掉字体和书签与历史记录等不需要的内容</li><li>设置合适的快捷键</li></ul><h3 id="互联网帐户"><a href="#互联网帐户" class="headerlink" title="互联网帐户"></a>互联网帐户</h3><ul><li>添加 iCloud 用户，同步日历，联系人和 Find my mac 等等</li></ul><h3 id="English"><a href="#English" class="headerlink" title="English"></a>English</h3><p>Trackpad</p><ul><li>Tap to click</li></ul><p>Accessibility -&gt; Mouse &amp; Trackpad -&gt; Trackpad Options</p><ul><li>Enable dragging | three finger drag</li></ul><p>Language &amp; Region</p><ul><li>Time format | 24-Hour Time</li><li>click add button | Chinese, Simplified</li></ul><p>Language &amp; Region -&gt; Keyboard Preferences -&gt; Shortcuts -&gt; Input Sources</p><ul><li>Select the previous input source</li></ul><p>Display -&gt; Arrangement</p><ul><li>Drag the graphics and just make what you want</li><li>if the display rotates 90 degrees then change Rotation to 90° or 270° and click confirm button to save</li></ul><h2 id="Mac-键盘快捷键"><a href="#Mac-键盘快捷键" class="headerlink" title="Mac 键盘快捷键"></a>Mac 键盘快捷键</h2><p><img src="https://ww2.sinaimg.cn/large/7207510dgw1evep6dhkflj20tx0m2dms.jpg" alt=""></p><table><thead><tr><th style="text-align:center">Symbol</th><th style="text-align:center">Key</th></tr></thead><tbody><tr><td style="text-align:center">&#8984;</td><td style="text-align:center">Command Key</td></tr><tr><td style="text-align:center">&#8963;</td><td style="text-align:center">Control Key</td></tr><tr><td style="text-align:center">&#8997;</td><td style="text-align:center">Option Key</td></tr><tr><td style="text-align:center">&#8679;</td><td style="text-align:center">Shift Key</td></tr></tbody></table><blockquote><p>我自己常用的快捷键</p></blockquote><table><thead><tr><th>快捷键</th><th>描述</th></tr></thead><tbody><tr><td>Command(⌘)-C</td><td>复制</td></tr><tr><td>Command(⌘)-V</td><td>粘贴</td></tr><tr><td>Command(⌘)-Z</td><td>撤销</td></tr><tr><td>Command(⌘)-Option-V</td><td>剪切粘贴</td></tr><tr><td>Command(⌘)-A</td><td>全选</td></tr><tr><td>Command(⌘)-F</td><td>查找</td></tr><tr><td>Command(⌘)-S</td><td>保存</td></tr><tr><td>Command(⌘)-W</td><td>关闭当前窗口</td></tr><tr><td>Command(⌘)- 空格键</td><td>聚焦</td></tr><tr><td>Command(⌘)- 方向左键</td><td>后退</td></tr><tr><td>Command(⌘)- 方向右键</td><td>前进</td></tr><tr><td>Control-A</td><td>移至行或段落的开头</td></tr><tr><td>Control-E</td><td>移至行或段落的末尾</td></tr><tr><td>Control - 空格键</td><td>切换输入法（需要手动设置）</td></tr><tr><td>Control-Command-Q</td><td>系统自带锁屏快捷键</td></tr><tr><td>Option-Command-C</td><td>复制文件路径，当然也可以直接拖拽到命令行</td></tr></tbody></table><p><a href="https://support.apple.com/zh-cn/HT201236" target="_blank" rel="noopener">https://support.apple.com/zh-cn/HT201236</a></p><h2 id="Mac-Soft"><a href="#Mac-Soft" class="headerlink" title="Mac Soft"></a>Mac Soft</h2><p>Homebrew - Mac 下必备的包管理工具<br><a href="https://brew.sh/" target="_blank" rel="noopener">https://brew.sh/</a></p><p>Alfred - Mac 下被无数人安利的效率工具，虽然我觉得 Spotlight 暂时够用了<br><a href="https://www.alfredapp.com/" target="_blank" rel="noopener">https://www.alfredapp.com/</a></p><p>Mounty for NTFS - 免费的 NTFS 支持软件<br><a href="http://enjoygineering.com/mounty/" target="_blank" rel="noopener">http://enjoygineering.com/mounty/</a></p><p>Sougou Input - 陪伴大家多年的搜狗输入法<br><a href="https://pinyin.sogou.com/mac/" target="_blank" rel="noopener">https://pinyin.sogou.com/mac/</a></p><p>Youdao Dict - 网易开发的老牌翻译工具<br><a href="http://cidian.youdao.com/index-mac.html" target="_blank" rel="noopener">http://cidian.youdao.com/index-mac.html</a></p><p>Jietu - 腾讯开发的截图工具，其实可以使用 QQ 或者微信快捷键<br><a href="http://jietu.qq.com/" target="_blank" rel="noopener">http://jietu.qq.com/</a></p><p>Kantu - 腾讯开发的看图工具<br><a href="https://kantu.qq.com/" target="_blank" rel="noopener">https://kantu.qq.com/</a></p><p>f.lux - Mac 和 Windows 都必备的护眼亮度调整工具<br><a href="https://justgetflux.com/" target="_blank" rel="noopener">https://justgetflux.com/</a></p><p>Foxit Reader - 国内福昕开发的免费 PDF 阅读器<br><a href="https://www.foxitsoftware.com/pdf-reader/" target="_blank" rel="noopener">https://www.foxitsoftware.com/pdf-reader/</a></p><p>Clearview - 支持 PDF, EPUB, CHM, MOBI 的免费阅读器<br><a href="https://itunes.apple.com/app/clearview/id557090104?mt=12&amp;ls=1" target="_blank" rel="noopener">https://itunes.apple.com/app/clearview/id557090104?mt=12&amp;ls=1</a></p><p>Evernote - 轻量级的在线笔记类应用内<br><a href="https://evernote.com/" target="_blank" rel="noopener">https://evernote.com/</a></p><p>Dropbox - 最佳的实时同步工具之一<br><a href="https://www.dropbox.com/" target="_blank" rel="noopener">https://www.dropbox.com/</a></p><p>Keka - 国外开源的免费压缩解压缩工具<br><a href="https://www.keka.io/en/" target="_blank" rel="noopener">https://www.keka.io/en/</a></p><p>Mac 迅雷 - 支持协议多广告也多<br><a href="http://mac.xunlei.com/" target="_blank" rel="noopener">http://mac.xunlei.com/</a></p><p>百度网盘 - 国内的网盘共享基本只剩下百度一家独大了<br><a href="https://pan.baidu.com/" target="_blank" rel="noopener">https://pan.baidu.com/</a></p><p>FOLX - 用来代替迅雷的免费下载工具<br><a href="https://mac.eltima.com/download-manager.html" target="_blank" rel="noopener">https://mac.eltima.com/download-manager.html</a></p><p>IINA - 国人编写的开源视频播放器<br><a href="https://lhc70000.github.io/iina/" target="_blank" rel="noopener">https://lhc70000.github.io/iina/</a></p><p>Clipy - 记录多条粘贴板小工具<br><a href="https://github.com/Clipy/Clipy" target="_blank" rel="noopener">https://github.com/Clipy/Clipy</a></p><p>Spectacle - 快速调整程序窗口位置的效率工具<br><a href="https://www.spectacleapp.com/" target="_blank" rel="noopener">https://www.spectacleapp.com/</a></p><p>Proxyee Down - Mac 下百度网盘下载神器<br><a href="https://github.com/proxyee-down-org/proxyee-down" target="_blank" rel="noopener">https://github.com/proxyee-down-org/proxyee-down</a></p><p>Sourcetree - 图形化 Git 管理工具<br><a href="https://www.sourcetreeapp.com/" target="_blank" rel="noopener">https://www.sourcetreeapp.com/</a></p><p>Microsoft Remote Desktop - Mac 下的微软 RDP 远程桌面登录工具<br><a href="https://itunes.apple.com/us/app/microsoft-remote-desktop-10/id1295203466?mt=12" target="_blank" rel="noopener">https://itunes.apple.com/us/app/microsoft-remote-desktop-10/id1295203466?mt=12</a></p><p>VirtualBox - 免费的虚拟机工具<br><a href="http://www.oracle.com/technetwork/server-storage/virtualbox/downloads/index.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/server-storage/virtualbox/downloads/index.html</a></p><p>PostMan - 免费强大的 HTTP 调试工具<br><a href="https://www.getpostman.com/" target="_blank" rel="noopener">https://www.getpostman.com/</a></p><p>VMware OS Optimization Tool - VMware 开发的 Windows 虚拟机优化工具<br><a href="https://labs.vmware.com/flings/vmware-os-optimization-tool" target="_blank" rel="noopener">https://labs.vmware.com/flings/vmware-os-optimization-tool</a></p><h3 id="Homebrew"><a href="#Homebrew" class="headerlink" title="Homebrew"></a>Homebrew</h3><p><a href="https://docs.brew.sh/Installation" target="_blank" rel="noopener">https://docs.brew.sh/Installation</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install xcode first</span></span><br><span class="line">https://itunes.apple.com/us/app/xcode/id497799835</span><br><span class="line"></span><br><span class="line"><span class="comment"># install homebrew</span></span><br><span class="line">/usr/bin/ruby -e <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install packages</span></span><br><span class="line">brew tap dteoh/sqa</span><br><span class="line">brew install zsh</span><br><span class="line">brew install wget</span><br><span class="line">brew install git</span><br><span class="line"><span class="comment"># default install is python3 now, if you need python2 just run `brew install python2`</span></span><br><span class="line">brew install python</span><br></pre></td></tr></table></figure><h3 id="iTerm2-zsh-Oh-My-Zsh"><a href="#iTerm2-zsh-Oh-My-Zsh" class="headerlink" title="iTerm2 + zsh + Oh My Zsh"></a>iTerm2 + zsh + Oh My Zsh</h3><p>iTerm2<br><a href="https://www.iterm2.com/" target="_blank" rel="noopener">https://www.iterm2.com/</a></p><p>Oh My Zsh<br><a href="http://ohmyz.sh/" target="_blank" rel="noopener">http://ohmyz.sh/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install latest zsh zsh-syntax-highlighting</span></span><br><span class="line">brew install zsh zsh-syntax-highlighting</span><br><span class="line"><span class="comment"># 修改默认 shell，在 /etc/shells 文件中加入如下一行</span></span><br><span class="line">vi /etc/shells</span><br><span class="line"></span><br><span class="line">/usr/<span class="built_in">local</span>/bin/zsh</span><br><span class="line"><span class="comment"># 然后运行命令切换 shell</span></span><br><span class="line">chsh -s /usr/<span class="built_in">local</span>/bin/zsh</span><br><span class="line"></span><br><span class="line"><span class="comment"># install oh-my-zsh</span></span><br><span class="line">sh -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改主题为 agnoster，增加一行 zsh-syntax-highlighting</span></span><br><span class="line">vi ~/.zshrc</span><br><span class="line"></span><br><span class="line">ZSH_THEME=<span class="string">"agnoster"</span></span><br><span class="line"><span class="built_in">source</span> /usr/<span class="built_in">local</span>/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选增加 visual studio code 命令行 code 支持 zsh</span></span><br><span class="line"><span class="keyword">function</span> code &#123;</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$#</span> = 0 ]]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        open -a <span class="string">"Visual Studio Code"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">local</span> argPath=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">        [[ <span class="variable">$1</span> = /* ]] &amp;&amp; argPath=<span class="string">"<span class="variable">$1</span>"</span> || argPath=<span class="string">"<span class="variable">$PWD</span>/<span class="variable">$&#123;1#./&#125;</span>"</span></span><br><span class="line">        open -a <span class="string">"Visual Studio Code"</span> <span class="string">"<span class="variable">$argPath</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决 Too many files open error</span></span><br><span class="line"><span class="built_in">ulimit</span> -n 10000</span><br><span class="line"><span class="built_in">ulimit</span> -u 2048</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新环境变量</span></span><br><span class="line"><span class="built_in">source</span> ~/.zshrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 powerline 字体</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/powerline/fonts.git</span><br><span class="line"><span class="built_in">cd</span> fonts</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure><blockquote><p>配置 iTerm2 主题，主题可以从 iterm2colorschemes 下载</p></blockquote><p><a href="https://iterm2colorschemes.com/" target="_blank" rel="noopener">https://iterm2colorschemes.com/</a></p><ol><li>Download iTerm2 color you like</li><li>Open iTerm2 that we already downloaded at the first section</li><li>Go to iTerm2 &gt; Preferences &gt; Profiles &gt; Colors Tab</li><li>Click Color Presets at the bottom right</li><li>Click Import</li><li>Select the *.itermcolors file</li><li>Select the * from Load Presets</li></ol><p>在 Keys -&gt; Hotkey 中设置 <code>command + i</code> 快速显示和隐藏 iTerm<br>在 Profiles -&gt; Default -&gt; Colors -&gt; Load Presets 导入主题，作为默认颜色，我的主题是 <code>3024 Night</code><br>在 Profiles -&gt; Text -&gt; Change Font 调整字体 / 大小 / 颜色等，我的字体是 <code>18pt Ubuntu Mono derivative Powerline</code></p><p>macOS 使用笔记：终端配置 - <a href="http://lizhiqiang.me/mac_terminal/" target="_blank" rel="noopener">http://lizhiqiang.me/mac_terminal/</a><br>打造 Mac 下高颜值好用的终端环境 - <a href="https://blog.biezhi.me/2018/11/build-a-beautiful-mac-terminal-environment.html" target="_blank" rel="noopener">https://blog.biezhi.me/2018/11/build-a-beautiful-mac-terminal-environment.html</a></p><blockquote><p>macOS vim 语法高亮的设置方法</p></blockquote><p>打开 terminal 复制 /usr/share/vim/vimrc 到家目录下并重命名为 “.vimrc”, 然后编辑该文件，增加以下几行：</p><p>VimConfig - <a href="https://vimconfig.com/" target="_blank" rel="noopener">https://vimconfig.com/</a><br>My .vimrc - <a href="https://chrisyeh96.github.io/2017/12/18/vimrc.html" target="_blank" rel="noopener">https://chrisyeh96.github.io/2017/12/18/vimrc.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/share/vim/vimrc ~/.vimrc</span><br><span class="line"><span class="built_in">set</span> ai                  <span class="string">"auto indenting</span></span><br><span class="line"><span class="string">set ruler"</span> show the cursor position</span><br><span class="line"><span class="built_in">set</span> hlsearch            <span class="string">"highlight the last searched term</span></span><br><span class="line"><span class="string">set history=1000"</span> keep 1000 lines of <span class="built_in">history</span></span><br><span class="line">syntax on               <span class="string">"syntax highlighting</span></span><br><span class="line"><span class="string">filetype plugin on"</span> use the file <span class="built_in">type</span> plugins</span><br></pre></td></tr></table></figure><h2 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h2><p><img src="http://wx4.sinaimg.cn/large/7207510dgy1fxgwknz69qg20jg0b5hdz.gif" alt=""></p><h3 id="升级-macOS-Mojave-新版卡顿黑屏和字体发虚解决方案"><a href="#升级-macOS-Mojave-新版卡顿黑屏和字体发虚解决方案" class="headerlink" title="升级 macOS Mojave 新版卡顿黑屏和字体发虚解决方案"></a>升级 macOS Mojave 新版卡顿黑屏和字体发虚解决方案</h3><blockquote><p>输入文字卡顿</p></blockquote><p>如果你的 Mac 已经更新至 macOS Mojave，在输入文字时经常卡顿，频繁出现小风车，那很有可能是搜狗输入法造成的，只需将它升级至最新的 4.8.0 版本，即可完美解决。</p><blockquote><p>字体发虚</p></blockquote><p>升级 macOS Mojave 新系统后，苹果默认关闭了子像素抗锯齿，导致字体变细锯齿增多。<br>解决字体渲染过细，打开终端，输入：</p><pre><code>defaults write -g CGFontRenderingFontSmoothingDisabled -bool NO</code></pre><p>重启应用比如 VS Code 后即可看到效果</p><blockquote><p>开启 HiDPI</p></blockquote><p>如果外接显示器字体模糊，可以使用 Scale Resolutions<br>Display Override PropertyList File Parser and Generator with HiDPI support</p><p><a href="https://comsysto.github.io/Display-Override-PropertyList-File-Parser-and-Generator-with-HiDPI-Support-For-Scaled-Resolutions/" target="_blank" rel="noopener">https://comsysto.github.io/Display-Override-PropertyList-File-Parser-and-Generator-with-HiDPI-Support-For-Scaled-Resolutions/</a></p><p>Enable HiDPI on OS X - <a href="https://github.com/syscl/Enable-HiDPI-OSX" target="_blank" rel="noopener">https://github.com/syscl/Enable-HiDPI-OSX</a></p><blockquote><p>解决唤醒时黑屏只看见鼠标的问题</p></blockquote><p>先关机，然后开机快速同时点击 Command + S 按键进入 single-user 单用户模式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/sbin/fsck -fy</span><br><span class="line">/sbin/mount -uw /</span><br><span class="line">rm -f /Library/Preferences/com.apple.loginwindow.plist</span><br><span class="line">rm -f /var/db/.AppleUpgrade</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><h3 id="解决-Command-Q-经常误按"><a href="#解决-Command-Q-经常误按" class="headerlink" title="解决 Command+Q 经常误按"></a>解决 Command+Q 经常误按</h3><p>Slow Quit Apps</p><p>A macOS app that adds a global delay of 1 second to the Cmd-Q shortcut. In other words, you have to hold down Cmd-Q for 1 second before an application will quit.</p><p>When the delay is active, an overlay is drawn at the center of the screen.</p><p><a href="https://github.com/dteoh/SlowQuitApps" target="_blank" rel="noopener">https://github.com/dteoh/SlowQuitApps</a></p><p>brew cask install slowquitapps</p><p>运行程序按照提示授权后重启应用并设置开机自启动即可享受 1s 延迟关闭提醒，如果觉得时间不够长可以自己设定</p><h3 id="提示应用程序被破坏无法打开"><a href="#提示应用程序被破坏无法打开" class="headerlink" title="提示应用程序被破坏无法打开"></a>提示应用程序被破坏无法打开</h3><blockquote><p>SOLVED: “Application” is damaged and can’t be opened in macOS Sierra</p></blockquote><pre><code>sudo spctl --master-disable</code></pre><p>输入密码重新打开 System Preferences &gt; Security &amp; Privacy &gt; General 即可看到之前隐藏的“Anywhere”<br><a href="https://www.santoshsrinivas.com/disable-gatekeeper-in-macos-sierra/" target="_blank" rel="noopener">https://www.santoshsrinivas.com/disable-gatekeeper-in-macos-sierra/</a></p><blockquote><p>macOS High Seirra 提示 “已损坏，打不开，您应该将它移至垃圾篓”</p></blockquote><p>这是因为在系统偏好设置的 “安全性与隐私” 里面的 “允许从以下位置下载的应用” 没有选中“任何来源”，解决方法如下：</p><ol><li>打开终端，然后输入以下命令：sudo spctl –master-disable</li><li>然后回车，输入系统密码并回车（这里输入密码不会显示，输完密码直接回车即可），如果没有提示即操作成功。</li><li>打开系统偏好设置的 “安全性与隐私”，查看“允许从以下位置下载的应用” 是否选中的是“任何来源”，如果选中说明操作成功。这时再打开软件安装就没有已损坏的提示的了。</li></ol><h3 id="Mac-开启关闭-SIP"><a href="#Mac-开启关闭-SIP" class="headerlink" title="Mac 开启关闭 SIP"></a>Mac 开启关闭 SIP</h3><p>S1. 查看 SIP 状态<br>在终端中输入 csrutil status，就可以看到是 enabled 还是 disabled。</p><p>S2. 关闭 SIP</p><ol><li>重启 MAC，按住 cmd+R 直到屏幕上出现苹果的标志和进度条，进入 Recovery 模式；</li><li>在屏幕最上方的工具栏找到实用工具（左数第 3 个），打开终端，输入：csrutil disable；</li><li>关掉终端，重启 mac；</li><li>重启以后可以在终端中查看状态确认。</li></ol><p>S3. 开启 SIP<br>与关闭的步骤类似，只是在 S2 中输入 csrutil enable 即可。</p><h3 id="更改-Apple-ID-国家或地区"><a href="#更改-Apple-ID-国家或地区" class="headerlink" title="更改 Apple ID 国家或地区"></a>更改 Apple ID 国家或地区</h3><blockquote><p>区域在国内即使身在国外也看不到你需要的很多东东，建议修改</p></blockquote><p><a href="https://support.apple.com/zh-cn/ht201389" target="_blank" rel="noopener">https://support.apple.com/zh-cn/ht201389</a></p><h3 id="USB-Type-C-耳机"><a href="#USB-Type-C-耳机" class="headerlink" title="USB Type-C 耳机"></a>USB Type-C 耳机</h3><ol><li>插入耳机至任意 USB Type-C 接口</li><li>System Preferences -&gt; Sound -&gt; Output -&gt; 选择识别到的耳机设备即可</li></ol><h3 id="Macbook-外置键盘如何更改设置"><a href="#Macbook-外置键盘如何更改设置" class="headerlink" title="Macbook 外置键盘如何更改设置"></a>Macbook 外置键盘如何更改设置</h3><p>option 改成 command（win 版键盘下的四个方块图标按键）<br>command 改成 option</p><p><a href="https://jingyan.baidu.com/article/363872ec2185346e4aa16f61.html" target="_blank" rel="noopener">https://jingyan.baidu.com/article/363872ec2185346e4aa16f61.html</a></p><h3 id="配置从命令提示行启动-vscode"><a href="#配置从命令提示行启动-vscode" class="headerlink" title="配置从命令提示行启动 vscode"></a>配置从命令提示行启动 vscode</h3><p>安装 Visual Studio Code，打开命令面板（按 F1 或 command + shift + p）输入 Shell 命令找到 Shell 命令: 在 PATH 中安装 “code” 命令。命令执行完成之后，重启终端工具使新的 $PATH 可用。现在，您可以简单地在终端中任意文件夹下输入‘code .’来编辑该文件夹下的文件了。</p><h3 id="Git-Ignore"><a href="#Git-Ignore" class="headerlink" title="Git Ignore"></a>Git Ignore</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个新文件 ~/.gitignore ，并将以下内容添加进去，这样全部 git 仓库将会忽略以下内容所提及的文件。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Folder view configuration files</span></span><br><span class="line">.DS_Store</span><br><span class="line">Desktop.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># Thumbnail cache files</span></span><br><span class="line">._*</span><br><span class="line">Thumbs.db</span><br><span class="line"></span><br><span class="line"><span class="comment"># Files that might appear on external disks</span></span><br><span class="line">.Spotlight-V100</span><br><span class="line">.Trashes</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compiled Python files</span></span><br><span class="line">*.pyc</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compiled C++ files</span></span><br><span class="line">*.out</span><br><span class="line"></span><br><span class="line"><span class="comment"># Application specific files</span></span><br><span class="line">venv</span><br><span class="line">node_modules</span><br><span class="line">.sass-cache</span><br><span class="line"></span><br><span class="line"><span class="comment"># Temp File</span></span><br><span class="line">*.swp</span><br><span class="line">*.swa</span><br><span class="line">*.swo</span><br><span class="line"></span><br><span class="line"><span class="comment"># github merge file</span></span><br><span class="line">*.orig</span><br><span class="line"></span><br><span class="line"><span class="comment">#vscode </span></span><br><span class="line">.vscode</span><br></pre></td></tr></table></figure><h3 id="禁止-DS-store-生成"><a href="#禁止-DS-store-生成" class="headerlink" title="禁止. DS_store 生成"></a>禁止. DS_store 生成</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 禁止 .DS_store 生成，打开“终端”，复制黏贴下面的命令，回车执行，重启 Mac 即可生效。</span></span><br><span class="line">defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool TRUE</span><br><span class="line"><span class="comment"># 恢复 .DS_store 生成</span></span><br><span class="line">defaults delete com.apple.desktopservices DSDontWriteNetworkStores</span><br><span class="line"><span class="comment"># 刪除已存在的. DS_Store</span></span><br><span class="line">sudo find . -name <span class="string">".DS_Store"</span> -depth -<span class="built_in">exec</span> rm &#123;&#125; \;</span><br></pre></td></tr></table></figure><h3 id="ssh-相关"><a href="#ssh-相关" class="headerlink" title="ssh 相关"></a>ssh 相关</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -bash: warning: setlocale: LC_CTYPE: cannot change locale (UTF-8): No such file or directory</span></span><br><span class="line"><span class="comment"># 禁止 OpenSSH 客户端从 OS X/Linux/Unix 桌面发送 LC_* 变量</span></span><br><span class="line">vi /etc/ssh/ssh_config</span><br><span class="line"><span class="comment">#SendEnv LANG LC_*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># port forwarding</span></span><br><span class="line">ssh -p 22202 wangao@127.0.0.1</span><br><span class="line">ssh -p 22202 wangao@127.0.0.1 -X</span><br><span class="line">scp -P 22202 -r sysctl.sh sysctl.d/ wangao@127.0.0.1:/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># ssh tunnel for one-time</span></span><br><span class="line">ssh -t -A wangao@xx.xx.xx.xx ssh wangao@10.65.32.60</span><br><span class="line"></span><br><span class="line"><span class="comment"># config ssh tunnel to make easy connect everyday</span></span><br><span class="line">vim ~/.ssh/config</span><br><span class="line"></span><br><span class="line">StrictHostKeyChecking no</span><br><span class="line">CheckHostIP no</span><br><span class="line"></span><br><span class="line">Host 10.71.12.*</span><br><span class="line">  HostName %h</span><br><span class="line">  ProxyCommand ssh bastion_GOP_SG_NC_MAIN -W %h:%p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Host 10.71.13.*</span><br><span class="line">  HostName %h</span><br><span class="line">  ProxyCommand ssh bastion_GOP_SG_NC_MAIN -W %h:%p</span><br><span class="line"></span><br><span class="line">Host 10.71.14.*</span><br><span class="line">  HostName %h</span><br><span class="line">  ProxyCommand ssh bastion_GOP_SG_NC_MAIN -W %h:%p</span><br><span class="line"></span><br><span class="line">Host 10.71.15.*</span><br><span class="line">  HostName %h</span><br><span class="line">  ProxyCommand ssh bastion_GOP_SG_NC_MAIN -W %h:%p</span><br><span class="line"></span><br><span class="line">Host bastion_GOP_SG_NC_MAIN</span><br><span class="line">  HostName 8.8.8.8</span><br><span class="line">  port 22</span><br><span class="line">  User wangao</span><br></pre></td></tr></table></figure><hr><p>题图 - 苹果 2015 新春广告<a href="http://www.apple.com/cn/start-something-new/#film-holiday" target="_blank" rel="noopener">《老唱片》</a></p>]]></content>
    
    <summary type="html">
    
      MacBook macOS 从小白到入门
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>静态路由和策略路由的配置实践</title>
    <link href="https://wsgzao.github.io/post/static-routes/"/>
    <id>https://wsgzao.github.io/post/static-routes/</id>
    <published>2019-03-12T06:22:32.000Z</published>
    <updated>2019-03-12T07:28:49.482Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>一般在多网卡的网络访问关系中我们通常根据目标 IP 地址段来添加静态路由 (static-routes)，在主机系统配置层面这个需求一般都比较简单也不需要使用非常复杂的命令，说实话如果不是因为开发测试中心同事的乱入启发，我也不会发现还有策略路由这样一种灵活通用的配置方法来实现 Linux 多网卡多路由的设定，灰常感谢。</p><blockquote><p>策略路由的出现在某些业务场景下可能更优于静态路由</p></blockquote><hr><h2 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h2><p>2019 年 03 月 12 日 - 更新 CentOS 7 静态路由添加规则<br>2016 年 03 月 18 日 - 更新静态路由配置和建议<br>2015 年 12 月 23 日 - 增加 Linux 添加静态路由最佳实践<br>2015 年 12 月 18 日 - 修正动态路由为策略路由描述，完善内容，感谢 <a href="http://www.v2ex.com/member/extreme" target="_blank" rel="noopener">@extreme</a><br>2015 年 12 月 17 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/static-routes/">https://wsgzao.github.io/post/static-routes/</a></p><p>扩展阅读</p><p>Static Routes and the Default Gateway - <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/networking_guide/ch-configuring_static_routes_and_the_default_gateway" target="_blank" rel="noopener">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/networking_guide/ch-configuring_static_routes_and_the_default_gateway</a><br>Routing Tables - <a href="http://linux-ip.net/html/routing-tables.html" target="_blank" rel="noopener">http://linux-ip.net/html/routing-tables.html</a><br>linux 配置静态路由 - <a href="http://www.361way.com/linux-define-static-route/4053.html" target="_blank" rel="noopener">http://www.361way.com/linux-define-static-route/4053.html</a><br>Linux 策略性路由应用及分析 (iproute2) - <a href="http://tilt.lib.tsinghua.edu.cn/node/408" target="_blank" rel="noopener">http://tilt.lib.tsinghua.edu.cn/node/408</a><br>Linux Advanced Routing &amp; Traffic Control - <a href="http://lartc.org/" target="_blank" rel="noopener">http://lartc.org/</a></p><hr><h2 id="静态路由表和策略路由的区别"><a href="#静态路由表和策略路由的区别" class="headerlink" title="静态路由表和策略路由的区别"></a>静态路由表和策略路由的区别</h2><p>通常我们维护静态路由表会手工填写所有 IP 地址段的路由规则，使用命令或者写入配置文件永久生效，先以 Windows/Linux/AIX 常用方法为例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Windows 静态路由 </span></span><br><span class="line">-- 键入 route -p add [目标] [mask &lt; 网络掩码 & gt;] [网关] [metric &lt; 度量值 & gt;] [<span class="keyword">if</span> &lt; 接口 & gt;]</span><br><span class="line">route <span class="built_in">print</span></span><br><span class="line">route delete</span><br><span class="line">route -p add 172.16.19.0 mask 255.255.255.0 198.15.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment">#RHEL 静态路由 </span></span><br><span class="line">vi /etc/sysconfig/network</span><br><span class="line">default via 192.168.3.1 dev eth0</span><br><span class="line">10.211.6.0/24 via 192.168.3.1 dev eth0</span><br><span class="line">10.0.0.0/8 via 10.212.52.1 dev eth1</span><br><span class="line"></span><br><span class="line"><span class="comment">#CentOS 静态路由 </span></span><br><span class="line">ip route add 172.16.5.0/24 via 10.0.0.101 dev eth0</span><br><span class="line">vim /etc/sysconfig/network-scripts/route-eth0</span><br><span class="line">172.16.5.0/24 via 10.0.0.101</span><br><span class="line"></span><br><span class="line"><span class="comment">#SuSE 静态路由 </span></span><br><span class="line">vim /etc/sysconfig/network/routes</span><br><span class="line">default 192.168.3.1 - -</span><br><span class="line">10.211.6.0 192.168.3.1 255.255.255.0 eth0</span><br><span class="line">10.0.0.0 10.212.52.1 255.0.0.0 eth1</span><br><span class="line"></span><br><span class="line"><span class="comment">#AIX 静态路由 </span></span><br><span class="line">smitty mkroute</span><br><span class="line">172.20.14.0/24 gw 172.23.14.254</span><br></pre></td></tr></table></figure><p>这种办法针对少量的规则还可以轻松应对，但规则一旦增加麻烦也就接踵而至，网段地址不断变化就必须及时更新路由表，否则其他用户就无法访问。如果可以根据用户访问进来的路径设定策略路由就会方便很多，而 rt_tables 就是为此而生。</p><h2 id="Linux-添加静态路由最佳实践"><a href="#Linux-添加静态路由最佳实践" class="headerlink" title="Linux 添加静态路由最佳实践"></a>Linux 添加静态路由最佳实践</h2><blockquote><p>按照 RedHat 官方介绍有三种方式添加永久静态路由，这里只列举最佳方式</p></blockquote><h3 id="临时路由"><a href="#临时路由" class="headerlink" title="临时路由"></a>临时路由</h3><blockquote><p>以下两种方法可以立即生效，但重启后会消失，切记使用场景</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#route 命令参数，使用 route 命令，查看本机路由直接输入 route -n 回车即可 </span></span><br><span class="line">add     增加路由 </span><br><span class="line">del     删除路由 </span><br><span class="line">-net    设置到某个网段的路由 </span><br><span class="line">-host   设置到某台主机的路由 </span><br><span class="line">gw      出口网关 IP 地址 </span><br><span class="line">dev     出口网关 物理设备名 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加路由 </span></span><br><span class="line">route add -net 192.168.0.0/24 gw 192.168.0.1</span><br><span class="line">route add -host 192.168.1.1 dev 192.168.0.1</span><br><span class="line"><span class="comment"># 删除路由 </span></span><br><span class="line">route del -net 192.168.0.0/24 gw 192.168.0.1</span><br><span class="line"><span class="comment"># 添加默认路由 </span></span><br><span class="line">route add default gw 192.168.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 ip route 命令和 route 命令类似 </span></span><br><span class="line">add 增加路由 </span><br><span class="line">del 删除路由 </span><br><span class="line">via 网关出口 IP 地址 </span><br><span class="line">dev 网关出口 物理设备名 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加路由 </span></span><br><span class="line">ip route add 192.168.0.0/24 via 192.168.0.1</span><br><span class="line">ip route add 192.168.1.1 dev 192.168.0.1</span><br><span class="line"><span class="comment"># 删除路由 </span></span><br><span class="line">ip route del 192.168.0.0/24 via 192.168.0.1</span><br><span class="line"><span class="comment"># 增加默认路由 </span></span><br><span class="line">ip route add default via 192.168.0.1 dev eth0</span><br></pre></td></tr></table></figure><h3 id="永久路由"><a href="#永久路由" class="headerlink" title="永久路由"></a>永久路由</h3><blockquote><p>该方法需要重启网络会造成短暂的网络服务中断，但重启后优先级大于 rc.local 方式不会影响 nfs</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以通过临时命令立即生效 </span></span><br><span class="line">route add -net 192.168.3.0/24 gw 192.168.3.254</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 / etc/sysconfig/static-routes 文件里添加如下内容 (没有 static-routes 的话就手动建立一个这样的文件)</span></span><br><span class="line">any net 192.168.3.0/24 gw 192.168.3.254</span><br><span class="line">any net 10.250.228.128 netmask 255.255.255.192 gw 10.250.228.129</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果是生产系统可以考虑暂时不重启服务避免网络中断 </span></span><br><span class="line">service network restart</span><br></pre></td></tr></table></figure><h2 id="rt-tables"><a href="#rt-tables" class="headerlink" title="rt_tables"></a>rt_tables</h2><blockquote><p>rt_tables 简单来说就是通过给表的命名使得管理简单化</p></blockquote><p>大部分人习惯直接将路由表优先级号码直接作为表的名称来使用，这样做的好处是非常直观和简明的表达了表所在优先级的位置，但是当表的优先级结构出现变动时，我们对巨大的路由表的修改就显得很烦琐和费事了。</p><p>在 / etc/iproute2 / 目录下, 有这么一个文件 rt_tables, 只要对它进行改动，我们将很容易的完成路由表优先级结构的变动。(数值越小优先级别越高)</p><p>当路由表的优先级发生变化的时候，我们只需要编辑 / etc/iproute2/rt_tables 这个文件就可以直接改变路由表的优先级次序。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/iproute2/rt_tables</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># reserved values</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">255    <span class="built_in">local</span></span><br><span class="line">254    main</span><br><span class="line">253    default</span><br><span class="line">0    unspec</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># local</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#1    inr.ruhep</span></span><br></pre></td></tr></table></figure><p>Linux 最多可以支持 255 张路由表，其中有 3 张表是内置的：</p><p>表 255 本地路由表（Local table） 本地接口地址，广播地址，已及 NAT 地址都放在这个表。该路由表由系统自动维护，管理员不能直接修改。</p><p>表 254 主路由表（Main table） 如果没有指明路由所属的表，所有的路由都默认都放在这个表里，一般来说，旧的路由工具（如 route）所添加的路由都会加到这个表。一般是普通的路由。</p><p>表 253 默认路由表 （Default table） 一般来说默认的路由都放在这张表，但是如果特别指明放的也可以是所有的网关路由。</p><p>表 0 保留</p><h2 id="策略性路由应用及分析-iproute2"><a href="#策略性路由应用及分析-iproute2" class="headerlink" title="策略性路由应用及分析 (iproute2)"></a>策略性路由应用及分析 (iproute2)</h2><p>策略性路由</p><p>　　策略性是指对于 IP 包的路由是以网络管理员根据需要定下的一些策略为主要依据进行路由的。例如我们可以有这样的策略：“所有来直自网 A 的包，选择 X 路径；其他选择 Y 路径”，或者是 “所有 TOS 为 A 的包选择路径 F；其他选者路径 K”。<br>　　Cisco 的网络操作系统 (Cisco IOS) 从 11.0 开始就采用新的策略性路由机制。而 Linux 是在内核 2.1 开始采用策略性路由机制的。策略性路由机制与传统的路由算法相比主要是引入了多路由表以及规则的概念。</p><p>多路由表（multiple Routing Tables）</p><p>　　传统的路由算法是仅使用一张路由表的。但是在有些情形底下，我们是需要使用多路由表的。例如一个子网通过一个路由器与外界相连，路由器与外界有两条线路相连，其中一条的速度比较快，一条的速度比较慢。对于子网内的大多数用户来说对速度并没有特殊的要求，所以可以让他们用比较慢的路由；但是子网内有一些特殊的用户却是对速度的要求比较苛刻，所以他们需要使用速度比较快的路由。如果使用一张路由表上述要求是无法实现的，而如果根据源地址或其它参数，对不同的用户使用不同的路由表，这样就可以大大提高路由器的性能。</p><p>规则（rule）</p><p>　　规则是策略性的关键性的新的概念。我们可以用自然语言这样描述规则，例如我门可以指定这样的规则：<br>　　规则一：“所有来自 192.16.152.24 的 IP 包，使用路由表 10， 本规则的优先级别是 1500”<br>　　规则二：“所有的包，使用路由表 253，本规则的优先级别是 32767”</p><p>　　我们可以看到，规则包含 3 个要素：<br>　　什么样的包，将应用本规则（所谓的 SELECTOR，可能是 filter 更能反映其作用）；<br>　　符合本规则的包将对其采取什么动作（ACTION），例如用那个表；<br>　　本规则的优先级别。优先级别越高的规则越先匹配（数值越小优先级别越高）。</p><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><blockquote><p>服务器 A 和 B 为双网卡，操作系统为 rhel_7.1_64</p></blockquote><table><thead><tr><th>网卡显示名称</th><th>IP 地址</th><th>子网掩码</th><th>网关</th><th>备注</th></tr></thead><tbody><tr><td>ens4f0</td><td>172.31.192.201</td><td>255.255.255.0</td><td>172.31.192.254</td><td>服务器 A</td></tr><tr><td>ens9f0</td><td>172.31.196.1</td><td>255.255.255.0</td><td>172.31.196.254</td><td>服务器 A</td></tr><tr><td>ens4f0</td><td>172.31.192.202</td><td>255.255.255.0</td><td>172.31.192.254</td><td>服务器 B</td></tr><tr><td>ens9f0</td><td>172.31.196.2</td><td>255.255.255.0</td><td>172.31.196.254</td><td>服务器 B</td></tr><tr><td>/</td><td>172.25.168.44</td><td>255.255.255.0</td><td>172.25.168.254</td><td>接入测试</td></tr></tbody></table><blockquote><p>网络配置，以服务器 A 为例，注意注释默认网关</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/sysconfig/network-scripts/ifcfg-ens4f0</span><br><span class="line"></span><br><span class="line">DEVICE=ens4f0</span><br><span class="line">ONBOOT=yes</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">IPADDR=172.31.192.201</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line"><span class="comment">#GATEWAY=172.31.192.254</span></span><br><span class="line"></span><br><span class="line">cat /etc/sysconfig/network-scripts/ifcfg-ens9f0</span><br><span class="line"></span><br><span class="line">DEVICE=ens9f0</span><br><span class="line">ONBOOT=yes</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">IPADDR=172.31.196.1</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line"><span class="comment">#GATEWAY=172.31.196.254</span></span><br></pre></td></tr></table></figure><h2 id="策略路由配置"><a href="#策略路由配置" class="headerlink" title="策略路由配置"></a>策略路由配置</h2><blockquote><p>注意配置名称一定要吻合</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 rt_tables</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"192 net_192"</span> &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"196 net_196"</span> &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空 net_192 路由表 </span></span><br><span class="line">ip route flush table net_192</span><br><span class="line"><span class="comment"># 添加一个路由规则到 net_192 表，这条规则是 net_192 这个路由表中数据包默认使用源 IP 172.31.192.201 通过 ens4f0 走网关 172.31.192.254</span></span><br><span class="line">ip route add default via 172.31.192.254 dev ens4f0 src 172.31.192.201 table net_192</span><br><span class="line"><span class="comment"># 来自 172.31.192.201 的数据包，使用 net_192 路由表的路由规则 </span></span><br><span class="line">ip rule add from 172.31.192.201 table net_192</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空 net_196 路由表 </span></span><br><span class="line">ip route flush table net_196</span><br><span class="line"><span class="comment"># 添加一个路由规则到 net_196 表，这条规则是 net_196 这个路由表中数据包默认使用源 IP 172.31.196.1 通过 ens9f0 走网关 172.31.196.254</span></span><br><span class="line">ip route add default via 172.31.196.254 dev ens9f0 src 172.31.196.1 table net_196</span><br><span class="line"><span class="comment"># 来自 172.31.196.1 的数据包，使用 net_196 路由表的路由规则 </span></span><br><span class="line">ip rule add from 172.31.196.1 table net_196</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加默认网关 </span></span><br><span class="line">route add default gw 172.31.192.254</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果需要自启动生效可以写进配置文件也可以加入 rc.local</span></span><br><span class="line">vi /etc/rc.local</span><br><span class="line"></span><br><span class="line">ip route flush table net_192</span><br><span class="line">ip route add default via 172.31.192.254 dev ens4f0 src 172.31.192.201 table net_192</span><br><span class="line">ip rule add from 172.31.192.201 table net_192</span><br><span class="line">ip route flush table net_196</span><br><span class="line">ip route add default via 172.31.196.254 dev ens9f0 src 172.31.196.1 table net_196</span><br><span class="line">ip rule add from 172.31.196.1 table net_196</span><br><span class="line">route add default gw 172.31.192.254</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看路由表 </span></span><br><span class="line">route -n</span><br><span class="line"></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">169.254.0.0     0.0.0.0         255.255.0.0     U     1006   0        0 ens9f0</span><br><span class="line">169.254.0.0     0.0.0.0         255.255.0.0     U     1008   0        0 ens4f0</span><br><span class="line">169.254.0.0     0.0.0.0         255.255.0.0     U     1014   0        0 br-ex</span><br><span class="line">169.254.0.0     0.0.0.0         255.255.0.0     U     1015   0        0 br-int</span><br><span class="line">172.31.192.0    0.0.0.0         255.255.255.0   U     0      0        0 ens4f0</span><br><span class="line">172.31.196.0    0.0.0.0         255.255.255.0   U     0      0        0 ens9f0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在接入测试服务器上验证连通性 </span></span><br><span class="line">ping 172.31.192.201</span><br><span class="line">ping 172.31.196.1</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      策略路由的出现在某些业务场景下可能更优于静态路由
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>iptables 配置实践</title>
    <link href="https://wsgzao.github.io/post/iptables/"/>
    <id>https://wsgzao.github.io/post/iptables/</id>
    <published>2019-03-06T07:52:17.000Z</published>
    <updated>2019-03-07T11:01:41.336Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在大企业中防火墙角色主要交给硬件来支持，效果自然没话说只是需要增加一点点成本，但对于大多数个人或者互联网公司来说选择系统自带的 <code>iptables</code> 或者第三方云防火墙似乎是更加合适的选择，通过一些合理的优化和灵活的配置，我们也可以很轻松实现硬件防火墙的部分功能，够用就好。</p><blockquote><p>建立防火墙白名单机制很重要   </p></blockquote><hr><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 03 月 06 日 - 增加使用 ansible blockinfile 模块管理 iptables 规则<br>2018 年 07 月 18 日 - 更新 iptables 原理和 NAT 配置<br>2015 年 07 月 24 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/iptables/">https://wsgzao.github.io/post/iptables/</a></p><p><strong> 扩展阅读 </strong></p><p>Linux 防火墙和 iptables - <a href="http://liaoph.com/iptables/" target="_blank" rel="noopener">http://liaoph.com/iptables/</a><br>iptables 零基础快速入门系列 - <a href="http://www.zsythink.net/archives/tag/iptables/" target="_blank" rel="noopener">http://www.zsythink.net/archives/tag/iptables/</a></p><hr><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="Netfilter-与-iptables-的关系"><a href="#Netfilter-与-iptables-的关系" class="headerlink" title="Netfilter 与 iptables 的关系"></a>Netfilter 与 iptables 的关系</h3><p>Linux 系统在内核中提供了对报文数据包过滤和修改的官方项目名为 Netfilter，它指的是 Linux 内核中的一个框架，它可以用于在不同阶段将某些钩子函数（hook）作用域网络协议栈。Netfilter 本身并不对数据包进行过滤，它只是允许可以过滤数据包或修改数据包的函数挂接到内核网络协议栈中的适当位置。这些函数是可以自定义的。</p><p>iptables 是用户层的工具，它提供命令行接口，能够向 Netfilter 中添加规则策略，从而实现报文过滤，修改等功能。Linux 系统中并不止有 iptables 能够生成防火墙规则，其他的工具如 firewalld 等也能实现类似的功能。</p><h3 id="使用-iptables-进行包过滤"><a href="#使用-iptables-进行包过滤" class="headerlink" title="使用 iptables 进行包过滤"></a>使用 iptables 进行包过滤</h3><p>iptables 策略是由一组有序的规则建立的，它告诉内核应该如何处理某些类别的数据包。每一个 iptables 规则应用于一个表中的一个链。一个 iptables 链就是一个规则集，这些规则按序与包含某种特征的数据包进行比较匹配。</p><h3 id="表"><a href="#表" class="headerlink" title="表"></a>表</h3><p>iptables 默认有 4 个表</p><ol><li>nat 表（地址转换表）</li><li>filter 表（数据过滤表）</li><li>raw 表（状态跟踪表）</li><li>mangle 表（包标记表）</li></ol><h3 id="链"><a href="#链" class="headerlink" title="链"></a>链</h3><p>每个表都有一组内置链，用户还可以添加自定义的链。最重要的内置链是 filter 表中的 INPUT、OUTPUT 和 FORWARD 链。</p><ol><li>INPUT 链（入站规则）</li><li>OUTPUT 链（出站规则）</li><li>FORWARD 链（转发规则）</li><li>PREROUTING 链（路有前规则）</li><li>POSTROUTING 链（路由后规则）</li></ol><p>下图展现了一个数据包是如何通过内核中的 net 和 filter 表的：</p><p><img src="https://i.v2ex.co/4WFXrnn2.png" alt=""><br><img src="http://wx4.sinaimg.cn/large/7207510dgy1ftfb6rbw5tj20sr0f73z2.jpg" alt=""></p><h3 id="iptables-的-4-表-5-链"><a href="#iptables-的-4-表-5-链" class="headerlink" title="iptables 的 4 表 5 链"></a>iptables 的 4 表 5 链</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">iptables --&gt; 四表五链 </span><br><span class="line">    添加规则是的考量点：</span><br><span class="line">        （1）要实现那种功能：判断添加在那张表上</span><br><span class="line">        （2）报文流经的路径：判断添加在那个链上</span><br><span class="line"></span><br><span class="line"> 链 --&gt;&gt; 练上规则的次序，即为检查的次序，因此隐含一定的法则 </span><br><span class="line">        （1）同类规则(访问同一应用)：匹配范围小的放上面</span><br><span class="line">        （2）不同类规则(访问不同应用)：匹配到报文平率较大的放上面</span><br><span class="line">        （3）将可以由条规则描述的多个规则合并为一个</span><br><span class="line">        （4）设置默认策略：</span><br><span class="line"></span><br><span class="line"> 功能的优先级次序：raw --&gt; mangle --&gt; nat --&gt; filter</span><br><span class="line"></span><br><span class="line">规则：</span><br><span class="line">    组成部分：报文的匹配条件，匹配到后处理动作 </span><br><span class="line">    匹配条件：根据协议报文特征指定匹配条件</span><br><span class="line">            基本匹配条件：源 IP，目标 IP，源端口，目标端口</span><br><span class="line">                        扩展匹配条件：IP 追踪</span><br><span class="line">    处理动作：</span><br><span class="line">                        内建处理机制</span><br><span class="line">                        自定义处理机制</span><br><span class="line"> 注意：</span><br><span class="line"></span><br><span class="line">报文不会经过自定义链，只能在内置链上通过规则引用后生效</span><br><span class="line">        iptables 的规则管理工具</span><br><span class="line">                添加、修改、删除、显示等功能</span><br><span class="line">        规则和链有计数器：</span><br><span class="line">                pkgs：有规则或链所匹配到的报文的个数</span><br><span class="line">                bytes: 由规则或链匹配到的所有报文大小之和</span><br></pre></td></tr></table></figure><h3 id="匹配"><a href="#匹配" class="headerlink" title="匹配"></a>匹配</h3><p>每个 iptables 规则都包含一组匹配和一个目标动作，后者定义了复合规则的数据包应该采取什么处理行为。iptables 匹配指定是数据包必须匹配的条件，只有当数据包满足所有的匹配条件时，iptables 才能根据规则的目标所指定的动作来处理该数据包。</p><p>每个匹配都在 iptables 的命令行中指定。下面是一些常用的基本匹配：</p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-P</td><td>设置默认策略</td></tr><tr><td>-F</td><td>清空规则链</td></tr><tr><td>-L</td><td>查看规则链</td></tr><tr><td>-A</td><td>在规则链的末尾加入新规则                        </td></tr><tr><td>-I num</td><td>在规则链的头部加入新规则                        </td></tr><tr><td>-D num</td><td>删除某一条规则                                    </td></tr><tr><td>-s</td><td>匹配来源地址 IP/MASK，加叹号 “!” 表示除这个 IP 外    </td></tr><tr><td>-d</td><td>匹配目标地址                                    </td></tr><tr><td>-i 网卡名称</td><td>匹配从这块网卡流入的数据                        </td></tr><tr><td>-o 网卡名称</td><td>匹配从这块网卡流出的数据                        </td></tr><tr><td>-p</td><td>匹配协议，如 TCP、UDP、ICMP                        </td></tr><tr><td>–dport num</td><td>匹配目标端口号                                    </td></tr><tr><td>–sport num</td><td>匹配来源端口号                                    </td></tr></tbody></table><h3 id="防火墙的匹配规则"><a href="#防火墙的匹配规则" class="headerlink" title="防火墙的匹配规则"></a>防火墙的匹配规则</h3><ul><li>匹配即可停止</li><li>匹配有先后顺序</li><li>默认规则的优先级最低</li></ul><h3 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h3><blockquote><p>表名作用：</p></blockquote><p>raw：高级功能，如：网址过滤。<br>mangle：数据包修改（QOS），用于实现服务质量。<br>net：地址转换，用于网关路由器。<br>filter：包过滤，用于防火墙规则。</p><blockquote><p>规则链作用：</p></blockquote><p>INPUT 链：处理输入数据包。<br>OUTPUT 链：处理输出数据包。<br>PORWARD 链：处理转发数据包。<br>PREROUTING 链：用于目标地址转换（DNAT）。<br>POSTOUTING 链：用于源地址转换（SNAT）。</p><blockquote><p>动作作用：</p></blockquote><p>accept：接收数据包。<br>DROP：丢弃数据包。<br>REJECT ：拒绝数据包<br>REDIRECT：重定向、映射、透明代理。<br>SNAT：源地址转换。<br>DNAT：目标地址转换。<br>MASQUERADE：IP 伪装（NAT），用于 ADSL。<br>LOG：日志记录。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 规则的观察与清除 </span></span><br><span class="line"></span><br><span class="line">     iptables [-t tables] [-L] [-nv]</span><br><span class="line"></span><br><span class="line"> 选项与参数：</span><br><span class="line">-t ：后面接 table ，例如 nat 或 filter ，若省略此项目，则使用默认的 filter</span><br><span class="line">-L ：列出目前的 table 的规则 </span><br><span class="line">-n ：不进行 IP 与 HOSTNAME 的反查，显示讯息的速度会快很多！</span><br><span class="line">-v ：列出更多的信息，包括通过该规则的封包总位数、相关的网络接口等</span><br><span class="line"></span><br><span class="line">     iptables [-t tables] [-FXZ]</span><br><span class="line"></span><br><span class="line"> 选项与参数：</span><br><span class="line">-F ：清除所有的已订定的规则；</span><br><span class="line">-X ：杀掉所有使用者 <span class="string">"自定义"</span> 的 chain (应该说的是 tables ）啰；</span><br><span class="line">-Z ：将所有的 chain 的计数与流量统计都归零 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 封包的基础比对：IP, 网域及接口装置</span></span><br><span class="line"></span><br><span class="line">    iptables [-AI 链名] [-io 网络接口] [-p 协议] [-s 来源 IP / 网域] [-d 目标 IP / 网域] -j [ACCEPT|DROP|REJECT|LOG]</span><br><span class="line"></span><br><span class="line"> 选项与参数：</span><br><span class="line">-AI 链名：针对某的链进行规则的 <span class="string">"插入"</span> 或 <span class="string">"累加"</span></span><br><span class="line">    -A ：新增加一条规则，该规则增加在原本规则的最后面。例如原本已经有四条规则，</span><br><span class="line">         使用 -A 就可以加上第五条规则！</span><br><span class="line">    -I ：插入一条规则。如果没有指定此规则的顺序，默认是插入变成第一条规则。</span><br><span class="line">         例如原本有四条规则，使用 -I 则该规则变成第一条，而原本四条变成 2~5 号 </span><br><span class="line">    链 ：有 INPUT, OUTPUT, FORWARD 等，此链名称又与 -io 有关，请看底下。</span><br><span class="line"></span><br><span class="line">-io 网络接口：设定封包进出的接口规范</span><br><span class="line">    -i ：封包所进入的那个网络接口，例如 eth0, lo 等接口。需与 INPUT 链配合；</span><br><span class="line">    -o ：封包所传出的那个网络接口，需与 OUTPUT 链配合；</span><br><span class="line"></span><br><span class="line">-p 协定：设定此规则适用于哪种封包格式</span><br><span class="line">   主要的封包格式有： tcp, udp, icmp 及 all 。</span><br><span class="line"></span><br><span class="line">-s 来源 IP / 网域：设定此规则之封包的来源项目，可指定单纯的 IP 或包括网域，例如：</span><br><span class="line">   IP  ：192.168.0.100</span><br><span class="line">   网域：192.168.0.0/24, 192.168.0.0/255.255.255.0 均可。</span><br><span class="line">   若规范为『不许』时，则加上 ! 即可，例如：</span><br><span class="line">   -s ! 192.168.100.0/24 表示不许 192.168.100.0/24 之封包来源；</span><br><span class="line"></span><br><span class="line">-d 目标 IP / 网域：同 -s ，只不过这里指的是目标的 IP 或网域。</span><br><span class="line"></span><br><span class="line">-j ：后面接动作，主要的动作有接受(ACCEPT)、丢弃(DROP)、拒绝(REJECT) 及记录 (LOG)</span><br><span class="line"></span><br><span class="line"><span class="comment">#TCP, UDP 的规则比对：针对端口设定</span></span><br><span class="line"></span><br><span class="line">    iptables [-AI 链] [-io 网络接口] [-p tcp,udp] [-s 来源 IP / 网域] [--sport 埠口范围] [-d 目标 IP / 网域] [--dport 端口范围] -j [ACCEPT|DROP|REJECT]</span><br><span class="line"></span><br><span class="line"> 选项与参数：</span><br><span class="line">--sport 埠口范围：限制来源的端口号码，端口号码可以是连续的，例如 1024:65535</span><br><span class="line">--dport 埠口范围：限制目标的端口号码。</span><br><span class="line"></span><br><span class="line"><span class="comment">#iptables 外挂模块：mac 与 state</span></span><br><span class="line"></span><br><span class="line">    iptables -A INPUT [-m state] [--state 状态]</span><br><span class="line"></span><br><span class="line">选项与参数：</span><br><span class="line">-m ：一些 iptables 的外挂模块，主要常见的有：</span><br><span class="line">     state ：状态模块 </span><br><span class="line">     mac   ：网络卡硬件地址 (hardware address)</span><br><span class="line">--state ：一些封包的状态，主要有：</span><br><span class="line">     INVALID    ：无效的封包，例如数据破损的封包状态</span><br><span class="line">     ESTABLISHED：已经联机成功的联机状态；</span><br><span class="line">     NEW        ：想要新建立联机的封包状态；</span><br><span class="line">     RELATED    ：这个最常用！表示这个封包是与我们主机发送出去的封包有关</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ICMP 封包规则的比对：针对是否响应 ping 来设计</span></span><br><span class="line"></span><br><span class="line">    iptables -A INPUT [-p icmp] [--icmp-type 类型] -j ACCEPT</span><br><span class="line"></span><br><span class="line"> 选项与参数：</span><br><span class="line">--icmp-type ：后面必须要接 ICMP 的封包类型，也可以使用代号，</span><br><span class="line">              例如 8  代表 <span class="built_in">echo</span> request 的意思。</span><br></pre></td></tr></table></figure><blockquote><p>注意事项与规律</p></blockquote><ul><li>可以不指定表，默认为 filter 表</li><li>可以不指定链，默认为对应表的所有链</li><li>除非设置默认策略，否则必须指定匹配条件</li><li>选项 / 链名 / 目标操作用大写字母，其余都小写</li></ul><h2 id="配置-iptables-白名单机制"><a href="#配置-iptables-白名单机制" class="headerlink" title="配置 iptables 白名单机制"></a>配置 iptables 白名单机制</h2><blockquote><p>配置 iptables 白名单是相对简单有效的管理手段</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 清除所有规则(慎用)</span></span><br><span class="line">iptables -F</span><br><span class="line">iptables -X</span><br><span class="line">iptables -Z</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 iptable 和行号</span></span><br><span class="line">iptables -nL --line-number</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存当前防火墙配置</span></span><br><span class="line">service iptables save</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动编辑防火墙策略</span></span><br><span class="line">vi /etc/sysconfig/iptables</span><br><span class="line"></span><br><span class="line">*filter</span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [0:0]</span><br><span class="line"><span class="comment"># 开放本地和 Ping</span></span><br><span class="line">-A INPUT -i lo -j ACCEPT  </span><br><span class="line">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT </span><br><span class="line">-A INPUT -p icmp -j ACCEPT</span><br><span class="line"><span class="comment"># 配置内网白名单</span></span><br><span class="line">-A INPUT -s 10.0.0.0/8 -j ACCEPT</span><br><span class="line">-A INPUT -s 172.16.0.0/12 -j ACCEPT</span><br><span class="line">-A INPUT -s 192.168.0.0/16 -j ACCEPT</span><br><span class="line"><span class="comment"># 配置外网白名单</span></span><br><span class="line">-A INPUT -s 180.168.36.198 -j ACCEPT </span><br><span class="line">-A INPUT -s 180.168.34.218 -j ACCEPT </span><br><span class="line">-A INPUT -s 222.73.202.251 -j ACCEPT </span><br><span class="line"><span class="comment"># 控制端口</span></span><br><span class="line">-A INPUT -p tcp --dport 80 -j ACCEPT </span><br><span class="line">-A INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line"><span class="comment"># 拒绝其它</span></span><br><span class="line">-A INPUT -j DROP </span><br><span class="line">-A FORWARD -j DROP </span><br><span class="line"><span class="comment"># 开放出口</span></span><br><span class="line">-A OUTPUT -j ACCEPT </span><br><span class="line">COMMIT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启生效</span></span><br><span class="line">service iptables restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复查结果</span></span><br><span class="line"></span><br><span class="line">iptables -nL --line-number</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">2    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED </span><br><span class="line">3    ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">4    ACCEPT     all  --  10.0.0.0/8           0.0.0.0/0           </span><br><span class="line">5    ACCEPT     all  --  172.16.0.0/12        0.0.0.0/0           </span><br><span class="line">6    ACCEPT     all  --  192.168.0.0/16       0.0.0.0/0           </span><br><span class="line">7    ACCEPT     all  --  180.168.36.198       0.0.0.0/0           </span><br><span class="line">8    ACCEPT     all  --  180.168.34.218       0.0.0.0/0           </span><br><span class="line">9    ACCEPT     all  --  222.73.202.251       0.0.0.0/0           </span><br><span class="line">10   ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0           tcp dpt:80 </span><br><span class="line">11   ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0           tcp dpt:22 </span><br><span class="line">12   DROP       all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    DROP       all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">num  target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">1    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0</span><br></pre></td></tr></table></figure><h2 id="设置-crontab-脚本"><a href="#设置-crontab-脚本" class="headerlink" title="设置 crontab 脚本"></a>设置 crontab 脚本</h2><blockquote><p>便于运维集中化管理扩展</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">vim /root/start_iptables.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#0 0 * * * /root/start_iptables.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除配置</span></span><br><span class="line">/sbin/iptables -P INPUT ACCEPT</span><br><span class="line">/sbin/iptables -F</span><br><span class="line">/sbin/iptables -X</span><br><span class="line"><span class="comment"># 开放本地和 Ping</span></span><br><span class="line">/sbin/iptables -A INPUT -i lo -j ACCEPT  </span><br><span class="line">/sbin/iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT </span><br><span class="line">/sbin/iptables -A INPUT -p icmp -j ACCEPT</span><br><span class="line"><span class="comment"># 配置内网白名单</span></span><br><span class="line">/sbin/iptables -A INPUT -s 10.0.0.0/8 -j ACCEPT</span><br><span class="line">/sbin/iptables -A INPUT -s 172.16.0.0/12 -j ACCEPT</span><br><span class="line">/sbin/iptables -A INPUT -s 192.168.0.0/16 -j ACCEPT</span><br><span class="line"><span class="comment"># 配置外网白名单</span></span><br><span class="line">/sbin/iptables -A INPUT -s 180.168.36.198 -j ACCEPT </span><br><span class="line">/sbin/iptables -A INPUT -s 180.168.34.218 -j ACCEPT </span><br><span class="line">/sbin/iptables -A INPUT -s 222.73.202.251 -j ACCEPT </span><br><span class="line"><span class="comment"># 控制端口</span></span><br><span class="line">/sbin/iptables -A INPUT -p tcp --dport 80 -j ACCEPT </span><br><span class="line">/sbin/iptables -A INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line"><span class="comment"># 拒绝其它</span></span><br><span class="line">/sbin/iptables -A INPUT -j DROP </span><br><span class="line">/sbin/iptables -A FORWARD -j DROP </span><br><span class="line"><span class="comment"># 开放出口</span></span><br><span class="line">/sbin/iptables -A OUTPUT -j ACCEPT </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chmod 755 /root/start_iptables.sh</span><br><span class="line">crontab -e</span><br><span class="line">0 0 * * * /root/start_iptables.sh</span><br></pre></td></tr></table></figure><h2 id="CentOS7-配置-iptables"><a href="#CentOS7-配置-iptables" class="headerlink" title="CentOS7 配置 iptables"></a>CentOS7 配置 iptables</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置好 yum 源以后安装 iptables-service</span></span><br><span class="line">yum install -y iptables-services</span><br><span class="line"><span class="comment"># 停止 firewalld</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="comment"># 禁止 firewalld 自动启动</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"><span class="comment"># 启动 iptables</span></span><br><span class="line">systemctl start iptables</span><br><span class="line"><span class="comment"># 将 iptables 设置为开机自动启动，以后即可通过 iptables-service 控制 iptables 服务</span></span><br><span class="line">systemctl <span class="built_in">enable</span> iptables</span><br></pre></td></tr></table></figure><h3 id="开启-Linux-路由转发"><a href="#开启-Linux-路由转发" class="headerlink" title="开启 Linux 路由转发"></a>开启 Linux 路由转发</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭路由转发</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/ip_forward            </span><br><span class="line"><span class="comment"># 开启路由转发</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward            </span><br><span class="line"><span class="comment"># 注意以上操作仅当前有效，计算机重启后无效，修改 / etc/sysctl.conf 配置文件，可以实现永久有效规则</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'net.ipv4.ip_forward=1'</span> &gt;&gt; /etc/sysctl.conf</span><br></pre></td></tr></table></figure><h2 id="配置-NAT-Tunnel"><a href="#配置-NAT-Tunnel" class="headerlink" title="配置 NAT Tunnel"></a>配置 NAT Tunnel</h2><blockquote><p>俗称跳板机</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 iptables</span></span><br><span class="line">vi /etc/sysconfig/iptables</span><br><span class="line">*nat</span><br><span class="line">:PREROUTING ACCEPT [6:504]</span><br><span class="line">:INPUT ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [1:52]</span><br><span class="line">:POSTROUTING ACCEPT [1:52]</span><br><span class="line"></span><br><span class="line">-A POSTROUTING -j MASQUERADE</span><br><span class="line">COMMIT</span><br><span class="line"></span><br><span class="line">*filter</span><br><span class="line">:INPUT DROP [1029028:53321694]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [44723822:21524638399]</span><br><span class="line"></span><br><span class="line"><span class="comment">#zabbix</span></span><br><span class="line">-A INPUT -s 10.65.200.90 -p tcp -m tcp --dport 10050 -j ACCEPT</span><br><span class="line"></span><br><span class="line">-A INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># For keepalived:</span></span><br><span class="line"><span class="comment"># allow vrrp</span></span><br><span class="line">-A INPUT -p vrrp -j ACCEPT</span><br><span class="line">-A INPUT -p igmp -j ACCEPT</span><br><span class="line"><span class="comment"># allow multicast</span></span><br><span class="line">-A INPUT -d 224.0.0.18 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># Drop packets from spoofed networks</span></span><br><span class="line">-A INPUT -s 169.254.0.0/16   -j DROP</span><br><span class="line"><span class="comment">#-A INPUT -s 10.0.0.0/8       -j DROP</span></span><br><span class="line"><span class="comment">#-A INPUT -s 127.0.0.0/8      -j DROP</span></span><br><span class="line">-A INPUT -s 224.0.0.0/4      -j DROP</span><br><span class="line">-A INPUT -d 224.0.0.0/4      -j DROP</span><br><span class="line">-A INPUT -s 240.0.0.0/5      -j DROP</span><br><span class="line">-A INPUT -d 240.0.0.0/5      -j DROP</span><br><span class="line">-A INPUT -s 0.0.0.0/8        -j DROP</span><br><span class="line">-A INPUT -d 0.0.0.0/8        -j DROP</span><br><span class="line">-A INPUT -d 239.255.255.0/24 -j DROP</span><br><span class="line">-A INPUT -d 255.255.255.255  -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># Drop Invalid packets</span></span><br><span class="line">-A INPUT   -m state --state INVALID -j DROP</span><br><span class="line"><span class="comment">#-A FORWARD -m state --state INVALID -j DROP</span></span><br><span class="line">-A OUTPUT  -m state --state INVALID -j DROP</span><br><span class="line"></span><br><span class="line"><span class="comment"># Drop Bogus TCP packets</span></span><br><span class="line">-A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP</span><br><span class="line">-A INPUT -p tcp --tcp-flags SYN,RST SYN,RST -j DROP</span><br><span class="line"></span><br><span class="line">-A INPUT -p icmp --icmp-type <span class="built_in">echo</span>-reply -j ACCEPT</span><br><span class="line">-A INPUT -p icmp --icmp-type destination-unreachable -j ACCEPT</span><br><span class="line">-A INPUT -p icmp --icmp-type redirect -j ACCEPT</span><br><span class="line">-A INPUT -p icmp --icmp-type <span class="built_in">echo</span>-request -j ACCEPT</span><br><span class="line">-A INPUT -p icmp --icmp-type time-exceeded -j ACCEPT</span><br><span class="line">-A INPUT -i lo -j ACCEPT</span><br><span class="line">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">COMMIT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启生效并检查</span></span><br><span class="line">service iptables restart</span><br><span class="line">iptables -nvL</span><br></pre></td></tr></table></figure><h2 id="常用的-iptables-配置文件"><a href="#常用的-iptables-配置文件" class="headerlink" title="常用的 iptables 配置文件"></a>常用的 iptables 配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dnat</span></span><br><span class="line">-A PREROUTING -s 1.1.1.1/30,2.2.2.2 -p tcp --dport 10000 -j DNAT --to-destination 10.71.12.89:80</span><br><span class="line"><span class="comment"># snat</span></span><br><span class="line">-A POSTROUTING -d 1.1.1.1 -j SNAT --to-source 2.2.2.2</span><br><span class="line">-A POSTROUTING -o bond1 -j SNAT --to-source 3.3.3.3</span><br><span class="line">-A POSTROUTING -j MASQUERADE</span><br><span class="line"><span class="comment"># multiport</span></span><br><span class="line">-A INPUT -s 10.65.200.90 -p tcp -m multiport --dports 10050,10051 -j ACCEPT</span><br><span class="line">-A INPUT -s 10.65.200.90 -p tcp -m multiport --dports 10050:10060 -j ACCEPT</span><br></pre></td></tr></table></figure><h2 id="Ansible-管理-iptables"><a href="#Ansible-管理-iptables" class="headerlink" title="Ansible 管理 iptables"></a>Ansible 管理 iptables</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  become:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">  gather_facts:</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">backup</span> <span class="string">iptables</span></span><br><span class="line"><span class="attr">      copy:</span></span><br><span class="line"><span class="attr">        src:</span> <span class="string">/etc/sysconfig/iptables</span></span><br><span class="line"><span class="attr">        dest:</span> <span class="string">/etc/sysconfig/iptables.bak</span></span><br><span class="line"><span class="attr">        remote_src:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">add</span> <span class="string">iptables</span> <span class="string">line</span> <span class="string">for</span> <span class="string">internal</span> <span class="string">logic</span> <span class="string">service</span></span><br><span class="line"><span class="attr">      blockinfile:</span></span><br><span class="line"><span class="attr">        path:</span> <span class="string">/etc/sysconfig/iptables</span></span><br><span class="line"><span class="attr">        insertafter:</span> <span class="string">'^:OUTPUT ACCEPT'</span></span><br><span class="line"><span class="attr">        marker:</span> <span class="string">"# &#123;mark&#125; iptables whitelist only for internal logic service"</span></span><br><span class="line"><span class="attr">        block:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          -A INPUT -s 10.0.0.0/8 -j ACCEPT</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span><span class="attr">    - name:</span> <span class="string">reload</span> <span class="string">service</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=iptables</span> <span class="string">state=reloaded</span></span><br><span class="line"><span class="attr">      tags:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">reload</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      建立防火墙白名单机制很重要
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>中文文案排版指北</title>
    <link href="https://wsgzao.github.io/post/chinese-copywriting-guidelines/"/>
    <id>https://wsgzao.github.io/post/chinese-copywriting-guidelines/</id>
    <published>2019-03-06T07:31:24.000Z</published>
    <updated>2019-03-07T07:39:58.103Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://i.v2ex.co/ekrNgJeK.jpeg" alt=""></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>统一中文文案、排版的相关用法，降低团队成员之间的沟通成本，增强网站气质。</p><hr><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 03 月 06 日 - 更新至最新版本<br>2018 年 04 月 01 日 - 更新至最新版本<br>2016 年 05 月 09 日 - 更新至 release v0.0.9<br>2015 年 10 月 24 日 - 更新官方翻译的简体中文<br>2015 年 07 月 11 日 - 转载初稿，转化为简体中文</p><p>本文链接 - <a href="https://wsgzao.github.io/post/chinese-copywriting-guidelines/">https://wsgzao.github.io/post/chinese-copywriting-guidelines/</a></p><p><strong> 原文出处 </strong></p><p>Chinese Copywriting Guidelines：中文文案排版指北 - <a href="https://github.com/sparanoid/chinese-copywriting-guidelines" target="_blank" rel="noopener">https://github.com/sparanoid/chinese-copywriting-guidelines</a><br>Chinese Copywriting Guidelines：中文文案排版指北（简体中文版） - <a href="https://github.com/sparanoid/chinese-copywriting-guidelines/blob/master/README.zh-CN.md" target="_blank" rel="noopener">https://github.com/sparanoid/chinese-copywriting-guidelines/blob/master/README.zh-CN.md</a></p><hr><h2 id="空格"><a href="#空格" class="headerlink" title="空格"></a>空格</h2><p>「有研究显示，打字的时候不喜欢在中文和英文之间加空格的人，感情路都走得很辛苦，有七成的比例会在 34 岁的时候跟自己不爱的人结婚，而其余三成的人最后只能把遗产留给自己的猫。 毕竟爱情跟书写都需要适时地留白。</p><p>与大家共勉之。」——<a href="https://github.com/vinta/pangu.js" target="_blank" rel="noopener">vinta/paranoid-auto-spacing</a></p><h3 id="中英文之间需要增加空格"><a href="#中英文之间需要增加空格" class="headerlink" title="中英文之间需要增加空格"></a>中英文之间需要增加空格</h3><p>正确：</p><blockquote><p>在 LeanCloud 上，数据存储是围绕 <code>AVObject</code> 进行的。</p></blockquote><p>错误：</p><blockquote><p>在 LeanCloud 上，数据存储是围绕 <code>AVObject</code> 进行的。</p><p>在 LeanCloud 上，数据存储是围绕 <code>AVObject</code> 进行的。</p></blockquote><p>完整的正确用法：</p><blockquote><p>在 LeanCloud 上，数据存储是围绕 <code>AVObject</code> 进行的。 每个 <code>AVObject</code> 都包含了与 JSON 兼容的 key-value 对应的数据。 数据是 schema-free 的，你不需要在每个 <code>AVObject</code> 上提前指定存在哪些键，只要直接设定对应的 key-value 即可。</p></blockquote><p>例外：「豆瓣 FM」等产品名词，按照官方所定义的格式书写。</p><h3 id="中文与数字之间需要增加空格"><a href="#中文与数字之间需要增加空格" class="headerlink" title="中文与数字之间需要增加空格"></a>中文与数字之间需要增加空格</h3><p>正确：</p><blockquote><p>今天出去买菜花了 5000 元。</p></blockquote><p>错误：</p><blockquote><p>今天出去买菜花了 5000 元。</p><p>今天出去买菜花了 5000 元。</p></blockquote><h3 id="数字与单位之间需要增加空格"><a href="#数字与单位之间需要增加空格" class="headerlink" title="数字与单位之间需要增加空格"></a>数字与单位之间需要增加空格</h3><p>正确：</p><blockquote><p>我家的光纤入屋宽频有 10 Gbps，SSD 一共有 20 TB</p></blockquote><p>错误：</p><blockquote><p>我家的光纤入屋宽频有 10Gbps，SSD 一共有 20TB</p></blockquote><p>例外：度 / 百分比与数字之间不需要增加空格：</p><p>正确：</p><blockquote><p>今天是 233° 的高温。</p><p>新 MacBook Pro 有 15% 的 CPU 性能提升。</p></blockquote><p>错误：</p><blockquote><p>今天是 233 ° 的高温。</p><p>新 MacBook Pro 有 15 % 的 CPU 性能提升。</p></blockquote><h3 id="全角标点与其他字符之间不加空格"><a href="#全角标点与其他字符之间不加空格" class="headerlink" title="全角标点与其他字符之间不加空格"></a>全角标点与其他字符之间不加空格</h3><p>正确：</p><blockquote><p>刚刚买了一部 iPhone，好开心！</p></blockquote><p>错误：</p><blockquote><p>刚刚买了一部 iPhone ，好开心！</p><p>刚刚买了一部 iPhone， 好开心！</p></blockquote><h3 id="用-text-spacing-来挽救？"><a href="#用-text-spacing-来挽救？" class="headerlink" title="用 text-spacing 来挽救？"></a>用 <code>text-spacing</code> 来挽救？</h3><p>CSS Text Module Level 4 的 <a href="https://www.w3.org/TR/css-text-4/#text-spacing-property" target="_blank" rel="noopener"><code>text-spacing</code></a> 和 Microsoft 的 <a href="http://msdn.microsoft.com/en-us/library/ie/ms531164(v=vs.85" target="_blank" rel="noopener"><code>-ms-text-autospace</code></a>.aspx) 可以实现自动为中英文之间增加空白。不过目前并未普及，另外在其他应用场景，例如 macOS、iOS、Windows 等用户介面目前并不存在这个特性，所以请继续保持随手加空格的习惯。</p><h2 id="标点符号"><a href="#标点符号" class="headerlink" title="标点符号"></a>标点符号</h2><h3 id="不重复使用标点符号"><a href="#不重复使用标点符号" class="headerlink" title="不重复使用标点符号"></a>不重复使用标点符号</h3><p>正确：</p><blockquote><p>德国队竟然战胜了巴西队！</p><p>她竟然对你说「喵」？！</p></blockquote><p>错误：</p><blockquote><p>德国队竟然战胜了巴西队！！</p><p>德国队竟然战胜了巴西队！！！！！！！！</p><p>她竟然对你说「喵」？？！！</p><p>她竟然对你说「喵」？！？！？？！！</p></blockquote><h2 id="全角和半角"><a href="#全角和半角" class="headerlink" title="全角和半角"></a>全角和半角</h2><p>不明白什么是全角（全形）与半角（半形）符号？请查看维基百科词条『<a href="http://zh.wikipedia.org/wiki/%E5%85%A8%E5%BD%A2%E5%92%8C%E5%8D%8A%E5%BD%A2" target="_blank" rel="noopener">全形和半形</a>』。</p><h3 id="使用全角中文标点"><a href="#使用全角中文标点" class="headerlink" title="使用全角中文标点"></a>使用全角中文标点</h3><p>正确：</p><blockquote><p>嗨！你知道嘛？今天前台的小妹跟我说「喵」了哎！</p><p>核磁共振成像（NMRI）是什么原理都不知道？JFGI！</p></blockquote><p>错误：</p><blockquote><p>嗨! 你知道嘛? 今天前台的小妹跟我说 “喵” 了哎！</p><p>嗨! 你知道嘛? 今天前台的小妹跟我说 “喵” 了哎！</p><p>核磁共振成像 (NMRI) 是什么原理都不知道? JFGI!</p><p>核磁共振成像 (NMRI) 是什么原理都不知道? JFGI!</p></blockquote><h3 id="数字使用半角字符"><a href="#数字使用半角字符" class="headerlink" title="数字使用半角字符"></a>数字使用半角字符</h3><p>正确：</p><blockquote><p>这件蛋糕只卖 1000 元。</p></blockquote><p>错误：</p><blockquote><p>这件蛋糕只卖 １０００ 元。</p></blockquote><p>例外：在设计稿、宣传海报中如出现极少量数字的情形时，为方便文字对齐，是可以使用全形数字的。</p><h3 id="遇到完整的英文整句、特殊名词，其内容使用半角标点"><a href="#遇到完整的英文整句、特殊名词，其内容使用半角标点" class="headerlink" title="遇到完整的英文整句、特殊名词，其内容使用半角标点"></a>遇到完整的英文整句、特殊名词，其内容使用半角标点</h3><p>正确：</p><blockquote><p>贾伯斯那句话是怎么说的？「Stay hungry, stay foolish.」</p><p>推荐你阅读《Hackers &amp; Painters: Big Ideas from the Computer Age》，非常的有趣。</p></blockquote><p>错误：</p><blockquote><p>贾伯斯那句话是怎么说的？「Stay hungry，stay foolish。」</p><p>推荐你阅读《Hackers＆Painters：Big Ideas from the Computer Age》，非常的有趣。</p></blockquote><h2 id="名词"><a href="#名词" class="headerlink" title="名词"></a>名词</h2><h3 id="专有名词使用正确的大小写"><a href="#专有名词使用正确的大小写" class="headerlink" title="专有名词使用正确的大小写"></a>专有名词使用正确的大小写</h3><p>大小写相关用法原属于英文书写范畴，不属于本 wiki 讨论内容，在这里只对部分易错用法进行简述。</p><p>正确：</p><blockquote><p>使用 GitHub 登录</p><p>我们的客户有 GitHub、Foursquare、Microsoft Corporation、Google、Facebook, Inc.。</p></blockquote><p>错误：</p><blockquote><p>使用 github 登录</p><p>使用 GITHUB 登录</p><p>使用 Github 登录</p><p>使用 gitHub 登录</p><p>使用 gｲんĤЦ8 登录</p><p>我们的客户有 github、foursquare、microsoft corporation、google、facebook, inc.。</p><p>我们的客户有 GITHUB、FOURSQUARE、MICROSOFT CORPORATION、GOOGLE、FACEBOOK, INC.。</p><p>我们的客户有 Github、FourSquare、MicroSoft Corporation、Google、FaceBook, Inc.。</p><p>我们的客户有 gitHub、fourSquare、microSoft Corporation、google、faceBook, Inc.。</p><p>我们的客户有 gｲんĤЦ8、ｷouЯƧquﾑгє、๓เςг๏ร๏Ŧt ς๏гק๏гคtเ๏ภn、900913、ƒ4ᄃëв๏๏к, IПᄃ.。</p></blockquote><p>注意：当网页中需要配合整体视觉风格而出现全部大写／小写的情形，HTML 中请使用标淮的大小写规范进行书写；并通过 <code>text-transform: uppercase;</code>／<code>text-transform: lowercase;</code> 对表现形式进行定义。</p><h3 id="不要使用不地道的缩写"><a href="#不要使用不地道的缩写" class="headerlink" title="不要使用不地道的缩写"></a>不要使用不地道的缩写</h3><p>正确：</p><blockquote><p>我们需要一位熟悉 JavaScript、HTML5，至少理解一种框架（如 Backbone.js、AngularJS、React 等）的前端开发者。</p></blockquote><p>错误：</p><blockquote><p>我们需要一位熟悉 Js、h5，至少理解一种框架（如 backbone、angular、RJS 等）的 FED。</p></blockquote><h2 id="争议"><a href="#争议" class="headerlink" title="争议"></a>争议</h2><p>以下用法略带有个人色彩，即：无论是否遵循下述规则，从语法的角度来讲都是 <strong> 正确 </strong> 的。</p><h3 id="链接之间增加空格"><a href="#链接之间增加空格" class="headerlink" title="链接之间增加空格"></a>链接之间增加空格</h3><p>用法：</p><blockquote><p>请 <a href="#">提交一个 issue</a> 并分配给相关同事。</p><p>访问我们网站的最新动态，请 <a href="#">点击这里</a> 进行订阅！</p></blockquote><p>对比用法：</p><blockquote><p>请 <a href="#">提交一个 issue</a> 并分配给相关同事。</p><p>访问我们网站的最新动态，请 <a href="#">点击这里</a> 进行订阅！</p></blockquote><h3 id="简体中文使用直角引号"><a href="#简体中文使用直角引号" class="headerlink" title="简体中文使用直角引号"></a>简体中文使用直角引号</h3><p>用法：</p><blockquote><p>「老师，『有条不紊』的『紊』是什么意思？」</p></blockquote><p>对比用法：</p><blockquote><p>“老师，‘有条不紊’的‘紊’是什么意思？”</p></blockquote><h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><table><thead><tr><th>仓库</th><th>语言</th></tr></thead><tbody><tr><td><a href="https://github.com/vinta/paranoid-auto-spacing" target="_blank" rel="noopener">vinta/paranoid-auto-spacing</a></td><td>JavaScript</td></tr><tr><td><a href="https://github.com/huei90/pangu.node" target="_blank" rel="noopener">huei90/pangu.node</a></td><td>Node.js</td></tr><tr><td><a href="https://github.com/huacnlee/auto-correct" target="_blank" rel="noopener">huacnlee/auto-correct</a></td><td>Ruby</td></tr><tr><td><a href="https://github.com/sparanoid/space-lover" target="_blank" rel="noopener">sparanoid/space-lover</a></td><td>PHP (WordPress)</td></tr><tr><td><a href="https://github.com/NauxLiu/auto-correct" target="_blank" rel="noopener">nauxliu/auto-correct</a></td><td>PHP</td></tr><tr><td><a href="https://github.com/jxlwqq/chinese-typesetting" target="_blank" rel="noopener">jxlwqq/chinese-typesetting</a></td><td>PHP</td></tr><tr><td><a href="https://github.com/hotoo/pangu.vim" target="_blank" rel="noopener">hotoo/pangu.vim</a></td><td>Vim</td></tr><tr><td><a href="https://github.com/sparanoid/grunt-auto-spacing" target="_blank" rel="noopener">sparanoid/grunt-auto-spacing</a></td><td>Node.js (Grunt)</td></tr><tr><td><a href="https://github.com/hjiang/scripts/blob/master/add-space-between-latin-and-cjk" target="_blank" rel="noopener">hjiang/scripts/add-space-between-latin-and-cjk</a></td><td>Python</td></tr><tr><td><a href="https://github.com/hustcc/hint" target="_blank" rel="noopener">hustcc/hint</a></td><td>Python</td></tr></tbody></table><h2 id="谁在这样做？"><a href="#谁在这样做？" class="headerlink" title="谁在这样做？"></a>谁在这样做？</h2><table><thead><tr><th>网站</th><th>文案</th><th>UGC</th></tr></thead><tbody><tr><td><a href="http://www.apple.com/cn/" target="_blank" rel="noopener">Apple 中国</a></td><td>是</td><td>N/A</td></tr><tr><td><a href="http://www.apple.com/hk/" target="_blank" rel="noopener">Apple 香港</a></td><td>是</td><td>N/A</td></tr><tr><td><a href="http://www.apple.com/tw/" target="_blank" rel="noopener">Apple 台湾</a></td><td>是</td><td>N/A</td></tr><tr><td><a href="http://www.microsoft.com/zh-cn/" target="_blank" rel="noopener">Microsoft 中国</a></td><td>是</td><td>N/A</td></tr><tr><td><a href="http://www.microsoft.com/zh-hk/" target="_blank" rel="noopener">Microsoft 香港</a></td><td>是</td><td>N/A</td></tr><tr><td><a href="http://www.microsoft.com/zh-tw/" target="_blank" rel="noopener">Microsoft 台湾</a></td><td>是</td><td>N/A</td></tr><tr><td><a href="https://leancloud.cn/" target="_blank" rel="noopener">LeanCloud</a></td><td>是</td><td>N/A</td></tr><tr><td><a href="https://www.v2ex.com/" target="_blank" rel="noopener">V2EX</a></td><td>是</td><td>是</td></tr><tr><td><a href="http://apple4us.com/" target="_blank" rel="noopener">Apple4us</a></td><td>是</td><td>N/A</td></tr><tr><td><a href="https://ruby-china.org/" target="_blank" rel="noopener">Ruby China</a></td><td>是</td><td>标题达成</td></tr><tr><td><a href="https://phphub.org/" target="_blank" rel="noopener">PHPHub</a></td><td>是</td><td>标题达成</td></tr><tr><td><a href="http://sspai.com/" target="_blank" rel="noopener">少数派</a></td><td>是</td><td>N/A</td></tr></tbody></table><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul><li><a href="http://grammar.about.com/od/punctuationandmechanics/a/Guidelines-For-Using-Capital-Letters.htm" target="_blank" rel="noopener">Guidelines for Using Capital Letters - About.com</a></li><li><a href="http://en.wikipedia.org/wiki/Letter_case" target="_blank" rel="noopener">Letter case - Wikipedia</a></li><li><a href="http://www.oxforddictionaries.com/words/punctuation" target="_blank" rel="noopener">Punctuation - Oxford Dictionaries</a></li><li><a href="https://owl.english.purdue.edu/owl/section/1/6/" target="_blank" rel="noopener">Punctuation - The Purdue OWL</a></li><li><a href="http://www.wikihow.com/Use-English-Punctuation-Correctly" target="_blank" rel="noopener">How to Use English Punctuation Correctly - wikiHow</a></li><li><a href="https://zh.opensuse.org/index.php?title=Help:%E6%A0%BC%E5%BC%8F" target="_blank" rel="noopener">格式 - openSUSE</a></li><li><a href="http://zh.wikipedia.org/wiki/%E5%85%A8%E5%BD%A2%E5%92%8C%E5%8D%8A%E5%BD%A2" target="_blank" rel="noopener">全形和半形 - 维基百科</a></li><li><a href="http://zh.wikipedia.org/wiki/%E5%BC%95%E8%99%9F" target="_blank" rel="noopener">引号 - 维基百科</a></li><li><a href="http://zh.wikipedia.org/wiki/%E7%96%91%E5%95%8F%E9%A9%9A%E5%98%86%E8%99%9F" target="_blank" rel="noopener">疑问惊叹号 - 维基百科</a></li></ul>]]></content>
    
    <summary type="html">
    
      统一中文文案、排版的相关用法，降低团队成员之间的沟通成本，增强网站气质。
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Zabbix 常见问题整理</title>
    <link href="https://wsgzao.github.io/post/zabbix-faq/"/>
    <id>https://wsgzao.github.io/post/zabbix-faq/</id>
    <published>2019-03-05T06:59:49.000Z</published>
    <updated>2019-03-06T03:45:17.762Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>根据安装和使用 Zabbix 中遇到的常见报错提示，结合 Zabbix 官网和 Google 到的一些解决方案，简单做下分享</p><blockquote><p>Zabbix 常见问题整理</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 03 月 05 日 - 完善内容<br>2018 年 11 月 02 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/zabbix-faq/">https://wsgzao.github.io/post/zabbix-faq/</a></p><p><strong> 扩展阅读 </strong></p><p>Zabbix - <a href="https://www.zabbix.com/" target="_blank" rel="noopener">https://www.zabbix.com/</a></p><hr><h2 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h2><p>Frequently asked questions / Troubleshooting</p><p><a href="https://www.zabbix.org/wiki/Troubleshooting" target="_blank" rel="noopener">https://www.zabbix.org/wiki/Troubleshooting</a><br><a href="https://www.zabbix.com/documentation/current/manual/appendix/faq" target="_blank" rel="noopener">https://www.zabbix.com/documentation/current/manual/appendix/faq</a></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><blockquote><p>常见错误建议先查看 log，常见的问题通常由权限，防火墙，数据库，参数错误，性能瓶颈等问题导致</p></blockquote><p>zabbix_get [7189]: Check access restrictions in Zabbix agent configuration<br>zabbix 的服务器端与客户端连接的主要工具就是 zabbix 里 bin 文件夹下的 zabbix_get 文件，这个命令只能在 zabbix 的 server 端使用</p><p>Assuming that agent dropped connection because of access permissions（由于访问权限导致 agent 连接失败）<br>问题实现：zabbix_server 和 zabbix_agent 在同一台机器，server 监听全网地址，agent 监听内网地址。导致上面的报错发生<br>解决方案：把 zabbix_agentd.conf 中 的 server 把 zabbix_server 的公网和内网地址都加行。然后 agent 就可以正常获取到值了</p><p>解决 zabbix 中文乱码问题</p><p>方法一：下载文泉驿字体<br>yum -y install wqy-microhei-fonts<br>cp /usr/share/fonts/wqy-microhei/wqy-microhei.ttc /usr/share/fonts/dejavu/DejaVuSans.ttf</p><p>方法二：从 Windows 中拷贝<br>cd /usr/share/zabbix/fonts<br>从 windows 拷贝 simhei.ttf 字体到当前目录<br>替换配置文件<br>vim /usr/share/zabbix/include/defines.inc.php<br>define(‘ZBX_GRAPH_FONT_NAME’,           ‘simhei’)</p><p>Zabbix 报 No route to host<br>原来是被客户端的防火墙档掉了，关闭客户端防火墙或者配置相应规则即可</p><p>No active checks on server: host [] not found<br>查看监控机上的 / tmp/zabbix_server.log，显示日志：<br>cannot send list of active checks to [192.168.0.1]: host [Zabbix server] not found<br>查看被监控机上的 / tmp/zabbix_agentd.log，显示日志：<br>No active checks on server: host [Zabbix server] not found<br>这是因为通过 zabbix dashboard 页面配置的被监控主机名跟被监控主机上 zabbix_agentd.conf 中配置的 Hostname 不一致。修改为一致的名字后，重启 zabbix_agentd 即可。</p><p>Zabbix alerter processes more than 75% busy<br>zabbix 服务器邮件进程繁忙导致的，一般是因为在设置动作的时候，间隔太短，在一些特殊情况下，产生大量告警，例如几万封邮件，服务器发邮件，邮件进程发挂了。<br>建议通过导流解决。改发邮件的脚本，将邮件的动作改为打印时间，如下，待邮件都释放完了，再改回来。</p><p>Zabbix discoverer processes more than 75% busy<br>配置了自动发现的任务。每个自动发现的任务都会在一定时间内占用一个自动发现的进程。而默认配置项为 1，所以报警<br>修改配置文件的 StartDiscoverers 选项<br>StartDiscoverers=10</p><p>Zabbix poller processes more than 75% busy<br>轮询的负载量高，网上大多数说法是增加启动的 StartPollers 进程数，个人建议分析自己的 items 监控项设置是否合理，templates 模板应用是否恰当。<br>调整 StartPollers 数量<br>StartPollers=500<br>StartPollersUnreachable=100</p><p>Zabbix housekeeper processes more than 75% busy<br>为了防止数据库持续增大，zabbix 有个自动删除历史数据的机制，就是 housekeeper，而 mysql 数据库删数据的时候，性能会降低，就会报这个错。建议禁用采取数据库分区表优化自动清理。<br>HousekeepingFrequency=0            #间隔时间</p><p>2816:20170725:174352.675 [file:dbconfig.c,line:652] zbx_mem_realloc(): out of memory (requested 162664 bytes)<br>2816:20170725:174352.675 [file:dbconfig.c,line:652] zbx_mem_realloc(): please increase CacheSize configuration parameter<br>提示内存溢出，需要调整 zabbix 服务器配置 zabbix_server.conf<br>CacheSize=8G</p><p>PHP Fatal error: Allowed memory size of 134217728 bytes exhausted (tried to allocate 11 bytes)<br>zabbix 某些页面无法打开，查看 php 日志发现，当访问这个页面是，报错内存不足，不清楚是否内存泄露，最简单的方法是调大 php 进程的可用内存，memory_limit 默认值为 128M<br>grep ‘memory_limit’ /etc/httpd/conf.d/zabbix.conf<br>        php_value memory_limit 512M</p><p>Too many processes on zabbix server<br>zabbix 服务器进程太多报警，默认超过 300 个进程就报警。感觉默认值太小了，zabbix 配置调优后，进程就 500 多个了，所以我把触发值改为 600.</p><h2 id="zabbix-server-conf-中英文解释"><a href="#zabbix-server-conf-中英文解释" class="headerlink" title="zabbix_server.conf 中英文解释"></a>zabbix_server.conf 中英文解释</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is a configuration file for Zabbix server daemon</span></span><br><span class="line"><span class="comment"># To get more information about Zabbix, visit http://www.zabbix.com</span></span><br><span class="line"><span class="comment">############ GENERAL PARAMETERS #################</span></span><br><span class="line"><span class="comment">### Option: ListenPort</span></span><br><span class="line"><span class="comment">#   Listen port for trapper.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1024-32767</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明: 服务端监听端口用于接收二级代理或直连 AGENT 的采集数据 </span></span><br><span class="line"><span class="comment"># ListenPort=10051</span></span><br><span class="line"><span class="comment">### Option: SourceIP</span></span><br><span class="line"><span class="comment">#   Source IP address for outgoing connections.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：服务端监听 IP，建议指定</span></span><br><span class="line"><span class="comment"># SourceIP=</span></span><br><span class="line"><span class="comment">### Option: LogType</span></span><br><span class="line"><span class="comment">#   Specifies where log messages are written to:</span></span><br><span class="line"><span class="comment">#       system  - syslog</span></span><br><span class="line"><span class="comment">#       file    - file specified with LogFile parameter</span></span><br><span class="line"><span class="comment">#       console - standard output</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># LogType=file</span></span><br><span class="line"><span class="comment">### Option: LogFile</span></span><br><span class="line"><span class="comment">#   Log file name for LogType 'file' parameter.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># LogFile=</span></span><br><span class="line"><span class="comment"># 说明：zabbix 服务端日志路径，视具体情况指定</span></span><br><span class="line">LogFile=/tmp/zabbix_server.log</span><br><span class="line"><span class="comment">### Option: LogFileSize</span></span><br><span class="line"><span class="comment">#   Maximum size of log file in MB.</span></span><br><span class="line"><span class="comment">#   0 - disable automatic log rotation.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1024</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：日志达到多少 M 里就轮转；若此参数值为 0 时，则不轮转，日志将不断变大，建议设置成轮转</span></span><br><span class="line">LogFileSize=50</span><br><span class="line"><span class="comment">### Option: DebugLevel</span></span><br><span class="line"><span class="comment">#   Specifies debug level:</span></span><br><span class="line"><span class="comment">#   0 - basic information about starting and stopping of Zabbix processes</span></span><br><span class="line"><span class="comment">#   1 - critical information  灾难日志，日志量较少</span></span><br><span class="line"><span class="comment">#   2 - error information  错误级别，日志量大于 CRITICAL 级别</span></span><br><span class="line"><span class="comment">#   3 - warnings    告警级别，日志量大于 ERROR 级别</span></span><br><span class="line"><span class="comment">#   4 - for debugging (produces lots of information) 调试级别，日志量大于 WARNING</span></span><br><span class="line"><span class="comment">#   5 - extended debugging (produces even more information)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-5</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：日志级别 0~4，单位时间内生成日志的量不断增大</span></span><br><span class="line">DebugLevel=3</span><br><span class="line"><span class="comment">### Option: PidFile</span></span><br><span class="line"><span class="comment">#   Name of PID file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：zabbix 服务端程序 PID 路径</span></span><br><span class="line">PidFile=/tmp/zabbix_server.pid</span><br><span class="line"><span class="comment">### Option: DBHost</span></span><br><span class="line"><span class="comment">#   Database host name.</span></span><br><span class="line"><span class="comment">#   If set to localhost, socket is used for MySQL.</span></span><br><span class="line"><span class="comment">#   If set to empty string, socket is used for PostgreSQL.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：指定数据库信息，对于 mysql，若设置为 localhost 则 mysql 用 SOCKET 来连接(需配合参数 DBSocket 使用)，否则用 IP 连接；若 DHHOST 值为空，则默认连接 PostgreSQL</span></span><br><span class="line"><span class="comment"># DBHost=localhost</span></span><br><span class="line">DBHost=</span><br><span class="line"><span class="comment">### Option: DBName</span></span><br><span class="line"><span class="comment">#   Database name.</span></span><br><span class="line"><span class="comment">#   For SQLite3 path to database file must be provided. DBUser and DBPassword are ignored.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: yes</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># DBName=</span></span><br><span class="line"><span class="comment"># 说明：服务端连接数据库的库名</span></span><br><span class="line">DBName=</span><br><span class="line"><span class="comment">### Option: DBSchema</span></span><br><span class="line"><span class="comment">#   Schema name. Used for IBM DB2 and PostgreSQL.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：专门用于 IBM DB2 数据库的连接信息</span></span><br><span class="line"><span class="comment"># DBSchema=</span></span><br><span class="line"><span class="comment">### Option: DBUser</span></span><br><span class="line"><span class="comment">#   Database user. Ignored for SQLite.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：连接数据库的用户</span></span><br><span class="line"><span class="comment"># DBUser=</span></span><br><span class="line">DBUser=</span><br><span class="line"><span class="comment">### Option: DBPassword</span></span><br><span class="line"><span class="comment">#   Database password. Ignored for SQLite.</span></span><br><span class="line"><span class="comment">#   Comment this line if no password is used.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：连接数据库的密码</span></span><br><span class="line">DBPassword=</span><br><span class="line"><span class="comment">### Option: DBSocket</span></span><br><span class="line"><span class="comment">#   Path to MySQL socket.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：指定 MYSQL 的 SOCK 连接路径</span></span><br><span class="line">DBSocket=/tmp/mysql.sock</span><br><span class="line"><span class="comment">### Option: DBPort</span></span><br><span class="line"><span class="comment">#   Database port when not using local socket. Ignored for SQLite.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1024-65535</span></span><br><span class="line"><span class="comment"># Default (for MySQL):</span></span><br><span class="line"><span class="comment"># 说明：指定连接数据库的端口，默认 3306</span></span><br><span class="line">DBPort=3306</span><br><span class="line"><span class="comment">############ ADVANCED PARAMETERS ################</span></span><br><span class="line"><span class="comment"># 高级参数</span></span><br><span class="line"><span class="comment">### Option: StartPollers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of pollers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明; 初始化时，启动子进程数量，数量越多，则服务端吞吐能力越强，对系统资源消耗越大</span></span><br><span class="line">StartPollers=300</span><br><span class="line"><span class="comment">### Option: StartIPMIPollers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of IPMI pollers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 说明: 主要用于 IPmi 技术用于获取硬件状态场景。若无相关监控项，建议设置为 0</span></span><br><span class="line"><span class="comment"># StartIPMIPollers=0</span></span><br><span class="line"><span class="comment">### Option: StartPollersUnreachable</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of pollers for unreachable hosts (including IPMI and Java).</span></span><br><span class="line"><span class="comment">#   At least one poller for unreachable hosts must be running if regular, IPMI or Java pollers</span></span><br><span class="line"><span class="comment">#   are started.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：默认情况下，ZABBIX 会启用指定进程用于探测某些不可达主机的（含 IPMI 场景）；若使用场景中含有代理端，建议保持默认；若直接 agent 较多，可视具体情况调整</span></span><br><span class="line">StartPollersUnreachable=50</span><br><span class="line"><span class="comment">### Option: StartTrappers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of trappers.</span></span><br><span class="line"><span class="comment">#   Trappers accept incoming connections from Zabbix sender, active agents and active proxies.</span></span><br><span class="line"><span class="comment">#   At least one trapper process must be running to display server availability and view queue</span></span><br><span class="line"><span class="comment">#   in the frontend.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于设置诸如 SNMP STRAPPER 场景提交来的数据的接收进程数，若客户机 SNMP TRAPPER 技术较多，建议加大此参数值</span></span><br><span class="line">StartTrappers=50</span><br><span class="line"><span class="comment">### Option: StartPingers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of ICMP pingers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于设置启用 icmp 协议 PING 主机方式启动线程数量，若单台代理所管理机器超过 500 台，建议加大此数值</span></span><br><span class="line"><span class="comment"># StartPingers=10</span></span><br><span class="line"><span class="comment">### Option: StartDiscoverers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of discoverers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-250</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于设置自动发现主机的线程数量，若单台代理所管理机器超过 500 台，可以考虑加大此数值（仅适用于直接 AGENT 场景）</span></span><br><span class="line">StartDiscoverers=15</span><br><span class="line"><span class="comment">### Option: StartHTTPPollers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of HTTP pollers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于设置 WEB 拨测监控线程数，可视具体情况增加或减少此数值。</span></span><br><span class="line"><span class="comment"># StartHTTPPollers=1</span></span><br><span class="line"><span class="comment">### Option: StartTimers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of timers.</span></span><br><span class="line"><span class="comment">#   Timers process time-based trigger functions and maintenance periods.</span></span><br><span class="line"><span class="comment">#   Only the first timer process handles the maintenance periods.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：各实例计时器数量，主要用于触发器，标有维护标识的主机，但只第一个计时器用于计算维护标识主机。</span></span><br><span class="line"><span class="comment"># StartTimers=1</span></span><br><span class="line"><span class="comment">### Option: StartEscalators</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of escalators.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-100</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于处理动作中的步骤的进程，zabbix 动作较多时建议调大。</span></span><br><span class="line">StartEscalators=30</span><br><span class="line"><span class="comment">### Option: JavaGateway</span></span><br><span class="line"><span class="comment">#   IP address (or hostname) of Zabbix Java gateway.</span></span><br><span class="line"><span class="comment">#   Only required if Java pollers are started.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：JAVAGATEWAY 场景下使用</span></span><br><span class="line">JavaGateway=10.238.0.180</span><br><span class="line"><span class="comment">### Option: JavaGatewayPort</span></span><br><span class="line"><span class="comment">#   Port that Zabbix Java gateway listens on.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1024-32767</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：JAVAGATEWAY 场景下使用</span></span><br><span class="line">JavaGatewayPort=10052</span><br><span class="line"><span class="comment">### Option: StartJavaPollers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of Java pollers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：JAVAGATEWAY 场景下使用</span></span><br><span class="line">StartJavaPollers=30</span><br><span class="line"><span class="comment">### Option: StartVMwareCollectors</span></span><br><span class="line"><span class="comment">#   Number of pre-forked vmware collector instances.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-250</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于设置监控 VMWARE Esxi 主机实例时使用，若为 0 则不启用，若要监控 ESXI 主机，此值最少为 1 ；视监控 ESXI 数量设置对应数值</span></span><br><span class="line"><span class="comment"># StartVMwareCollectors=0</span></span><br><span class="line"><span class="comment">### Option: VMwareFrequency</span></span><br><span class="line"><span class="comment">#   How often Zabbix will connect to VMware service to obtain a new data.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 10-86400</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：代理端访问 VMWARE service 的频率，单位: 秒</span></span><br><span class="line"><span class="comment"># VMwareFrequency=60</span></span><br><span class="line"><span class="comment">### Option: VMwarePerfFrequency</span></span><br><span class="line"><span class="comment">#   How often Zabbix will connect to VMware service to obtain performance data.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 10-86400</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># VMwarePerfFrequency=60</span></span><br><span class="line"><span class="comment">### Option: VMwareCacheSize</span></span><br><span class="line"><span class="comment">#   Size of VMware cache, in bytes.</span></span><br><span class="line"><span class="comment">#   Shared memory size for storing VMware data.</span></span><br><span class="line"><span class="comment">#   Only used if VMware collectors are started.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 256K-2G</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：划出多少共享内存用于存储 VMWARE 数据</span></span><br><span class="line">VMwareCacheSize=256M</span><br><span class="line"><span class="comment">### Option: VMwareTimeout</span></span><br><span class="line"><span class="comment">#   Specifies how many seconds vmware collector waits for response from VMware service.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-300</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：等待 VMWare 返回数据的最长时间</span></span><br><span class="line">VMwareTimeout=10</span><br><span class="line"><span class="comment">### Option: SNMPTrapperFile</span></span><br><span class="line"><span class="comment">#   Temporary file used for passing data from SNMP trap daemon to the server.</span></span><br><span class="line"><span class="comment">#   Must be the same as in zabbix_trap_receiver.pl or SNMPTT configuration file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：指定 SNMP TRAPPER 时的临时文件，用于代理端启用 SNMP TRAPPER 功能时使用</span></span><br><span class="line"><span class="comment"># SNMPTrapperFile=/tmp/zabbix_traps.tmp</span></span><br><span class="line"><span class="comment">### Option: StartSNMPTrapper</span></span><br><span class="line"><span class="comment">#   If 1, SNMP trapper process is started.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：是否启用 snmptrapper 功能 ，默认不启用 = 0，启用 = 1（配合参数 SNMPTrapperFile 使用）</span></span><br><span class="line"><span class="comment"># StartSNMPTrapper=0</span></span><br><span class="line"><span class="comment">### Option: ListenIP</span></span><br><span class="line"><span class="comment">#   List of comma delimited IP addresses that the trapper should listen on.</span></span><br><span class="line"><span class="comment">#   Trapper will listen on all network interfaces if this parameter is missing.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：启用 SNMPTRAPPER 里 ，接收端监听的 IP，此参数与 StartSNMPTrapper，SNMPTrapperFile 联合使用</span></span><br><span class="line"><span class="comment"># ListenIP=0.0.0.0</span></span><br><span class="line">ListenIP=10.238.0.180</span><br><span class="line"><span class="comment">### Option: HousekeepingFrequency</span></span><br><span class="line"><span class="comment">#   How often Zabbix will perform housekeeping procedure (in hours).</span></span><br><span class="line"><span class="comment">#   Housekeeping is removing outdated information from the database.</span></span><br><span class="line"><span class="comment">#   To prevent Housekeeper from being overloaded, no more than 4 times HousekeepingFrequency</span></span><br><span class="line"><span class="comment">#   hours of outdated information are deleted in one housekeeping cycle, for each item.</span></span><br><span class="line"><span class="comment">#   To lower load on server startup housekeeping is postponed for 30 minutes after server start.</span></span><br><span class="line"><span class="comment">#   With HousekeepingFrequency=0 the housekeeper can be only executed using the runtime control option.</span></span><br><span class="line"><span class="comment">#   In this case the period of outdated information deleted in one housekeeping cycle is 4 times the</span></span><br><span class="line"><span class="comment">#   period since the last housekeeping cycle, but not less than 4 hours and not greater than 4 days.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-24</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：多少小时清理一次代理端数据库的 history, alert, and alarms，以保持代理端数据库轻便，建议保持默认</span></span><br><span class="line">HousekeepingFrequency=24</span><br><span class="line"><span class="comment">### Option: MaxHousekeeperDelete</span></span><br><span class="line"><span class="comment">#   The table "housekeeper" contains "tasks" for housekeeping procedure in the format:</span></span><br><span class="line"><span class="comment">#   [housekeeperid], [tablename], [field], [value].</span></span><br><span class="line"><span class="comment">#   No more than 'MaxHousekeeperDelete' rows (corresponding to [tablename], [field], [value])</span></span><br><span class="line"><span class="comment">#   will be deleted per one task in one housekeeping cycle.</span></span><br><span class="line"><span class="comment">#   SQLite3 does not use this parameter, deletes all corresponding rows without a limit.</span></span><br><span class="line"><span class="comment">#   If set to 0 then no limit is used at all. In this case you must know what you are doing!</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-1000000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明: 每个 HouseKeeper 任务删除的最大记录数，1.8.2 开始支持</span></span><br><span class="line">MaxHousekeeperDelete=1000000</span><br><span class="line"><span class="comment">### Option: SenderFrequency</span></span><br><span class="line"><span class="comment">#   How often Zabbix will try to send unsent alerts (in seconds).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 5-3600</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明: 多少秒后重试发送失败的报警信息</span></span><br><span class="line">SenderFrequency=30</span><br><span class="line"><span class="comment">### Option: CacheSize</span></span><br><span class="line"><span class="comment">#   Size of configuration cache, in bytes.</span></span><br><span class="line"><span class="comment">#   Shared memory size for storing host, item and trigger data.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 128K-8G</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明; zabbix 初始化时占用多少系统共享内存用于存储配置信息，HOST,ITEM,TRIGGER 数据，视监控主机数量和监控项调整，建议调整到 32M 或者更大</span></span><br><span class="line">CacheSize=8G</span><br><span class="line"><span class="comment">### Option: CacheUpdateFrequency</span></span><br><span class="line"><span class="comment">#   How often Zabbix will perform update of configuration cache, in seconds.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-3600</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：zabbix 更新操作系统 CACHE 频率，若管理页面操作不频繁，可以考虑加大参数值</span></span><br><span class="line">CacheUpdateFrequency=300</span><br><span class="line"><span class="comment">### Option: StartDBSyncers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of DB Syncers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-100</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明: 将采集数据从 CACHE 同步到数据库线程数量，视数据库服务器 I/O 繁忙情况，和数据库写能力调整。数值越大，写能力越强。对数据库服务器 I/O 压力越大。</span></span><br><span class="line">StartDBSyncers=20</span><br><span class="line"><span class="comment">### Option: HistoryCacheSize</span></span><br><span class="line"><span class="comment">#   Size of history cache, in bytes.</span></span><br><span class="line"><span class="comment">#   Shared memory size for storing history data.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 128K-2G</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于设置划分多少系统共享内存用于存储采集的历史数据，此数值越大，数据库读压力越小</span></span><br><span class="line">HistoryCacheSize=2048M</span><br><span class="line"><span class="comment">### Option: HistoryIndexCacheSize</span></span><br><span class="line"><span class="comment">#   Size of history index cache, in bytes.</span></span><br><span class="line"><span class="comment">#   Shared memory size for indexing history cache.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 128K-2G</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：3.0.0 开始支持，历史索引大小，一个监控项需要 100bytes 来存储</span></span><br><span class="line">HistoryIndexCacheSize=2048M</span><br><span class="line"><span class="comment">### Option: TrendCacheSize</span></span><br><span class="line"><span class="comment">#   Size of trend cache, in bytes.</span></span><br><span class="line"><span class="comment">#   Shared memory size for storing trends data.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 128K-2G</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：用于设置划分多少系统共享内存用于存储计算出来的趋势数据，此参数值从一定程度上可影响数据库读压力</span></span><br><span class="line">TrendCacheSize=512M</span><br><span class="line"><span class="comment">### Option: ValueCacheSize</span></span><br><span class="line"><span class="comment">#   Size of history value cache, in bytes.</span></span><br><span class="line"><span class="comment">#   Shared memory size for caching item history data requests.</span></span><br><span class="line"><span class="comment">#   Setting to 0 disables value cache.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0,128K-64G</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：划出系统多少共享内存用于已请求的存储监控项信息，若监控项较多，建议加大此数值</span></span><br><span class="line">ValueCacheSize=16G</span><br><span class="line"><span class="comment">### Option: Timeout</span></span><br><span class="line"><span class="comment">#   Specifies how long we wait for agent, SNMP device or external check (in seconds).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-30</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># Timeout=3</span></span><br><span class="line"><span class="comment"># 说明：与 AGNET\SNMP 设备和其它外部设备通信超时设置，单位为秒；若采集数据不完整或网络繁忙，或从管理页面发现客户端状态变化频繁，可以考虑加大此数值。注意若此数值加大，应该考虑参数 StartPollers 是否有相应加大的必要。</span></span><br><span class="line">Timeout=10</span><br><span class="line"><span class="comment">### Option: TrapperTimeout</span></span><br><span class="line"><span class="comment">#   Specifies how many seconds trapper may spend processing new data.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-300</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：启用 trapper 功能，用于进程等待超时设置。根据需要调整</span></span><br><span class="line">TrapperTimeout=50</span><br><span class="line"><span class="comment">### Option: UnreachablePeriod</span></span><br><span class="line"><span class="comment">#   After how many seconds of unreachability treat a host as unavailable.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-3600</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：当 AGNET 端处于不可用状态下，间隔多少秒后，尝试重新连接。建议根据具体情况设置。注意，若此数值过小，右 agent 端业务系统繁忙时，有可能造成报警信息误报</span></span><br><span class="line"><span class="comment"># UnreachablePeriod=45</span></span><br><span class="line"><span class="comment">### Option: UnavailableDelay</span></span><br><span class="line"><span class="comment">#   How often host is checked for availability during the unavailability period, in seconds.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-3600</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明: 当 AGENT 端处于可用状态下，间隔多少秒后，进行状态检查。若出现可正常采集数据，但管理页面 AGENT 状态不正常；若在网络，端口等均通畅情况下，AGENT 状态仍不正常，可以考虑加大此数值</span></span><br><span class="line"><span class="comment"># UnavailableDelay=60</span></span><br><span class="line"><span class="comment">### Option: UnreachableDelay</span></span><br><span class="line"><span class="comment">#   How often host is checked for availability during the unreachability period, in seconds.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-3600</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：当 agent 端处于不可达状态下，延迟多少秒后，进行重新尝试，建议保持默认，在 AGENT 接入调试阶段，可考虑减少此数值</span></span><br><span class="line"><span class="comment"># UnreachableDelay=15</span></span><br><span class="line"><span class="comment">### Option: AlertScriptsPath</span></span><br><span class="line"><span class="comment">#   Full path to location of custom alert scripts.</span></span><br><span class="line"><span class="comment">#   Default depends on compilation options.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：监控报警脚本路径，非研发人员不建议修改此参数值</span></span><br><span class="line"><span class="comment"># AlertScriptsPath=$&#123;datadir&#125;/zabbix/alertscripts</span></span><br><span class="line">AlertScriptsPath=/home/zabbix/bin</span><br><span class="line"><span class="comment">### Option: ExternalScripts</span></span><br><span class="line"><span class="comment">#   Full path to location of external scripts.</span></span><br><span class="line"><span class="comment">#   Default depends on compilation options.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：自定义脚本存储路径，非研发人员不建议修改此参数值</span></span><br><span class="line"><span class="comment"># ExternalScripts=$&#123;datadir&#125;/zabbix/externalscripts</span></span><br><span class="line"><span class="comment">### Option: FpingLocation</span></span><br><span class="line"><span class="comment">#   Location of fping.</span></span><br><span class="line"><span class="comment">#   Make sure that fping binary has root ownership and SUID flag set.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：IPv4 FPING 命令路径，仅 ROOT 可用。注意使用此命令时，应该确认此命令是否存在</span></span><br><span class="line">FpingLocation=/usr/sbin/fping</span><br><span class="line"><span class="comment">### Option: Fping6Location</span></span><br><span class="line"><span class="comment">#   Location of fping6.</span></span><br><span class="line"><span class="comment">#   Make sure that fping6 binary has root ownership and SUID flag set.</span></span><br><span class="line"><span class="comment">#   Make empty if your fping utility is capable to process IPv6 addresses.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：IPv6 FPING 命令路径，仅 ROOT 可用。注意使用此命令时，应该确认此命令是否存在</span></span><br><span class="line"><span class="comment"># Fping6Location=/usr/sbin/fping6</span></span><br><span class="line"><span class="comment">### Option: SSHKeyLocation</span></span><br><span class="line"><span class="comment">#   Location of public and private keys for SSH checks and actions.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：在服务端需要 SSH 到 AGENT 端且采用用 KEY 验证方式时使用。非研发人员，不建议修改或设置</span></span><br><span class="line"><span class="comment"># SSHKeyLocation=</span></span><br><span class="line"><span class="comment">### Option: LogSlowQueries</span></span><br><span class="line"><span class="comment">#   How long a database query may take before being logged (in milliseconds).</span></span><br><span class="line"><span class="comment">#   Only works if DebugLevel set to 3, 4 or 5.</span></span><br><span class="line"><span class="comment">#   0 - don't log slow queries.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-3600000</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明: 用于服务端数据库慢查询功能，单位是毫秒；1 毫秒 = 0.001 秒，若有服务端数据库监控慢查询的需求，可以视具体情况调整此数。</span></span><br><span class="line"><span class="comment"># LogSlowQueries=0</span></span><br><span class="line">LogSlowQueries=3000</span><br><span class="line"><span class="comment">### Option: TmpDir</span></span><br><span class="line"><span class="comment">#   Temporary directory.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：zabbix 服务端工作的临时目录</span></span><br><span class="line"><span class="comment"># TmpDir=/tmp</span></span><br><span class="line"><span class="comment">### Option: StartProxyPollers</span></span><br><span class="line"><span class="comment">#   Number of pre-forked instances of pollers for passive proxies.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 0-250</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明: 启用多少子进程与代理端通信，若代理端较多可考虑加大此数值</span></span><br><span class="line"><span class="comment"># StartProxyPollers=1</span></span><br><span class="line"><span class="comment">### Option: ProxyConfigFrequency</span></span><br><span class="line"><span class="comment">#   How often Zabbix Server sends configuration data to a Zabbix Proxy in seconds.</span></span><br><span class="line"><span class="comment">#   This parameter is used only for proxies in the passive mode.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-3600*24*7</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：zabbix 服务端将配置文件数据同步到代理端的频率，仅适用于代理端为被动模式情况下</span></span><br><span class="line"><span class="comment"># ProxyConfigFrequency=3600</span></span><br><span class="line"><span class="comment">### Option: ProxyDataFrequency</span></span><br><span class="line"><span class="comment">#   How often Zabbix Server requests history data from a Zabbix Proxy in seconds.</span></span><br><span class="line"><span class="comment">#   This parameter is used only for proxies in the passive mode.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Range: 1-3600</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：zabbix 服务端请求代理端采集的数据的频率，仅适用代理端为被动模式情况下</span></span><br><span class="line"><span class="comment"># ProxyDataFrequency=1</span></span><br><span class="line"><span class="comment">### Option: AllowRoot</span></span><br><span class="line"><span class="comment">#   Allow the server to run as'root'. If disabled and the server is started by'root', the server</span></span><br><span class="line"><span class="comment">#   will try to switch to the user specified by the User configuration option instead.</span></span><br><span class="line"><span class="comment">#   Has no effect if started under a regular user.</span></span><br><span class="line"><span class="comment">#   0 - do not allow 不允许</span></span><br><span class="line"><span class="comment">#   1 - allow 允许</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：是否允许以 root 身份运行服务端</span></span><br><span class="line">AllowRoot=1</span><br><span class="line"><span class="comment">### Option: User</span></span><br><span class="line"><span class="comment">#   Drop privileges to a specific, existing user on the system.</span></span><br><span class="line"><span class="comment">#   Only has effect if run as'root'and AllowRoot is disabled.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：非 root 运行的账号</span></span><br><span class="line"><span class="comment"># User=zabbix</span></span><br><span class="line"><span class="comment">### Option: Include</span></span><br><span class="line"><span class="comment">#   You may include individual files or all files in a directory in the configuration file.</span></span><br><span class="line"><span class="comment">#   Installing Zabbix will create include directory in /usr/local/etc, unless modified during the compile time.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：在一些情况下，软件的参数配置文件很长，为了方便管理，将配置文件切割成 N 个配置文件，但为了主配置参数文件的简洁，便会启用 INCLUDE 参数，以方便程序读取指定目录下的所有配置文件</span></span><br><span class="line"><span class="comment"># Include=</span></span><br><span class="line"><span class="comment"># Include=/usr/local/etc/zabbix_server.general.conf</span></span><br><span class="line"><span class="comment"># Include=/usr/local/etc/zabbix_server.conf.d/</span></span><br><span class="line"><span class="comment"># Include=/usr/local/etc/zabbix_server.conf.d/*.conf</span></span><br><span class="line"><span class="comment">### Option: SSLCertLocation</span></span><br><span class="line"><span class="comment">#   Location of SSL client certificates.</span></span><br><span class="line"><span class="comment">#   This parameter is used only in web monitoring.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：SSL 客户端认证文件，2.4 开始支持</span></span><br><span class="line"><span class="comment"># SSLCertLocation=$&#123;datadir&#125;/zabbix/ssl/certs</span></span><br><span class="line"><span class="comment">### Option: SSLKeyLocation</span></span><br><span class="line"><span class="comment">#   Location of private keys for SSL client certificates.</span></span><br><span class="line"><span class="comment">#   This parameter is used only in web monitoring.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：SSL 私钥文件目录，2.4 开始支持</span></span><br><span class="line"><span class="comment"># SSLKeyLocation=$&#123;datadir&#125;/zabbix/ssl/keys</span></span><br><span class="line"><span class="comment">### Option: SSLCALocation</span></span><br><span class="line"><span class="comment">#   Override the location of certificate authority (CA) files for SSL server certificate verification.</span></span><br><span class="line"><span class="comment">#   If not set, system-wide directory will be used.</span></span><br><span class="line"><span class="comment">#   This parameter is used only in web monitoring and SMTP authentication.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：SSL CA 钥文件目录，2.4 开始支持</span></span><br><span class="line"><span class="comment"># SSLCALocation=</span></span><br><span class="line"><span class="comment">####### LOADABLE MODULES #######</span></span><br><span class="line"><span class="comment"># 可加载的模块</span></span><br><span class="line"><span class="comment">### Option: LoadModulePath</span></span><br><span class="line"><span class="comment">#   Full path to location of server modules.</span></span><br><span class="line"><span class="comment">#   Default depends on compilation options.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 指定本地模块路径，非研发人员不建议修改</span></span><br><span class="line"><span class="comment"># LoadModulePath=$&#123;libdir&#125;/modules</span></span><br><span class="line"><span class="comment">### Option: LoadModule</span></span><br><span class="line"><span class="comment">#   Module to load at server startup. Modules are used to extend functionality of the server.</span></span><br><span class="line"><span class="comment">#   Format: LoadModule=&lt;module.so&gt;</span></span><br><span class="line"><span class="comment">#   The modules must be located in directory specified by LoadModulePath.</span></span><br><span class="line"><span class="comment">#   It is allowed to include multiple LoadModule parameters.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 指定本地模块路径，非研发人员不建议修改</span></span><br><span class="line"><span class="comment"># LoadModule=</span></span><br><span class="line"><span class="comment">####### TLS-RELATED PARAMETERS #######</span></span><br><span class="line"><span class="comment">#TLS 相关参数</span></span><br><span class="line"><span class="comment">### Option: TLSCAFile</span></span><br><span class="line"><span class="comment">#   Full pathname of a file containing the top-level CA(s) certificates for</span></span><br><span class="line"><span class="comment">#   peer certificate verification.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：TLS 证书文件</span></span><br><span class="line"><span class="comment"># TLSCAFile=</span></span><br><span class="line"><span class="comment">### Option: TLSCRLFile</span></span><br><span class="line"><span class="comment">#   Full pathname of a file containing revoked certificates.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：TLS 证书文件</span></span><br><span class="line"><span class="comment"># TLSCRLFile=</span></span><br><span class="line"><span class="comment">### Option: TLSCertFile</span></span><br><span class="line"><span class="comment">#   Full pathname of a file containing the server certificate or certificate chain.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：TLS 证书文件</span></span><br><span class="line"><span class="comment"># TLSCertFile=</span></span><br><span class="line"><span class="comment">### Option: TLSKeyFile</span></span><br><span class="line"><span class="comment">#   Full pathname of a file containing the server private key.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Mandatory: no</span></span><br><span class="line"><span class="comment"># Default:</span></span><br><span class="line"><span class="comment"># 说明：TLS 证书文件</span></span><br><span class="line"><span class="comment"># TLSKeyFile=</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      Zabbix常见问题整理
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Python 爬虫框架 Scrapy 入门与实践之爬取豆瓣电影 Top250 榜单</title>
    <link href="https://wsgzao.github.io/post/scrapy/"/>
    <id>https://wsgzao.github.io/post/scrapy/</id>
    <published>2019-03-02T07:59:49.000Z</published>
    <updated>2019-03-07T08:01:23.740Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>爬虫就是请求网站并提取数据的自动化程序，其中请求，提取，自动化是爬虫的关键。Python 作为一款出色的胶水语言自然成为了很多爬虫爱好者的首选，而使用 Python 开发的爬虫框架 Scrapy 当属目前最热门的解决方案之一。本文记录了目前网络上比较经典的 Scrapy 爬取豆瓣电影 Top250 榜单实践过程，作为 Python 爬虫框架 Scrapy 的入门案例。</p><blockquote><p>Python 爬虫框架 Scrapy 入门与实践之爬取豆瓣电影 Top250 榜单</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 03 月 02 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/scrapy/">https://wsgzao.github.io/post/scrapy/</a></p><p><strong> 扩展阅读 </strong></p><p>Scrapy - <a href="https://scrapy.org/" target="_blank" rel="noopener">https://scrapy.org/</a></p><hr><h2 id="什么是爬虫？"><a href="#什么是爬虫？" class="headerlink" title="什么是爬虫？"></a>什么是爬虫？</h2><p>网络爬虫（又被称为网页蜘蛛，网络机器人，在 FOAF 社区中间，更经常的称为网页追逐者），是一种按照一定的规则，自动地抓取万维网信息的程序或者脚本。另外一些不常使用的名字还有蚂蚁、自动索引、模拟程序或者蠕虫。</p><p>其实通俗的讲就是通过程序去获取 web 页面上自己想要的数据，也就是自动抓取数据</p><p>爬虫可以做什么？<br>你可以爬去妹子的图片，爬取自己想看看的视频。。等等你想要爬取的数据，只要你能通过浏览器访问的数据都可以通过爬虫获取</p><p>爬虫的本质是什么？<br>模拟浏览器打开网页，获取网页中我们想要的那部分数据</p><p>浏览器打开网页的过程：<br>当你在浏览器中输入地址后，经过 DNS 服务器找到服务器主机，向服务器发送一个请求，服务器经过解析后发送给用户浏览器结果，包括 html,js,css 等文件内容，浏览器解析出来最后呈现给用户在浏览器上看到的结果</p><p>所以用户看到的浏览器的结果就是由 HTML 代码构成的，我们爬虫就是为了获取这些内容，通过分析和过滤 html 代码，从中获取我们想要资源（文本，图片，视频…..）</p><h2 id="Python-爬虫的原理"><a href="#Python-爬虫的原理" class="headerlink" title="Python 爬虫的原理"></a>Python 爬虫的原理</h2><h3 id="爬虫的基本流程"><a href="#爬虫的基本流程" class="headerlink" title="爬虫的基本流程"></a>爬虫的基本流程</h3><p>发起请求<br>通过 HTTP 库向目标站点发起请求，也就是发送一个 Request，请求可以包含额外的 header 等信息，等待服务器响应</p><p>获取响应内容<br>如果服务器能正常响应，会得到一个 Response，Response 的内容便是所要获取的页面内容，类型可能是 HTML,Json 字符串，二进制数据（图片或者视频）等类型</p><p>解析内容<br>得到的内容可能是 HTML, 可以用正则表达式，页面解析库进行解析，可能是 Json, 可以直接转换为 Json 对象解析，可能是二进制数据，可以做保存或者进一步的处理</p><p>保存数据<br>保存形式多样，可以存为文本，也可以保存到数据库，或者保存特定格式的文件</p><h3 id="什么是-Request-Response"><a href="#什么是-Request-Response" class="headerlink" title="什么是 Request,Response"></a>什么是 Request,Response</h3><p>浏览器发送消息给网址所在的服务器，这个过程就叫做 HTPP Request</p><p>服务器收到浏览器发送的消息后，能够根据浏览器发送消息的内容，做相应的处理，然后把消息回传给浏览器，这个过程就是 HTTP Response</p><p>浏览器收到服务器的 Response 信息后，会对信息进行相应的处理，然后展示</p><blockquote><p>Request 中包含什么？</p></blockquote><p><strong> 请求方式 </strong></p><p>主要有：GET/POST 两种类型常用，另外还有 HEAD/PUT/DELETE/OPTIONS<br>GET 和 POST 的区别就是：请求的数据 GET 是在 url 中，POST 则是存放在头部</p><p>GET: 向指定的资源发出 “显示” 请求。使用 GET 方法应该只用在读取数据，而不应当被用于产生 “副作用” 的操作中，例如在 Web Application 中。其中一个原因是 GET 可能会被网络蜘蛛等随意访问</p><p>POST: 向指定资源提交数据，请求服务器进行处理（例如提交表单或者上传文件）。数据被包含在请求本文中。这个请求可能会创建新的资源或修改现有资源，或二者皆有。</p><p>HEAD：与 GET 方法一样，都是向服务器发出指定资源的请求。只不过服务器将不传回资源的本文部分。它的好处在于，使用这个方法可以在不必传输全部内容的情况下，就可以获取其中 “关于该资源的信息”（元信息或称元数据）。</p><p>PUT：向指定资源位置上传其最新内容。</p><p>OPTIONS：这个方法可使服务器传回该资源所支持的所有 HTTP 请求方法。用 ‘*’ 来代替资源名称，向 Web 服务器发送 OPTIONS 请求，可以测试服务器功能是否正常运作。</p><p>DELETE：请求服务器删除 Request-URI 所标识的资源。</p><p><strong> 请求 URL</strong></p><p>URL，即统一资源定位符，也就是我们说的网址，统一资源定位符是对可以从互联网上得到的资源的位置和访问方法的一种简洁的表示，是互联网上标准资源的地址。互联网上的每个文件都有一个唯一的 URL，它包含的信息指出文件的位置以及浏览器应该怎么处理它。</p><p>URL 的格式由三个部分组成：<br>第一部分是协议 (或称为服务方式)。<br>第二部分是存有该资源的主机 IP 地址 (有时也包括端口号)。<br>第三部分是主机资源的具体地址，如目录和文件名等。</p><p>爬虫爬取数据时必须要有一个目标的 URL 才可以获取数据，因此，它是爬虫获取数据的基本依据。</p><p><strong> 请求头 </strong></p><p>包含请求时的头部信息，如 User-Agent,Host,Cookies 等信息</p><p><strong> 请求体 </strong><br>请求是携带的数据，如提交表单数据时候的表单数据（POST）</p><blockquote><p>Response 中包含了什么</p></blockquote><p>所有 HTTP 响应的第一行都是状态行，依次是当前 HTTP 版本号，3 位数字组成的状态代码，以及描述状态的短语，彼此由空格分隔。</p><p><strong> 响应状态 </strong></p><p>有多种响应状态，如：200 代表成功，301 跳转，404 找不到页面，502 服务器错误</p><p>1xx 消息 —— 请求已被服务器接收，继续处理<br>2xx 成功 —— 请求已成功被服务器接收、理解、并接受<br>3xx 重定向 —— 需要后续操作才能完成这一请求<br>4xx 请求错误 —— 请求含有词法错误或者无法被执行<br>5xx 服务器错误 —— 服务器在处理某个正确请求时发生错误 </p><p>常见代码：<br>200 OK 请求成功<br>301 目标永久性转移<br>302 目标暂时性转移<br>400 Bad Request 客户端请求有语法错误，不能被服务器所理解<br>401 Unauthorized 请求未经授权，这个状态代码必须和 WWW-Authenticate 报头域一起使用<br>403 Forbidden 服务器收到请求，但是拒绝提供服务<br>404 Not Found 请求资源不存在，eg：输入了错误的 URL<br>500 Internal Server Error 服务器发生不可预期的错误<br>503 Server Unavailable 服务器当前不能处理客户端的请求，一段时间后可能恢复正常 </p><p><strong> 响应头 </strong></p><p>如内容类型，类型的长度，服务器信息，设置 Cookie</p><p><strong> 响应体 </strong></p><p>最主要的部分，包含请求资源的内容，如网页 HTMl, 图片，二进制数据等</p><h3 id="能爬取什么样的数据"><a href="#能爬取什么样的数据" class="headerlink" title="能爬取什么样的数据"></a>能爬取什么样的数据</h3><p>网页文本：如 HTML 文档，Json 格式化文本等<br>图片：获取到的是二进制文件，保存为图片格式<br>视频：同样是二进制文件<br>其他：只要请求到的，都可以获取</p><h3 id="如何解析数据"><a href="#如何解析数据" class="headerlink" title="如何解析数据"></a>如何解析数据</h3><p>直接处理<br>Json 解析<br>正则表达式处理<br>BeautifulSoup 解析处理<br>PyQuery 解析处理<br>XPath 解析处理</p><h3 id="关于抓取的页面数据和浏览器里看到的不一样的问题"><a href="#关于抓取的页面数据和浏览器里看到的不一样的问题" class="headerlink" title="关于抓取的页面数据和浏览器里看到的不一样的问题"></a>关于抓取的页面数据和浏览器里看到的不一样的问题</h3><p>出现这种情况是因为，很多网站中的数据都是通过 js，ajax 动态加载的，所以直接通过 get 请求获取的页面和浏览器显示的不同。</p><p>如何解决 js 渲染的问题？</p><p>分析 ajax<br>Selenium/webdriver<br>Splash<br>PyV8,Ghost.py</p><h3 id="怎样保存数据"><a href="#怎样保存数据" class="headerlink" title="怎样保存数据"></a>怎样保存数据</h3><p>文本：纯文本，Json,Xml 等</p><p>关系型数据库：如 mysql,oracle,sql server 等结构化数据库</p><p>非关系型数据库：MongoDB,Redis 等 key-value 形式存储</p><h2 id="Scrapy-简介"><a href="#Scrapy-简介" class="headerlink" title="Scrapy 简介"></a>Scrapy 简介</h2><p>Scrapy is an application framework for crawling web sites and extracting structured data which can be used for a wide range of useful applications, like data mining, information processing or historical archival.</p><p>Scrapy 是一个为了爬取网站数据，提取结构性数据而编写的应用框架。 可以应用在包括数据挖掘，信息处理或存储历史数据等一系列的程序中。</p><p>Scrapy Tutorial<br><a href="https://docs.scrapy.org/en/latest/intro/overview.html" target="_blank" rel="noopener">https://docs.scrapy.org/en/latest/intro/overview.html</a></p><h3 id="Scrapy-架构"><a href="#Scrapy-架构" class="headerlink" title="Scrapy 架构"></a>Scrapy 架构</h3><p><img src="https://ws4.sinaimg.cn/large/7207510dgy1g0oavg4q11j20jg0dqdi2.jpg" alt=""></p><p><strong>Scrapy Engine</strong><br>引擎负责控制数据流在系统中所有组件中流动，并在相应动作发生时触发事件。 详细内容查看下面的数据流 (Data Flow) 部分。</p><p>此组件相当于爬虫的 “大脑”，是整个爬虫的调度中心。</p><p><strong> 调度器 (Scheduler)</strong><br>调度器从引擎接受 request 并将他们入队，以便之后引擎请求他们时提供给引擎。</p><p>初始的爬取 URL 和后续在页面中获取的待爬取的 URL 将放入调度器中，等待爬取。同时调度器会自动去除重复的 URL（如果特定的 URL 不需要去重也可以通过设置实现，如 post 请求的 URL）</p><p><strong> 下载器 (Downloader)</strong><br>下载器负责获取页面数据并提供给引擎，而后提供给 spider。</p><p><strong>Spiders</strong><br>Spider 是 Scrapy 用户编写用于分析 response 并提取 item (即获取到的 item) 或额外跟进的 URL 的类。 每个 spider 负责处理一个特定 (或一些) 网站。</p><p><strong>Item Pipeline</strong><br>Item Pipeline 负责处理被 spider 提取出来的 item。典型的处理有清理、 验证及持久化 (例如存取到数据库中)。</p><p>当页面被爬虫解析所需的数据存入 Item 后，将被发送到项目管道 (Pipeline)，并经过几个特定的次序处理数据，最后存入本地文件或存入数据库。</p><p><strong> 下载器中间件 (Downloader middlewares)</strong><br>下载器中间件是在引擎及下载器之间的特定钩子 (specific hook)，处理 Downloader 传递给引擎的 response。 其提供了一个简便的机制，通过插入自定义代码来扩展 Scrapy 功能。</p><p>通过设置下载器中间件可以实现爬虫自动更换 user-agent、IP 等功能。</p><p><strong>Spider 中间件 (Spider middlewares)</strong><br>Spider 中间件是在引擎及 Spider 之间的特定钩子 (specific hook)，处理 spider 的输入 (response) 和输出 (items 及 requests)。 其提供了一个简便的机制，通过插入自定义代码来扩展 Scrapy 功能。</p><p><strong> 数据流 (Data flow)</strong></p><ol><li>引擎打开一个网站 (open a domain)，找到处理该网站的 Spider 并向该 spider 请求第一个要爬取的 URL (s)。</li><li>引擎从 Spider 中获取到第一个要爬取的 URL 并在调度器 (Scheduler) 以 Request 调度。</li><li>引擎向调度器请求下一个要爬取的 URL。</li><li>调度器返回下一个要爬取的 URL 给引擎，引擎将 URL 通过下载中间件 (请求 (request) 方向) 转发给下载器 (Downloader)。</li><li>一旦页面下载完毕，下载器生成一个该页面的 Response，并将其通过下载中间件 (返回 (response) 方向) 发送给引擎。</li><li>引擎从下载器中接收到 Response 并通过 Spider 中间件 (输入方向) 发送给 Spider 处理。</li><li>Spider 处理 Response 并返回爬取到的 Item 及 (跟进的) 新的 Request 给引擎。</li><li>引擎将 (Spider 返回的) 爬取到的 Item 给 Item Pipeline，将 (Spider 返回的) Request 给调度器。</li><li>(从第二步) 重复直到调度器中没有更多地 request，引擎关闭该网站。</li></ol><h2 id="Scrapy-爬取豆瓣电影-Top250-榜单"><a href="#Scrapy-爬取豆瓣电影-Top250-榜单" class="headerlink" title="Scrapy 爬取豆瓣电影 Top250 榜单"></a>Scrapy 爬取豆瓣电影 Top250 榜单</h2><p><a href="https://docs.scrapy.org/en/latest/intro/tutorial.html" target="_blank" rel="noopener">https://docs.scrapy.org/en/latest/intro/tutorial.html</a></p><p>工具和环境</p><ol><li>语言: Python 3.7</li><li>IDE: Pycharm</li><li>爬虫框架：Scrapy</li><li>浏览器: Google Chrome</li><li>浏览器插件: XPath Helper</li></ol><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>在开始爬取之前，首先要创建一个新的 Scrapy 项目。这里以爬取豆瓣电影 Top250 为例，进入你打算存储代码的目录中，运行下列命令:</p><pre><code>scrapy startproject douban</code></pre><p>该命令将会创建包含下列内容的 douban 目录:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">douban</span><br><span class="line">|-- __init__.py</span><br><span class="line">|-- __pycache__</span><br><span class="line">|   |-- __init__.cpython-37.pyc</span><br><span class="line">|   |-- items.cpython-37.pyc</span><br><span class="line">|   |-- pipelines.cpython-37.pyc</span><br><span class="line">|   `-- settings.cpython-37.pyc</span><br><span class="line">|-- items.py</span><br><span class="line">|-- middlewares.py</span><br><span class="line">|-- pipelines.py</span><br><span class="line">|-- settings.py</span><br><span class="line">`-- spiders</span><br><span class="line">    |-- __init__.py</span><br><span class="line">    |-- __pycache__</span><br><span class="line">    |   |-- __init__.cpython-37.pyc</span><br><span class="line">    |   `-- douban_spider.cpython-37.pyc</span><br><span class="line">    `-- douban_spider.py</span><br><span class="line"></span><br><span class="line">3 directories, 13 files</span><br></pre></td></tr></table></figure><p>这些文件分别是:</p><ul><li>scrapy.cfg: 项目的配置文件。</li><li>douban/: 该项目的 python 模块。之后您将在此加入代码。</li><li>douban/items.py: 项目中的 item 文件。定义我们所要爬取的信息的相关属性。</li><li>douban/pipelines.py: 项目中的 pipelines 文件。当数据被爬虫爬取下来后，它会被发送到 item pipelines 中，每个 item pipelines 组件（有时称为 “项目管道”）是一个实现简单方法的 Python 类。他们收到一个项目并对其执行操作，还决定该项目是否应该继续通过管道或被丢弃并且不再被处理。</li><li>douban/settings.py: 项目的设置文件。</li><li>douban/spiders/: 放置 spider 代码的目录。</li></ul><h3 id="观察页面结构"><a href="#观察页面结构" class="headerlink" title="观察页面结构"></a>观察页面结构</h3><p>首先我们打开豆瓣电影 TOP250 的页面，通过观察页面决定让我们的爬虫获取每一部电影的排名、电影名称、评分和评分的人数。<br><a href="https://movie.douban.com/top250" target="_blank" rel="noopener">https://movie.douban.com/top250</a></p><p>运行 Chrome F12 开发者工具，使用选取工具选取整个电影的信息，可以发现，所有的信息都是放在单独的一个 li 标签中的，而且在 li 下还有一个 class 为 item 的 div 包裹着所有的信息。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"pic"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">em</span> <span class="attr">class</span>=<span class="string">""</span>&gt;</span>1<span class="tag">&lt;/<span class="name">em</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://movie.douban.com/subject/1292052/"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">img</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">alt</span>=<span class="string">" 肖申克的救赎 "</span> <span class="attr">src</span>=<span class="string">"https://img3.doubanio.com/view/photo/s_ratio_poster/public/p480747492.webp"</span> <span class="attr">class</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"hd"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://movie.douban.com/subject/1292052/"</span> <span class="attr">class</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span> 肖申克的救赎 < span class="tag">&lt;/<span class="name">span</span>&gt;</span><br><span class="line">                                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span>&amp;nbsp;/&amp;nbsp;The Shawshank Redemption<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"other"</span>&gt;</span>&amp;nbsp;/&amp;nbsp; 月黑高飞 (港)  /  刺激 1995 (台)<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"playable"</span>&gt;</span>[可播放]<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"bd"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">                            导演：弗兰克・德拉邦特 Frank Darabont&amp;nbsp;&amp;nbsp;&amp;nbsp; 主演：蒂姆・罗宾斯 Tim Robbins /...<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                            1994&amp;nbsp;/&amp;nbsp; 美国 & amp;nbsp;/&amp;nbsp; 犯罪 剧情 </span><br><span class="line">                        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        </span><br><span class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"star"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"rating5-t"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"rating_num"</span> <span class="attr">property</span>=<span class="string">"v:average"</span>&gt;</span>9.6<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">property</span>=<span class="string">"v:best"</span> <span class="attr">content</span>=<span class="string">"10.0"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span>&gt;</span>1338863 人评价 < span class="tag">&lt;/<span class="name">span</span>&gt;</span><br><span class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"quote"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"inq"</span>&gt;</span> 希望让人自由。<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="声明-Item"><a href="#声明-Item" class="headerlink" title="声明 Item"></a>声明 Item</h3><p>什么是 Items 呢？官方文档 Items 定义如下：</p><p>爬取的主要目标就是从非结构性的数据源提取结构性数据，例如网页。 Scrapy spider 可以以 python 的 dict 来返回提取的数据。虽然 dict 很方便，并且用起来也熟悉，但是其缺少结构性，容易打错字段的名字或者返回不一致的数据，尤其在具有多个 spider 的大项目中。</p><p>为了定义常用的输出数据，Scrapy 提供了 Item 类。 Item 对象是种简单的容器，保存了爬取到得数据。 其提供了 类似于词典 (dictionary-like) 的 API 以及用于声明可用字段的简单语法。</p><p>许多 Scrapy 组件使用了 Item 提供的额外信息: exporter 根据 Item 声明的字段来导出数据、 序列化可以通过 Item 字段的元数据 (metadata) 来定义、 trackref 追踪 Item 实例来帮助寻找内存泄露 (see 使用 trackref 调试内存泄露) 等等。</p><p>Item 使用简单的 class 定义语法以及 Field 对象来声明。我们打开 spider 目录下的 items.py 文件写入下列代码声明 Item：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define here the models for your scraped items</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See documentation in:</span></span><br><span class="line"><span class="comment"># https://doc.scrapy.org/en/latest/topics/items.html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoubanItem</span><span class="params">(scrapy.Item)</span>:</span></span><br><span class="line">    <span class="comment"># define the fields for your item here like:</span></span><br><span class="line">    <span class="comment"># name = scrapy.Field()</span></span><br><span class="line">    serial_number = scrapy.Field()</span><br><span class="line">    movie_name = scrapy.Field()</span><br><span class="line">    introduce = scrapy.Field()</span><br><span class="line">    star = scrapy.Field()</span><br><span class="line">    evaluate = scrapy.Field()</span><br><span class="line">    describe = scrapy.Field()</span><br></pre></td></tr></table></figure><h3 id="编写爬虫程序"><a href="#编写爬虫程序" class="headerlink" title="编写爬虫程序"></a>编写爬虫程序</h3><p>在编写代码前我们可以通过修改 settings.py 文件调整 user-agent 和其它参数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Scrapy settings for douban project</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For simplicity, this file contains only settings considered important or</span></span><br><span class="line"><span class="comment"># commonly used. You can find more settings consulting the documentation:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     https://doc.scrapy.org/en/latest/topics/settings.html</span></span><br><span class="line"><span class="comment">#     https://doc.scrapy.org/en/latest/topics/downloader-middleware.html</span></span><br><span class="line"><span class="comment">#     https://doc.scrapy.org/en/latest/topics/spider-middleware.html</span></span><br><span class="line"></span><br><span class="line">BOT_NAME = <span class="string">'douban'</span></span><br><span class="line"></span><br><span class="line">SPIDER_MODULES = [<span class="string">'douban.spiders'</span>]</span><br><span class="line">NEWSPIDER_MODULE = <span class="string">'douban.spiders'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Crawl responsibly by identifying yourself (and your website) on the user-agent</span></span><br><span class="line">USER_AGENT = <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Obey robots.txt rules</span></span><br><span class="line">ROBOTSTXT_OBEY = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure a delay for requests for the same website (default: 0)</span></span><br><span class="line"><span class="comment"># See https://doc.scrapy.org/en/latest/topics/settings.html#download-delay</span></span><br><span class="line"><span class="comment"># See also autothrottle settings and docs</span></span><br><span class="line">DOWNLOAD_DELAY = <span class="number">0.5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure item pipelines</span></span><br><span class="line"><span class="comment"># See https://doc.scrapy.org/en/latest/topics/item-pipeline.html</span></span><br><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">   <span class="string">'douban.pipelines.DoubanPipeline'</span>: <span class="number">300</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mongo_host = <span class="string">'127.0.0.1'</span></span><br><span class="line">mongo_port = <span class="number">27017</span></span><br><span class="line">mongo_db_name = <span class="string">'douban'</span></span><br><span class="line">mongo_db_collection = <span class="string">'douban_movie'</span></span><br></pre></td></tr></table></figure><p>在 spiders 文件夹下创建 douban_spider.py 文件</p><p>在我们编写爬虫之前，先了解一下 scrapy 的爬取机制，scrapy 提取数据有自己的一套机制。它们被称作选择器 (seletors)，因为他们通过特定的 XPath 或者 CSS 表达式来 “选择” HTML 文件中的某个部分。</p><p>Xpath 学习教程<br><a href="http://www.w3school.com.cn/xpath/index.asp" target="_blank" rel="noopener">http://www.w3school.com.cn/xpath/index.asp</a></p><p>XPath Helper<br><a href="https://chrome.google.com/webstore/detail/xpath-helper/hgimnogjllphhhkhlmebbmlgjoejdpjl" target="_blank" rel="noopener">https://chrome.google.com/webstore/detail/xpath-helper/hgimnogjllphhhkhlmebbmlgjoejdpjl</a></p><p>Scrapy xpath-tutorial<br><a href="https://doc.scrapy.org/en/xpath-tutorial/topics/xpath-tutorial.html" target="_blank" rel="noopener">https://doc.scrapy.org/en/xpath-tutorial/topics/xpath-tutorial.html</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> douban.items <span class="keyword">import</span> DoubanItem</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoubanSpiderSpider</span><span class="params">(scrapy.Spider)</span>:</span></span><br><span class="line">    name = <span class="string">'douban_spider'</span></span><br><span class="line">    allowed_domains = [<span class="string">'movie.douban.com'</span>]</span><br><span class="line">    start_urls = [<span class="string">'https://movie.douban.com/top250'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        movie_list = response.xpath(<span class="string">"//div[@class='article']//ol[@class='grid_view']/li"</span>)</span><br><span class="line">        <span class="keyword">for</span> i_item <span class="keyword">in</span> movie_list:</span><br><span class="line">            douban_item = DoubanItem()</span><br><span class="line">            douban_item[<span class="string">'serial_number'</span>] = i_item.xpath(<span class="string">".//div[@class='item']//em/text()"</span>).extract_first()</span><br><span class="line">            douban_item[<span class="string">'movie_name'</span>] = i_item.xpath(<span class="string">".//div[@class='info']/div[@class='hd']/a/span[1]/text()"</span>).extract_first()</span><br><span class="line">            content = i_item.xpath(<span class="string">".//div[@class='info']//div[@class='bd']/p[1]/text()"</span>).extract()</span><br><span class="line">            <span class="keyword">for</span> i_content <span class="keyword">in</span> content:</span><br><span class="line">                content_s = <span class="string">""</span>.join(i_content.split())</span><br><span class="line">                douban_item[<span class="string">'introduce'</span>] = content_s</span><br><span class="line">            douban_item[<span class="string">'star'</span>] =  i_item.xpath(<span class="string">".//span[@class='rating_num']/text()"</span>).extract_first()</span><br><span class="line">            douban_item[<span class="string">'evaluate'</span>] = i_item.xpath(<span class="string">".//div[@class='star']//span[4]/text()"</span>).extract_first()</span><br><span class="line">            douban_item[<span class="string">'describe'</span>] = i_item.xpath(<span class="string">".//p[@class='quote']//span/text()"</span>).extract_first()</span><br><span class="line">            <span class="keyword">yield</span> douban_item</span><br><span class="line">        next_link = response.xpath(<span class="string">"//span[@class='next']/link/@href"</span>).extract()</span><br><span class="line">        <span class="keyword">if</span> next_link:</span><br><span class="line">            next_link = next_link[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">yield</span> scrapy.Request(<span class="string">"https://movie.douban.com/top250"</span>+next_link,callback=self.parse)</span><br></pre></td></tr></table></figure><p>自动翻页<br>先别急着高兴，你难道没有发现一个问题吗？这样的话我们还是只能爬到当前页的 25 个电影的内容。怎么样才能把剩下的也一起爬下来呢？</p><p>实现自动翻页一般有两种方法：</p><ol><li>在页面中找到下一页的地址；</li><li>自己根据 URL 的变化规律构造所有页面地址。</li></ol><p>一般情况下我们使用第一种方法，第二种方法适用于页面的下一页地址为 JS 加载的情况。这次我们只说第一种方法。</p><p>首先利用 Chrome 浏览器的开发者工具找到下一页的地址，然后在解析该页面时获取下一页的地址并将地址交给调度器 (Scheduler)</p><h3 id="运行爬虫"><a href="#运行爬虫" class="headerlink" title="运行爬虫"></a>运行爬虫</h3><p>scrapy crawl douban_spider</p><p>scrapy crawl douban_spider -o douban.csv</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">(venv)  wangao@wangao-MAC  ~/Documents/git/wangao/python3/scrapy/douban  python -V</span><br><span class="line">Python 3.7.1</span><br><span class="line">(venv)  wangao@wangao-MAC  ~/Documents/git/wangao/python3/scrapy/douban  scrapy crawl douban_spider -o douban.csv</span><br><span class="line">2019-03-02 15:37:56 [scrapy.utils.log] INFO: Scrapy 1.5.1 started (bot: douban)</span><br><span class="line">2019-03-02 15:37:56 [scrapy.utils.log] INFO: Versions: lxml 4.2.5.0, libxml2 2.9.8, cssselect 1.0.3, parsel 1.5.1, w3lib 1.19.0, Twisted 18.9.0, Python 3.7.1 (default, Nov  6 2018, 18:46:03) - [Clang 10.0.0 (clang-1000.11.45.5)], pyOpenSSL 18.0.0 (OpenSSL 1.1.0j  20 Nov 2018), cryptography 2.4.2, Platform Darwin-18.2.0-x86_64-i386-64bit</span><br><span class="line">2019-03-02 15:37:56 [scrapy.crawler] INFO: Overridden settings: &#123;<span class="string">'BOT_NAME'</span>: <span class="string">'douban'</span>, <span class="string">'DOWNLOAD_DELAY'</span>: 0.5, <span class="string">'FEED_FORMAT'</span>: <span class="string">'csv'</span>, <span class="string">'FEED_URI'</span>: <span class="string">'douban.csv'</span>, <span class="string">'NEWSPIDER_MODULE'</span>: <span class="string">'douban.spiders'</span>, <span class="string">'SPIDER_MODULES'</span>: [<span class="string">'douban.spiders'</span>], <span class="string">'USER_AGENT'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>&#125;</span><br><span class="line">2019-03-02 15:37:56 [scrapy.middleware] INFO: Enabled extensions:</span><br><span class="line">[<span class="string">'scrapy.extensions.corestats.CoreStats'</span>,</span><br><span class="line"> <span class="string">'scrapy.extensions.telnet.TelnetConsole'</span>,</span><br><span class="line"> <span class="string">'scrapy.extensions.memusage.MemoryUsage'</span>,</span><br><span class="line"> <span class="string">'scrapy.extensions.feedexport.FeedExporter'</span>,</span><br><span class="line"> <span class="string">'scrapy.extensions.logstats.LogStats'</span>]</span><br><span class="line">2019-03-02 15:37:56 [scrapy.middleware] INFO: Enabled downloader middlewares:</span><br><span class="line">[<span class="string">'scrapy.downloadermiddlewares.httpauth.HttpAuthMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.downloadtimeout.DownloadTimeoutMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.defaultheaders.DefaultHeadersMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.useragent.UserAgentMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.retry.RetryMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.redirect.MetaRefreshMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.httpcompression.HttpCompressionMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.redirect.RedirectMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.cookies.CookiesMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.httpproxy.HttpProxyMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.stats.DownloaderStats'</span>]</span><br><span class="line">2019-03-02 15:37:56 [scrapy.middleware] INFO: Enabled spider middlewares:</span><br><span class="line">[<span class="string">'scrapy.spidermiddlewares.httperror.HttpErrorMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.spidermiddlewares.offsite.OffsiteMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.spidermiddlewares.referer.RefererMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.spidermiddlewares.urllength.UrlLengthMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.spidermiddlewares.depth.DepthMiddleware'</span>]</span><br><span class="line">2019-03-02 15:37:56 [scrapy.middleware] INFO: Enabled item pipelines:</span><br><span class="line">[<span class="string">'douban.pipelines.DoubanPipeline'</span>]</span><br><span class="line">2019-03-02 15:37:56 [scrapy.core.engine] INFO: Spider opened</span><br><span class="line">2019-03-02 15:37:56 [scrapy.extensions.logstats] INFO: Crawled 0 pages (at 0 pages/min), scraped 0 items (at 0 items/min)</span><br><span class="line">2019-03-02 15:37:56 [scrapy.extensions.telnet] DEBUG: Telnet console listening on 127.0.0.1:6023</span><br><span class="line">^C2019-03-02 15:37:56 [scrapy.crawler] INFO: Received SIGINT, shutting down gracefully. Send again to force </span><br><span class="line">2019-03-02 15:37:56 [scrapy.core.engine] INFO: Closing spider (shutdown)</span><br><span class="line">2019-03-02 15:37:58 [scrapy.core.engine] DEBUG: Crawled (200) &lt;GET https://movie.douban.com/top250&gt; (referer: None)</span><br><span class="line">2019-03-02 15:37:58 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://movie.douban.com/top250&gt;</span><br><span class="line">&#123;<span class="string">'describe'</span>: <span class="string">'希望让人自由。'</span>,</span><br><span class="line"> <span class="string">'evaluate'</span>: <span class="string">'1338863 人评价'</span>,</span><br><span class="line"> <span class="string">'introduce'</span>: <span class="string">'1994 / 美国 / 犯罪剧情'</span>,</span><br><span class="line"> <span class="string">'movie_name'</span>: <span class="string">'肖申克的救赎'</span>,</span><br><span class="line"> <span class="string">'serial_number'</span>: <span class="string">'1'</span>,</span><br><span class="line"> <span class="string">'star'</span>: <span class="string">'9.6'</span>&#125;</span><br><span class="line">2019-03-02 15:37:58 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://movie.douban.com/top250&gt;</span><br><span class="line">&#123;<span class="string">'describe'</span>: <span class="string">'风华绝代。'</span>,</span><br><span class="line"> <span class="string">'evaluate'</span>: <span class="string">'989216 人评价'</span>,</span><br><span class="line"> <span class="string">'introduce'</span>: <span class="string">'1993 / 中国大陆香港 / 剧情爱情同性'</span>,</span><br><span class="line"> <span class="string">'movie_name'</span>: <span class="string">'霸王别姬'</span>,</span><br><span class="line"> <span class="string">'serial_number'</span>: <span class="string">'2'</span>,</span><br><span class="line"> <span class="string">'star'</span>: <span class="string">'9.6'</span>&#125;</span><br><span class="line">2019-03-02 15:37:58 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://movie.douban.com/top250&gt;</span><br><span class="line">&#123;<span class="string">'describe'</span>: <span class="string">'怪蜀黍和小萝莉不得不说的故事。'</span>,</span><br><span class="line"> <span class="string">'evaluate'</span>: <span class="string">'1225142 人评价'</span>,</span><br><span class="line"> <span class="string">'introduce'</span>: <span class="string">'1994 / 法国 / 剧情动作犯罪'</span>,</span><br><span class="line"> <span class="string">'movie_name'</span>: <span class="string">'这个杀手不太冷'</span>,</span><br><span class="line"> <span class="string">'serial_number'</span>: <span class="string">'3'</span>,</span><br><span class="line"> <span class="string">'star'</span>: <span class="string">'9.4'</span>&#125;</span><br><span class="line">2019-03-02 15:37:58 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://movie.douban.com/top250&gt;</span><br><span class="line">&#123;<span class="string">'describe'</span>: <span class="string">'一部美国近现代史。'</span>,</span><br><span class="line"> <span class="string">'evaluate'</span>: <span class="string">'1054616 人评价'</span>,</span><br><span class="line"> <span class="string">'introduce'</span>: <span class="string">'1994 / 美国 / 剧情爱情'</span>,</span><br><span class="line"> <span class="string">'movie_name'</span>: <span class="string">'阿甘正传'</span>,</span><br><span class="line"> <span class="string">'serial_number'</span>: <span class="string">'4'</span>,</span><br><span class="line"> <span class="string">'star'</span>: <span class="string">'9.4'</span>&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">describe,evaluate,introduce,movie_name,serial_number,star</span><br><span class="line"> 希望让人自由。,1338863 人评价, 1994 / 美国 / 犯罪剧情, 肖申克的救赎, 1,9.6</span><br><span class="line"> 风华绝代。,989216 人评价, 1993 / 中国大陆香港 / 剧情爱情同性, 霸王别姬, 2,9.6</span><br><span class="line"> 怪蜀黍和小萝莉不得不说的故事。,1224747 人评价, 1994 / 法国 / 剧情动作犯罪, 这个杀手不太冷, 3,9.4</span><br><span class="line"> 一部美国近现代史。,1054616 人评价, 1994 / 美国 / 剧情爱情, 阿甘正传, 4,9.4</span><br><span class="line"> 最美的谎言。,617064 人评价, 1997 / 意大利 / 剧情喜剧爱情战争, 美丽人生, 5,9.5</span><br><span class="line"> 失去的才是永恒的。 ,993900 人评价, 1997 / 美国 / 剧情爱情灾难, 泰坦尼克号, 6,9.3</span><br><span class="line"> 最好的宫崎骏，最好的久石让。 ,981959 人评价, 2001 / 日本 / 剧情动画奇幻, 千与千寻, 7,9.3</span><br><span class="line"> 拯救一个人，就是拯救整个世界。,550815 人评价, 1993 / 美国 / 剧情历史战争, 辛德勒的名单, 8,9.5</span><br><span class="line"> 诺兰给了我们一场无法盗取的梦。,1067442 人评价, 2010 / 美国英国 / 剧情科幻悬疑冒险, 盗梦空间, 9,9.3</span><br></pre></td></tr></table></figure><h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p>Scrapy 爬虫框架掌握好可以事半功倍，但是遇到简单的需求未必需要使用框架去解决。关于 IP 代理中间件，写入数据库，Web 前台展示等需求都是非常值得延伸的内容，希望大家通过爬虫豆瓣电影 Top250 这个入门项目开个学习的好头。</p>]]></content>
    
    <summary type="html">
    
      Python爬虫框架Scrapy入门与实践之爬取豆瓣电影Top250榜单
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>基于 Keepalived 搭建 Zabbix Server HA 双机高可用</title>
    <link href="https://wsgzao.github.io/post/zabbix-ha/"/>
    <id>https://wsgzao.github.io/post/zabbix-ha/</id>
    <published>2019-03-02T06:59:49.000Z</published>
    <updated>2019-03-13T03:13:55.852Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前使用 Zabbix 被动模式存在单点风险，借助这次 Zabbix 4.0 LTS 主动模式改造的机会，使用 Keepalived 搭建 Zabbix Server HA 双击高可用架构，简单记录下做 HA 的过程以备参考。</p><blockquote><p>基于 Keepalived 搭建 Zabbix Server HA 双机高可用</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 03 月 02 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/zabbix-ha/">https://wsgzao.github.io/post/zabbix-ha/</a></p><p><strong> 扩展阅读 </strong></p><p>Zabbix - <a href="https://www.zabbix.com/" target="_blank" rel="noopener">https://www.zabbix.com/</a></p><hr><h2 id="Zabbix-高可用设计目标"><a href="#Zabbix-高可用设计目标" class="headerlink" title="Zabbix 高可用设计目标"></a>Zabbix 高可用设计目标</h2><p>keepalived 服务优先级选择切换机制：对于 zabbix 服务器来说，只要 zabbix 存活和 mysql 存活，就能够正常记录数据，不会丢失数据，php 和 httpd 只是 web 页面的访问而已，所以我在这里定义 mysql 和 zabbix 为主要服务，php 和 httpd 为次要服务，为了实现主要服务存在，次要服务挂了；次要服务器存在，主要服务器挂了，keepalived 会优先选择主要服务存在的一方作为 master，让 keepalived 切换更为更合理。</p><p>数据库主主同步：不管切到哪一边都需要保持数据一致性，不可出现丢数据或者数据重复，保证数据库的高可用。</p><p>文件双向同步：        </p><ol><li>web 文件同步：任何做 web 文件得配置和修改，保证两边一致，确保切换不会发生任何变化。        </li><li>zabbix 服务文件同步：对 zabbix_servr 的配置文件做的任何修改，和脚本的修改进行同步，也是为了保证两边的服务一致性，没有落后情况，达到无需人工干预自动切换服务可正常时候。        </li><li>到此完成了 zabbix 得无缝切换，无故障时间！</li></ol><h2 id="Zabbix-Server"><a href="#Zabbix-Server" class="headerlink" title="Zabbix Server"></a>Zabbix Server</h2><blockquote><p>基于官方的 LAMP 架构，按照最简单的原生方式来部署 Zabbix 4.0 LTS，不做任何多余优化</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装必要依赖包 </span></span><br><span class="line">yum install -y httpd mariadb-server mariadb php php-mysql php-gd libjpeg* php-ldap php-odbc php-pear php-xml php-xmlrpc php-mhash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 apache 配置 </span></span><br><span class="line">vim /etc/httpd/conf/httpd.conf</span><br><span class="line">ServerName 192.168.56.103</span><br><span class="line">DirectoryIndex index.html index.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 php 时区 </span></span><br><span class="line">vim /etc/php.ini</span><br><span class="line">date.timezone = Asia/Singapore</span><br><span class="line">memory_limit = 512M</span><br><span class="line"></span><br><span class="line"><span class="comment"># 优化 php 参数 (可选，建议 memory_limit 根据内存值调高)</span></span><br><span class="line">sed -i <span class="string">'s/post_max_size = 8M/post_max_size = 32M/g'</span> /etc/php.ini</span><br><span class="line">sed -i <span class="string">'s/upload_max_filesize = 2M/upload_max_filesize = 50M/g'</span> /etc/php.ini</span><br><span class="line">sed -i <span class="string">'s/\;date.timezone =/date.timezone = Asia\/Singapore/'</span> /etc/php.ini</span><br><span class="line">sed -i <span class="string">'s/max_execution_time = 30/max_execution_time = 600/g'</span> /etc/php.ini</span><br><span class="line">sed -i <span class="string">'s/max_input_time = 60/max_input_time = 600/g'</span> /etc/php.ini</span><br><span class="line">sed -i <span class="string">'s/memory_limit = 128M/memory_limit = 256M/g'</span> /etc/php.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 httpd 服务 </span></span><br><span class="line">systemctl start httpd.service</span><br><span class="line"><span class="comment"># 启动 mariadb 服务 </span></span><br><span class="line">systemctl start mariadb.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 mysql 数据库，并配置 root 用户密码 </span></span><br><span class="line">mysql_secure_installation</span><br><span class="line"></span><br><span class="line"><span class="comment"># 万一新版本忘记随机密码可以通过日志获取 </span></span><br><span class="line">grep <span class="string">'temporary password'</span> /var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个测试页，测试 LAMP 是否搭建成功 </span></span><br><span class="line">cat &gt; /var/www/html/index.php &lt;&lt; EOF</span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 zabbix 数据库 </span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line">mysql&gt; create database zabbix character <span class="built_in">set</span> utf8 collate utf8_bin;</span><br><span class="line">mysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by <span class="string">'zabbix'</span>;</span><br><span class="line">mysql&gt; quit;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署 zabbix</span></span><br><span class="line">rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm</span><br><span class="line">yum clean all</span><br><span class="line">yum -y install zabbix-server-mysql zabbix-web-mysql zabbix-agent</span><br><span class="line">zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p zabbix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据库用户及密码 </span></span><br><span class="line">vim /etc/zabbix/zabbix_server.conf</span><br><span class="line">DBPassword=zabbix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改时区和参数优化 </span></span><br><span class="line">vim /etc/httpd/conf.d/zabbix.conf</span><br><span class="line">php_value date.timezone Asia/Singapore</span><br><span class="line">php_value memory_limit 512M</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 zabbix 并设置自启动服务 </span></span><br><span class="line">systemctl restart zabbix-server zabbix-agent httpd</span><br><span class="line">systemctl <span class="built_in">enable</span> zabbix-server zabbix-agent httpd mariadb</span><br><span class="line"></span><br><span class="line">http://localhost/zabbix</span><br><span class="line">Admin/zabbix</span><br></pre></td></tr></table></figure><h2 id="Zabbix-配置优化"><a href="#Zabbix-配置优化" class="headerlink" title="Zabbix 配置优化"></a>Zabbix 配置优化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Zabbix 默认原始配置 </span></span><br><span class="line">grep -Ev <span class="string">'^$|#'</span> /etc/zabbix/zabbix_server.conf</span><br><span class="line">LogFile=/var/<span class="built_in">log</span>/zabbix/zabbix_server.log</span><br><span class="line">LogFileSize=0</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_server.pid</span><br><span class="line">SocketDir=/var/run/zabbix</span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br><span class="line">SNMPTrapperFile=/var/<span class="built_in">log</span>/snmptrap/snmptrap.log</span><br><span class="line">Timeout=4</span><br><span class="line">AlertScriptsPath=/usr/lib/zabbix/alertscripts</span><br><span class="line">ExternalScripts=/usr/lib/zabbix/externalscripts</span><br><span class="line">LogSlowQueries=3000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 zabbix_server.conf，通常可以追加在末尾 </span></span><br><span class="line">CacheSize=8G</span><br><span class="line">TrendCacheSize=2G</span><br><span class="line">Timeout=30</span><br><span class="line">StartPollers=500</span><br><span class="line">StartPollersUnreachable=100</span><br><span class="line">StartPingers=50</span><br><span class="line">HousekeepingFrequency=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果服务器性能很好可以继续向上调整参数 </span></span><br><span class="line">LogFile=/var/<span class="built_in">log</span>/zabbix/zabbix_server.log</span><br><span class="line">LogFileSize=0</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_server.pid</span><br><span class="line">SocketDir=/var/run/zabbix</span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br><span class="line">StartPollers=700</span><br><span class="line">StartPreprocessors=100</span><br><span class="line">StartPollersUnreachable=500</span><br><span class="line">StartTrappers=200</span><br><span class="line">StartPingers=500</span><br><span class="line">StartDiscoverers=100</span><br><span class="line">SNMPTrapperFile=/var/<span class="built_in">log</span>/snmptrap/snmptrap.log</span><br><span class="line">CacheSize=8G</span><br><span class="line">StartDBSyncers=64</span><br><span class="line">HistoryCacheSize=2G</span><br><span class="line">HistoryIndexCacheSize=2G</span><br><span class="line">TrendCacheSize=2G</span><br><span class="line">ValueCacheSize=2G</span><br><span class="line">Timeout=30</span><br><span class="line">AlertScriptsPath=/usr/lib/zabbix/alertscripts</span><br><span class="line">ExternalScripts=/usr/lib/zabbix/externalscripts</span><br><span class="line">LogSlowQueries=3000</span><br></pre></td></tr></table></figure><h2 id="数据库配置优化"><a href="#数据库配置优化" class="headerlink" title="数据库配置优化"></a>数据库配置优化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">grep -Ev <span class="string">'^$|#'</span> /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">symbolic-links=0</span><br><span class="line">max_connections=1000</span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mariadb/mariadb.log</span><br><span class="line">pid-file=/var/run/mariadb/mariadb.pid</span><br><span class="line">!includedir /etc/my.cnf.d</span><br></pre></td></tr></table></figure><h2 id="Zabbix-Partition-分区表优化"><a href="#Zabbix-Partition-分区表优化" class="headerlink" title="Zabbix Partition 分区表优化"></a>Zabbix Partition 分区表优化</h2><blockquote><p>Zabbix &gt;= 3.2, history 30, Trends 120,(‘history’, 30, 24, 14), 最多保存 30 天的数据，每隔 24 小时生成一个分区，每次生成 14 个分区</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`partition_create`</span>(SCHEMANAME <span class="built_in">varchar</span>(<span class="number">64</span>), TABLENAME <span class="built_in">varchar</span>(<span class="number">64</span>), PARTITIONNAME <span class="built_in">varchar</span>(<span class="number">64</span>), CLOCK <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           SCHEMANAME = The DB schema in which to make changes</span></span><br><span class="line"><span class="comment">           TABLENAME = The table with partitions to potentially delete</span></span><br><span class="line"><span class="comment">           PARTITIONNAME = The name of the partition to create</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Verify that the partition does not already exist</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">DECLARE</span> RETROWS <span class="built_in">INT</span>;</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="number">1</span>) <span class="keyword">INTO</span> RETROWS</span><br><span class="line">        <span class="keyword">FROM</span> information_schema.partitions</span><br><span class="line">        <span class="keyword">WHERE</span> table_schema = SCHEMANAME <span class="keyword">AND</span> table_name = TABLENAME <span class="keyword">AND</span> partition_description &gt;= CLOCK;</span><br><span class="line"></span><br><span class="line">        IF RETROWS = 0 THEN</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   1. Print a message indicating that a partition was created.</span></span><br><span class="line"><span class="comment">                   2. Create the SQL to create the partition.</span></span><br><span class="line"><span class="comment">                   3. Execute the SQL from #2.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>( <span class="string">"partition_create("</span>, SCHEMANAME, <span class="string">","</span>, TABLENAME, <span class="string">","</span>, PARTITIONNAME, <span class="string">","</span>, CLOCK, <span class="string">")"</span> ) <span class="keyword">AS</span> msg;</span><br><span class="line">                <span class="keyword">SET</span> @<span class="keyword">sql</span> = <span class="keyword">CONCAT</span>( <span class="string">'ALTER TABLE'</span>, SCHEMANAME, <span class="string">'.'</span>, TABLENAME, <span class="string">'ADD PARTITION (PARTITION'</span>, PARTITIONNAME, <span class="string">'VALUES LESS THAN ('</span>, CLOCK, <span class="string">'));'</span> );</span><br><span class="line">                <span class="keyword">PREPARE</span> STMT <span class="keyword">FROM</span> @<span class="keyword">sql</span>;</span><br><span class="line">                <span class="keyword">EXECUTE</span> STMT;</span><br><span class="line">                <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> STMT;</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`partition_drop`</span>(SCHEMANAME <span class="built_in">VARCHAR</span>(<span class="number">64</span>), TABLENAME <span class="built_in">VARCHAR</span>(<span class="number">64</span>), DELETE_BELOW_PARTITION_DATE <span class="built_in">BIGINT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           SCHEMANAME = The DB schema in which to make changes</span></span><br><span class="line"><span class="comment">           TABLENAME = The table with partitions to potentially delete</span></span><br><span class="line"><span class="comment">           DELETE_BELOW_PARTITION_DATE = Delete any partitions with names that are dates older than this one (yyyy-mm-dd)</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">DECLARE</span> done <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span>;</span><br><span class="line">        <span class="keyword">DECLARE</span> drop_part_name <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Get a list of all the partitions that are older than the date</span></span><br><span class="line"><span class="comment">           in DELETE_BELOW_PARTITION_DATE.  All partitions are prefixed with</span></span><br><span class="line"><span class="comment">           a "p", so use SUBSTRING TO get rid of that character.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">DECLARE</span> myCursor <span class="keyword">CURSOR</span> <span class="keyword">FOR</span></span><br><span class="line">                <span class="keyword">SELECT</span> partition_name</span><br><span class="line">                <span class="keyword">FROM</span> information_schema.partitions</span><br><span class="line">                <span class="keyword">WHERE</span> table_schema = SCHEMANAME <span class="keyword">AND</span> table_name = TABLENAME <span class="keyword">AND</span> <span class="keyword">CAST</span>(<span class="keyword">SUBSTRING</span>(partition_name <span class="keyword">FROM</span> <span class="number">2</span>) <span class="keyword">AS</span> <span class="keyword">UNSIGNED</span>) &lt; DELETE_BELOW_PARTITION_DATE;</span><br><span class="line">        <span class="keyword">DECLARE</span> CONTINUE <span class="keyword">HANDLER</span> <span class="keyword">FOR</span> <span class="keyword">NOT</span> <span class="keyword">FOUND</span> <span class="keyword">SET</span> done = <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Create the basics for when we need to drop the partition.  Also, create</span></span><br><span class="line"><span class="comment">           @drop_partitions to hold a comma-delimited list of all partitions that</span></span><br><span class="line"><span class="comment">           should be deleted.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">SET</span> @alter_header = <span class="keyword">CONCAT</span>(<span class="string">"ALTER TABLE"</span>, SCHEMANAME, <span class="string">"."</span>, TABLENAME, <span class="string">"DROP PARTITION"</span>);</span><br><span class="line">        <span class="keyword">SET</span> @drop_partitions = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Start looping through all the partitions that are too old.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        OPEN myCursor;</span><br><span class="line">        read_loop: LOOP</span><br><span class="line">                FETCH myCursor INTO drop_part_name;</span><br><span class="line">                IF done THEN</span><br><span class="line">                        LEAVE read_loop;</span><br><span class="line">                <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line">                <span class="keyword">SET</span> @drop_partitions = <span class="keyword">IF</span>(@drop_partitions = <span class="string">""</span>, drop_part_name, <span class="keyword">CONCAT</span>(@drop_partitions, <span class="string">","</span>, drop_part_name));</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line">        IF @drop_partitions != ""THEN</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   1. Build the SQL to drop all the necessary partitions.</span></span><br><span class="line"><span class="comment">                   2. Run the SQL to drop the partitions.</span></span><br><span class="line"><span class="comment">                   3. Print out the table partitions that were deleted.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">SET</span> @full_sql = <span class="keyword">CONCAT</span>(@alter_header, @drop_partitions, <span class="string">";"</span>);</span><br><span class="line">                <span class="keyword">PREPARE</span> STMT <span class="keyword">FROM</span> @full_sql;</span><br><span class="line">                <span class="keyword">EXECUTE</span> STMT;</span><br><span class="line">                <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> STMT;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(SCHEMANAME, <span class="string">"."</span>, TABLENAME) <span class="keyword">AS</span> <span class="string">`table`</span>, @drop_partitions <span class="keyword">AS</span> <span class="string">`partitions_deleted`</span>;</span><br><span class="line">        ELSE</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   No partitions are being deleted, so print out"N/A"(Not applicable) to indicate</span></span><br><span class="line"><span class="comment">                   that no changes were made.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(SCHEMANAME, <span class="string">"."</span>, TABLENAME) <span class="keyword">AS</span> <span class="string">`table`</span>, <span class="string">"N/A"</span> <span class="keyword">AS</span> <span class="string">`partitions_deleted`</span>;</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`partition_maintenance`</span>(SCHEMA_NAME <span class="built_in">VARCHAR</span>(<span class="number">32</span>), TABLE_NAME <span class="built_in">VARCHAR</span>(<span class="number">32</span>), KEEP_DATA_DAYS <span class="built_in">INT</span>, HOURLY_INTERVAL <span class="built_in">INT</span>, CREATE_NEXT_INTERVALS <span class="built_in">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">DECLARE</span> OLDER_THAN_PARTITION_DATE <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> PARTITION_NAME <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> OLD_PARTITION_NAME <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> LESS_THAN_TIMESTAMP <span class="built_in">INT</span>;</span><br><span class="line">        <span class="keyword">DECLARE</span> CUR_TIME <span class="built_in">INT</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">CALL</span> partition_verify(SCHEMA_NAME, TABLE_NAME, HOURLY_INTERVAL);</span><br><span class="line">        <span class="keyword">SET</span> CUR_TIME = <span class="keyword">UNIX_TIMESTAMP</span>(<span class="keyword">DATE_FORMAT</span>(<span class="keyword">NOW</span>(), <span class="string">'%Y-%m-%d 00:00:00'</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SET</span> @__interval = <span class="number">1</span>;</span><br><span class="line">        create_loop: LOOP</span><br><span class="line">                IF @__interval &gt; CREATE_NEXT_INTERVALS THEN</span><br><span class="line">                        LEAVE create_loop;</span><br><span class="line">                <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">SET</span> LESS_THAN_TIMESTAMP = CUR_TIME + (HOURLY_INTERVAL * @__interval * <span class="number">3600</span>);</span><br><span class="line">                <span class="keyword">SET</span> PARTITION_NAME = FROM_UNIXTIME(CUR_TIME + HOURLY_INTERVAL * (@__interval - <span class="number">1</span>) * <span class="number">3600</span>, <span class="string">'p%Y%m%d%H00'</span>);</span><br><span class="line">                IF(PARTITION_NAME != OLD_PARTITION_NAME) THEN</span><br><span class="line">                        <span class="keyword">CALL</span> partition_create(SCHEMA_NAME, TABLE_NAME, PARTITION_NAME, LESS_THAN_TIMESTAMP);</span><br><span class="line">                <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line">                <span class="keyword">SET</span> @__interval=@__interval+<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">SET</span> OLD_PARTITION_NAME = PARTITION_NAME;</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SET</span> OLDER_THAN_PARTITION_DATE=<span class="keyword">DATE_FORMAT</span>(<span class="keyword">DATE_SUB</span>(<span class="keyword">NOW</span>(), <span class="built_in">INTERVAL</span> KEEP_DATA_DAYS <span class="keyword">DAY</span>), <span class="string">'%Y%m%d0000'</span>);</span><br><span class="line">        <span class="keyword">CALL</span> partition_drop(SCHEMA_NAME, TABLE_NAME, OLDER_THAN_PARTITION_DATE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`partition_verify`</span>(SCHEMANAME <span class="built_in">VARCHAR</span>(<span class="number">64</span>), TABLENAME <span class="built_in">VARCHAR</span>(<span class="number">64</span>), HOURLYINTERVAL <span class="built_in">INT</span>(<span class="number">11</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">DECLARE</span> PARTITION_NAME <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> RETROWS <span class="built_in">INT</span>(<span class="number">11</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> FUTURE_TIMESTAMP <span class="keyword">TIMESTAMP</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Check if any partitions exist for the given SCHEMANAME.TABLENAME.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="number">1</span>) <span class="keyword">INTO</span> RETROWS</span><br><span class="line">        <span class="keyword">FROM</span> information_schema.partitions</span><br><span class="line">        <span class="keyword">WHERE</span> table_schema = SCHEMANAME <span class="keyword">AND</span> table_name = TABLENAME <span class="keyword">AND</span> partition_name <span class="keyword">IS</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If partitions do not exist, go ahead and partition the table</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        IF RETROWS = 1 THEN</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Take the current date at 00:00:00 and add HOURLYINTERVAL to it.  This is the timestamp below which we will store values.</span></span><br><span class="line"><span class="comment">                 * We begin partitioning based on the beginning of a day.  This is because we don't want to generate a random partition</span></span><br><span class="line"><span class="comment">                 * that won't necessarily fall in line with the desired partition naming (ie: if the hour interval is 24 hours, we could</span></span><br><span class="line"><span class="comment">                 * end up creating a partition now named"p201403270600"when all other partitions will be like"p201403280000").</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">SET</span> FUTURE_TIMESTAMP = <span class="keyword">TIMESTAMPADD</span>(<span class="keyword">HOUR</span>, HOURLYINTERVAL, <span class="keyword">CONCAT</span>(<span class="keyword">CURDATE</span>(), <span class="string">" "</span>, <span class="string">'00:00:00'</span>));</span><br><span class="line">                <span class="keyword">SET</span> PARTITION_NAME = <span class="keyword">DATE_FORMAT</span>(<span class="keyword">CURDATE</span>(), <span class="string">'p%Y%m%d%H00'</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">-- Create the partitioning query</span></span><br><span class="line">                <span class="keyword">SET</span> @__PARTITION_SQL = <span class="keyword">CONCAT</span>(<span class="string">"ALTER TABLE "</span>, SCHEMANAME, <span class="string">"."</span>, TABLENAME, <span class="string">" PARTITION BY RANGE(`clock`)"</span>);</span><br><span class="line">                <span class="keyword">SET</span> @__PARTITION_SQL = <span class="keyword">CONCAT</span>(@__PARTITION_SQL, <span class="string">"(PARTITION "</span>, PARTITION_NAME, <span class="string">" VALUES LESS THAN ("</span>, <span class="keyword">UNIX_TIMESTAMP</span>(FUTURE_TIMESTAMP), <span class="string">"));"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">-- Run the partitioning query</span></span><br><span class="line">                <span class="keyword">PREPARE</span> STMT <span class="keyword">FROM</span> @__PARTITION_SQL;</span><br><span class="line">                <span class="keyword">EXECUTE</span> STMT;</span><br><span class="line">                <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> STMT;</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span><span class="string">`partition_maintenance_all`</span>(SCHEMA_NAME <span class="built_in">VARCHAR</span>(<span class="number">32</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history_log'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history_str'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history_text'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history_uint'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'trends'</span>, <span class="number">120</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'trends_uint'</span>, <span class="number">120</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;%</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入 partition.sql</span></span><br><span class="line">mysql -u<span class="string">'zabbix'</span> -p<span class="string">'zabbix'</span> zabbix  &lt; partition.sql</span><br><span class="line"><span class="comment"># 手动后台单次执行 </span></span><br><span class="line">nohup mysql -u<span class="string">'zabbix'</span> -p<span class="string">'zabbix'</span> <span class="string">'zabbix'</span> -e <span class="string">"CALL partition_maintenance_all('zabbix');"</span> &amp;&gt; /root/partition.log&amp;</span><br><span class="line">tail -f /root/partition.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看过程逻辑 </span></span><br><span class="line">show create procedure partition_maintenance_all \G;</span><br><span class="line"><span class="comment"># 删除存储过程 </span></span><br><span class="line">drop procedure <span class="keyword">if</span> exists partition_maintenance_all; </span><br><span class="line"><span class="comment"># 查看存储过程 </span></span><br><span class="line">show procedure status like <span class="string">'partition_maintenance%'</span> \G;</span><br><span class="line"><span class="comment"># 查看 </span></span><br><span class="line">show create table <span class="built_in">history</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建定时任务脚本 </span></span><br><span class="line">[root@sg-gop-10-65-200-90 wangao]<span class="comment"># cat /opt/sa_scripts/zabbix_partitioning.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">user=<span class="string">'zabbix'</span></span><br><span class="line">password=<span class="string">'zabbix'</span></span><br><span class="line">database=<span class="string">'zabbix'</span></span><br><span class="line"></span><br><span class="line">mysql -u<span class="variable">$&#123;user&#125;</span> -p<span class="variable">$password</span> <span class="variable">$database</span> -e <span class="string">"CALL partition_maintenance_all('zabbix');"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改执行权限 </span></span><br><span class="line">chmod 755 /opt/sa_scripts/zabbix_partitioning.sh</span><br><span class="line"><span class="comment"># 修改 crontab</span></span><br><span class="line">vim /etc/crontab</span><br><span class="line">15 3 * * * root bash /opt/sa_scripts/zabbix_partitioning.sh</span><br></pre></td></tr></table></figure><h2 id="Zabbix-Proxy"><a href="#Zabbix-Proxy" class="headerlink" title="Zabbix Proxy"></a>Zabbix Proxy</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zabbix proxy 的依赖就只有数据库了，用于存储配置信息 </span></span><br><span class="line">yum install -y mariadb-server mariadb</span><br><span class="line"><span class="comment"># 启动 mariadb 服务 </span></span><br><span class="line">systemctl start mariadb.service</span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb.service</span><br><span class="line"><span class="comment"># 初始化 mysql 数据库，并配置 root 用户密码 </span></span><br><span class="line">mysql_secure_installation</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 zabbix_proxy 数据库 </span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line">mysql&gt; create database zabbix_proxy character <span class="built_in">set</span> utf8 collate utf8_bin;</span><br><span class="line">mysql&gt; grant all privileges on zabbix_proxy.* to zabbix@localhost identified by <span class="string">'zabbix'</span>;</span><br><span class="line">mysql&gt; quit;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署 zabbix_proxy</span></span><br><span class="line">rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm</span><br><span class="line">yum install -y zabbix-proxy-mysql</span><br><span class="line">zcat /usr/share/doc/zabbix-proxy-mysql*/schema.sql.gz | mysql -uzabbix -p zabbix_proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据库用户及密码 </span></span><br><span class="line">vim /etc/zabbix/zabbix_proxy.conf</span><br><span class="line">Server=192.168.56.103</span><br><span class="line">Hostname=zabbix_proxy</span><br><span class="line">DBName=zabbix_proxy</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Zabbix Server Proxy</span></span><br><span class="line">Administration -&gt; Proxies -&gt; Create proxy</span><br><span class="line">Proxy name: zabbix_proxy</span><br><span class="line">Proxy mode: Active</span><br><span class="line">Proxy address: 192.168.56.101</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 zabbix_proxy</span></span><br><span class="line">systemctl restart zabbix-proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 zabbix_agent 配置指向 zabbix_proxy</span></span><br><span class="line">vim /etc/zabbix/zabbix_agentd.conf</span><br><span class="line">Server=192.168.56.101,192.168.56.103</span><br><span class="line">ServerActive=192.168.56.101</span><br><span class="line">Hostname=192.168.56.101</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 zabbix_proxy 服务 </span></span><br><span class="line">systemctl <span class="built_in">enable</span> zabbix-proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 zabbix_server 中添加代理主机 </span></span><br><span class="line">Configuration -&gt; Hosts -&gt; Create host</span><br><span class="line">Monitored by proxy: zabbix_proxy</span><br></pre></td></tr></table></figure><h2 id="Zabbix-HA-高可用"><a href="#Zabbix-HA-高可用" class="headerlink" title="Zabbix HA 高可用"></a>Zabbix HA 高可用</h2><blockquote><p>基于 Keepalived 搭建 Zabbix HA 高可用</p></blockquote><p>【zabbix HA】zabbixHA 高可用的实现<br><a href="https://www.jianshu.com/p/eecb5e8d1a96" target="_blank" rel="noopener">https://www.jianshu.com/p/eecb5e8d1a96</a></p>]]></content>
    
    <summary type="html">
    
      基于keepalived搭建zabbix server HA双机高可用
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>tcpdump 抓包使用小结</title>
    <link href="https://wsgzao.github.io/post/tcpdump/"/>
    <id>https://wsgzao.github.io/post/tcpdump/</id>
    <published>2019-02-27T06:59:49.000Z</published>
    <updated>2019-03-01T04:04:41.337Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>tcpdump 是一个很常用的网络包分析工具，可以用来显示通过网络传输到本系统的 TCP/IP 以及其他网络的数据包。tcpdump 使用 libpcap 库来抓取网络报，这个库在几乎在所有的 Linux/Unix 中都有。在 Windows 中我们通常会使用 Wireshark 进行图形化操作相当便捷，然而在 Linux 环境中如何巧妙应用 tcpdump 的命令来操作提升效率就显得尤为重要。在本文中，我们将会通过一些实例来演示如何使用 tcpdump 命令。</p><blockquote><p>tcpdump 是一款灵活、功能强大的抓包工具，能有效地帮助排查网络故障问题。</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 02 月 27 日 - 更新 tcpdump 抓包规则常用命令<br>2018 年 12 月 11 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/tcpdump/">https://wsgzao.github.io/post/tcpdump/</a></p><p><strong> 扩展阅读 </strong></p><p>Wireshark - <a href="https://www.wireshark.org/#download" target="_blank" rel="noopener">https://www.wireshark.org/#download</a><br>tcpdump - <a href="http://www.tcpdump.org/" target="_blank" rel="noopener">http://www.tcpdump.org/</a><br>在 Linux 命令行中使用 tcpdump 抓包 - <a href="https://linux.cn/article-10191-1.html" target="_blank" rel="noopener">https://linux.cn/article-10191-1.html</a></p><hr><h2 id="tcpdump-简介"><a href="#tcpdump-简介" class="headerlink" title="tcpdump 简介"></a>tcpdump 简介</h2><blockquote><p>tcpdump, a powerful command-line packet analyzer; and libpcap, a portable C/C++ library for network traffic capture.</p></blockquote><p>Tcpdump prints out a description of the contents of packets on a network interface that match the boolean expression; the description is preceded by a time stamp, printed, by default, as hours, minutes, seconds, and fractions of a second since midnight. It can also be run with the -w flag, which causes it to save the packet data to a file for later analysis, and/or with the -r flag, which causes it to read from a saved packet file rather than to read packets from a network interface. It can also be run with the -V flag, which causes it to read a list of saved packet files. In all cases, only packets that match expression will be processed by tcpdump.</p><p>tcpdump 是一款用于截取网络分组，并过滤输出分组内容的工具。tcpdump 凭借强大的功能和灵活的截取策略，使其成为类 UNIX 系统下用于网络分析和问题排查的首选工具。 tcpdump 提供了源代码，公开了接口，因此具备很强的可扩展性，对于网络维护和入侵者都是非常有用的工具。tcpdump 存在于基本的 Linux 系统中，由于它需要将网络界面设置为混杂模式，普通用户不能正常执行，但具备 root 权限的用户可以直接执行它来获取网络上的信息。因此系统中存在网络分析工具主要不是对本机安全的威胁，而是对网络上的其他计算机的安全存在威胁。tcpdump 可以将网络中传送的数据包的 “头” 完全截获下来提供分析。它支持针对网络层、协议、主机、网络或端口的过滤，并提供 and、or、not 等逻辑语句来帮助我们去掉无用的信息。</p><h2 id="tcpdump-安装"><a href="#tcpdump-安装" class="headerlink" title="tcpdump 安装"></a>tcpdump 安装</h2><blockquote><p>tcpdump 默认在几乎所有的 Linux 发行版中都可用，但若你的 Linux 上没有的话，使用下面方法进行安装。</p></blockquote><p>CentOS/RHEL<br>使用下面命令在 CentOS 和 RHEL 上安装 tcpdump，</p><pre><code>sudo yum install tcpdump*</code></pre><p>Fedora<br>使用下面命令在 Fedora 上安装 tcpdump：</p><pre><code>dnf install tcpdump</code></pre><p>Ubuntu/Debian/Linux Mint<br>在 Ubuntu/Debain/Linux Mint 上使用下面命令安装 tcpdump：</p><pre><code>apt-get install tcpdump</code></pre><h2 id="tcpdump-常用命令解释"><a href="#tcpdump-常用命令解释" class="headerlink" title="tcpdump 常用命令解释"></a>tcpdump 常用命令解释</h2><p>tcpdump [ 选项 ] [ -c 数量 ] [ -i 网络接口 ] [ -w 文件名 ] [ 表达式 ]</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">man tcpdump</span><br><span class="line">...</span><br><span class="line">tcpdump [ -AbdDefhHIJKlLnNOpqStuUvxX<span class="comment"># ] [ -B buffer_size ]</span></span><br><span class="line">        [ -c count ]</span><br><span class="line">        [ -C file_size ] [ -G rotate_seconds ] [ -F file ]</span><br><span class="line">        [ -i interface ] [ -j tstamp_type ] [ -m module ] [ -M secret ]</span><br><span class="line">        [ --number ] [ -Q <span class="keyword">in</span>|out|inout ]</span><br><span class="line">        [ -r file ] [ -V file ] [ -s snaplen ] [ -T <span class="built_in">type</span> ] [ -w file ]</span><br><span class="line">        [ -W filecount ]</span><br><span class="line">        [ -E spi@ipaddr algo:secret,...  ]</span><br><span class="line">        [ -y datalinktype ] [ -z postrotate-command ] [ -Z user ]</span><br><span class="line">        [ --time-stamp-precision=tstamp_precision ]</span><br><span class="line">        [ --immediate-mode ] [ --version ]</span><br><span class="line">        [ expression ]</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">选项翻译如下： </span><br><span class="line"></span><br><span class="line">-l：使标准输出变为缓冲行形式；</span><br><span class="line">-c：抓包次数；</span><br><span class="line">-nn：直接以 IP 及 Port Number 显示，而非主机名与服务名称；</span><br><span class="line">-s ：&lt; 数据包大小 & gt; 设置每个数据包的大小；</span><br><span class="line">-i：指定监听的网络接口；</span><br><span class="line">-r：从指定的文件中读取包；</span><br><span class="line">-w：输出信息保存到指定文件；</span><br><span class="line">-a：将网络地址和广播地址转变成名字；</span><br><span class="line">-d：将匹配信息包的代码以人们能够理解的汇编格式给出；</span><br><span class="line">-e：在输出行打印出数据链路层的头部信息；</span><br><span class="line">-f：将外部的 Internet 地址以数字的形式打印出来；</span><br><span class="line">-t：在输出的每一行不打印时间戳；</span><br><span class="line">-v ：输出稍微详细的报文信息；--vv 则输出更详细信息。</span><br></pre></td></tr></table></figure><p>表达式指正则表达式，tcpdump 利用它作为过滤报文的条件，如果一个报文满足表达式的条件，则会捕获该报文。如果没有给出任何条件，则会截获网络上所有的信息包。<br>在表达式中一般有如下几种类型的关键字： </p><ol><li><p>关于类型的关键字：<br>host(缺省类型): 指明一台主机，如：host 10.215.20.13<br>net: 指定网络地址, net 10.215.20.0<br>port: 指明端口号, port 3306</p></li><li><p>确定传输方向的关键字： </p></li></ol><p>dst or src(缺省值) 指定源或者目标地址是 10.215.20.13 的流量包<br>src: src 10.9.51.13, 指定源地址是 10.9.51.13<br>dst: dst net 172.0.0.0, 指定目标网络地址是 172.0.0.0<br>dst and src  比如: src host 10.9.51.13 and dst host 10.215.20.13 </p><ol start="3"><li>协议的关键字：</li></ol><p>协议的关键字：缺省值是监听所有协议的信息包<br>ip<br>arp<br>tcp<br>udp<br>icmp</p><ol start="4"><li>三种逻辑运算： </li></ol><p>非 : ! , not<br>与 : &amp;&amp; , and<br>或 : || , or</p><p>例子: 抓取所有经过 bond0，目的地址是 10.10.1.254 或 10.10.1.200 端口是 80 的 TCP 数据</p><pre><code>tcpdump -i bond0 &apos;((tcp) and (port 80) and ((dst host 10.10.1.254) or (dst host 10.10.1.200)))&apos;</code></pre><ol start="5"><li>其他重要的关键字：</li></ol><p>gateway, broadcast, less（小于）, greater（大于）</p><h2 id="tcpdump-参数实例"><a href="#tcpdump-参数实例" class="headerlink" title="tcpdump 参数实例"></a>tcpdump 参数实例</h2><pre><code>tcpdump tcp -i bond0 -tttt -s 0 -c 100 and dst port ! 22 and src net 10.10.1.0/24 -w 20190131.tcpdump</code></pre><p>(1) tcp: 协议类型，用来过滤数据报的协议类型。<br>(2) -i bond0 : 只抓取经过接口 bond0 的包<br>(3) -tttt : 使用格式 2019-02-02 10:37:37.120297, 便于分析。<br>(4) -s 0: 抓取数据包时默认抓取长度为 68 字节。加上 - s 0 后可以抓到完整的数据包<br>(5) -c 100: 只抓取 100 个数据包<br>(6) dst port ! 22: 不抓取目标端口是 22 的数据包<br>(7) src net 10.10.1.0/24: 数据包的源网络地址为 10.10.1.0/24<br>(8) -w 20190131.tcpdump: 保存成 tcpdump 文件中, 方便使用 wireshark 分析抓包结果。</p><p>还有其他常用的参数:</p><p>-D: 列出所有可用的网络接口<br>-n: 禁用域名解析，让 tcpdump 直接输出 IP 地址.<br>-X: 以 16 进制格式输出数据包的内容, 不加该参数, 会只输出 iptcp/udp 头部信息。<br>                            加上该选项会将整个数据包输出。<br>-vvvv  该参数其实是 - v 与 - vvv 的组合。<br>       -v 会输出稍微详细一点的信息包括校验和 ttl 之类的；<br>       -vvv 会尝试解析应用层协议，输出详细信息。二者组合就能完整的详细信息。<br>-A: 以 ASCII 值显示抓到的包, 比如和 MySQL 的交互时，可以通过 - A 查看包的文本内容.   </p><h2 id="tcpdump-命令演示"><a href="#tcpdump-命令演示" class="headerlink" title="tcpdump 命令演示"></a>tcpdump 命令演示</h2><p>从所有网卡中捕获数据包<br>运行下面命令来从所有网卡中捕获数据包：</p><pre><code>tcpdump -i any</code></pre><p>从指定网卡中捕获数据包<br>要从指定网卡中捕获数据包，运行：</p><pre><code>tcpdump -i eth0</code></pre><p>将捕获的包写入文件<br>使用 -w 选项将所有捕获的包写入文件：</p><pre><code>tcpdump -i eth1 -w packets_file</code></pre><p>读取之前产生的 tcpdump 文件<br>使用下面命令从之前创建的 tcpdump 文件中读取内容：</p><pre><code>tcpdump -r packets_file</code></pre><p>获取更多的包信息，并且以可读的形式显示时间戳<br>要获取更多的包信息同时以可读的形式显示时间戳，使用：</p><pre><code>tcpdump -ttttnnvvS</code></pre><p>查看整个网络的数据包<br>要获取整个网络的数据包，在终端执行下面命令：</p><pre><code>tcpdump net 192.168.1.0/24</code></pre><p>根据 IP 地址查看报文<br>要获取指定 IP 的数据包，不管是作为源地址还是目的地址，使用下面命令：</p><pre><code>tcpdump host 192.168.1.100</code></pre><p>要指定 IP 地址是源地址或是目的地址则使用：</p><pre><code>tcpdump src 192.168.1.100tcpdump dst 192.168.1.100</code></pre><p>查看某个协议或端口号的数据包<br>要查看某个协议的数据包，运行下面命令：</p><pre><code>tcpdump ssh</code></pre><p>要捕获某个端口或一个范围的数据包，使用：</p><pre><code>tcpdump port 22tcpdump portrange 22-125</code></pre><p>我们也可以与 src 和 dst 选项连用来捕获指定源端口或指定目的端口的报文。</p><p>我们还可以使用 “与” （and，&amp;&amp;）、“或” （or，|| ) 和 “非”（not，!） 来将两个条件组合起来。当我们需要基于某些条件来分析网络报文是非常有用。</p><p>使用 “与”<br>可以使用 and 或者符号 &amp;&amp; 来将两个或多个条件组合起来。比如：</p><pre><code>tcpdump src 192.168.1.100 &amp;&amp; port 22 -w ssh_packets</code></pre><p>使用 “或”<br>“或” 会检查是否匹配命令所列条件中的其中一条，像这样：</p><pre><code>tcpdump src 192.168.1.100 or dst 192.168.1.50 &amp;&amp; port 22 -w ssh_packetstcpdump port 443 or 80 -w http_packets</code></pre><p>使用 “非”<br>当我们想表达不匹配某项条件时可以使用 “非”，像这样：</p><pre><code>tcpdump -i eth0 src port not 22</code></pre><p>这会捕获 eth0 上除了 22 号端口的所有通讯。</p><h2 id="tcpdump-抓包规则常用命令"><a href="#tcpdump-抓包规则常用命令" class="headerlink" title="tcpdump 抓包规则常用命令"></a>tcpdump 抓包规则常用命令</h2><blockquote><p>下面的例子全是以抓取 eth0 接口为例，如果不加”-i eth0” 是表示抓取所有的接口包括 lo</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 抓取包含 172.16.1.122 的数据包  </span></span><br><span class="line">tcpdump -i eth0 -vnn host 172.16.1.122  </span><br><span class="line"><span class="comment"># 抓取包含 172.16.1.0/24 网段的数据包  </span></span><br><span class="line">tcpdump -i eth0 -vnn net 172.16.1.0/24  </span><br><span class="line"><span class="comment"># 抓取包含端口 22 的数据包  </span></span><br><span class="line">tcpdump -i eth0 -vnn port 22  </span><br><span class="line"><span class="comment"># 抓取 udp 协议的数据包  </span></span><br><span class="line">tcpdump -i eth0 -vnn  udp  </span><br><span class="line"><span class="comment"># 抓取 icmp 协议的数据包  </span></span><br><span class="line">tcpdump -i eth0 -vnn icmp  </span><br><span class="line"><span class="comment"># 抓取 arp 协议的数据包  </span></span><br><span class="line">tcpdump -i eth0 -vnn arp  </span><br><span class="line"><span class="comment"># 抓取 ip 协议的数据包  </span></span><br><span class="line">tcpdump -i eth0 -vnn ip  </span><br><span class="line"><span class="comment"># 抓取源 ip 是 172.16.1.122 数据包。  </span></span><br><span class="line">tcpdump -i eth0 -vnn src host 172.16.1.122  </span><br><span class="line"><span class="comment"># 抓取目的 ip 是 172.16.1.122 数据包  </span></span><br><span class="line">tcpdump -i eth0 -vnn dst host 172.16.1.122  </span><br><span class="line"><span class="comment"># 抓取源端口是 22 的数据包  </span></span><br><span class="line">tcpdump -i eth0 -vnn src port 22  </span><br><span class="line"><span class="comment"># 抓取源 ip 是 172.16.1.253 且目的 ip 是 22 的数据包  </span></span><br><span class="line">tcpdump -i eth0 -vnn src host 172.16.1.253 and dst port 22  </span><br><span class="line"><span class="comment"># 抓取源 ip 是 172.16.1.122 或者包含端口是 22 的数据包  </span></span><br><span class="line">tcpdump -i eth0 -vnn src host 172.16.1.122 or port 22  </span><br><span class="line"><span class="comment"># 抓取源 ip 是 172.16.1.122 且端口不是 22 的数据包  </span></span><br><span class="line">tcpdump -i eth0 -vnn src host 172.16.1.122 and not port 22  </span><br><span class="line"><span class="comment"># 抓取源 ip 是 172.16.1.2 且目的端口是 22，或源 ip 是 172.16.1.65 且目的端口是 80 的数据包。  </span></span><br><span class="line">tcpdump -i eth0 -vnn \( src host 172.16.1.2 and dst port 22 \) or   \( src host 172.16.1.65 and dst port 80 \)  </span><br><span class="line"><span class="comment"># 抓取源 ip 是 172.16.1.59 且目的端口是 22，或源 ip 是 172.16.1.68 且目的端口是 80 的数据包。  </span></span><br><span class="line">tcpdump -i  eth0 -vnn <span class="string">'src host 172.16.1.59 and dst port 22'</span> or  <span class="string">'src host 172.16.1.68 and dst port 80'</span>  </span><br><span class="line"><span class="comment"># 把抓取的数据包记录存到 / tmp/fill 文件中，当抓取 100 个数据包后就退出程序。  </span></span><br><span class="line">tcpdump –i eth0 -vnn -w  /tmp/fil1 -c 100  </span><br><span class="line"><span class="comment"># 从 / tmp/fill 记录中读取 tcp 协议的数据包  </span></span><br><span class="line">tcpdump –i eth0 -vnn -r  /tmp/fil1 tcp</span><br><span class="line"><span class="comment"># 从 / tmp/fill 记录中读取包含 172.16.1.58 的数据包  </span></span><br><span class="line">tcpdump –i eth0 -vnn -r  /tmp/fil1 host  172.16.1.58 </span><br><span class="line"><span class="comment"># 抓取目的地址范围是 10 网段</span></span><br><span class="line">tcpdump -i any -nn <span class="string">'ip[16] == 10'</span></span><br><span class="line"><span class="comment"># 抓取目的地址范围是 192.168.1.10 ~ 192.168.1.100</span></span><br><span class="line">tcpdump -i any -nn <span class="string">'ip[16] == 192 and ip[17] == 168 and ip[18] == 1 and ip[19] &gt; 9 and ip[19] &lt; 101'</span></span><br><span class="line"><span class="comment"># 保存 10000 个数据包过滤条件为 443 端口，并解析来源 IP</span></span><br><span class="line">tcpdump -i any -nn -c 10000 port 443 &gt; tcpdump.log</span><br><span class="line">cat tcpdump.log | awk <span class="string">'&#123;print $3&#125;'</span> |awk -F <span class="string">'.'</span> <span class="string">'&#123;print $1"."$2"."$3"."$4&#125;'</span>| sort | uniq -c | sort -rn</span><br></pre></td></tr></table></figure><h2 id="tcpdump-抓包实践"><a href="#tcpdump-抓包实践" class="headerlink" title="tcpdump 抓包实践"></a>tcpdump 抓包实践</h2><p>使用 tcpdump 抓包，需要管理员权限，因此下面的示例中绝大多数命令都是以 sudo 开头。</p><p>首先，先用 tcpdump -D 命令列出可以抓包的网络接口：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -D</span><br><span class="line">1.eth0</span><br><span class="line">2.virbr0</span><br><span class="line">3.eth1</span><br><span class="line">4.any (Pseudo-device that captures on all interfaces)</span><br><span class="line">5.lo [Loopback]</span><br></pre></td></tr></table></figure><p>如上所示，可以看到我的机器中所有可以抓包的网络接口。其中特殊接口 any 可用于抓取所有活动的网络接口的数据包。</p><p>我们就用如下命令先对 any 接口进行抓包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">09:56:18.293641 IP rhel75.localdomain.ssh &gt; 192.168.64.1.56322: Flags [P.], seq 3770820720:3770820916, ack 3503648727, win 309, options [nop,nop,TS val 76577898 ecr 510770929], length 196</span><br><span class="line">09:56:18.293794 IP 192.168.64.1.56322 &gt; rhel75.localdomain.ssh: Flags [.], ack 196, win 391, options [nop,nop,TS val 510771017 ecr 76577898], length 0</span><br><span class="line">09:56:18.295058 IP rhel75.59883 &gt; gateway.domain: 2486+ PTR? 1.64.168.192.in-addr.arpa. (43)</span><br><span class="line">09:56:18.310225 IP gateway.domain &gt; rhel75.59883: 2486 NXDomain* 0/1/0 (102)</span><br><span class="line">09:56:18.312482 IP rhel75.49685 &gt; gateway.domain: 34242+ PTR? 28.64.168.192.in-addr.arpa. (44)</span><br><span class="line">09:56:18.322425 IP gateway.domain &gt; rhel75.49685: 34242 NXDomain* 0/1/0 (103)</span><br><span class="line">09:56:18.323164 IP rhel75.56631 &gt; gateway.domain: 29904+ PTR? 1.122.168.192.in-addr.arpa. (44)</span><br><span class="line">09:56:18.323342 IP rhel75.localdomain.ssh &gt; 192.168.64.1.56322: Flags [P.], seq 196:584, ack 1, win 309, options [nop,nop,TS val 76577928 ecr 510771017], length 388</span><br><span class="line">09:56:18.323563 IP 192.168.64.1.56322 &gt; rhel75.localdomain.ssh: Flags [.], ack 584, win 411, options [nop,nop,TS val 510771047 ecr 76577928], length 0</span><br><span class="line">09:56:18.335569 IP gateway.domain &gt; rhel75.56631: 29904 NXDomain* 0/1/0 (103)</span><br><span class="line">09:56:18.336429 IP rhel75.44007 &gt; gateway.domain: 61677+ PTR? 98.122.168.192.in-addr.arpa. (45)</span><br><span class="line">09:56:18.336655 IP gateway.domain &gt; rhel75.44007: 61677* 1/0/0 PTR rhel75. (65)</span><br><span class="line">09:56:18.337177 IP rhel75.localdomain.ssh &gt; 192.168.64.1.56322: Flags [P.], seq 584:1644, ack 1, win 309, options [nop,nop,TS val 76577942 ecr 510771047], length 1060</span><br><span class="line">---- SKIPPING LONG OUTPUT -----</span><br><span class="line">09:56:19.342939 IP 192.168.64.1.56322 &gt; rhel75.localdomain.ssh: Flags [.], ack 1752016, win 1444, options [nop,nop,TS val 510772067 ecr 76578948], length 0</span><br><span class="line">^C</span><br><span class="line">9003 packets captured</span><br><span class="line">9010 packets received by filter</span><br><span class="line">7 packets dropped by kernel</span><br><span class="line">$</span><br></pre></td></tr></table></figure><p>tcpdump 会持续抓包直到收到中断信号。你可以按 Ctrl+C 来停止抓包。正如上面示例所示，tcpdump 抓取了超过 9000 个数据包。在这个示例中，由于我是通过 ssh 连接到服务器，所以 tcpdump 也捕获了所有这类数据包。-c 选项可以用于限制 tcpdump 抓包的数量：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c 5</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">11:21:30.242740 IP rhel75.localdomain.ssh &gt; 192.168.64.1.56322: Flags [P.], seq 3772575680:3772575876, ack 3503651743, win 309, options [nop,nop,TS val 81689848 ecr 515883153], length 196</span><br><span class="line">11:21:30.242906 IP 192.168.64.1.56322 &gt; rhel75.localdomain.ssh: Flags [.], ack 196, win 1443, options [nop,nop,TS val 515883235 ecr 81689848], length 0</span><br><span class="line">11:21:30.244442 IP rhel75.43634 &gt; gateway.domain: 57680+ PTR? 1.64.168.192.in-addr.arpa. (43)</span><br><span class="line">11:21:30.244829 IP gateway.domain &gt; rhel75.43634: 57680 NXDomain 0/0/0 (43)</span><br><span class="line">11:21:30.247048 IP rhel75.33696 &gt; gateway.domain: 37429+ PTR? 28.64.168.192.in-addr.arpa. (44)</span><br><span class="line">5 packets captured</span><br><span class="line">12 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line">$</span><br></pre></td></tr></table></figure><p>如上所示，tcpdump 在抓取 5 个数据包后自动停止了抓包。这在有些场景中十分有用 —— 比如你只需要抓取少量的数据包用于分析。当我们需要使用过滤规则抓取特定的数据包（如下所示）时，-c 的作用就十分突出了。</p><p>在上面示例中，tcpdump 默认是将 IP 地址和端口号解析为对应的接口名以及服务协议名称。而通常在网络故障排查中，使用 IP 地址和端口号更便于分析问题；用 -n 选项显示 IP 地址，-nn 选项显示端口号：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c5 -nn</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">23:56:24.292206 IP 192.168.64.28.22 &gt; 192.168.64.1.35110: Flags [P.], seq 166198580:166198776, ack 2414541257, win 309, options [nop,nop,TS val 615664 ecr 540031155], length 196</span><br><span class="line">23:56:24.292357 IP 192.168.64.1.35110 &gt; 192.168.64.28.22: Flags [.], ack 196, win 1377, options [nop,nop,TS val 540031229 ecr 615664], length 0</span><br><span class="line">23:56:24.292570 IP 192.168.64.28.22 &gt; 192.168.64.1.35110: Flags [P.], seq 196:568, ack 1, win 309, options [nop,nop,TS val 615664 ecr 540031229], length 372</span><br><span class="line">23:56:24.292655 IP 192.168.64.1.35110 &gt; 192.168.64.28.22: Flags [.], ack 568, win 1400, options [nop,nop,TS val 540031229 ecr 615664], length 0</span><br><span class="line">23:56:24.292752 IP 192.168.64.28.22 &gt; 192.168.64.1.35110: Flags [P.], seq 568:908, ack 1, win 309, options [nop,nop,TS val 615664 ecr 540031229], length 340</span><br><span class="line">5 packets captured</span><br><span class="line">6 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure><p>如上所示，抓取的数据包中显示 IP 地址和端口号。这样还可以阻止 tcpdump 发出 DNS 查找，有助于在网络故障排查中减少数据流量。</p><p>现在你已经会抓包了，让我们来分析一下这些抓包输出的含义吧。</p><h3 id="理解抓取的报文"><a href="#理解抓取的报文" class="headerlink" title="理解抓取的报文"></a>理解抓取的报文</h3><p>tcpdump 能够抓取并解码多种协议类型的数据报文，如 TCP、UDP、ICMP 等等。虽然这里我们不可能介绍所有的数据报文类型，但可以分析下 TCP 类型的数据报文，来帮助你入门。更多有关 tcpdump 的详细介绍可以参考其 帮助手册。tcpdump 抓取的 TCP 报文看起来如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">08:41:13.729687 IP 192.168.64.28.22 &gt; 192.168.64.1.41916: Flags [P.], seq 196:568, ack 1, win 309, options [nop,nop,TS val 117964079 ecr 816509256], length 372</span><br></pre></td></tr></table></figure><p>具体的字段根据不同的报文类型会有不同，但上面这个例子是一般的格式形式。</p><p>第一个字段 08:41:13.729687 是该数据报文被抓取的系统本地时间戳。</p><p>然后，IP 是网络层协议类型，这里是 IPv4，如果是 IPv6 协议，该字段值是 IP6。</p><p>192.168.64.28.22 是源 ip 地址和端口号，紧跟其后的是目的 ip 地址和其端口号，这里是 192.168.64.1.41916。</p><p>在源 IP 和目的 IP 之后，可以看到是 TCP 报文标记段 Flags [P.]。该字段通常取值如下：</p><table><thead><tr><th>值</th><th>标志类型</th><th>描述</th></tr></thead><tbody><tr><td>S</td><td>SYN</td><td>Connection Start 发起连接标志</td></tr><tr><td>F</td><td>FIN</td><td>Connection Finish 关闭连接标志</td></tr><tr><td>P</td><td>PUSH</td><td>Data push 传送数据标志</td></tr><tr><td>R</td><td>RST</td><td>Connection reset 异常关闭连接</td></tr><tr><td>.</td><td>ACK</td><td>Acknowledgment 表示确认包</td></tr></tbody></table><p>该字段也可以是这些值的组合，例如 [S.] 代表 SYN-ACK 数据包。</p><p>接下来是该数据包中数据的序列号。对于抓取的第一个数据包，该字段值是一个绝对数字，后续包使用相对数值，以便更容易查询跟踪。例如此处 seq 196:568 代表该数据包包含该数据流的第 196 到 568 字节。</p><p>接下来是 ack 值：ack 1。该数据包是数据发送方，ack 值为 1。在数据接收方，该字段代表数据流上的下一个预期字节数据，例如，该数据流中下一个数据包的 ack 值应该是 568。</p><p>接下来字段是接收窗口大小 win 309，它表示接收缓冲区中可用的字节数，后跟 TCP 选项如 MSS（最大段大小）或者窗口比例值。更详尽的 TCP 协议内容请参考 Transmission Control Protocol(TCP) Parameters。</p><p>最后，length 372 代表数据包有效载荷字节长度。这个长度和 seq 序列号中字节数值长度是不一样的。</p><p>现在让我们学习如何过滤数据报文以便更容易的分析定位问题。</p><h3 id="过滤数据包"><a href="#过滤数据包" class="headerlink" title="过滤数据包"></a>过滤数据包</h3><p>正如上面所提，tcpdump 可以抓取很多种类型的数据报文，其中很多可能和我们需要查找的问题并没有关系。举个例子，假设你正在定位一个与 web 服务器连接的网络问题，就不必关系 SSH 数据报文，因此在抓包结果中过滤掉 SSH 报文可能更便于你分析问题。</p><p>tcpdump 有很多参数选项可以设置数据包过滤规则，例如根据源 IP 以及目的 IP 地址，端口号，协议等等规则来过滤数据包。下面就介绍一些最常用的过滤方法。</p><p>协议<br>在命令中指定协议便可以按照协议类型来筛选数据包。比方说用如下命令只要抓取 ICMP 报文：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c5 icmp</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">然后再打开一个终端，去 ping 另一台机器：</span><br><span class="line"></span><br><span class="line">$ ping opensource.com</span><br><span class="line">PING opensource.com (54.204.39.132) 56(84) bytes of data.</span><br><span class="line">64 bytes from ec2-54-204-39-132.compute-1.amazonaws.com (54.204.39.132): icmp_seq=1 ttl=47 time=39.6 ms</span><br><span class="line">回到运行 tcpdump 命令的终端中，可以看到它筛选出了 ICMP 报文。这里 tcpdump 并没有显示有关 opensource.com 的域名解析数据包：</span><br><span class="line"></span><br><span class="line">09:34:20.136766 IP rhel75 &gt; ec2-54-204-39-132.compute-1.amazonaws.com: ICMP <span class="built_in">echo</span> request, id 20361, seq 1, length 64</span><br><span class="line">09:34:20.176402 IP ec2-54-204-39-132.compute-1.amazonaws.com &gt; rhel75: ICMP <span class="built_in">echo</span> reply, id 20361, seq 1, length 64</span><br><span class="line">09:34:21.140230 IP rhel75 &gt; ec2-54-204-39-132.compute-1.amazonaws.com: ICMP <span class="built_in">echo</span> request, id 20361, seq 2, length 64</span><br><span class="line">09:34:21.180020 IP ec2-54-204-39-132.compute-1.amazonaws.com &gt; rhel75: ICMP <span class="built_in">echo</span> reply, id 20361, seq 2, length 64</span><br><span class="line">09:34:22.141777 IP rhel75 &gt; ec2-54-204-39-132.compute-1.amazonaws.com: ICMP <span class="built_in">echo</span> request, id 20361, seq 3, length 64</span><br><span class="line">5 packets captured</span><br><span class="line">5 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">主机 </span><br><span class="line"> 用 host 参数只抓取和特定主机相关的数据包：</span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">$ sudo tcpdump -i any -c5 -nn host 54.204.39.132</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">09:54:20.042023 IP 192.168.122.98.39326 &gt; 54.204.39.132.80: Flags [S], seq 1375157070, win 29200, options [mss 1460,sackOK,TS val 122350391 ecr 0,nop,wscale 7], length 0</span><br><span class="line">09:54:20.088127 IP 54.204.39.132.80 &gt; 192.168.122.98.39326: Flags [S.], seq 1935542841, ack 1375157071, win 28960, options [mss 1460,sackOK,TS val 522713542 ecr 122350391,nop,wscale 9], length 0</span><br><span class="line">09:54:20.088204 IP 192.168.122.98.39326 &gt; 54.204.39.132.80: Flags [.], ack 1, win 229, options [nop,nop,TS val 122350437 ecr 522713542], length 0</span><br><span class="line">09:54:20.088734 IP 192.168.122.98.39326 &gt; 54.204.39.132.80: Flags [P.], seq 1:113, ack 1, win 229, options [nop,nop,TS val 122350438 ecr 522713542], length 112: HTTP: GET / HTTP/1.1</span><br><span class="line">09:54:20.129733 IP 54.204.39.132.80 &gt; 192.168.122.98.39326: Flags [.], ack 113, win 57, options [nop,nop,TS val 522713552 ecr 122350438], length 0</span><br><span class="line">5 packets captured</span><br><span class="line">5 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line">如上所示，只抓取和显示与 54.204.39.132 有关的数据包。</span><br></pre></td></tr></table></figure><p>端口号<br>tcpdump 可以根据服务类型或者端口号来筛选数据包。例如，抓取和 HTTP 服务相关的数据包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c5 -nn port 80</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">09:58:28.790548 IP 192.168.122.98.39330 &gt; 54.204.39.132.80: Flags [S], seq 1745665159, win 29200, options [mss 1460,sackOK,TS val 122599140 ecr 0,nop,wscale 7], length 0</span><br><span class="line">09:58:28.834026 IP 54.204.39.132.80 &gt; 192.168.122.98.39330: Flags [S.], seq 4063583040, ack 1745665160, win 28960, options [mss 1460,sackOK,TS val 522775728 ecr 122599140,nop,wscale 9], length 0</span><br><span class="line">09:58:28.834093 IP 192.168.122.98.39330 &gt; 54.204.39.132.80: Flags [.], ack 1, win 229, options [nop,nop,TS val 122599183 ecr 522775728], length 0</span><br><span class="line">09:58:28.834588 IP 192.168.122.98.39330 &gt; 54.204.39.132.80: Flags [P.], seq 1:113, ack 1, win 229, options [nop,nop,TS val 122599184 ecr 522775728], length 112: HTTP: GET / HTTP/1.1</span><br><span class="line">09:58:28.878445 IP 54.204.39.132.80 &gt; 192.168.122.98.39330: Flags [.], ack 113, win 57, options [nop,nop,TS val 522775739 ecr 122599184], length 0</span><br><span class="line">5 packets captured</span><br><span class="line">5 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure><p>IP 地址 / 主机名<br>同样，你也可以根据源 IP 地址或者目的 IP 地址或者主机名来筛选数据包。例如抓取源 IP 地址为 192.168.122.98 的数据包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c5 -nn src 192.168.122.98</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">10:02:15.220824 IP 192.168.122.98.39436 &gt; 192.168.122.1.53: 59332+ A? opensource.com. (32)</span><br><span class="line">10:02:15.220862 IP 192.168.122.98.39436 &gt; 192.168.122.1.53: 20749+ AAAA? opensource.com. (32)</span><br><span class="line">10:02:15.364062 IP 192.168.122.98.39334 &gt; 54.204.39.132.80: Flags [S], seq 1108640533, win 29200, options [mss 1460,sackOK,TS val 122825713 ecr 0,nop,wscale 7], length 0</span><br><span class="line">10:02:15.409229 IP 192.168.122.98.39334 &gt; 54.204.39.132.80: Flags [.], ack 669337581, win 229, options [nop,nop,TS val 122825758 ecr 522832372], length 0</span><br><span class="line">10:02:15.409667 IP 192.168.122.98.39334 &gt; 54.204.39.132.80: Flags [P.], seq 0:112, ack 1, win 229, options [nop,nop,TS val 122825759 ecr 522832372], length 112: HTTP: GET / HTTP/1.1</span><br><span class="line">5 packets captured</span><br><span class="line">5 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line">注意此处示例中抓取了来自源 IP 地址 192.168.122.98 的 53 端口以及 80 端口的数据包，它们的应答包没有显示出来因为那些包的源 IP 地址已经变了。</span><br><span class="line"></span><br><span class="line">相对的，使用 dst 就是按目的 IP / 主机名来筛选数据包。</span><br><span class="line"></span><br><span class="line">$ sudo tcpdump -i any -c5 -nn dst 192.168.122.98</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">10:05:03.572931 IP 192.168.122.1.53 &gt; 192.168.122.98.47049: 2248 1/0/0 A 54.204.39.132 (48)</span><br><span class="line">10:05:03.572944 IP 192.168.122.1.53 &gt; 192.168.122.98.47049: 33770 0/0/0 (32)</span><br><span class="line">10:05:03.621833 IP 54.204.39.132.80 &gt; 192.168.122.98.39338: Flags [S.], seq 3474204576, ack 3256851264, win 28960, options [mss 1460,sackOK,TS val 522874425 ecr 122993922,nop,wscale 9], length 0</span><br><span class="line">10:05:03.667767 IP 54.204.39.132.80 &gt; 192.168.122.98.39338: Flags [.], ack 113, win 57, options [nop,nop,TS val 522874436 ecr 122993972], length 0</span><br><span class="line">10:05:03.672221 IP 54.204.39.132.80 &gt; 192.168.122.98.39338: Flags [P.], seq 1:643, ack 113, win 57, options [nop,nop,TS val 522874437 ecr 122993972], length 642: HTTP: HTTP/1.1 302 Found</span><br><span class="line">5 packets captured</span><br><span class="line">5 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure><p>多条件筛选<br>当然，可以使用多条件组合来筛选数据包，使用 and 以及 or 逻辑操作符来创建过滤规则。例如，筛选来自源 IP 地址 192.168.122.98 的 HTTP 数据包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c5 -nn src 192.168.122.98 and port 80</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">10:08:00.472696 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags [S], seq 2712685325, win 29200, options [mss 1460,sackOK,TS val 123170822 ecr 0,nop,wscale 7], length 0</span><br><span class="line">10:08:00.516118 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags [.], ack 268723504, win 229, options [nop,nop,TS val 123170865 ecr 522918648], length 0</span><br><span class="line">10:08:00.516583 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags [P.], seq 0:112, ack 1, win 229, options [nop,nop,TS val 123170866 ecr 522918648], length 112: HTTP: GET / HTTP/1.1</span><br><span class="line">10:08:00.567044 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags [.], ack 643, win 239, options [nop,nop,TS val 123170916 ecr 522918661], length 0</span><br><span class="line">10:08:00.788153 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags [F.], seq 112, ack 643, win 239, options [nop,nop,TS val 123171137 ecr 522918661], length 0</span><br><span class="line">5 packets captured</span><br><span class="line">5 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line">你也可以使用括号来创建更为复杂的过滤规则，但在 shell 中请用引号包含你的过滤规则以防止被识别为 shell 表达式：</span><br><span class="line"></span><br><span class="line">$ sudo tcpdump -i any -c5 -nn <span class="string">"port 80 and (src 192.168.122.98 or src 54.204.39.132)"</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">10:10:37.602214 IP 192.168.122.98.39346 &gt; 54.204.39.132.80: Flags [S], seq 871108679, win 29200, options [mss 1460,sackOK,TS val 123327951 ecr 0,nop,wscale 7], length 0</span><br><span class="line">10:10:37.650651 IP 54.204.39.132.80 &gt; 192.168.122.98.39346: Flags [S.], seq 854753193, ack 871108680, win 28960, options [mss 1460,sackOK,TS val 522957932 ecr 123327951,nop,wscale 9], length 0</span><br><span class="line">10:10:37.650708 IP 192.168.122.98.39346 &gt; 54.204.39.132.80: Flags [.], ack 1, win 229, options [nop,nop,TS val 123328000 ecr 522957932], length 0</span><br><span class="line">10:10:37.651097 IP 192.168.122.98.39346 &gt; 54.204.39.132.80: Flags [P.], seq 1:113, ack 1, win 229, options [nop,nop,TS val 123328000 ecr 522957932], length 112: HTTP: GET / HTTP/1.1</span><br><span class="line">10:10:37.692900 IP 54.204.39.132.80 &gt; 192.168.122.98.39346: Flags [.], ack 113, win 57, options [nop,nop,TS val 522957942 ecr 123328000], length 0</span><br><span class="line">5 packets captured</span><br><span class="line">5 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line">该例子中我们只抓取了来自源 IP 为 192.168.122.98 或者 54.204.39.132 的 HTTP （端口号 80）的数据包。使用该方法就很容易抓取到数据流中交互双方的数据包了。</span><br></pre></td></tr></table></figure><h3 id="检查数据包内容"><a href="#检查数据包内容" class="headerlink" title="检查数据包内容"></a>检查数据包内容</h3><p>在以上的示例中，我们只按数据包头部的信息来建立规则筛选数据包，例如源地址、目的地址、端口号等等。有时我们需要分析网络连接问题，可能需要分析数据包中的内容来判断什么内容需要被发送、什么内容需要被接收等。tcpdump 提供了两个选项可以查看数据包内容，-X 以十六进制打印出数据报文内容，-A 打印数据报文的 ASCII 值。</p><p>例如，HTTP 请求报文内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c10 -nn -A port 80</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">13:02:14.871803 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [S], seq 2546602048, win 29200, options [mss 1460,sackOK,TS val 133625221 ecr 0,nop,wscale 7], length 0</span><br><span class="line">E..&lt;..@.@.....zb6.<span class="string">'....P...@......r............</span></span><br><span class="line"><span class="string">............................</span></span><br><span class="line"><span class="string">13:02:14.910734 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags [S.], seq 1877348646, ack 2546602049, win 28960, options [mss 1460,sackOK,TS val 525532247 ecr 133625221,nop,wscale 9], length 0</span></span><br><span class="line"><span class="string">E..&lt;..@./..a6.'</span>...zb.P..o..&amp;...A..q a..........</span><br><span class="line">.R.W.......     ................</span><br><span class="line">13:02:14.910832 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [.], ack 1, win 229, options [nop,nop,TS val 133625260 ecr 525532247], length 0</span><br><span class="line">E..4..@.@.....zb6.<span class="string">'....P...Ao..'</span>...........</span><br><span class="line">.....R.W................</span><br><span class="line">13:02:14.911808 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [P.], seq 1:113, ack 1, win 229, options [nop,nop,TS val 133625261 ecr 525532247], length 112: HTTP: GET / HTTP/1.1</span><br><span class="line">E.....@.@..1..zb6.<span class="string">'....P...Ao..'</span>...........</span><br><span class="line">.....R.WGET / HTTP/1.1</span><br><span class="line">User-Agent: Wget/1.14 (linux-gnu)</span><br><span class="line">Accept: */*</span><br><span class="line">Host: opensource.com</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">................</span><br><span class="line">13:02:14.951199 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags [.], ack 113, win 57, options [nop,nop,TS val 525532257 ecr 133625261], length 0</span><br><span class="line">E..4.F@./..<span class="string">"6.'...zb.P..o..'.......9.2.....</span></span><br><span class="line"><span class="string">.R.a....................</span></span><br><span class="line"><span class="string">13:02:14.955030 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags [P.], seq 1:643, ack 113, win 57, options [nop,nop,TS val 525532258 ecr 133625261], length 642: HTTP: HTTP/1.1 302 Found</span></span><br><span class="line"><span class="string">E....G@./...6.'...zb.P..o..'.......9.......</span></span><br><span class="line"><span class="string">.R.b....HTTP/1.1 302 Found</span></span><br><span class="line"><span class="string">Server: nginx</span></span><br><span class="line"><span class="string">Date: Sun, 23 Sep 2018 17:02:14 GMT</span></span><br><span class="line"><span class="string">Content-Type: text/html; charset=iso-8859-1</span></span><br><span class="line"><span class="string">Content-Length: 207</span></span><br><span class="line"><span class="string">X-Content-Type-Options: nosniff</span></span><br><span class="line"><span class="string">Location: https://opensource.com/</span></span><br><span class="line"><span class="string">Cache-Control: max-age=1209600</span></span><br><span class="line"><span class="string">Expires: Sun, 07 Oct 2018 17:02:14 GMT</span></span><br><span class="line"><span class="string">X-Request-ID: v-6baa3acc-bf52-11e8-9195-22000ab8cf2d</span></span><br><span class="line"><span class="string">X-Varnish: 632951979</span></span><br><span class="line"><span class="string">Age: 0</span></span><br><span class="line"><span class="string">Via: 1.1 varnish (Varnish/5.2)</span></span><br><span class="line"><span class="string">X-Cache: MISS</span></span><br><span class="line"><span class="string">Connection: keep-alive</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE HTML PUBLIC"</span>-//IETF//DTD HTML 2.0//EN<span class="string">"&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;302 Found&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Found&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;The document has moved &lt;a href="</span>https://opensource.com/<span class="string">"&gt;here&lt;/a&gt;.&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">................</span></span><br><span class="line"><span class="string">13:02:14.955083 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [.], ack 643, win 239, options [nop,nop,TS val 133625304 ecr 525532258], length 0</span></span><br><span class="line"><span class="string">E..4..@.@.....zb6.'....P....o..............</span></span><br><span class="line"><span class="string">.....R.b................</span></span><br><span class="line"><span class="string">13:02:15.195524 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [F.], seq 113, ack 643, win 239, options [nop,nop,TS val 133625545 ecr 525532258], length 0</span></span><br><span class="line"><span class="string">E..4..@.@.....zb6.'....P....o..............</span></span><br><span class="line"><span class="string">.....R.b................</span></span><br><span class="line"><span class="string">13:02:15.236592 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags [F.], seq 643, ack 114, win 57, options [nop,nop,TS val 525532329 ecr 133625545], length 0</span></span><br><span class="line"><span class="string">E..4.H@./.. 6.'...zb.P..o..........9.I.....</span></span><br><span class="line"><span class="string">.R......................</span></span><br><span class="line"><span class="string">13:02:15.236656 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [.], ack 644, win 239, options [nop,nop,TS val 133625586 ecr 525532329], length 0</span></span><br><span class="line"><span class="string">E..4..@.@.....zb6.'....P....o..............</span></span><br><span class="line"><span class="string">.....R..................</span></span><br><span class="line"><span class="string">10 packets captured</span></span><br><span class="line"><span class="string">10 packets received by filter</span></span><br><span class="line"><span class="string">0 packets dropped by kernel</span></span><br></pre></td></tr></table></figure><p>这对定位一些普通 HTTP 调用 API 接口的问题很有用。当然如果是加密报文，这个输出也就没多大用了。</p><h3 id="保存抓包数据"><a href="#保存抓包数据" class="headerlink" title="保存抓包数据"></a>保存抓包数据</h3><p>tcpdump 提供了保存抓包数据的功能以便后续分析数据包。例如，你可以夜里让它在那里抓包，然后早上起来再去分析它。同样当有很多数据包时，显示过快也不利于分析，将数据包保存下来，更有利于分析问题。</p><p>使用 -w 选项来保存数据包而不是在屏幕上显示出抓取的数据包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c10 -nn -w webserver.pcap port 80</span><br><span class="line">[sudo] password <span class="keyword">for</span> ricardo:</span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">10 packets captured</span><br><span class="line">10 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure><p>该命令将抓取的数据包保存到文件 webserver.pcap。后缀名 pcap 表示文件是抓取的数据包格式。</p><p>正如示例中所示，保存数据包到文件中时屏幕上就没有任何有关数据报文的输出，其中 -c10 表示抓取到 10 个数据包后就停止抓包。如果想有一些反馈来提示确实抓取到了数据包，可以使用 -v 选项。</p><p>tcpdump 将数据包保存在二进制文件中，所以不能简单的用文本编辑器去打开它。使用 -r 选项参数来阅读该文件中的报文内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nn -r webserver.pcap</span><br><span class="line">reading from file webserver.pcap, link-type LINUX_SLL (Linux cooked)</span><br><span class="line">13:36:57.679494 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags [S], seq 3709732619, win 29200, options [mss 1460,sackOK,TS val 135708029 ecr 0,nop,wscale 7], length 0</span><br><span class="line">13:36:57.718932 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [S.], seq 1999298316, ack 3709732620, win 28960, options [mss 1460,sackOK,TS val 526052949 ecr 135708029,nop,wscale 9], length 0</span><br><span class="line">13:36:57.719005 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags [.], ack 1, win 229, options [nop,nop,TS val 135708068 ecr 526052949], length 0</span><br><span class="line">13:36:57.719186 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags [P.], seq 1:113, ack 1, win 229, options [nop,nop,TS val 135708068 ecr 526052949], length 112: HTTP: GET / HTTP/1.1</span><br><span class="line">13:36:57.756979 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [.], ack 113, win 57, options [nop,nop,TS val 526052959 ecr 135708068], length 0</span><br><span class="line">13:36:57.760122 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [P.], seq 1:643, ack 113, win 57, options [nop,nop,TS val 526052959 ecr 135708068], length 642: HTTP: HTTP/1.1 302 Found</span><br><span class="line">13:36:57.760182 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags [.], ack 643, win 239, options [nop,nop,TS val 135708109 ecr 526052959], length 0</span><br><span class="line">13:36:57.977602 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags [F.], seq 113, ack 643, win 239, options [nop,nop,TS val 135708327 ecr 526052959], length 0</span><br><span class="line">13:36:58.022089 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [F.], seq 643, ack 114, win 57, options [nop,nop,TS val 526053025 ecr 135708327], length 0</span><br><span class="line">13:36:58.022132 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags [.], ack 644, win 239, options [nop,nop,TS val 135708371 ecr 526053025], length 0</span><br><span class="line">$</span><br></pre></td></tr></table></figure><p>这里不需要管理员权限 sudo 了，因为此刻并不是在网络接口处抓包。</p><p>你还可以使用我们讨论过的任何过滤规则来过滤文件中的内容，就像使用实时数据一样。 例如，通过执行以下命令从源 IP 地址 54.204.39.132 检查文件中的数据包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nn -r webserver.pcap src 54.204.39.132</span><br><span class="line">reading from file webserver.pcap, link-type LINUX_SLL (Linux cooked)</span><br><span class="line">13:36:57.718932 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [S.], seq 1999298316, ack 3709732620, win 28960, options [mss 1460,sackOK,TS val 526052949 ecr 135708029,nop,wscale 9], length 0</span><br><span class="line">13:36:57.756979 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [.], ack 113, win 57, options [nop,nop,TS val 526052959 ecr 135708068], length 0</span><br><span class="line">13:36:57.760122 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [P.], seq 1:643, ack 113, win 57, options [nop,nop,TS val 526052959 ecr 135708068], length 642: HTTP: HTTP/1.1 302 Found</span><br><span class="line">13:36:58.022089 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [F.], seq 643, ack 114, win 57, options [nop,nop,TS val 526053025 ecr 135708327], length 0</span><br></pre></td></tr></table></figure><h2 id="下一步做什么？"><a href="#下一步做什么？" class="headerlink" title="下一步做什么？"></a>下一步做什么？</h2><p>以上的基本功能已经可以帮助你使用强大的 tcpdump 抓包工具了。更多的内容请参考 tcpdump 网站以及它的帮助文件。</p><p><a href="https://hackertarget.com/tcpdump-examples/" target="_blank" rel="noopener">https://hackertarget.com/tcpdump-examples/</a></p><p>tcpdump 命令行工具为分析网络流量数据包提供了强大的灵活性。如果需要使用图形工具来抓包请参考 Wireshark。</p><p>Wireshark 还可以用来读取 tcpdump 保存的 pcap 文件。你可以使用 tcpdump 命令行在没有 GUI 界面的远程机器上抓包然后在 Wireshark 中分析数据包。</p><p>一站式学习 Wireshark<br><a href="https://community.emc.com/thread/194901" target="_blank" rel="noopener">https://community.emc.com/thread/194901</a><br><a href="https://www.w3cschool.cn/wireshark/" target="_blank" rel="noopener">https://www.w3cschool.cn/wireshark/</a></p>]]></content>
    
    <summary type="html">
    
      tcpdump 是一款灵活、功能强大的抓包工具，能有效地帮助排查网络故障问题。
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>从国内跳槽至新加坡工作的经验分享</title>
    <link href="https://wsgzao.github.io/post/singapore/"/>
    <id>https://wsgzao.github.io/post/singapore/</id>
    <published>2019-02-14T06:59:49.000Z</published>
    <updated>2019-02-14T10:10:21.037Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://wx3.sinaimg.cn/large/7207510dgy1fv6xrebwasj21jj0uzqe6.jpg" alt=""></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>记录和分享自己在新加坡的工作生活以及新加坡的基本介绍，如果你只想了解我是如何来到新加坡的可以直接跳到最后一章。</p><blockquote><p>为帮助大家玩转新加坡，快速适应当地生活</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 02 月 14 日 - 更新半年的经历以及 PR 申请流程<br>2018 年 09 月 09 日 - 增加新加坡 3 个月工作生活感受<br>2018 年 08 月 01 日 - 更新个人经验<br>2018 年 05 月 15 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/singapore/">https://wsgzao.github.io/post/singapore/</a></p><p><strong> 扩展阅读 </strong></p><p>新加坡外交部 - <a href="https://www.mfa.gov.sg/content/mfa/overseasmission/beijing/ch.html" target="_blank" rel="noopener">https://www.mfa.gov.sg/content/mfa/overseasmission/beijing/ch.html</a><br>新加坡眼 - <a href="https://www.yan.sg/" target="_blank" rel="noopener">https://www.yan.sg/</a></p><hr><h2 id="认识狮城"><a href="#认识狮城" class="headerlink" title="认识狮城"></a>认识狮城</h2><p>姓名：新加坡</p><p>年龄：53 岁（成立于 1965 年，国庆日为每年的 8 月 9 日）</p><p>家庭住址：北半球赤道地区，位于马来半岛最南端 （北纬 1°22′，东经 103°48′）</p><p>住房面积：新加坡国土面积 710.3 平方公里 （新加坡面积是上海的 1/9，北京的 1/23）</p><p>家庭成员：人口约 520 万，密度达到每平方公里 7700 多人（排在世界前列）</p><p>相貌特征：新加坡多元种族和文化的相互融合是其极具魅力的原因之一，由华族（占全国人口约四分之三）、欧亚族、印度族、马来族、土生华人构成。</p><p>性格特征：新加坡以实行严格的法律和制度著称，无论是居民还是游客，都需要予以足够重视，否则可能会被课以重罚。当然，如果您遵循当地法律规章，也不必过分担心。</p><blockquote><p>所获荣誉：或许这些荣誉只属于过去，我们更需要关心的是现在和未来会怎样</p></blockquote><p>让人最想移民的国家全球排名第一<br>全球最具竞争力国家排名第一<br>最适应亚洲人士居住的地方全球排名第一<br>城市基础设施建设全球排名第一<br>全球化程度最高的城市排名第一</p><p>其他方面：<a href="http://www.visitsingapore.com.cn/travel-guide-tips/about-singapore/" target="_blank" rel="noopener">http://www.visitsingapore.com.cn/travel-guide-tips/about-singapore/</a></p><h2 id="旅游出入境"><a href="#旅游出入境" class="headerlink" title="旅游出入境"></a>旅游出入境</h2><blockquote><p>签证</p></blockquote><p>中国公民去新加坡须提前申请有效签证，不可以落地签。</p><p>中国公民申请的新加坡旅游 / 商务签证为电子签证（e-Visa），在获得签证后，建议上网打印多份有效签证以防遗失。签证费为每人 SG$30。</p><p>新加坡签证可多次入境，有效期分别有 35 天 / 62 天 / 2 年，由签证官根据申请人资料而定。逗留时间则由入境官决定，通常为 14-30 天。从 2015 年 6 月 1 日起新加坡将给予符合条件的中国公民有效期长达 10 年的多次入境签证。</p><p><a href="http://www.visitsingapore.com.cn/travel-guide-tips/travelling-to-singapore/" target="_blank" rel="noopener">http://www.visitsingapore.com.cn/travel-guide-tips/travelling-to-singapore/</a></p><blockquote><p>申请途径 How to Apply</p></blockquote><p>2014 年 12 月 8 日起大使馆及各领事馆停止接收签证申请，可登录新加坡外交部官网，查询中国国内官方指定的签证机构，办理新加坡签证。</p><blockquote><p>所需资料 Required Information</p></blockquote><ol><li>个人信息表（登录新加坡外交部官网下载表格，链接：<a href="http://www.mfa.gov.sg）" target="_blank" rel="noopener">www.mfa.gov.sg）</a></li><li>户口本（原件或扫描电子版，户主 + 个人页复印件）</li><li>身份证（原件或正反面扫描电子版，正反面复印件）</li><li>护照（原件或个人页扫描电子版，个人页复印件，有效期 6 个月以上）</li><li>2 张 2 寸白底免冠照片</li><li>在职证明原件或相关职业证书</li></ol><blockquote><p>出入境</p></blockquote><p>从 2018 年 10 月 4 日起，新加坡纸质入境卡（人称 “白卡”）即将走入历史！取而代之的是电子化入境卡。</p><p>访客可通过移民关卡局官方网站 <a href="https://www.ica.gov.sg/" target="_blank" rel="noopener">https://www.ica.gov.sg/</a> 或下载手机应用程序填写资料。通过手机填写资料还有自动储存功能，以方便下一次入境时使用。而与家人或小组团体同游新加坡的人，能够以团体方式提交入境资料。</p><p>离境前别忘了退税，在附有 “退税” 标志的场所消费满 100 新币以上，即可退回 7% 的商品及服务税，退税时需出示购物发票或收据。具体的退税要求，可咨询工作人员。</p><blockquote><p>其它注意事项</p></blockquote><p>电源插座：新加坡使用的标准电流是 220-240 伏特交流电（50 赫兹），在这里，您可以使用三眼电源插座。</p><p><a href="http://www.visitsingapore.com.cn/travel-guide-tips/" target="_blank" rel="noopener">http://www.visitsingapore.com.cn/travel-guide-tips/</a></p><p><img src="https://ws3.sinaimg.cn/large/7207510dgy1frc1wdtdd7j20vh12047o.jpg" alt=""></p><h2 id="新加坡工作准证"><a href="#新加坡工作准证" class="headerlink" title="新加坡工作准证"></a>新加坡工作准证</h2><blockquote><p>关于工作准证的最新信息请以新加坡人力部 (MOM) 发布的为准</p></blockquote><p><a href="https://www.mom.gov.sg/" target="_blank" rel="noopener">https://www.mom.gov.sg/</a></p><p>在新加坡工作，新加坡人力部 Ministry Of Manpower (MOM) 是最常打交道的政府部门，工作准证不仅是由人力部批准和颁发所有文件提交最终也是到达人力部</p><p>注意：所有提交给 MOM 的资料原件，都需要在入境的时候随身携带。以便在去人力部办卡的时候，让长官核实和查阅。</p><ol><li>新版卡片上将不再印刷准证的到期日期，新版卡片会印上二维码（QR Code），下载 SGWorkPass 的手机 APP 后，可以扫码查看持卡人的职务、证件是否有效等信息</li><li>如果过海关或签合约等需要核对卡片截止日期时，不再可以只看卡面信息，还需要扫码或在线上核对截止日期等，建议保存 SGWorkPass 截图至手机中以防万一</li></ol><p><img src="https://wx1.sinaimg.cn/large/7207510dgy1fv5lr2gqf4j21a40ek0xd.jpg" alt=""></p><p><a href="https://docs.qq.com/sheet/DeVh5ZEhKWnhCTldK" target="_blank" rel="noopener">如果发现表有错误请点击链接申请编辑更新，谢谢</a></p><h3 id="Work-Permit-WP"><a href="#Work-Permit-WP" class="headerlink" title="Work Permit (WP)"></a>Work Permit (WP)</h3><p>WP 是人力部设置的给外国低水准员工提供的工作准证。</p><p>对申请者的要求：薪水和学历：无要求<br>年龄：马来西亚人（18-58 周岁），非马来西亚人（18-50 周岁）；<br>对公司的要求：需要为其购买保额至少 15000 新币的保险；缴纳 5000 新币担保金<br>注意事项：<br>公司需要先为雇员申请好 WP 并办理保险，才可以持 WP 准证进入新加坡。在申请的状态中，本人不可以进入新加坡。</p><h3 id="S-PASS-SP"><a href="#S-PASS-SP" class="headerlink" title="S PASS (SP)"></a>S PASS (SP)</h3><p>SP 是人力部设置的给外国中级技术水准雇员提供的工作准证。</p><p>对申请者的要求：学历：大专，本科，或者技术资质认证（需要至少一年全职学习获得的技术认证）；<br>工作年限：虽然没有明文规定最少需要多少年的工作经验，但工作经验会作为一个审核标准；<br>对公司的要求：所付起薪 2200 新币；</p><p>注意事项：<br>也有公司人头配额限制：服务行业 SP 人数不可超过总员工的 15%，其它行业是 20%。<br>你在申请之前需要确保学历在 Dataflow，学信网及中国学位与研究生教育信息网上可以查到。另外，针对不同的行业，也有可能需要提交相关的专业证明。</p><h3 id="Employment-Pass（EP）"><a href="#Employment-Pass（EP）" class="headerlink" title="Employment Pass（EP）"></a>Employment Pass（EP）</h3><p>EP 是人力部设置的给外国专业人员（管理层，主管或专业职位）提供的工作准证. 是工作准证中级别最高的。</p><p>对申请者的要求：<br>年轻的申请者需拥有优秀院校的毕业证书，且达到 3600 的雇佣薪水以及拥有相关专业经验才可以申请。<br>至于年长的申请人，则必须拥有更高的薪水以及相应工作经验和工作质量。</p><p>对雇主的要求：<br>所付起薪 3600 新币</p><p>注意事项：<br>和申请 SP 一样，在申请之前需要确保学历在 Dataflow，学信网及中国学位与研究生教育信息网上可以查到。另外，针对不同的行业，也有可能需要提交相关的专业证明。<br>根据对应的准证类型，提交人力部 (MOM) 所要求的材料</p><ul><li>有效的护照信息</li><li>必要的技能证书</li><li>有效的毕业证</li></ul><p>2018 年 1 月 1 日起两件重要变化</p><ul><li>EP 准证持有人月薪至少 6000 新币以上可以给配偶和孩子申请相关准证(DP)</li><li>EP 准证持有人月薪至少 12000 新币以上可以申请父母长期探访准证（LTVP)</li></ul><h2 id="家庭成员准证"><a href="#家庭成员准证" class="headerlink" title="家庭成员准证"></a>家庭成员准证</h2><h3 id="Dependant‘s-Pass-家属准证（DP）"><a href="#Dependant‘s-Pass-家属准证（DP）" class="headerlink" title="Dependant‘s Pass 家属准证（DP）"></a>Dependant‘s Pass 家属准证（DP）</h3><p>家属准证，在新加坡工作或经商，并持有 EP SP 或 Enptrpass 的人士，可为自己的配偶及 21 岁以下小孩申请的一种准证。持家属准证的小孩，可直接入学新加坡政府中小学。</p><p>薪水：担保人固定月薪薪水需达到 5,000 新币以上。（2018 年 1 月 1 日起至少达到 6000 新币以上）。</p><p>工作：EP 或创业准证家属，可通过公司向人力部申请新加坡工作的凭证 LOC（Letter of consent），批准后，可直接工作（不占用公司配额）。SP 家属准证，需申请工作准证后才能工作。家属准证（DP）持有人申请到工作准证（EP 或 SP）后需取消 DP，SP 家属取得的工作准证有效期与 SP 持有人准证有效期相关。</p><h3 id="Long-Term-Visit-Pass-长期探访准证（LTVP）"><a href="#Long-Term-Visit-Pass-长期探访准证（LTVP）" class="headerlink" title="Long Term Visit Pass 长期探访准证（LTVP）"></a>Long Term Visit Pass 长期探访准证（LTVP）</h3><p>长期探访准证，是新加坡政府颁发的一种可以在新加坡长期居住的准证，期限从半年到十年不等。其中新加坡公民的配偶又可以申请获得 LTVP+。目前的审批部门有两个，一个是 ICA 移民厅，一个是 MOM 人力部。</p><p>需要去移民厅申请的：</p><ol><li>新加坡公民的配偶<br>2.PR 的配偶</li><li>新加坡公民 / PR 未满 21 周岁的小孩</li><li>新加坡公民 / 21 周岁以上 PR 的父母</li><li>寻求在新加坡工作的有关高校毕业生</li><li>小孩 / 孙辈在新加坡持学生准证读书的母亲或外祖母</li><li>寻求准许在新加坡分娩者</li></ol><p>新加坡移民局网址<br><a href="https://www.ica.gov.sg/" target="_blank" rel="noopener">https://www.ica.gov.sg/</a></p><p>需要去人力部申请的：</p><ol><li>EP/SP 准证持有者的配偶（2018 年 1 月 1 日起至少 6000 新币）</li><li>EP/SP 准证持有者未满 21 周岁的未婚残疾子女（2018 年 1 月 1 日起至少 6000 新币）</li><li>EP/SP 准证持有者未满 21 周岁的未婚继子女（2018 年 1 月 1 日起至少 6000 新币）</li><li>EP/SP 准证持有者的父母（2018 年 1 月 1 日起至少 12000 新币）</li><li>Entrepass（创业准证）的父母</li></ol><p>新加坡人力部网址：<br><a href="https://www.mom.gov.sg/" target="_blank" rel="noopener">https://www.mom.gov.sg/</a></p><h2 id="新加坡通讯指南"><a href="#新加坡通讯指南" class="headerlink" title="新加坡通讯指南"></a>新加坡通讯指南</h2><p>国内的手机大部分都可以在新加坡直接换卡使用，除非你的手机是中国移动 4G 定制版本，由于网络制式的区别，无法使用新加坡 4G 网络，新加坡目前 2G 网络停止服务。</p><blockquote><p>小贴士：建议使用全网通手机，去国外任何地方都可以直接换卡使用。</p></blockquote><p>运营商：新电信（Singtel）、星河（Starhub）和 M1（Mobile One）</p><p>在新加坡机场、邮局、7-11 便利店和代理商都可以购买和充值电话卡，记得一定要带上护照，新加坡的手机卡采用实名制。推荐大家下载所用运营商的 App，查询和购买话费、流量等。</p><blockquote><p>Zero1: Get Ready For Unlimited Data | Plans</p></blockquote><p>我自己办理的是 Zero1 的 9.9 新币 / 月无限流量套餐</p><p>详情请参考官网：<a href="https://zero1.sg/" target="_blank" rel="noopener">https://zero1.sg/</a></p><h2 id="新加坡交通指南"><a href="#新加坡交通指南" class="headerlink" title="新加坡交通指南"></a>新加坡交通指南</h2><p>新加坡主要交通出行方式：地铁（MRT）、轻轨（LRT）、巴士（Bus）和德士（Taxi）。</p><p>其中地铁（MRT）是新加坡最便捷的交通工具，也是日常最佳的出行方式。根据官方 2017 年 1 月份提供的最新信息显示，全岛共设有 142 个车站，目前主要的运营线中，南北运营线以 “NS” 红线标明，东西运营线以 “EW” 绿线标明，东北运营线以 “NE” 紫线标明，环线以 “CC” 黄线标明，市区运营线以 “DT” 蓝线。</p><p><img src="http://ws2.sinaimg.cn/large/7207510dgy1ftu6uc735wj215o0xp48v.jpg" alt=""></p><p>新加坡地铁图</p><p><a href="https://exploresg.com/ditie/" target="_blank" rel="noopener">https://exploresg.com/ditie/</a></p><p>新加坡地铁和巴士车 (站) 内规定</p><ol><li>不可吃喝、吸烟、携带榴莲、大声喧哗和带宠物 </li><li>Bus 不报站、上下车需要刷卡</li></ol><p>温馨提示</p><ol><li>地铁和巴士上冷气很足，建议携带薄外套</li><li>在 20 分钟内，地铁和巴士之间转换，车资有优惠</li><li>在地铁或者商场等使用扶梯时，左侧是站立侧，右侧是快速通道</li></ol><h2 id="新加坡房屋指南"><a href="#新加坡房屋指南" class="headerlink" title="新加坡房屋指南"></a>新加坡房屋指南</h2><blockquote><p>组屋(HDB)</p></blockquote><p>新加坡的“组屋”，全称为组合房屋。由新加坡建屋发展局（HDB）不以盈利为目的承担建筑的楼房，为大部分新加坡人（80%）的住所。</p><p>组屋一般分为三房式、四房式和五房式。三房式指一厅两房，使用面积约 60 平方米；四房式是一厅三房，使用面积约 90 平方米；五房式是两厅三房，使用面积大致在 110 平方米。</p><p>组屋的区分都是按照地区名 + 数字，例如：PasirRis Block 186（巴西立大牌 186）、YishunBlock 210（义顺大牌 210）等。</p><p>屋内客厅，厨房，卫生间都是公用设施，一般会配备冰箱，洗衣机，空调或者风扇。</p><p>租房费用（一般情况下）：</p><p>新型组屋 (近 10 年内建成的) 相对条件会好很多 (平均价格 S$1000-1200 / 间)<br>单人单间：500-1000 新币<br>二人间：350-550 新币 / 人<br>四人间：270-350 新币 / 人</p><p><strong> 小贴士 </strong></p><ol><li>新加坡政府规定租住的房子必须要能在建屋局上注册。正常情况下，注册要求至少住 6 个月。如果不能注册，就是不合法的房屋。</li><li>如果退租，一定要提前一月声明，以防押金不退。</li><li>仔细看合同，仔细看合同，仔细看合同。</li></ol><blockquote><p>私人公寓(Condo)</p></blockquote><p>公寓，常见两房式或三房式，相当于国内的高档成熟社区，内有免费游泳池、健身房，BBQ 等公共设施，住宿环境相对较好，价格也相对高一些；大部分的 condo 房间都有主人房与非主人房之分，主人房有自己独立的洗手间和相对宽敞的卧室，当然价格也比非主人房高 200-300 / 月(非主人房平均价格<br>S$1,000-1,500 / 间 / 月)</p><blockquote><p>排屋(Terrace)</p></blockquote><p>独门不独栋的联排别墅，此类出租房源相对较少，住宿环境、价格与房子位置、条件有相当大的关系。</p><blockquote><p>独栋别墅(Landedproperty)</p></blockquote><p>少见于房间出租。</p><h2 id="租房"><a href="#租房" class="headerlink" title="租房"></a>租房</h2><blockquote><p>如果英语不是太差，不推荐狮城 BBS 或者微博租房，如果你有认识的新加坡房产中介自然是最佳选择</p></blockquote><p>Property Guru - <a href="http://www.propertyguru.com.sg/" target="_blank" rel="noopener">http://www.propertyguru.com.sg/</a></p><p>新加坡本地发布平台，房源多。使用下来感觉 Property Guru 信息发布是最多的，信息筛选条件多，容易搜索到希望的房源。多为中介发布，有中介费。</p><p>Nestia - <a href="https://www.nestia.com/" target="_blank" rel="noopener">https://www.nestia.com/</a></p><p>新加坡本地发布平台，功能强。Nestia 上的房源也比较多，但感觉不如 Property Guru。不过 Nestia 可以以某一建筑（公司地址）为中心从远及近的搜索房源。找步行距离的房源就很合适了。另外自带的导航也不错。所以我是 Property Guru 和 Nestia 结合使用。</p><p>99.co - <a href="https://www.99.co/" target="_blank" rel="noopener">https://www.99.co/</a></p><p>新加坡本地发布平台，平台新。和上面两个相比算是一个比较新的平台，数据没有 Property Guru 多但是针对房屋本身的介绍更加详细，房源信息相对真实。</p><p>在新加坡租房，有哪些经验可以分享？<br><a href="https://www.zhihu.com/question/22430961" target="_blank" rel="noopener">https://www.zhihu.com/question/22430961</a></p><h2 id="在新加坡买房与中国有何不同？"><a href="#在新加坡买房与中国有何不同？" class="headerlink" title="在新加坡买房与中国有何不同？"></a>在新加坡买房与中国有何不同？</h2><blockquote><p>无论在中国还是新加坡买房前后都记得关注下政策上的变化，新加坡买房的流程很简单，首付 = 房屋价格 + 税 + 中介费 - 贷款额度。</p></blockquote><p><img src="https://ws4.sinaimg.cn/large/7207510dgy1fuwkom9kljj20u00i30u7.jpg" alt=""></p><p>① 面积</p><p>说到面积，首先让中国买家摸不着头脑的，就是面积单位的换算。中国买家习惯用平方米（也称平方公尺）计算面积，来新加坡选购房子时听到的都是平方英尺，往往脑子得转一圈才知道个大概。1 平方米约等于 10.8 平方英尺。100 平方米就是 1080 平方英尺。</p><p>除了计算单位不同，“面积”一词在两地公寓市场上的定义也不一样。在中国，面积指的是建筑面积；新加坡算的是实用面积。建筑面积的算法比较繁琐。简单来讲，是根据各套房屋的套内建筑面积，求得各套房屋分摊所得的共有建筑分摊面积，比如门口的面积、楼梯等，都按比例算进每一个单位的建筑面积。</p><p>所以，同一个公寓单位，其建筑面积一定会大于实用面积，通常后者比前者少 20％左右。在中国买一个 “100 平方米” 的单位，和在新加坡买一个“1080 平方英尺”（相当于 100 平方米）相比，后者明显感觉宽敞一点，就是这个道理。</p><p>② 地契</p><p>中国的房产地契通常是 70 年左右，而新加坡的则有 99 年、999 年和永久地契之分。新加坡的房产因为地契年限长，颇受外籍人士青睐。其中，永久地契的房产一般要比 99 年地契的贵 20％。尽管如此，永久地契一直很抢手，也深受中国买家欢迎，因为买家看准这块市场的保值与增值。</p><p>这其中很大程度上因为新加坡的地皮比较少，想要建新楼必须拆掉现有的建筑。不像中国地皮比较多，还有可开发的地段。新加坡永久地契的地段价值比较高，所以如果进行集体出售、或是被政府征用的话，永久地契房地产的房主会可得到较高的补偿。</p><p>物以稀为贵，永久地契房产越是少见，也就越炙手可热。此外，永久地契对中国买家还有另一大吸引力，那就是永久地契满足了 “总觉得要给后代留下点什么” 的传统华人心愿。所以说，新加坡房产能如此吸引外国买家，与地契久脱不了关系。</p><p>③ 贷款</p><p>在新加坡首次购房的买家，可向金融机构贷款的房贷比率顶限为 80％，外籍人士一般则最高 70％。在中国，外国人一般不能向本土中国银行贷款，只能通过外资银行或中国银行境外支行。</p><p>原本新加坡和中国在房贷比率顶限方面有很大差别。不过两国都不断调整房贷比率顶限，因此两国的房贷比率顶限差别已缩小。</p><p>④ 税收</p><p>在新加坡，如果在一定期限里卖掉公寓，卖家需要上缴印花税。在 2011 年 1 月 14 日过后买房的购屋者，只要在四年内卖房屋都需要支付卖方印花税，第一、二、三和四年卖掉房产的税率分别是 16％、12％、8％和 4％。此后就不必上缴卖家印花税。</p><p>在中国，除了印花税外，还需要上缴增值税。为了给中国房地产市场降温，中国政府在 2013 年实施 20％的房地产买卖增值税。所谓增值税，就是对卖家卖房所得的利润征收的税。譬如，150 万人民币买的房子在几年后以 200 万人民币卖掉，卖家所赚得的 50 万就将需要以一定的比率交税。</p><p>⑤ 车位</p><p>在中国购买中高档住宅，需要另外购买车位。而在新加坡，买家不需要另付车位费，发展商一般会为每个新单位赠送一个车位。可不能小瞧这个车位费。近年来，车位费在中国节节攀升，动辄十几、二十万人民币，是一笔不小的开销。</p><p>新加坡私人公寓不收车位费，而是将停车场的修建和维护等费用，包括在每月的项目管理费之中。管理费除了车库，还包括游泳池、健身房等设施，每月一般是几百元新元。如果每月的管理费是 300 元新元（约 1400 元人民币），一年就是 1 万 7000 元人民币，15 年刚好是 25 万 5000 元人民币。总体来讲，这要比中国的车位 “划算” 得多。</p><h2 id="新加坡医疗指南"><a href="#新加坡医疗指南" class="headerlink" title="新加坡医疗指南"></a>新加坡医疗指南</h2><p>新加坡是一个热带国家，从国内刚过去有可能因水土不服引起的伤风、感冒、皮肤敏感或蚊虫叮咬等。出行之前可以带一些三九胃泰、牛黄解毒等日常药品之类的药品，防范于未然是最好的。</p><p>看医生：在新加坡持有工作签证，所在的公司会按照新加坡劳工部规定给每位员工会购买医疗保险或者费用报销。</p><p>医疗保险：一般是三种模式</p><ol><li>直接去合作门诊，提供公司信息，看病不用自己拿钱。</li><li>直接去合作门诊，提供公司信息，看病前给门诊 5 新币（每个公司不一样），其它的费用不用自己拿。</li><li>直接去合作门诊，自己先付产生的费用，然后去公司报销。意外伤害险等（视公司合同规定）。</li></ol><h2 id="公立和私立医疗服务"><a href="#公立和私立医疗服务" class="headerlink" title="公立和私立医疗服务"></a>公立和私立医疗服务</h2><blockquote><p>中国人在新加坡看病就好比外国人在中国看病一样不是很方便，价格不便宜，小病也有可能看成大病</p></blockquote><p>新加坡的医疗服务体系以优质高效著称，选择面广, 综合医院，专科医院，私人诊所遍布全国, 随处可见；不仅为全新加坡的公民，永久居民，外籍工作人士提供服务，同时周边国家的高端人群, 包括东南亚、亚洲、欧洲、中东阿拉伯等国家的病患都会将新加坡的国际医疗服务作为他们的首选。</p><p>新加坡的公立医疗机构和私立医疗机构在整个医疗系统中扮演着不同的角色。基础医疗门诊 80% 由私立医疗机构 / 家庭医生诊所提供，另外 20% 则是由政府综合诊疗所提供；而综合医疗，包括各类科室的住院，专科和 24 小时急诊主要由公立医疗机构提供，占 80% 的比例，剩下的 20% 由私立医疗机构提供。由于政府的有效规划和管控，公立医院和私立医院相辅相成, 缺一不可。</p><p>在公立医疗机构就诊一般都需要提前预约, 候诊时间较长, 也不能自由选择医生。由于那里的医生要面对更多的患者, 为每个患者服务的时间相对较短；而私立医疗机构由于患者相对较少, 不需要预约, 候诊时间较短，还可以自己选择医生，医生也能与患者作更多的交流, 提供更细致的服务，收费就相应高一些。</p><p>一些新加坡的公立医院也为自费病人提供高端医疗服务, 设有针对性的部门和项目, 如体检，会诊，专科治疗等。基础的检查和服务, 公立医院比私立医院收费较低；对于外籍人士和高端的服务项目, 公立和私立医院的收费差异不大。</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzIwMTQxODUxNw==&amp;mid=2650871863&amp;idx=3&amp;sn=b9536c73a1b6a0e0ed02019598d75c35&amp;chksm=8d1b8a4dba6c035b898a133fdf30ec613eb6826a0f4a66d5befe6364a04e24fb6bde9a981ce7&amp;scene=21" target="_blank" rel="noopener">8 家新加坡著名的公立和私立医院</a></p><h2 id="货币兑换和汇款"><a href="#货币兑换和汇款" class="headerlink" title="货币兑换和汇款"></a>货币兑换和汇款</h2><blockquote><p>如果时间宽裕，推荐走新加坡工商银行渠道</p></blockquote><p>新加坡实行货币开放政策，货币兑换中心随处可见，尤其是在牛车水 (China Town) 附近。如有汇款需求到国内，可以先去牛车水汇款 (珍珠坊二楼)，方便快捷。等周围熟悉后，推荐去淡宾尼(Tampines) 汇款到国内，汇率会比其它地方高一些。具体的地方，在地图搜索 Tampines Money Exchange Center。 </p><p>小贴士：汇款中心一般可以汇到中国邮政、中国农业、中国交通、中国招商和中国银行等。第一次汇钱到国内，当填写汇款单据的时候一定要知道对方银行卡是在 <strong> 省 </strong> 市 ** 银行支行开户的(很重要)。</p><h2 id="法律法规"><a href="#法律法规" class="headerlink" title="法律法规"></a>法律法规</h2><p>新加坡向来是给世人展示优美环境，井然秩序，舒适安全的名片，然而这些美好的展现离不开新加坡法律制度的约束和规范。Singaporeis a“fine”country 完整的诠释了这两方面。所以在新加坡生活，你需要注意以下细节：</p><ol><li>自动排队：公共场合最经常听到的一句话就是 please queue！</li><li>着装：不同场合穿不同衣服, 建议每天换衣服。</li><li>公共习惯：乘坐公共交通或者在公共场合用餐时, 切忌大声喧哗, 不然你一样会被当做异类奥! 而且记得再饿也要撑到下车再用餐。</li><li>言论：新加坡是多文化和宗教融合的国家, 公共场合不要发表敏感政治言论或者宗教话题, 这也体现互相尊重。</li><li>不当行为：竖中指可能会被当做种族歧视处理的</li><li>如厕：来也匆匆, 去也冲冲。如若不然请准备 500 新币吧。</li><li>口香糖：公共场所不允许嚼口香糖, 不可以随意买卖, 允许带少量入境, 正是这个奇葩的规定维护了公共环境的整洁。</li><li>吸烟：新加坡公共场所绝对禁烟。如若吸烟不幸被抓到, 恭喜你一个月的工资 (高达 2000 新币) 为国家做贡献了!</li><li>垃圾：乱丢垃圾初犯者将处高达 1000 新币罚款, 再犯者将罚款额提高至 2000 新币以及在劳改法令下受罚。</li><li>交通规则：闯红灯, 随便乱穿马路这些不多啰嗦。违反的是规则, 伤害的是人身安全, 因为小编也感觉马路上的车如同闪电般行驶。</li><li>不可非法聚会和使用暴力</li></ol><p>以上内容是提醒大家在生活细节方面应遵守的规则, 但有些行为未必就可以罚款结案的, 比如: 签证到期后逾期逗留、抢劫、公共场所涂鸦、纵火、携带毒品等这些可都是在鞭刑的定罪范围内的。</p><p><strong> 最后郑重的提醒各位：</strong> 在机场不要发扬助人为乐精神帮陌生人携带物品, 因为很有可能你同时把生命交给了别人(运输毒品和贩毒同罪)。</p><h2 id="工作准证遗失如何处理"><a href="#工作准证遗失如何处理" class="headerlink" title="工作准证遗失如何处理"></a>工作准证遗失如何处理</h2><ol><li>发现丢失后立即携带护照或者工作准证的复印件到任何一间警察局报案，记得保存报案记录原件。</li><li>通知雇主公司 HR, 让其在 7 天之内在新加坡人力部网上提交补办工作准证的申请。</li><li>费用: 首次补办 100 新币, 第二次是 300 新币(一般在提交申请补办 4 个工作日可去新卡)</li></ol><h2 id="银行卡遗失如何处理"><a href="#银行卡遗失如何处理" class="headerlink" title="银行卡遗失如何处理"></a>银行卡遗失如何处理</h2><ol><li>发现遗失后立即拨打银行客户服务中心热线挂失</li><li>银行客户专员会核对护照和工作准证信息, 然后等待新卡邮寄到住处或者去支行直接领取。</li></ol><p>POSB 用户请拨打 18003396963<br>DBS 用户请拨打 18001111111<br>UOB 用户请拨打 18002222121<br>OCBC 用户请拨打 18003633333</p><h2 id="护照遗失如何处理"><a href="#护照遗失如何处理" class="headerlink" title="护照遗失如何处理"></a>护照遗失如何处理</h2><p>如护照遗失或被盗, 请立即到中国驻新加坡大使馆如实填写《护照遗失陈述表》，提供关于护照遗失或被盗的情况说明, 以及提供报警记录原件及复印件。如护照损毁, 请提交损毁的护照, 以及护照损毁的原因说明。</p><p>具体的更换护照和网上预约等等详细流程请参考大使馆的官网：<a href="http://www.chinaembassy.org.sg/chn/" target="_blank" rel="noopener">http://www.chinaembassy.org.sg/chn/</a></p><p>中国驻新加坡大使馆信息:</p><p>地址: 150 TANGLIN ROAD,SINGAPORE 247969</p><p>领事部：64712117；92971517(仅限紧急领保求助, 不接受证件咨询)</p><p>Email: <a href="mailto:chinaemb_sg@mfa.gov.cn" target="_blank" rel="noopener">chinaemb_sg@mfa.gov.cn</a></p><p>办公时间：周一至周五(节假日除外)</p><p>上午 9:00-11:30</p><h2 id="新加坡日常-App-推荐"><a href="#新加坡日常-App-推荐" class="headerlink" title="新加坡日常 App 推荐"></a>新加坡日常 App 推荐</h2><blockquote><p>如果是 Android 记得安装 Google 框架，如果是 iOS 记得调整更改 Apple ID 国家或地区</p></blockquote><p>交通: Grab(类似国内滴滴)、Google Map(谷歌地图)、SG Buses(公交时刻表)、Mobike（摩拜单车国内账户通用）</p><p>社交: Facebook、WhatsApp、Twitter、Instagram</p><p>购物: Shopee、Lazada、eBay、Amazon、淘宝国际、京东国际、网易考拉、网易严选、小米有品</p><p>娱乐: Youtube(视频必备)、 Golden Village(电影院)、CATHAY (电影院)</p><p>快递: 小坡岛集运、淘宝直送 / 集运</p><p>特别推荐: Zero1(9.9 每月无限流量手机卡)、SG BusLeh(更好用的公交时刻表)、eatigo(开启新加坡美食 5 折之旅)</p><h2 id="新加坡父母签证"><a href="#新加坡父母签证" class="headerlink" title="新加坡父母签证"></a>新加坡父母签证</h2><blockquote><p>网上找到的，忘记出处了，如果有错误描述请及时指正</p></blockquote><p>本人 PR，老婆七月份预产期。打算让父母 6 月中旬来。计划步骤如下:<br>1, 先买往返机票（返程可更改的）。<br>=== 对的。<br>2,5 月份申请父母旅游签证。<br>=== 旅游签证可提前一个月内申请，有效期多数 63 天，也有一年，两年，非固定。有效期内入境即可。<br>3, 父母来新后申请延期至 89 天。<br>=== 对的。<br>4, 同时申请 LTVP。<br>=== 也没错。<br>5, 悲剧后申诉。<br>=== 步骤没错。<br>请指点一下按这样做有什么不拖吗？<br>=== 有什么不妥是吧？没什么不妥的，如果觉得自己条件还可以，就可以早点安排申请 LTVP，如果觉得条件比较牵强，可以晚一点入境，晚一点延期，晚一点申请 ltvp，争取在月子后多待一点时间帮你们带孩子。<br>可以现在就申请旅行签证吗?<br>=== 提前一个月内申请，一个月内，内。<br>旅行签证有效期多久? 一年多次吗？<br>=== 上面已经回答了。<br>申请 LTVP 必须人在新加坡吗？<br>=== 是的。必须入境后申请。</p><p><a href="https://www.ica.gov.sg/" target="_blank" rel="noopener">https://www.ica.gov.sg/</a></p><h2 id="新加坡公民-永久居民-外国人的区别"><a href="#新加坡公民-永久居民-外国人的区别" class="headerlink" title="新加坡公民 / 永久居民 / 外国人的区别"></a>新加坡公民 / 永久居民 / 外国人的区别</h2><blockquote><p>我们大多数人的起点是外国人，这点与国内的户口制度类似，无论是中国还是新加坡始终绕不开买房和教育这两座大山</p></blockquote><p><img src="http://wx1.sinaimg.cn/large/7207510dgy1fv25ybdomqj21su0qiwqe.jpg" alt=""></p><p><a href="https://docs.qq.com/sheet/B80RhZ2ZATLC0ge3Bi2bLYpr2iY5PC1nE3031LWRcK1rTcgj0Z2bvD00bDO63Ie3tz2ovOwW4" target="_blank" rel="noopener">如果发现表有错误请点击链接申请编辑更新，谢谢</a></p><h3 id="EP-申请-PR"><a href="#EP-申请-PR" class="headerlink" title="EP 申请 PR"></a>EP 申请 PR</h3><blockquote><p>在新加坡工作满半年即可申请 PR，不过大概率是被拒的，失败后等待半年继续申请挑战吧</p></blockquote><p>基本准备材料：</p><ol><li>护照 （资料页）</li><li>准证 / 身份证 （如有）</li><li>出生证明 （公证件）</li><li>更名证明（如有）</li><li>最高学历（成绩单，资格证，会员资质等也可提供）</li><li>护照尺寸照片</li></ol><blockquote><p>其他所需材料：</p></blockquote><p>A1：以前雇主的推荐信，说明就业的性质，持续时间以及基本工资（有最好了，没有也可以）<br>A2：过去 6 个月的薪资单（这个找 HR 开）<br>A3：现任雇主的信函，说明就业日期，过去 6 个月的每月工资，包括加班和津贴（找 HR 开）。这封信 To 谁呢，记得是 To Controller of Immigration，而且要在申请前一个月内开具<br>A4：IRAS 同意书，表示同意 ICA 获取和核实与此相关的财务信息</p><blockquote><p>已婚汪们还需要这些：</p></blockquote><p>B1：结婚证书（需要公证的记得公证）<br>B2：关于之前婚姻的死亡证明或离婚证明（如有）<br>B3：关于以前婚姻的子女的监护文件（如有）<br>B4：配偶的最高教育证书（包括大专学历），成绩单，职业资格证，能证明牛 X 的统统甩出来哈！</p><blockquote><p>如果配偶一同申请：</p></blockquote><p>B5：配偶的有效旅行证件及有效的入境通行证，护照（资料页）<br>B6：配偶的出生证明<br>B7：更名文件（如有）<br>B8：配偶的身份证（如适用）<br>B9：关于配偶以前的婚姻（如有）离婚证明以及孩子的监护文件，或者死亡证明</p><blockquote><p>如果孩子一起申请：</p></blockquote><p>C1：护照资料页<br>C2：孩子的出生证明，显示孩子和父母的姓名<br>C3：儿童收养文件（如适用）<br>C4：儿童改名证明（如适用）</p><h3 id="PR-申请公民"><a href="#PR-申请公民" class="headerlink" title="PR 申请公民"></a>PR 申请公民</h3><blockquote><p>等 PR 满两年后再申请</p></blockquote><p><a href="https://toutiaosg.com/%E5%90%90%E8%A1%80%E6%95%B4%E7%90%86%EF%BC%81%E5%A6%82%E4%BD%95%E5%9C%A8%E7%BD%91%E4%B8%8A%E7%94%B3%E8%AF%B7%E6%96%B0%E5%8A%A0%E5%9D%A1pr%E5%92%8C%E5%85%AC%E6%B0%91%E6%9C%80%E5%BC%BA%E6%94%BB%E7%95%A5/" target="_blank" rel="noopener">吐血整理！如何在网上申请新加坡 PR 和公民最强攻略！收藏~</a></p><h2 id="个人经验"><a href="#个人经验" class="headerlink" title="个人经验"></a>个人经验</h2><blockquote><p>选择新加坡的理由：给自己多一种选择</p></blockquote><ul><li>MOM: Ministry of Manpower</li><li>IPA: In-Principle Approval</li><li>EP: Employment Pass 人才准证</li><li>DP: Dependant’s Pass 家属准证</li><li>PR: Singapore Permanent Resident 新加坡永久居民</li><li>SC: Singapore Citizen 新加坡公民</li><li>HDB: Housing &amp; Development 政府组屋</li><li>Condo: 私人公寓</li><li>Food Court: 食阁</li><li>CPF: 公积金</li><li>NUS: National University of Singapore 新加坡国立大学</li><li>NTU: Nanyang Technological University 新加坡南洋理工大学</li></ul><ol><li>原始坐标：上海，无留学经验也没有去过新加坡</li><li>猎头推荐新加坡的职位，想想自己那被遗忘的蹩脚英语抱着试一试的心态</li><li>一共 3 轮 Skype 远程视频面试，约 4 周时间到最后确认 offer</li><li>约 1 天时间思考，离职申请，签电子合同</li><li>检查护照有效期，下载学信网英文翻译认证，由 HR 帮助提交申请 EP，约 3 周内收到 IPA</li><li>在上海户口所在区公证处办理结婚证公证翻译，约 3 周时间完成，又慢又麻烦</li><li>完成 EP 后由 HR 帮助提交申请 DP，约 1 周内收到 IPA</li><li>购买机票，打印 IPA，带上护照，打包行李，兑换 4000 新币，确认人事档案存放地址，选择不缴纳每月养老保险和医疗保险约 1500 元人民币(可由父母代缴，中断非连续缴纳暂时不影响回国养老，以政策变化为准)</li><li>飞机上填写好新加坡入境卡，完成入境登记，无需录入指纹，开启华为天际通</li><li>抵达公司提前安排好的住址，熟悉新加坡环境</li><li>办理 EZ-Link 交通卡和 Singtel Prepaid 手机卡(如果没有强需求可以暂时不办理)</li><li>公司 HR 提交 EP 现场办理申请，收到邮件后预约 MOM 办理时间（我没有被要求体检，根据不同公司情况而定）</li><li>约 1 周后收到 EP 绿色实体卡，使用 SGWorkPass 扫描保存照片，注册 SingPass 后约 1 周左右收到密码信封</li><li>公司开具证明办理银行卡，新加坡本地我选择 UOB(保持 1000 新币存款)，另外强烈推荐再办理工商银行卡(持卡 0 门槛，转账回国 0 费用)</li><li>网上申请 Zero1 的无限流量手机卡，约 3 个工作日收到直接使用，弃用 Singtel Prepaid（浪费了 25 新币）</li><li>新加坡日常消费以现金为主，我本人习惯手机支付无奈降级至刷信用卡阶段(持有浦发 AE 白 / Visa/Master)，怀念下国内的支付宝和微信</li></ol><p>我刚来新加坡 1 个多月，不用担心语言不通，大部分人都会说华语。新加坡真的不算大，地铁和公交都很方便，空气质量很好至少我的鼻炎消失了，天气没有国内那么热，居然没有蚊子，没有蚊子，没有蚊子。在这段时间里我幸运了结识了交大和复旦的校友，跟随专业的中介实地考察了新加坡的租房和买房市场，走遍了几个重要的核心区域，顺便吃了几顿亲民的米其林一星。之后我应该还会继续更新自己在新加坡的经历，比如健身、快递、看病等日常生活，希望对大家有所帮助。</p><h3 id="新加坡-3-个月感想"><a href="#新加坡-3-个月感想" class="headerlink" title="新加坡 3 个月感想"></a>新加坡 3 个月感想</h3><blockquote><p>咋们就从最传统的衣食住行说起吧</p></blockquote><p><strong> 衣 </strong></p><p>因为新加坡全年都是夏季，平时的正常温度基本在 30° 上下，对于我来说已经把家里的夏装的家底全部带过来了，所以也没有什么特别需要单独购买，作为男生如果以后缺衣服的话在新加坡线下就是优衣库，线上还是优衣库。</p><p>女生的选择实在太多了，乌节路和 VivoCity 等都可以逛好久，这里就跳过吧</p><p>新加坡本地的 Outlet(奥特莱斯)是 IMM，如果你喜欢跑步运动，那么只卖 80 新币的 adidas Ultraoost X 和 Asics GEL-Kayano 会有一定吸引力</p><p>在新加坡网购，和国内激烈竞争的胜出者相比，还有很长一段路要走，当然也证明东南亚市场是一块巨大的蛋糕等待挖掘</p><p>新加坡室内空调冷气普遍开得比较足，建议怕冷的同学多备件长袖外套在公司，长时间逛商场时注意冷热交替避免生病</p><p>从中国快递至新加坡我通常会选择和同事拼团 小坡岛新加坡集运</p><p><a href="http://www.xiaopodao.com" target="_blank" rel="noopener">http://www.xiaopodao.com</a></p><p><strong> 食 </strong></p><p>新加坡最有特点的饮食文化莫过于食阁(Food Court)，其实有点类似于上海的大食代，但价格亲民而且还有米其林一星的神奇存在，平均一顿的价格区间在 3-7 新币，整体口味偏重。每个食阁上方都会标注 A/B/C 卫生评级，新加坡本地的习惯一般不在家做饭，大家都出去吃所以种类也还算多，不知道吃什么可以认准 Singapore Best Foods 红色标志，和国内相比关键是放心。</p><p>如果平时想吃顿大餐类似国内海底捞、小龙坎那种，平均每人大概 30-50 新币左右，评级更高的餐厅价格自然也水涨船高</p><p>自己在家做饭的成本其实和外面吃也差不了多少，如果居住的房子允许大炒和大煮当然可以选择自己动手丰衣足食</p><p>新加坡的菜市场比较少见可能是我没有刻意去寻找或者需求的缘故吧，买蔬菜和肉类基本都在 Sheng Siong(昇菘)，FairPrice(NTUC)，Cold Storage，喜欢日本食物还可以选择 DON DON DONKI，我个人很喜欢这只萌企鹅的魔性主题曲</p><p><a href="https://www.bilibili.com/video/av32078102" target="_blank" rel="noopener">https://www.bilibili.com/video/av32078102</a></p><p>新加坡的便利店清一色 7-Eleven，部分大一点的屈臣氏 (Watsons) 支持支付宝(Alipay)，上面提到的 Sheng Siong 已经全部支持 Alipay</p><p>外卖大家就不要指望 GrabFood 或 Foodpanda 有饿了么和美团外卖的速度了，老老实实去附近的食阁按时吃饭才是正道</p><p>新增推荐 eatigo，我每个周末都会使用 eatigo 开启 5 折美食之旅</p><p><a href="https://eatigo.com/sg/singapore/en" target="_blank" rel="noopener">https://eatigo.com/sg/singapore/en</a></p><p><strong> 住 </strong></p><p>(1) 租房</p><p>我在租房这个环节基本上算是跳过了，刚来时建议找好房源，这边的酒店居住成本很高的。因为目前是长租在公司提供的组屋 (HDB) 内，毕竟室友都是公司自己人很放心，合同限制不多每月会安排阿姨定期打扫和保养空调等，手机银行转账支付租金也方便。回想当时刚来的 1 个月每周都跟随专业的中介校友出去找房子都十分辛苦，更不要说自己联系中介一家一家看了，说多了都是泪。这边的房产中介需要考证，据说通过率只有 10-15%，每个中介都会展示唯一的证书编号，所以不用太担心被骗，不过每个中介的态度千差万别，找到靠谱的中介能够加快找房的速度。</p><p>由于地理位置和房屋面积质量差异，下面的租房价格仅仅是一个参考区间，数字单位为新币 / 月<br>组屋(HBD)，普通房 600-800，主人房 1000-1200，整租 1000+<br>公寓(Condo)，普通房 800-1500，主人房 1200-2000，整租 1500+</p><p>房源信息可以来自于同事，也可以自己在线挑选，方法我都写在前面了，和同事咨询过新加坡租房的大致流程</p><ol><li>看准自己喜欢的房子</li><li>看清楚合同，看清楚合同，看清楚合同，签约</li><li>签 1 年一般押一付一，签 2 年押二付一</li><li>中介费是根据实际情况由房东或者租客来承担，一般根据合约长短支付 0.5 或 1 个月的房租作为中介费</li></ol><p>(2) 买房</p><p>虽然是否决定买房的话题为时尚早，但经历了魔都十几年房地产的上涨自然也不会错过对新加坡房地产的研究，如果你是冲着 30w 新币的组屋 (HDB) 那么找新加坡本地人结婚是最快的途径。新加坡在 2018 年 07 月 06 日 0 点开始调整了印花税，对于我们普通人来说 2-3 年内拿到永久居民 (PR) 已然不易。新加坡私人公寓 (Condo) 的价格和质量相对国内来说是有优势的，但是 1 室 80w，2 室 100w，3 室 120w 这样的价格加上印花税还是会让我们感到一丢丢肉疼，好在房地产市场涨幅长期平稳且退出机制清晰，租房市场也足够活跃，而且银行可以贷款 7 成 + 2% 左右的低利率还是足以让我们拥有奋力一搏的勇气，不用牺牲 6 个钱包。</p><p><strong> 行 </strong></p><p>现在无论在哪里手机的使用比重都是极高的，我自己来新加坡前把小米 6 替换为华为 P20 Pro，妻子还是用的小米 MIX2，在国内早已习惯电信乐享家 199 元全国无限流量，我们的老卡 1 个是移动，1 个是联通，来到新加坡之后选择了无合约限制价格为 29.99 新币无限流量的虚拟运营商 Zero1.sg，因为背后是 Singtel 所以质量有保障。在新加坡接收国内短信验证码之类不要钱，双卡双待都是没有问题的，不过我妻子还是很期待 iPhone 即将推出的双卡功能，毕竟她在美国时的 iPhone5s 也用了 4 年多，被我硬生生拖入 Android 阵营实属不易。 </p><p>新加坡公共交通发达，Google Map 在手说走就走。我的选择和国内类似，能坐地铁尽量就不会选择公交车，因为坐公交车有几点不爽，如果你不熟悉新加坡或者不会熟练使用 Google Map 建议不要轻易乘坐公交车。</p><blockquote><p>乘坐地铁切记不可吃喝、吸烟、携带榴莲、大声喧哗和带宠物，乘坐公交车的规定与地铁类似但有以下额外注意事项</p></blockquote><ol><li>公交车来之前一定要招手才会停</li><li>在到达下一站前一定要按 Stop 红色停车按钮，不然不会停</li><li>下车时还要再刷一次交通卡确认付款</li></ol><p>除了公交车和国内差异较大以外，平时过马路记得按一下身边的指示灯，你不按或者对面也没人按，那你就不用想着过去了</p><p>这边的公交卡称为 EZ-Link，想刷 NFC 不好意思没有小米和华为，请购买 NFC SIM card。虽然充值很方便支持国内双币信用卡，但我还是很想念上海二维码扫码进闸机。另外新加坡地铁站没有安检，没有安检，没有安检。</p><p>我丢过一次地铁卡，为了挽回里面 25 新币我第一次主动走进新加坡警察局开具丢失证明，他们做事确实负责而高效，不过我因为操作失误导致旧卡数据没有正常转移到新卡，超过 7 天申报时间我也没有办法无力回天，所以再一次怀念下国内的手机刷卡。</p><p>新加坡已经遍布 Mobike 和 ofo，摩拜的国内账户可以在这里直接使用，ofo 需要重新注册。</p><p>新加坡打车市场已经被 Grab 一统江湖，Uber 和滴滴出行都入股 Grab，另外 Grab 打车很安全而且支持支付宝(Alipay)，普通出租车都支持微信和支付宝</p><p>关于机票从上海往返新加坡的航班很多，价格和飞行时间比较透明就不多说了，我这里还是推荐大家体验下新加坡航空 (Singapore Airlines) 的服务，今年航空公司评选又站回全球第一，即使乘坐经济舱也不要忘记品尝一下新加坡司令哈。</p><p>今年国庆节期间我和老婆买了新加坡至四川成都的 5 日往返机票，新加坡航空旗下的胜安航空(SilkAir)，令我感到惊喜的是 2 人机票往返价格总共才 1600 人民币。</p><p>新加坡拥车成本比较高，虽然公共交通发达，但是开车的梦想还是要有的，万一实现了呢？</p><p>新加坡和国内的走位不一样，行走避让和司机开车位置与国内正好相反。</p><blockquote><p>传统的四大金刚扯完了，我们再聊一些逆转未来的话题</p></blockquote><p><strong> 安全 </strong></p><p>新加坡的安全本质上是基于严格的法律加上遍布各地的摄像头，你如果想挑战下不如先了解下鞭刑的酸爽和罚款罚到你肉疼的数字。</p><p>吸烟，喝酒，乱扔垃圾在法律中都有明确要求，虽然不能百分百杜绝抽烟现象，但你走在马路上不会遇到随意吐痰也不需要提防狗屎。穿过十字路口车辆都会早早的自觉停下来等你先过去，新加坡随处可见的就是无障碍设施，地铁沿线基本都设置了棚顶，既可以防晒又可以躲雨，即便每天都能遇到短时暴雨由于出色的排水系统也从来不会看到有积水。</p><p>在国内随时会收到的垃圾短信和房产金融中介等骚扰电话，在新加坡基本是看不到的，不过 Email 和 WhatsApp 这种网络骚扰还是无法消灭的。这边的违法成本比较高只要被投诉就会收到法律的严格制裁，当然注意保护自己的隐私安全始终不能掉以轻心，毕竟再文明的社会偶尔也会遇上小人。</p><p>在新加坡你基本不用担心丢失物品，因为大概率都能找回来，包包也不用刻意放在前面，拉链忘记拉上也没关系，不用担心人口贩子和小孩走丢，更不用担心一个人走夜路会不会不安全，犯罪成本高促成的低犯罪率给你带来的不仅仅是安全感更是幸福感。</p><p>由于新加坡的地理位置极好，无论是过去还是未来基本是不会受到任何灾难气候影响，台风、海啸或者地震是不存在的</p><p>新加坡的人际关系相对简单，与人为善的过程中也不要忘记多留个心眼谨慎一些，在这边和他人发生误会大多数都会听到 Sorry 和 I am fine 而不是争吵，规规矩矩排队而很少有人随意插队，政府办事效率高以廉洁著称也是难能可贵，在新加坡未必有国内这么亲切有人情味，但你能感受到的是相对的公平和简单。</p><p><strong> 健康 </strong></p><p>我在上海的时候就饱受着变态反应性鼻炎的痛苦，每次体检医生都开玩笑要不住到外环去吧，没想到现在离家这么远。至少来新加坡后我的鼻子就彻底舒畅了，我原来对空气质量也不以为然，买个小米净化器放在家里，直到离开上海前看见基因检测报告提醒风险最高的是鼻咽癌，我才明白空气对于每个人的未来都是如此重要。</p><p>新加坡的温度常年保持在 30° 上下，不会像上海夏季烈日炎炎，但新加坡比较像“蓝天白云 晴空万里 突然暴风雨”，有云有风有遮雨棚，身体其实会觉得很舒服.</p><p>之前已经说过新加坡的饮食文化以食阁 (Food Court) 为主，这些小店很多都有几十年的历史，食物未必都符合你的胃口但至少足够安全，不用担心地沟油。合理的饮食搭配以及规律的生活节奏才是根本。</p><p>新加坡本地人都注重健身，如果不想花太多钱在健身房可以考虑在小区附近的体育馆免费跑步或者花费 1.3 新币游泳。私人公寓 (Condo) 一般自带小型游泳池和健身房，虽然小但有总比没有好。如果公司有补贴健身房的价格 (一般 150-200 新币每月) 其实也不算太贵，每月 99 新币可以选择像 Fitness First or Pure Fitness(Pure Yoga)等专业健身房。</p><p>关于看病，因为前段时间工作比较忙抵抗力突然下降导致出现额头皮肤红肿，在国内经历过不注意小病而酿成大病的惨痛教训，<a href="https://wsgzao.github.io/post/wisdom-tooth/">我是如何做到花 8000 元拔智齿的</a>，所以这次特地请 1 天病假去公司合作的 Raffles Medical 私人诊所看病，事后看诊断结果比较准确且看病过程十分高科技 + 高效率，病因是 <code>带状疱疹</code>，总共 99 新币，30 是问诊费其余都是买药钱。只不过第二天我发现未有起色且眼皮红肿都快睁不开了就先让昨天的医生开具的急症介绍信，然后直奔 Raffles Hospital，在了解基本无大碍和每位专科医生复查至少 300 新币起步的情况下果断申请放弃继续治疗赶紧溜回去休养生息，这一趟花了 199 新币，其中 130 为问诊费(节假日看病费用翻翻)。命固然重要，但人只要一生病真的可能失去一切甚至连累家人。</p><p>和同事回顾了他们看病的流程，作为外国人一般也是建议直接去附近的私人医院，价格其实差不多但不用排队。如果选择去政府医院比如 NUH 等可能存在排队现象，这个体验对于国内看病来说大家心里应该很明白有多痛苦，如果各位有足额的医疗保险在国内其实可以选择特需医疗(免排队 + 专家门诊)。关于新加坡医院的更多信息可以参考最上面的介绍。</p><p>印尼 “烧芭” 引发空气污染和马来西亚动不动就拿断水挑事也是新加坡需要持续努力解决的问题之一。</p><p>新加坡的蔬菜和水果算不上贵但也不会像国内一样便宜，除了猫山王榴莲和部分进口水果质量和价格有优势，也没有太多的种类可供选择，我自己会从网易考拉购买 Swisse 作为补充，话说新加坡的营养品真心贵，同样的 Swisse 一小瓶卖 56 新币，其它品牌价格也是高居不下。</p><p><strong> 娱乐消费 </strong></p><p>新加坡本身就很小，加上我和我妻子都倾向于工作，学习和健身。平时的娱乐活动也就停留在节假日出去寻找下亲民美食，慢慢游览新加坡仅有的几个景点，新加坡环球影城，S.E.A. 海洋馆，新加坡动物园，新加坡夜间动物园，滨海湾花园，金沙酒店附近的鱼尾狮和摩天轮，圣淘沙和赌场，其它像植物园，大学校园很多都是免费的，旅游一般 2 天可以快速结束，如果需要细细品味也就再多增加 1-2 天足够了。</p><p>新加坡娱乐设施真的不算很多，看电影还得去现场买票，网上购买需要多花钱。吃喝玩乐想看看附近的活动和评价都没有像美团点评类似的产品，毕竟需求不像国内这么大，但我觉得让国内的美团猫眼或者阿里淘票票来进攻新加坡市场，相信分分钟钟可以拿下。</p><p>新加坡本地目前小额仍然以现金为主，商场一般支持刷卡，而主要的景点和购物中心区域全部覆盖支付宝(Alipay)</p><p><strong> 教育培训 </strong></p><p>虽然现在谈教育太早但是新加坡本地的教育资源始终都是偏向本国公民的，对我们来说永久居民 (PR) 只是万里长征的第一步，要不要买学区房，要不要做义工，也是留给自己的问题。感觉这又有上海户口，学区房，拼父母，何其相似？</p><p>新加坡和中国一样都很注重基础教育，对子女的教育支出都很高，新加坡第三方教育机构或者成人专业类培训机构的市场也很大。最近在微信朋友圈看到英国 BBC 邀请 3 名威尔士的优等生体验韩国鸡血教育的文章，除了深刻感受到教育的重要性，更加理解韩国快速崛起的因素，成熟而完整的教育产业链对孩子很重要，对国家来说更重要。</p><p><strong> 工作生活 </strong></p><p>我目前在一家新加坡互联网公司上班，工作制度是弹性的，没有严格的打卡要求，正常时间为 09:30-19:00，周围以中国同事居多，大部分是在这边读书毕业工作，学校几乎清一色新加坡国立大学 (NUS) 和新加坡南洋理工大学(NTU)，工作语言为英文，核心生产力工具包括 Google Suite，顶配 MacBook Pro，Herman Miller，Dell 2417H，还有无限制的饮料，水果和零食。原以为只能在国内的创业公司和少数尊重技术的优质公司才能看到的办公环境，可能在国外是很常见的事情吧。新加坡互联网公司在 IT 方面的人才非常短缺，也许是因为本地人大都投身于金融行业，所以很多技术人才也是会考虑从中国引进，甚至直接在国内开设分公司。</p><p>因为我以 EP 身份把我老婆也带了过来，目前还是 DP。对她来说在新加坡找一份金融行业的工作真的非常不容易，花了 2 个多月时间扫光了 LinkedIn 在新加坡几乎所有公开招聘，遗憾的是很少有金融行业愿意招聘非新加坡公民 (SZ) 和永久居民 (PR) 以外的人群，得到的回复大多数都是 Sorry，毕竟新加坡政府在很多地方都会优先照顾本国人的利益，这个道理放在中国也很好理解。不过目前经历了 6 轮面试最终拿到了一个还不错的 offer，后续 DP 也要转成 EP，这是一件值得庆幸的事情。</p><p>在没有明显压缩新加坡生活成本，按 1 人每月估算为 1w 人民币，如果是 2 个人差不多是 1.5w 人民币</p><p>新加坡月薪中位数是 4500 新币左右，新加坡人力部公布了 2018 年全国的工资中位数 4437 新币 / 月</p><p>HDB 合租主人房: 1100<br>水电网: 50<br>移动套餐: 9.9<br>饭费: 20x30<br>交通: 2x30<br>健身: 99<br>理发: 12<br>其他: 100</p><p>≈2030.9 新币≈10000 人民币，如果你是单人还可以选择普通房大概 800 每月。不过我相信新加坡贵的部分体现在后期的看病和生娃教育上</p><p>中国 VS 新加坡，生娃养娃究竟要花多少钱？</p><p>中国：</p><ul><li>生娃：3000-1 万人民币</li><li>养娃：65 万元 - 130 万人民币</li><li>总计：约 65 万 - 131 万人民币</li></ul><p>新加坡：</p><ul><li>生娃：1003-18912 新币</li><li>养娃：至少 67 万新币</li><li>总计：约 69 万新币</li></ul><p>推荐下 Grammarly for Chrome，在写邮件和文档时可以快速发现并纠正语法错误，对提升英文书写能力非常有帮助。我自己也是第一次开始深度使用 MacBook，记录一些简单的入门过程在 Blog 中，也可以做下参考。</p><p>MacBook 使用指北 - <a href="https://wsgzao.github.io/post/macbook/">https://wsgzao.github.io/post/macbook/</a></p><p><strong> 养老政策 </strong></p><p>新加坡不养闲人，你在新加坡的食阁 (Food Court) 仔细观察过就会发现几乎所有打扫卫生的都是老年人，和中国相比新加坡的养老金 CPF 是交多少退多少，不会被平均，所以更多的本地人会提前了解基金股票保险和投资房地产等方式来为自己养老。新加坡、日本、韩国等国家的老龄化问题已经凸显，我们都可以看到未来国内严重的老龄化趋势，谁又能独善其身呢？</p><p>新加坡政府因为楼市过热而提高印花税的闪电行动，中国也吹响了全球征税的集结号，无论身在哪里我们始终躲不开政治不是吗？</p><h2 id="日用品推荐"><a href="#日用品推荐" class="headerlink" title="日用品推荐"></a>日用品推荐</h2><blockquote><p>回顾来新加坡前后的经历，我希望自己分享的一部分实用建议和商品可以帮助大家更好的适应新加坡生活。如果你不喜欢网易严选和网易考拉可以选择性跳过。</p></blockquote><p>只能通过简单描述分享的建议：</p><ol><li>随身携带好护照和相关入境材料，非常重要，非常重要，非常重要</li><li>证件，学历和结婚证公正翻译等材料可以通过扫描全能王 (CamScanner) 录入为电子版，水印是可以很方便去除的，这里就不多说了。如果觉得好用请购买正版服务支持下总部位于上海的合合信息，名片全能王 (CamCard) 也是他们家的产品</li><li>提前规划好到达新加坡后的住宿，交通出行，手机应用，SIM 卡，入职流程</li><li>准备好足够的新币现金建议 4k+，因为银行卡和租房都是大头，有条件至少准备一张以上的 Visa/Mastercard 信用卡</li><li>出国前检查下国内的银行，手机，社保，人事档案是否安排妥当，身份证和护照离过期更换时间是否可控</li><li>如果有条件出国前做下全面的体检至少对自己身体有一个清晰的认识，把牙齿之类的小毛小病尽可能提前扫除隐患</li><li>现在的网络通信都很发达，记得和家人保持联系，减少他们的担心，自己照顾好自己</li></ol><p>我自己携带并且大家都能买到的产品分享：</p><ol><li>药品：我带的是泰诺和夫西地酸乳膏，这边初期看病成本还是比较高，建议最好带一些板蓝根、急用的抗生素、抗过敏药及自己习惯的常用药，如胃药、哮喘喷剂等等。</li><li>其他综合的日用品，我是分 3 批带过来的，这里按照重要性分成 2 部分来推荐，大部分来自网易严选和网易考拉工厂店，关于原因我也记录了自己的观点。如果你不喜欢网易严选和网易考拉可以选择性跳过。</li></ol><p>我的线上线下购物变迁史 - <a href="https://wsgzao.github.io/post/buy/">https://wsgzao.github.io/post/buy/</a></p><h3 id="必备推荐"><a href="#必备推荐" class="headerlink" title="必备推荐"></a>必备推荐</h3><blockquote><p>我就只推荐适用于男同胞的产品了，虽然我妻子也是在严选和工厂店买，如果各位有需求我日后可以再补充，她的东西实在是多</p></blockquote><p>[手机 / 耳机 / 智能穿戴无推荐]<br>Follow Your Heart</p><p><a href="http://163.lu/I8OGX1" target="_blank" rel="noopener">28 寸 纯 PC“铝框”（非全铝）拉杆箱</a><br>新秀丽制造商，但是怎么看怎么觉得更像是日默瓦(RIMOWA)，虽然有小米 90 分旅行箱但 20 寸太小，为了追求更大容量就买了这款，使用感受非常可靠，五星推荐</p><p>[双肩包无推荐]<br>我自己背的是一加(OnePlus)1 代和 2 代，她带的是 Longchamp 和 Doughnut，都是多年的老包了</p><p><a href="http://wx.uniir.com/" target="_blank" rel="noopener">独美</a><br>眼镜我和妻子每人配了 2 副做主备, 我们买的都是来自京东众筹的独美，3.3g 镜架加镜片只要 398。小米有品太阳镜带了 1 副，不过来新加坡后我从来没佩戴过</p><p>[晴雨伞没有推荐]<br>新加坡经常短时暴雨，平日基本阳光明媚，建议携带一把晴雨伞，既能遮阳、又能挡雨。我自己带了 1 把天堂和 1 把小米晴雨两用，因为比较懒所以买的都是自动伞。只是可惜了 RealBrella 锐乐 不对称设计长柄伞留在家里吃灰，我好喜欢这款大红色啊。</p><p>[跑鞋无推荐]<br>自己带了 2 双旧鞋过来，严选上买过一双类似 Adidas UltraBoost 的鞋子还不错。我妻子带了 Asics GEL-Kayano 24，无论在网易考拉买还是在新加坡本地买 Asics 都很便宜，而且新加坡 NIKE EPIC REACT 新款居然只要 130 + 新币，这也是让我觉得很神奇</p><p><a href="http://163.lu/050tb0" target="_blank" rel="noopener">两带式男女款软木拖鞋 2.0</a><br><a href="http://163.lu/SpQlo1" target="_blank" rel="noopener">两带式男 / 女款拖鞋</a><br>Birkenstock 集团制造商，我特地在国内和新加坡的专卖店对比过，自己穿了 1 代非常舒服然后又买了 2 代，因为在新加坡基本是拖鞋 + 短裤的夏装，如果你的工作要求正装注意带好皮鞋和衣服套装</p><p><a href="http://163.lu/v4KrM2" target="_blank" rel="noopener">软弹速干男 / 女沐浴拖鞋</a><br>Crocs 制造商，浴室必备。本来想分享严选的人字拖，但不知道为什么严选把它下架了，反正我基本是放在室内穿，大家买自己觉得舒服的就好</p><p><a href="http://163.lu/CKQh21" target="_blank" rel="noopener">考拉工厂店 5 双 男士精梳棉防臭休闲袜</a><br>我在新加坡穿袜子的次数就和穿运动鞋的次数保持一致，除了健身和户外活动，几乎都是大拖鞋走起，上次登顶新加坡最高峰武吉知马山也是拖鞋，不过大家还是必要学我穿拖鞋爬山，以免自己给自己挖坑</p><p><a href="http://163.lu/uE5Uz3" target="_blank" rel="noopener">网易严选 男式丝滑莫代尔平角内裤</a><br><a href="http://163.lu/7ZOLU2" target="_blank" rel="noopener">考拉工厂店 男士莫代尔零束缚感内裤</a><br>我买过 CK 也买过网易严选和小米有品的纯棉内裤，但真正可以打动我的材质还是莫代尔，网易严选和网易考拉工厂店的两款我都买了，质感各有特色。严选上还有一款空气内裤，勇于尝鲜的同学要不试试？</p><p><a href="http://163.lu/aXBps0" target="_blank" rel="noopener">考拉工厂店 男式无缝插肩短袖 T 恤</a><br>我买了 3 件来自于严选和考拉工厂店的运动速干衣，但是从品质和舒适度上还是感觉不如自己再 Nike 实体店中购买的 Dri-FIT，考拉工厂店这款已经无限逼近了。小米有品也有很多运动衣，都是可以考虑的。我个人推荐备上 3 套运动衣，因为新加坡常年夏季，出汗是难免的，速干面料可以保持身体的舒适</p><p><a href="http://163.lu/Qxhpq2" target="_blank" rel="noopener">考拉工厂店 男式运动短裤</a><br>这款运动短裤我五星推荐，不仅做工精湛，口袋拉链等细节也非常到位，我自己直接买了 2 条，如果不是因为只有 2 种颜色，我还会继续买。另外还带了一条 Nike Dri-FIT 短裤，不过因为没有拉链所以来新加坡后基本没穿过，在上海的时候也仅仅是健身时穿的，现在因为设计问题算是彻底废了。</p><p><a href="http://163.lu/FPubq0" target="_blank" rel="noopener">考拉工厂店 男式针织轻薄运动裤</a><br>这款运动长裤我五星推荐，空气面料在夏天也依旧舒爽，内口袋拉链细节设计极赞，我索性买了 2 条一模一样的黑色款。新加坡平时上班我基本是穿这款长裤，原因和上面说过的新加坡室内空调温度较低有关，注意保暖。</p><p>[睡衣没有推荐]<br>我就直接把以前优衣库的全棉联名 T 恤全部带过来当睡衣穿了，有时候出门也可以穿哈</p><p>[外套没有推荐]<br>我自己带了 Under Armour 防风防雨衣，小米有品夜跑皮肤衣，小米有品防雨皮肤衣，除了 Under Armour 放在公司偶尔冷的时候会披一下，其它皮肤衣还没穿过。</p><p>[衬衫没有推荐]<br>我把原来公司定制的各种正装带过来了，可惜就入职时穿过一次，后来就是拖鞋加运动套装上班了</p><p><a href="http://163.lu/N7voR2" target="_blank" rel="noopener">成人款 高清时尚电镀泳镜</a><br><a href="http://163.lu/tDJJb2" target="_blank" rel="noopener">黑闪系列 硅胶防水泳帽 （男女通用）</a><br><a href="http://163.lu/Egc5c1" target="_blank" rel="noopener">男式基础泳裤</a><br>严选做了游泳装备也出乎我的意料，关键是和我之前买的 Speedo 相比那叫一个便宜啊，我本身是退休多年的游泳二级运动员，看似很简单的游泳装备严选的质量和价格都把控的不错，希望未来增加带度数的游泳镜。新加坡开放的普通游泳馆使用 EZ-link 刷卡，1.3 新币一次非常便宜，关键还多是训练使用的标准泳池人也少，定时清洁的规范让人放心。</p><p><a href="http://163.lu/rDAkF3" target="_blank" rel="noopener">全球通用转换插座</a><br>全球通用转换插座出国的人都应该明白是必备的，严选居然也做出来了，感觉又要干死一片坑爹厂商</p><p>[移动电源必须小米啊]<br>互联网上一直流传着这样的传说，小米什么产品都可以黑但是谁要是敢黑小米移动电源就被其他人反过来喷死。如果不是小米移动电源的出现干掉一众无良商家，现在市场上还不知道有多少人会受到低劣电池爆炸的影响，小米移动电源是真正用产品说话赢得用户口碑的最佳案例之一。我自己买的是紫米新款，我妻子买了一个超薄款就为了好看，哎</p><p><a href="http://163.lu/4ehYt4" target="_blank" rel="noopener">3 头浮动式电动剃须刀</a><br>科技类产品其实很想支持小米，可惜小米生态链不给力，就先用着严选高性价比的剃须刀好了</p><p><a href="http://163.lu/5cpvU0" target="_blank" rel="noopener">THREE SEVEN/777 进口指甲刀便携 4 件套 指甲剪小套装 三色可选</a><br>被淘宝坑过电动指甲刀和匠技指甲刀，也被严选坑过过于简约的指甲刀，没想到最后还是要选择韩国原装进口的 777 牌 4 件套，我以前不了解斜口指甲刀，后来才发现这货是剪脚指甲的神器啊，我以前剪脚指甲是有多痛苦哇</p><p><a href="http://163.lu/RNu3A1" target="_blank" rel="noopener">8 件装 折叠多功能衣架</a><br><a href="http://163.lu/dtCu31" target="_blank" rel="noopener">18 头多功能晾衣架</a><br>必备推荐，折叠携带很方便，18 头多功能晾衣架晾衣服的时候一个顶百，我都差点可以不用普通衣架了</p><p><a href="http://163.lu/pAmCc4" target="_blank" rel="noopener">旅行分装瓶套装</a><br>洗护用品我建议用分装瓶或者带最小包装的出国，因为这些日常用品本身价值不高但分量重，在当地超市购买就好了，除非你非常在意使用某些品牌</p><p><a href="http://163.wyh5.top/OsArG4" target="_blank" rel="noopener">考拉工厂店 智能清洁电动牙刷</a><br>我给父母买的也是同款，建议再带上 2 个以上刷头。如果你之前从来没有使用过电动牙刷，非常建议你尝试，清洁牙齿更加彻底和方便，爱上之后就无法回到过去手动刷牙啦</p><p><a href="http://163.lu/H03jR2" target="_blank" rel="noopener">电动式硅胶洁面仪</a><br>我还记得我给妻子送的第一个礼物就是 FOREO LUNA MINI2 Plus，这个也是我在网易考拉上买的第一个商品，当时这款网红洁面仪被招商银行垄断，没办法直接购买，逼着自己了解到网易考拉在国内海淘市场的领先地位，也算是缘分吧。现在严选自己也推出类似洁面仪才十分之一的价格，买个给自己吧</p><p><a href="http://163.lu/ZKkRz3" target="_blank" rel="noopener">韩国制造 硅胶洁面刷</a><br><a href="http://163.lu/RJS3r0" target="_blank" rel="noopener">韩国制造 硅胶沐浴按摩手套</a><br><a href="http://163.lu/Rv9KI2" target="_blank" rel="noopener">韩国制造 多功能硅胶清洁刷</a><br>严选从韩国引进来相当专业的硅胶产品制造商，其中这 3 件小东西在洗脸，沐浴，洗碗上极大的提升了我的幸福感，强烈推荐人手一件</p><p><a href="http://163.lu/womXA3" target="_blank" rel="noopener">皇室御用超柔毛巾</a><br>内野制造商，这是网易严选当年备受争议的产品之一，我不知道内野是什么，但我只知道这款毛巾确实舒服</p><p>[床单 / 床笠 / 被套 / 毯子]<br>我从家里带了 2 套旧的，然后又从考拉工厂店买了外国人比较喜欢的床笠，因为晚上睡觉都是关闭空调，没有被子就一层薄薄的毯子，一般租房子房东都会提供床板和床上用品，如果你不习惯或者运气不好，在新加坡本地宜家采购也很方便的</p><p><a href="http://163.lu/VY4v73" target="_blank" rel="noopener">考拉工厂店 100% 桑蚕丝双面美肤枕套</a><br>我和妻子一人一个，带过去非常方便，水洗之后也没有出现质量问题，面料实在丝滑</p><p><a href="http://163.lu/pBhg61" target="_blank" rel="noopener">AQR 创口贴</a><br>在新加坡常年夏装，像脚和皮肤很容易受伤，带上一盒以备不时之需</p><h3 id="可选推荐"><a href="#可选推荐" class="headerlink" title="可选推荐"></a>可选推荐</h3><blockquote><p>分享自己购买过的东西真的好累，没想到不知不觉买了这么多，但是能够对自己派上用场没有浪费也值了</p></blockquote><p><a href="http://163.lu/23D8k4" target="_blank" rel="noopener">泰国制造 天然乳胶枕 护颈优眠 升级抗菌</a><br>我买过记忆枕，空气枕，乳胶枕还有各种酒店的枕头体验。小米 8H 的乳胶枕和网易严选的相比我更推荐严选的升级款，这也属于严选的爆款商品了</p><p><a href="http://163.lu/6iWZ74" target="_blank" rel="noopener">日式多功能颈枕 舒滑款</a><br>第一次看到 MUJI 的微粒子 U 型枕就被深深吸引，现在小米和网易严选都有同样类型的，我自己购买的是光滑面料，毕竟新加坡非常热，原来在国内我还买过一个经典款</p><p><a href="http://163.lu/9iYPC2" target="_blank" rel="noopener">舒眠真丝眼罩</a><br>折叠床是带不过去了，很早之前买过零听眼罩，用过真丝眼罩后才明白丝的舒服，就和上面买真丝枕套的理由一样。如果你对声音也很敏感，除了戴耳机以外，再购置几副耳塞也是不错的选择</p><p>[鼻毛修剪器]<br>没有看到小米和严选有，看了张大妈的评测最后淘宝购入松下 ER-BN50，虽然不知道和国产的飞科相比有多大优势，至少用下来还行吧</p><p>[洗护 / 牙膏 / 洗面奶 / 防晒霜]<br>我推荐带上便携装，其实选择什么不重要，重要的是理解背后的成分，我唯一推荐的就是自己在上海和新加坡都长期使用的<a href="http://163.lu/lWFct2" target="_blank" rel="noopener"> 熊野油脂 无硅弱酸性马油洗发水</a></p><p><a href="http://163.lu/M8IW72" target="_blank" rel="noopener">Swisse 男士复合维生素 120 片 / 瓶</a><br>加上我在上海之前吃的半瓶，一共带了 2.5 瓶过去，现在回头看这个决定是非常明智的，因为新加坡本地蔬菜和水果不算便宜，关键是营养品价格奇高，一小瓶都要五六十新币。营养品不能代替药物，更不能代替你规律的饮食作息和身体锻炼，请记住这只是用来辅助身体营养平衡。我妻子还会购买 Swisse 的女士复合维生素片 + 葡萄籽和 Unichi 玫瑰果 + 葡萄籽</p><p><a href="http://163.lu/PsXds0" target="_blank" rel="noopener">考拉工厂店 便携式手持蒸汽挂烫机</a><br>我妻子要买的，方便小巧，出席正式场合会排上用场</p><p><a href="http://163.lu/WXcRz2" target="_blank" rel="noopener">考拉工厂店 强力除螨吸尘器</a><br>我没同意我妻子买养生壶和破壁料理机，原本这么大个头的除螨仪其实也是拒绝的，但是在阅读过网易浪潮工作室的一篇《中国人为什么爱晒被子》后我认为在美国或者韩国流行的洗衣烘干一体机可能不适合现在的我们，但是我不希望自己身边的人因为痘痘或者皮肤细菌感染而受到伤害，既然网易工厂店降低了除螨仪的购买门槛，为什么不尝试改变下自己的习惯呢？</p><p><a href="http://163.lu/oCJS84" target="_blank" rel="noopener">春风 TryFun 超润滑避孕套</a><br>好孩子就不要点击了，尤其是不要淘气切换到春风 TryFun 系列</p><h2 id="工作招聘"><a href="#工作招聘" class="headerlink" title="工作招聘"></a>工作招聘</h2><p><img src="http://wx1.sinaimg.cn/large/7207510dgy1fv3qi3vd5jj20by0bymyh.jpg" alt=""></p><p><a href="https://docs.qq.com/doc/BqI21X2yZIht1vALQM0Mf73G24se4c4wv0v31gLPCn3U4vsH0IQmKC2Cjyb927Q9Ok0PRkXB3WYpg82K1GXC4" target="_blank" rel="noopener">中金所技术公司最新招聘岗位</a></p><p><a href="https://docs.qq.com/doc/B80RhZ2ZATLC0DsTVf3kFjA01XR7Mg1x8BG42bVOrs1E5zYc01HWAZ0vDTku39xOdU3cS99t2" target="_blank" rel="noopener">Sea Job Openings</a></p><p>这是我第一次创建微信个人公众号，不会向大家推送文章，只是作为信息分享的渠道。我和上家公司以及现在公司的人力关系都还不错，在征得允许的前提下给大家分享上海和新加坡这两家公司目前的内部招聘动态，上海的职位真的的是进去的多出来的少，如果你希望相对稳定那这是很不错的机会。新加坡这边我会跟随公司内部招聘邮件每半个月左右更新，工作语言以英文为主，周围的中国同事还比较多，不用太担心在新加坡的语言关。这两家公司的介绍都可以在互联网上轻松获取，如果你相信自己的能力可以直接投递简历至文章内的联系方式。努力奋斗未必都能达到预想的结果，但至少你做出了自己的选择。</p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><blockquote><p>如果你无法访问 github.io 的原文可以查看知乎专栏的文章，如果你想了解我前往新加坡的渠道可以看微信公众号的提炼内容</p></blockquote><p>从国内跳槽至新加坡工作的经验分享<br><a href="https://zhuanlan.zhihu.com/p/44280335" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/44280335</a></p><p>从国内跳槽至新加坡的最初半年，我都经历了什么？<br><a href="https://mp.weixin.qq.com/s/gDntToVrvFoQbyfrNf7XqA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/gDntToVrvFoQbyfrNf7XqA</a></p><p>从小到大我都没有离开过父母的保护，感谢你们的理解和支持，也同样感谢老婆的付出和双方家庭的包容。<br>引用领结婚证那天分享在朋友圈的一句话作为结语: I never grow up, but I nerver stop growing.</p>]]></content>
    
    <summary type="html">
    
      为帮助大家玩转新加坡、快速适应当地生活
    
    </summary>
    
      <category term="生活 | Life" scheme="https://wsgzao.github.io/categories/%E7%94%9F%E6%B4%BB-Life/"/>
    
    
  </entry>
  
  <entry>
    <title>Jenkins 学习使用实践</title>
    <link href="https://wsgzao.github.io/post/jenkins/"/>
    <id>https://wsgzao.github.io/post/jenkins/</id>
    <published>2019-02-12T06:59:49.000Z</published>
    <updated>2019-03-11T04:07:42.350Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Jenkins 就不用做多余的介绍了，作为 CI/CD 首选的开源解决方案，持续集成 (Continous Intergration)/ 持续交付 (Continous Delievery)，本文只是用于记录使用 Jenkins 的一些基本操作，Jenkins 官方文档也率先支持中文，相信对大家的学习热情会有积极地促进作用。</p><blockquote><p>Jenkins 学习使用实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 02 月 12 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/jenkins/">https://wsgzao.github.io/post/jenkins/</a></p><p><strong> 扩展阅读 </strong></p><p>Jenkins - <a href="https://jenkins.io/zh/" target="_blank" rel="noopener">https://jenkins.io/zh/</a></p><hr><h2 id="Jenkins-简介"><a href="#Jenkins-简介" class="headerlink" title="Jenkins 简介"></a>Jenkins 简介</h2><blockquote><p>构建伟大，无所不能</p></blockquote><p>Jenkins 是开源 CI&amp;CD 软件领导者， 提供超过 1000 个插件来支持构建、部署、自动化，满足任何项目的需要。</p><p>Jenkins 用户手册 - <a href="https://jenkins.io/zh/doc/" target="_blank" rel="noopener">https://jenkins.io/zh/doc/</a></p><p>Jenkins 训练营之基础篇 - <a href="https://ke.qq.com/course/265167" target="_blank" rel="noopener">https://ke.qq.com/course/265167</a><br>Jenkins 训练营之带你玩转 Pipeline - <a href="https://ke.qq.com/course/252785" target="_blank" rel="noopener">https://ke.qq.com/course/252785</a></p><p><a href="https://ke.qq.com/webcourse/index.html#cid=265167&amp;term_id=100312699&amp;taid=1794918372871119&amp;vid=p1423f5tn3g" target="_blank" rel="noopener">https://ke.qq.com/webcourse/index.html#cid=265167&amp;term_id=100312699&amp;taid=1794918372871119&amp;vid=p1423f5tn3g</a></p><p><a href="https://ke.qq.com/webcourse/index.html?cw_id=91852&amp;ac_type=3#cid=252785&amp;term_id=100298102&amp;taid=1707945285114737&amp;type=1024&amp;vid=w1422iqh9q1" target="_blank" rel="noopener">https://ke.qq.com/webcourse/index.html?cw_id=91852&amp;ac_type=3#cid=252785&amp;term_id=100298102&amp;taid=1707945285114737&amp;type=1024&amp;vid=w1422iqh9q1</a></p><h2 id="Jenkins-安装"><a href="#Jenkins-安装" class="headerlink" title="Jenkins 安装"></a>Jenkins 安装</h2><p>Jenkins 项目产生两个发行线，长期支持版本 (LTS) 和每周更新版本。 根据你的组织需求，一个可能比另一个更受欢迎。<br>两个版本都以 .war 文件，原生包，安装程序，和 Docker 容器的形式分发。<br><a href="https://jenkins.io/zh/download/" target="_blank" rel="noopener">https://jenkins.io/zh/download/</a></p><p>这里推荐下载使用 LTS 长期支持版本，以 CentOS 7 作为演示环境</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Java 8</span></span><br><span class="line">yum install java</span><br><span class="line"></span><br><span class="line"><span class="comment"># Jenkins stable version</span></span><br><span class="line">sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo</span><br><span class="line">sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key</span><br><span class="line">yum install jenkins</span><br><span class="line"></span><br><span class="line"><span class="comment"># start jenkins</span></span><br><span class="line">service jenkins start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化配置向导 </span></span><br><span class="line">http://192.168.56.103:8080/</span><br><span class="line"></span><br><span class="line">cat /var/lib/jenkins/secrets/initialAdminPassword</span><br><span class="line">5224fc83b6d84cc2be69a18c53309ea4</span><br><span class="line"></span><br><span class="line">Install suggested plugins</span><br><span class="line"></span><br><span class="line"> 是否创建管理员账户或者跳过</span><br></pre></td></tr></table></figure><h2 id="Jenkins-入门"><a href="#Jenkins-入门" class="headerlink" title="Jenkins 入门"></a>Jenkins 入门</h2><h3 id="主要的-Job-类型"><a href="#主要的-Job-类型" class="headerlink" title="主要的 Job 类型"></a>主要的 Job 类型</h3><p>Freestyle project<br>自由风格项目，Jenkins 最主要的项目类型</p><p>Maven Project<br>Maven 项目专用，类似 Freestyle，更简单</p><p>Multi-configuration project<br>多配置项目，适合需要大量不同配置 (环境，平台等) 构建</p><p>Pipeline<br>流水线项目，适合使用 pipeline(workflow)插件功能构建流水线任务，或者使用 Freestyle project 不容易实现的复杂任务</p><p>Multibranch Pipeline<br>多分支流水线项目，根据 SCM 仓库中的分支创建多个 Pipeline 项目</p><h3 id="Freestyle-项目"><a href="#Freestyle-项目" class="headerlink" title="Freestyle 项目"></a>Freestyle 项目</h3><p>General<br>项目基本配置<br>项目名字，描述，参数，禁用项目，并发构建，限制构建默认 node 等等</p><p>Source code Management<br>代码库信息，支持 Git，Subversion 等</p><p>Build Triggers<br>构建触发方式<br>周期性构建，Poll SCM，远程脚本触发构建，其他项目构建结束后触发等</p><p>Build Environment<br>构建环境相关设置<br>构建前删除 workspace，向 Console 输出添加时间戳，设置构建名称，插入环境变量等</p><p>Build<br>项目构建任务<br>添加 1 个或者多个构建步骤</p><p>Post-build Actions<br>构建后行为<br>Artifact 归档，邮件通知，发布单元测试报告，触发下游项目等等</p><h3 id="规范项目必要配置"><a href="#规范项目必要配置" class="headerlink" title="规范项目必要配置"></a>规范项目必要配置</h3><p>本规范尤其适用于较多项目共用同一 Jenkins 的场景</p><ul><li>项目命名规范</li><li>设置项目描述</li><li>设置历史构建清理规则</li><li>设置构建节点 Label</li><li>邮件通知</li></ul><h3 id="常用插件"><a href="#常用插件" class="headerlink" title="常用插件"></a>常用插件</h3><blockquote><p>注意 Jenkins 备份策略，建议结合 rsync 备份远端</p></blockquote><p>Jenkins 显示时间戳: Timestamper<br>Jenkins 配置构建历史: Job Configuration History Plugin<br>Jenkins 定时的备份: ThinBackup<br>邮件发送插件: Email Extension Plugin<br>空间清理扩展插件: Distributed Workspace Clean plugin</p><p>Jenkins 常用插件 – <a href="https://vwin.github.io/2019/01/07/Jenkins%E9%AB%98%E6%95%88%E6%8F%92%E4%BB%B6%E6%95%B4%E7%90%86/" target="_blank" rel="noopener">https://vwin.github.io/2019/01/07/Jenkins%E9%AB%98%E6%95%88%E6%8F%92%E4%BB%B6%E6%95%B4%E7%90%86/</a></p><h3 id="创建第一个-Job"><a href="#创建第一个-Job" class="headerlink" title="创建第一个 Job"></a>创建第一个 Job</h3><p>安装 Timestamper 插件<br>系统管理 - 插件管理 - 可用插件，搜索到 timestamper 点击 Install without restart</p><p>新建一个 Freestyle 类型的 Job</p><ul><li>General 项目名称: My-first-freestyle-demo</li><li>Build Environment 构建环境: 勾选 Add timestamps to the Console Output</li><li>Build 构建: 屏幕打印出 “这是我的第一个 Jenkins Job, oops” </li><li>Post-build Actions 构建后操作: 无</li><li>点击立刻构建</li><li>找到控制台输出</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Console Output</span><br><span class="line">14:40:59 Started by user admin</span><br><span class="line">14:40:59 Building <span class="keyword">in</span> workspace /var/lib/jenkins/workspace/My-first-freestyle-demo</span><br><span class="line">14:41:00 [My-first-freestyle-demo] $ /bin/sh -xe /tmp/jenkins3737737887278720679.sh</span><br><span class="line">14:41:00 + <span class="built_in">echo</span> <span class="string">'这是我的第一个 Jenkins Job, oops'</span></span><br><span class="line">14:41:00 这是我的第一个 Jenkins Job, oops </span><br><span class="line">14:41:00 Finished: SUCCESS</span><br></pre></td></tr></table></figure><h2 id="Jenkins-Pipeline-介绍"><a href="#Jenkins-Pipeline-介绍" class="headerlink" title="Jenkins Pipeline 介绍"></a>Jenkins Pipeline 介绍</h2><p>Pipeline，简而言之，就是一套运行于 Jenkins 上的工作流框架，将原本独立 运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂流程编排与可视化。</p><p>Pipeline 是 Jenkins2.X 最核心的特性，帮助 Jenkins 实现从 CI 到 CD 与 DevOps 的转变</p><blockquote><p>什么是 Jenkins Pipeline?</p></blockquote><p>Jenkins Pipeline 是一组插件，让 Jenkins 可以实现持续交付管道的落地和实施。持续交付管道 (CD Pipeline) 是将软件从版本控制阶段到交付给用户或客户的完 整过程的自动化表现。软件的每一次更改 (提交到源代码管理系统) 都要经过一个复杂的过程才能被发布。</p><p>Pipeline 提供了一组可扩展的工具，通过 Pipeline Domain Specific Language(DSL) syntax 可以达到 Pipeline as Code 的目的</p><p>Pipeline as Code:Jenkinsfile 存储在项目的源代码库</p><blockquote><p>Jenkins Pipeline 核心概念</p></blockquote><p>Stage<br>– 阶段，一个 Pipeline 可以划分为若干个 Stage，每个 Stage 代表一组操作，例如: “Build”, “Test”, “Deploy” 。<br>– 注意，Stage 是一个逻辑分组的概念，可以跨多个 Node。 </p><p>Node<br>– 节点，一个 Node 就是一个 Jenkins 节点，或者是 Master，或者是 Agent，是执行 Step 的具体 运行环境。</p><p>Step<br>– 步骤，Step 是最基本的操作单元，小到创建一个目录，大到构建一个 Docker 镜像，由各类 Jenkins Plugin 提供，例如: sh ‘make’</p><blockquote><p>为什么要用 Pipeline?</p></blockquote><ul><li>代码: Pipeline 以代码的形式实现，通常被检入源代码控制，使团队能够编辑，审查和迭代其 CD 流程。</li><li>可持续性: Jenkins 重启或者中断后都不会影响 Pipeline Job。</li><li>停顿: Pipeline 可以选择停止并等待人工输入或批准，然后再继续 Pipeline 运行。</li><li>多功能: Pipeline 支持现实世界的复杂 CD 要求，包括 fork/join 子进程，循环和 并行执行工作的能力。</li><li>可扩展: Pipeline 插件支持其 DSL 的自定义扩展以及与其他插件集成的多个选项。</li></ul><blockquote><p>Pipeline 和 Freestyle 的区别</p></blockquote><p>Freestyle:<br>– 上游 / 下游 Job 调度，如 BuildJob -&gt;TestJob -&gt; DeployJob<br>– 在 DSL Job 里面调度多个子 Job(利用 Build Flow plugin)</p><p>Pipeline:<br>– 单个 Job 中完成所有的任务编排<br>– 全局视图</p><blockquote><p>Pipeline 会取代 Freestyle 么?</p></blockquote><ul><li>Pipeline 一定会取代 Build Flow 插件</li><li>会，当你希望做到 Pipeline as code 的时候</li><li>会，当你独立运行一组 Job 没有特殊价值或者意义的时候</li><li>会，当你可以从 Multibranch Pipeline 受益的时候</li><li>会，当你希望获取类似于 TravisCI 风格的工作流的时候</li></ul><h3 id="Jenkins-Pipeline-入门"><a href="#Jenkins-Pipeline-入门" class="headerlink" title="Jenkins Pipeline 入门"></a>Jenkins Pipeline 入门</h3><p>Pipeline 脚本是由 Groovy 语言实现<br>– 无需专门学习 Groovy</p><p>Pipeline 支持两种语法<br>– Declarative 声明式(在 Pipeline plugin 2.5 中引入)<br>– Scripted Pipeline 脚本式</p><p>如何创建基本的 Pipeline<br>– 直接在 Jenkins Web UI 网页界面中输入脚本<br>– 通过创建一个 Jenkinsfile 可以检入项目的源代码管理库</p><p>最佳实践<br>– 通常推荐在 Jenkins 中直接从源代码控制 (SCM) 中载入 Jenkinsfile Pipeline</p><h3 id="快速创建一个简单的-Pipeline"><a href="#快速创建一个简单的-Pipeline" class="headerlink" title="快速创建一个简单的 Pipeline"></a>快速创建一个简单的 Pipeline</h3><ol><li>新建 Job: Jenkins -&gt; 新建 -&gt; 输入 Job 名称: “My-first-pipeline-demo” -&gt; 选择 Pipeline -&gt; 点击 “OK”</li><li>配置: 在 Pipeline -&gt; Script 文本输入框中输入下列语句，点击 ”保存”</li><li>立即构建</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'Build'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'Test'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'Deploy'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Jenkins-忘记密码怎么办"><a href="#Jenkins-忘记密码怎么办" class="headerlink" title="Jenkins 忘记密码怎么办"></a>Jenkins 忘记密码怎么办</h2><p>如果权限设置错误，或者忘记密码，导致 admin 自己都无法登陆 Jenkins 怎么办?</p><ul><li>命令行停止 Jenkins;</li><li>先备份 $JENKINS_HOME 中的 config.xml;</li><li>用编辑器打开 $JENKINS_HOME 中的 config.xml;</li><li>将 &lt; useSecurity&gt;true 元素中的 true 改为 false;</li><li>将 &lt; authorizationStrategy &gt; 和 &lt; securityRealm &gt; 元素的内容删掉; </li><li>命令行启动 Jenkins。</li></ul><h2 id="Ansible-Jenkins-API-Token-使用技巧"><a href="#Ansible-Jenkins-API-Token-使用技巧" class="headerlink" title="Ansible Jenkins API Token 使用技巧"></a>Ansible Jenkins API Token 使用技巧</h2><p>Jenkins REST API 提供了 API token，使得可以在程序中使用 API token 进行认证（而不是使用你真实的密码）。</p><p>API token 可以在用户个人设置界面查看<br>到用户→用户 id→设置页面，在 API Token 区域点击 Show API token 按钮，便可查看 API token，同时还可以更改 API token<br>相应的 URL 是<br>http://&lt;JENKINS_URL&gt;/user/<userid>/configure</userid></p><p>Manage Jenkins jobs by using Jenkins REST API</p><p>jenkins_job_facts – Get facts about Jenkins jobs<br><a href="https://docs.ansible.com/ansible/latest/modules/jenkins_job_facts_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/jenkins_job_facts_module.html</a></p><p>jenkins_job – Manage jenkins jobs<br><a href="https://docs.ansible.com/ansible/latest/modules/jenkins_job_module.html" target="_blank" rel="noopener">https://docs.ansible.com/ansible/latest/modules/jenkins_job_module.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python-jenkins package</span></span><br><span class="line">pip install python-jenkins lxml</span><br><span class="line"></span><br><span class="line"><span class="comment"># jenkins_job_facts.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  gather_facts: no</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Get host info</span><br><span class="line">      local_action:</span><br><span class="line">        module: jenkins_job_facts</span><br><span class="line">        url: https://xxx</span><br><span class="line">        user: xxx</span><br><span class="line">        token: xxx</span><br><span class="line">        glob: <span class="string">'*mh_kg*'</span></span><br><span class="line">      register: my_jenkins_job_facts</span><br><span class="line"></span><br><span class="line">    - debug:</span><br><span class="line">        msg: <span class="string">"&#123;&#123;my_jenkins_job_facts&#125;&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># shell awk</span></span><br><span class="line">cat reg | grep <span class="string">'"name"'</span> | awk -F <span class="string">'"'</span> <span class="string">'&#123;print $4&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># jenkins_job_delete.yml</span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  gather_facts: no</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Delete <span class="built_in">jobs</span></span><br><span class="line">      local_action:</span><br><span class="line">        module: jenkins_job</span><br><span class="line">        url: xxx</span><br><span class="line">        user: xxx</span><br><span class="line">        token: xxx</span><br><span class="line">        name: <span class="string">"&#123;&#123; item &#125;&#125;"</span></span><br><span class="line">        state: absent</span><br><span class="line">      loop: </span><br><span class="line">        - gop_live___mh_kg_garena_auth_nginx_static_files</span><br><span class="line">        - gop_live___mh_kg_nginx_reload</span><br><span class="line">        - gop_live___mh_kg_nginx_update_config</span><br><span class="line">        - gop_live___mh_kg_restart_service</span><br><span class="line">        - gop_live___mh_kg_setup_server</span><br><span class="line">        - gop_live___mh_kg_stop_service</span><br><span class="line">        - gop_live_mh_kg_app_point</span><br><span class="line">        - gop_live_mh_kg_game_service</span><br><span class="line">        - gop_live_mh_kg_payment_center_backend</span><br><span class="line">        - gop_live_mh_kg_sso_website</span><br></pre></td></tr></table></figure><h2 id="参考内容"><a href="#参考内容" class="headerlink" title="参考内容"></a>参考内容</h2><blockquote><p>官方手册永远是你的最佳参考内容</p></blockquote><p>Jenkins 用户手册 - <a href="https://jenkins.io/zh/doc/" target="_blank" rel="noopener">https://jenkins.io/zh/doc/</a></p>]]></content>
    
    <summary type="html">
    
      Jenkins学习使用实践
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>腾达 AC18 刷梅林固件 (KoolShare) 和恢复原厂固件实践心得</title>
    <link href="https://wsgzao.github.io/post/ac18/"/>
    <id>https://wsgzao.github.io/post/ac18/</id>
    <published>2019-02-07T08:40:53.000Z</published>
    <updated>2019-02-07T07:34:30.388Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://a.zdmimg.com/201706/17/5944e5991f09d7003.png_f710.jpg" alt=""></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>2016 年 9 月份买腾达 AC18 的时候是因为觉得 AC9 性能不够用，毕竟家里带宽已经上 200MB，当时考虑过小米路由但觉得和 NAS 搭配还不够成熟，也许现在或者下一个路由器会回归小米，本文主要和大家一起分享下 AC18 如何刷入梅林固件和恢复，推荐自己用的配置和插件，本来应该很早分享的但一直在验证稳定的刷机固件，希望这一切来的不会太迟。</p><blockquote><p>路由器刷固件后对我来说最直接的作用是科学上网和屏蔽广告，比如小米盒子广告就彻底屏蔽了</p></blockquote><h2 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h2><p>2019 年 02 月 07 日 - 更新 ASUS Merlin 梅林固件 Koolshare 改版离线安装 Shadowsocks 教程<br>2018 年 04 月 01 日 - 增加无线信号设置的几点建议<br>2017 年 08 月 07 日 - 完善细节描述<br>2017 年 07 月 14 日 - 增加优化设置<br>2017 年 06 月 21 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/ac18/">https://wsgzao.github.io/post/ac18/</a></p><p><strong> 扩展阅读 </strong></p><p>AC18 1900M 11ac 千兆口别墅型双频无线路由器 - <a href="http://www.tenda.com.cn/product/AC18.html" target="_blank" rel="noopener">http://www.tenda.com.cn/product/AC18.html</a><br>Asuswrt-merlin 基本操作 - <a href="http://koolshare.cn/thread-3578-1-1.html" target="_blank" rel="noopener">http://koolshare.cn/thread-3578-1-1.html</a></p><h2 id="购买记录"><a href="#购买记录" class="headerlink" title="购买记录"></a>购买记录</h2><blockquote><p>我买的时候差不多也是 499，如果你在 618 拿到优惠券 400 多拿下也是可能的</p></blockquote><p><a href="https://item.jd.com/3137178.html" target="_blank" rel="noopener">https://item.jd.com/3137178.html</a></p><h2 id="什么是-merlin"><a href="#什么是-merlin" class="headerlink" title="什么是 merlin"></a>什么是 merlin</h2><p>首先 Asuswrt 是华硕公司为他的路由器所开发的固件。Asuswrt-merlin 是一个对 Asuswrt 固件二次开发进行各种改进和修正的项目。现在支持以下的路由型号：<br>RT-AC56U<br>RT-N66U<br>RT-AC66U<br>RT-AC68U<br>RT-AC68P<br>RT-AC87U<br>RT-AC3200<br>源码来源于 <a href="https://github.com/RMerl/asuswrt-merlin" target="_blank" rel="noopener">https://github.com/RMerl/asuswrt-merlin</a></p><blockquote><p>Asuswrt-merlin 的优势</p></blockquote><p>Merlin 固件拥有更多的功能，由于第三方不断维护代码，各种新功能也在不断增加。Merlin 固件的升级并不需要反复的操作过程，方法与官方固件的升级相同，有很好的硬件软件兼容性。继承了 Asuswrt 官方固件优秀的交互界面。Koolshare 论坛所分享的固件大多是基于 Merlin 代码再次改进，增加适合国内使用的功能。</p><h2 id="刷固件"><a href="#刷固件" class="headerlink" title="刷固件"></a>刷固件</h2><blockquote><p>如果你觉得官方固件足够稳定，功能都满足你的需要建议就不用折腾自己刷机啦</p></blockquote><p>这里分享两种刷机方法</p><h3 id="方法一（推荐）"><a href="#方法一（推荐）" class="headerlink" title="方法一（推荐）"></a>方法一（推荐）</h3><p><img src="http://am.zdmimg.com/201706/17/5944e93c8989a7325.gif_e600.jpg" alt=""></p><p>在原厂固件下 AC18_kf_V15.03.3.7(4031)AC18 特殊版中间固件，重启会自动更新 18 的 cfe，修正早期版本的 ac18 的 cfe，破除固件限制，然后在就可以在 ac18 原厂固件的系统升级页面来选择梅林升级了</p><h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>按住路由后面的 reset 按钮，然后开机，持续大概 15 秒左右，看到路由器的大部分过之后，可以松开按钮，去电脑通过有线来刷机，打开 192.168.0.1，如下图，选择梅林固件，upload，等等长传完毕</p><p><img src="http://am.zdmimg.com/201706/17/5944e9ad9825c1058.png_e600.jpg" alt=""><br><img src="http://am.zdmimg.com/201706/17/5944e9ae5ce209143.png_e600.jpg" alt=""></p><p>刷完梅林之后路由会重启，需要进入梅林恢复出厂设置或捅菊花清空一次 nvram</p><p><img src="http://am.zdmimg.com/201706/17/5944e9af391118578.png_e600.jpg" alt=""></p><h2 id="固件和插件选择"><a href="#固件和插件选择" class="headerlink" title="固件和插件选择"></a>固件和插件选择</h2><blockquote><p>如果刷梅林目前推荐最新的 KoolShare 7.9.1 版本</p></blockquote><p><a href="http://koolshare.cn/forum-96-1.html" target="_blank" rel="noopener">http://koolshare.cn/forum-96-1.html</a></p><ol><li>第一次登陆梅林要清空 nvram 或出厂设置。然后进入 / 系统管理 / 选项里边的 / 系统设置 /</li></ol><p>将 format jffs 和 enable jssf custom script 两个选项选上 是，然后将下面的 enableSSH 选择 lan only ，保存提交配置，这样在重启之后就可以可以使用 webshell 和软件中心了</p><p><img src="http://am.zdmimg.com/201706/17/5944f28dc32c27837.png_e600.jpg" alt=""></p><ol start="2"><li>进入内置网络 / 内网址设置</li></ol><p>将路由器的 ip 地址设置成为 192.168.50.1，这个只是建议值，为了避免和光猫或上一级路由 IP 冲突，当然你也可以改成 192.168.xx.1 或你喜欢的非. 1.1 的地址就行，完成这项配置之后，选择重启路由</p><p><img src="http://am.zdmimg.com/201706/17/5944f28f390121205.png_e600.jpg" alt=""></p><ol start="3"><li>重启之后进入路由点 software center，更新到最新版本，并且安装 webshell</li></ol><p><img src="http://am.zdmimg.com/201706/17/5944f28ff304f7451.png_e600.jpg" alt=""></p><ol start="4"><li>推荐插件</li></ol><ul><li><p>koolproxy，路由器去广告插件的首选，占用资源低稳定</p></li><li><p>ss，科学上网利器你懂得，新版软件中心已经下架，建议手动离线安装</p></li></ul><ol start="5"><li>优化设置</li></ol><p>A： 5G 设置，在一般设置里边将频道带宽设置为 80Mhz，信道固定到 149 或 157（自动信道会出现有些信道无信号，从而不能搜到 5g 的 id）等等<br>然后进入专业设置，把地区改成 all area，可以让 5G 达到最佳效果</p><p>B：2.4G 设置</p><p>进入一般设置将频段带宽设置为 40mhz，然后进入专业设置，将降低 USB3.0 干扰 停用</p><p>因为 ac18 的屏蔽做的比华硕 68u 要好，这里可以停用，可以让 2.4g 的信号正常，如果 USB3.0 效果不行可以打开这个选项看看效果，这个功能看你看重哪个了，试一下找到最好的平衡点</p><h2 id="部分设备搜索不到-Wifi-信号"><a href="#部分设备搜索不到-Wifi-信号" class="headerlink" title="部分设备搜索不到 Wifi 信号"></a>部分设备搜索不到 Wifi 信号</h2><p>关于 2.4G: 有设备搜不到 2.4G 信号，此时请检查无线设置中的 2.4G 信号，信道设置在 13 可能会造成部分设备无法搜索到信号，通常建议使用 1 或 6 信道。此外，频道带宽也有可能影响信号的搜索，在不确定设备支持情况时请使用 20Mhz，保证最大兼容。注意，此时 2.4G 的连接速率会比 40Mhz 低一半。</p><p>关于 5G: 有支持 5G 的设备设备搜不到 5G 信号。部分用户购买的国际版手机可能工作在国内不支持的信道。遇到此类问题，请不要把信道设置为 36-64；一般情况下正常终端应该都会支持 149-165，您可以尝试将信道设置在此范围内然后再试。</p><h2 id="关于无线信号设置的几点建议"><a href="#关于无线信号设置的几点建议" class="headerlink" title="关于无线信号设置的几点建议"></a>关于无线信号设置的几点建议</h2><p>2.4G 通常作为无线覆盖主力，因此建议用 wifi 分析仪 或者 Wifi Analytics 之类的软件分析一下周围信道使用状况，尽量避免使用周围占用严重的信道。且建议用 20Mhz 频道带宽，尽量保证兼容性。</p><p>而 5G 作为高速连接使用的信号，建议使用 80Mhz 的频道带宽，增加速率，且 5G 信号中信道对传输速率相对影响较大，低频段信号穿墙能力好，但是速率仅略高于 2.4G（36 信道）因此，无法发挥 5G 信号本来的优势，153-157 信号一般速率都能达到 867Mbps 以上，有需要高速接入的，就必须把信道设定为 153 或 157 这样的高频信号。</p><h2 id="离线安装-ss-插件"><a href="#离线安装-ss-插件" class="headerlink" title="离线安装 ss 插件"></a>离线安装 ss 插件</h2><p>路由器：腾达 AC18<br>固件版本: 7.9.1<br>【华硕系列】【20180927】380.70_0-X7.9.1 固件发布 - <a href="http://koolshare.cn/thread-139322-1-1.html" target="_blank" rel="noopener">http://koolshare.cn/thread-139322-1-1.html</a><br>ASUS Merlin 梅林固件 Koolshare 改版离线安装 Shadowsocks 教程 - <a href="https://github.com/hq450/fancyss_history_package" target="_blank" rel="noopener">https://github.com/hq450/fancyss_history_package</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">wget https://raw.githubusercontent.com/hq450/fancyss/master/fancyss_arm/shadowsocks.tar.gz</span><br><span class="line">tar -zxvf /tmp/shadowsocks.tar.gz</span><br><span class="line">chmod +x /tmp/shadowsocks/install.sh</span><br><span class="line">sh /tmp/shadowsocks/install.sh</span><br></pre></td></tr></table></figure><h2 id="恢复原厂固件"><a href="#恢复原厂固件" class="headerlink" title="恢复原厂固件"></a>恢复原厂固件</h2><p>参照刷机方法二执行即可，如果现有的固件足够稳定，就不要用强迫症来折腾自己啦，够用就好</p>]]></content>
    
    <summary type="html">
    
      路由器刷固件后对我来说最直接的作用是科学上网和屏蔽广告，比如小米盒子广告就彻底屏蔽了
    
    </summary>
    
      <category term="生活 | Life" scheme="https://wsgzao.github.io/categories/%E7%94%9F%E6%B4%BB-Life/"/>
    
    
  </entry>
  
  <entry>
    <title>使用 ssh config 作为 ssh 代理轻松管理内网服务器</title>
    <link href="https://wsgzao.github.io/post/ssh-config/"/>
    <id>https://wsgzao.github.io/post/ssh-config/</id>
    <published>2019-01-31T03:18:44.000Z</published>
    <updated>2019-03-12T08:46:33.576Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>企业内部大部分服务器都只有内网，一般可以使用 NAT 方式正向代理访问公网资源。对于 Linux 来说一般通过 ssh 登录服务器，在没有公网 IP 的情况下可以修改 ssh config 配置文件，利用一台可以接入内网并具有公网 IP 的服务器作为代理或者称为 Tunnel 跳板机来管理，可以灵活定制访问规则并优化 ssh 参数让管理更加轻松。</p><blockquote><p>使用 ssh config 作为 ssh 代理轻松管理内网服务器</p></blockquote><hr><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 01 月 31 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/ssh-config/">https://wsgzao.github.io/post/ssh-config/</a></p><p><strong> 扩展阅读 </strong></p><p>SSH CONFIG FILE -  <a href="https://www.ssh.com/ssh/config/" target="_blank" rel="noopener">https://www.ssh.com/ssh/config/</a></p><hr><h2 id="ssh-config-的配置文件来源"><a href="#ssh-config-的配置文件来源" class="headerlink" title="ssh_config 的配置文件来源"></a>ssh_config 的配置文件来源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">man ssh_config</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">     ssh_config -- OpenSSH SSH client configuration files</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">     ssh(1) obtains configuration data from the following sources <span class="keyword">in</span> the following order:</span><br><span class="line"></span><br><span class="line">           1.   <span class="built_in">command</span>-line options</span><br><span class="line">           2.   user<span class="string">'s configuration file (~/.ssh/config)</span></span><br><span class="line"><span class="string">           3.   system-wide configuration file (/etc/ssh/ssh_config)</span></span><br></pre></td></tr></table></figure><p>ssh 程序可以从三个途径获取配置参数：</p><ol><li>命令行选型，比如 -F configfile</li><li>用户配置文件，放置在 ~/.ssh/config</li><li>系统配置文件，放置在 /etc/ssh/ssh_config（区别于 /etc/ssh/sshd_config）</li></ol><p>上面三个途径，前面的途径传入的参数可以覆盖后面的途径传入的参数（与 linux 里的大部分应用类似）。因为 / etc/ssh/ssh_config 会影响 ssh 全局的配置，因此如果想对多主机进行管理（不影响别人的情况下），可以考虑修改自己家目录下的~/.ssh/config 文件（~ 字符表示当前登录用户的家目录）。</p><h2 id="ssh-config-配置文件实例"><a href="#ssh-config-配置文件实例" class="headerlink" title="ssh_config 配置文件实例"></a>ssh_config 配置文件实例</h2><p>首先看一个配置文件的 demo，假设 8.8.8.8 是你可以直接登录的 Tunnel 公网跳板机，10.65.32.0 是需要管理的内网地址段，前提是 8.8.8.8 和内网服务器的防火墙策略均已配置正确，这里就不再赘述。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat ~/.ssh/config</span></span><br><span class="line"></span><br><span class="line">StrictHostKeyChecking no</span><br><span class="line">CheckHostIP no</span><br><span class="line"></span><br><span class="line">Host 10.65.32.*</span><br><span class="line">  HostName %h</span><br><span class="line">  ProxyCommand ssh bastion_GOP_SG_NC_MAIN -W %h:%p</span><br><span class="line">Host bastion_GOP_SG_NC_MAIN</span><br><span class="line">  HostName 8.8.8.8</span><br><span class="line">  port 22</span><br><span class="line">  User wangao</span><br><span class="line"></span><br><span class="line">Host 10.65.200.*</span><br><span class="line">  HostName %h</span><br><span class="line">  ProxyCommand ssh bastion_GOP_SG_MH_MAIN -W %h:%p</span><br><span class="line">Host bastion_GOP_SG_MH_MAIN</span><br><span class="line">  HostName 9.9.9.9</span><br><span class="line">  port 22</span><br><span class="line">  User wangao</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">StrictHostKeyChecking no</span><br><span class="line">CheckHostIP no</span><br><span class="line"></span><br><span class="line">Host 10.71.12.*</span><br><span class="line">  HostName %h</span><br><span class="line">  ProxyCommand ssh bastion_GOP_SG_NC_MAIN -W %h:%p</span><br><span class="line"></span><br><span class="line">Host 10.71.13.*</span><br><span class="line">  HostName %h</span><br><span class="line">  ProxyCommand ssh bastion_GOP_SG_NC_MAIN -W %h:%p</span><br><span class="line"></span><br><span class="line">Host 10.71.14.*</span><br><span class="line">  HostName %h</span><br><span class="line">  ProxyCommand ssh bastion_GOP_SG_NC_MAIN -W %h:%p</span><br><span class="line"></span><br><span class="line">Host 10.71.15.*</span><br><span class="line">  HostName %h</span><br><span class="line">  ProxyCommand ssh bastion_GOP_SG_NC_MAIN -W %h:%p</span><br><span class="line"></span><br><span class="line">Host bastion_GOP_SG_NC_MAIN</span><br><span class="line">  HostName 8.8.8.8</span><br><span class="line">  port 22</span><br><span class="line">  User wangao</span><br></pre></td></tr></table></figure><p>CheckHostIP no，禁用 known_hosts 检查<br>Directs ssh to additionally check the host IP address in the known_hosts file.</p><p>StrictHostKeyChecking no，跳过 known_hosts 写入<br>Specifies if ssh should never automatically add host keys to the ~/.ssh/known_hosts file, and refuses to connect to hosts whose host key has changed.</p><p>Host 字段<br>Host 字段配置了登录别名，这里需要注意的是，Host 是支持通配符的， * 代表 0～n 个非空白字符，? 代表一个非空白字符，! 表示例外通配</p><p>HostName 字段<br>指定远程主机名，可以直接使用 IP 地址。如果这个字段中包含 ‘%h’ ，则实际使用时会被命令行中的主机名替换</p><p>User 字段<br>指定登录用户名</p><p>IdentityFile 字段<br>指定密钥认证使用的私钥文件路径。默认为 ~/.ssh/id_rsa。这个字段可以指定多个密钥文件（以 , 分开），在连接的过程中会依次尝试这些密钥文件。和 HostName 字段一样，值也可以直接指定参数代替：</p><p>Port 字段<br>指定远程主机端口号，默认为 22 。</p><p>%h，远程主机名<br>%p，远程端口</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><blockquote><p>如果你还不了解 ssh 或者对 ssh 端口转发感兴趣，可以参考以下内容</p></blockquote><p>SSH 使用密钥登录并禁止口令登录实践 - <a href="https://wsgzao.github.io/post/ssh/">https://wsgzao.github.io/post/ssh/</a></p><p>玩转 SSH 端口转发 - <a href="https://blog.fundebug.com/2017/04/24/ssh-port-forwarding/" target="_blank" rel="noopener">https://blog.fundebug.com/2017/04/24/ssh-port-forwarding/</a></p>]]></content>
    
    <summary type="html">
    
      使用ssh config作为ssh代理轻松管理内网服务器
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>SSH 使用密钥登录并禁止口令登录实践</title>
    <link href="https://wsgzao.github.io/post/ssh/"/>
    <id>https://wsgzao.github.io/post/ssh/</id>
    <published>2019-01-31T02:18:44.000Z</published>
    <updated>2019-02-01T03:32:50.192Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://i.v2ex.co/zv9SM4PO.png" alt=""></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>无论是个人的 VPS 还是企业允许公网访问的服务器，如果开放 22 端口的 SSH 密码登录验证方式，被众多黑客暴力猜解捅破菊花也可能是经常发生的惨剧。企业可以通过防火墙来做限制，普通用户也可能借助修改 22 端口和强化弱口令等方式防护，但目前相对安全和简单的方案则是让 SSH 使用密钥登录并禁止口令登录。</p><blockquote><p>ssh 密钥登录是相对安全的登录管理方式</p></blockquote><hr><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 01 月 31 日 - 更新 ssh 基础知识讲解和 ansible authorized_key 示例<br>2015 年 08 月 13 日 - 增加 Bash Shell 自动修改脚本<br>2015 年 07 月 07 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/ssh/">https://wsgzao.github.io/post/ssh/</a></p><p><strong> 扩展阅读 </strong></p><p>SSH 原理与运用 -  <a href="http://www.ruanyifeng.com/blog/2011/12/ssh_remote_login.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2011/12/ssh_remote_login.html</a><br>Linode - <a href="https://www.linode.com/docs/networking/ssh/use-public-key-authentication-with-ssh" target="_blank" rel="noopener">https://www.linode.com/docs/networking/ssh/use-public-key-authentication-with-ssh</a></p><hr><h2 id="ssh-登录服务器的两种方式"><a href="#ssh-登录服务器的两种方式" class="headerlink" title="ssh 登录服务器的两种方式"></a>ssh 登录服务器的两种方式</h2><p>如果是一个比较喜欢折腾的人，在某个云平台购买了一台云主机，除了通过云平台提供的 web 页面上的命令行工具，其实也可以在本地电脑上面通过 ssh 进行登录。具体地又可以分成两种：</p><ol><li>ssh 用户名密码登录</li><li>ssh 证书（免密码）登录</li></ol><p>需要说明一下，后者的安全性高于前者，因此一般会默认不启用第一种登录方式，只允许第二种登录方式。</p><p>SSH 为 Secure Shell 的缩写，是建立在应用层基础上的安全协议，利用 SSH 协议可以有效防止远程管理过程中的信息泄露问题。ssh 分成服务端与客户端，其中服务端运行在被登录的机器上面，客户端运行在操作的机器上面。</p><h3 id="用户名密码登录"><a href="#用户名密码登录" class="headerlink" title="用户名密码登录"></a>用户名密码登录</h3><p>通常 openssh-server 默认允许用户名密码登录，但是不排除为了安全考虑云上的服务器上禁止开启 ssh 的这种登录方式，毕竟用户名加密码的方式很容易被爆力破解。如果大家理解其中的厉害关系，可以检查修改 /etc/ssh/sshd_config（sshd 的配置文件）中 PasswordAuthentication 这一项配置为 yes（一般默认是 yes ）。修改完配置重启 sshd 服务就可以使用用户名和密码登录了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -l 指定用户名为 wangao</span></span><br><span class="line"><span class="comment"># -p 指定端口为 2222，默认为 22</span></span><br><span class="line"><span class="comment"># 输入下面的命令后根据提示输入密码就可以登录到对应的服务器了 </span></span><br><span class="line">ssh -l wangao -p 2222 192.168.56.101</span><br></pre></td></tr></table></figure><h3 id="ssh-免密登录"><a href="#ssh-免密登录" class="headerlink" title="ssh 免密登录"></a>ssh 免密登录</h3><p>所谓免密登录，也就是说不需要人工再输入用户名和密码了，但这并不意味着没有了鉴权的动作，服务器毕竟是自己的，不能随便允许别人登录到上面去搞破坏。ssh 免密登录通过证书进行鉴权。</p><p>这里的证书分为公钥与私钥，我们可以简单地理解为：公钥 = 锁；私钥 = 钥匙。</p><p>流程基本是这样的：如果我们想要从 A 免密登录到 B，就需要把公钥（锁）放到 B 的特定位置，而 A 拥有私钥（钥匙）的完整副本。当 A 拿着私钥去访问 B 的时候，B 发现自己身上有一把锁（B 可能有很多公钥）可以被 A 的私钥打开，于是给 A 放行，A 就成功登录到 B 了。</p><blockquote><p>如何得到证书（公钥与私钥）<br>上面提到的证书可以通过两种方式获取得到。<br>第一种是向服务器管理员索取，一般索取得到的是私钥，这样就可以免密登录到任何存放了公钥的服务器了。<br>第二种是自己生成证书（比如使用 ssh-keygen），然后把公钥放到对应的服务器的特定位置，就可以免密登录到对应的服务器了。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过 ssh-keygen 可以生成需要的证书 </span></span><br><span class="line"><span class="comment"># 根据提示一路按 RETURN(ENTER) 即可 </span></span><br><span class="line"><span class="comment"># 默认情况下会生成 id_rsa 和 id_rsa.pub </span></span><br><span class="line"><span class="comment"># id_rsa 为私钥，id_rsa.pub 为公钥 </span></span><br><span class="line">ssh-keygen</span><br></pre></td></tr></table></figure><blockquote><p>公钥放置位置</p></blockquote><p>linux 系统允许多用户登录同一台服务器，一般情况下 /home 目录会有非常多的用户目录。可以把公钥放置在任何一个用户目录的 $HOME/.ssh/authorized_keys 文件中，比如 cat id_rsa.pub &gt;&gt; /home/wangao/.ssh/authorized_keys ，这样就可以使用私钥以 wangao 的名义登录对应的服务器了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -i 指定私钥，默认条件下使用 ~/.ssh/id_rsa</span></span><br><span class="line"><span class="comment"># -l 指定用户名 </span></span><br><span class="line"><span class="comment"># -p 指定端口，默认为 22</span></span><br><span class="line">ssh -i ~/.ssh/id_rsa -p 2222 -l wangao 192.168.56.101</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面的命令等同于 </span></span><br><span class="line">ssh -p 2222 wangao@192.168.56.101</span><br></pre></td></tr></table></figure><h2 id="ssh-免密码登录一般流程"><a href="#ssh-免密码登录一般流程" class="headerlink" title="ssh 免密码登录一般流程"></a>ssh 免密码登录一般流程</h2><h3 id="生成-PublicKey"><a href="#生成-PublicKey" class="headerlink" title="生成 PublicKey"></a>生成 PublicKey</h3><blockquote><p>建议设置并牢记 passphrase 密码短语，以 Linux 生成为例</p></blockquote><p>Linux：ssh-keygen -t rsa<br>[私钥 (id_rsa) 与公钥 (id_rsa.pub)]<br>Windows：SecurCRT/Xshell/PuTTY<br>[SSH-2 RSA 2048]</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 生成 SSH 密钥对 </span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line"></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line"><span class="comment"># 建议直接回车使用默认路径 </span></span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa): </span><br><span class="line"><span class="comment"># 输入密码短语（留空则直接回车）</span></span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line"><span class="comment"># 重复密码短语 </span></span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">aa:8b:61:13:38:ad:b5:49:ca:51:45:b9:77:e1:97:e1 root@localhost.localdomain</span><br><span class="line">The key<span class="string">'s randomart image is:</span></span><br><span class="line"><span class="string">+--[ RSA 2048]----+</span></span><br><span class="line"><span class="string">|    .o.          |</span></span><br><span class="line"><span class="string">|    ..   . .     |</span></span><br><span class="line"><span class="string">|   .  . . o o    |</span></span><br><span class="line"><span class="string">| o.  . . o E     |</span></span><br><span class="line"><span class="string">|o.=   . S .      |</span></span><br><span class="line"><span class="string">|.*.+   .         |</span></span><br><span class="line"><span class="string">|o.*   .          |</span></span><br><span class="line"><span class="string">| . + .           |</span></span><br><span class="line"><span class="string">|  . o.           |</span></span><br><span class="line"><span class="string">+-----------------+</span></span><br></pre></td></tr></table></figure><h3 id="复制密钥对"><a href="#复制密钥对" class="headerlink" title="复制密钥对"></a>复制密钥对</h3><blockquote><p>也可以手动在客户端建立目录和 authorized_keys，注意修改权限</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 复制公钥到无密码登录的服务器上, 22 端口改变可以使用下面的命令 </span></span><br><span class="line"><span class="comment">#ssh-copy-id -i ~/.ssh/id_rsa.pub "-p 10022 user@server"</span></span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.15.241</span><br></pre></td></tr></table></figure><h3 id="修改-SSH-配置文件"><a href="#修改-SSH-配置文件" class="headerlink" title="修改 SSH 配置文件"></a>修改 SSH 配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑 sshd_config 文件 </span></span><br><span class="line">vi /etc/ssh/sshd_config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用密码验证 </span></span><br><span class="line">PasswordAuthentication no</span><br><span class="line"><span class="comment"># 启用密钥验证 </span></span><br><span class="line">RSAAuthentication yes</span><br><span class="line">PubkeyAuthentication yes</span><br><span class="line"><span class="comment"># 指定公钥数据库文件 </span></span><br><span class="line">AuthorsizedKeysFile .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">"s/^PasswordAuthentication.*/PasswordAuthentication no/g"</span> /etc/ssh/sshd_config</span><br><span class="line">sed -i <span class="string">"s/^#RSAAuthentication.*/RSAAuthentication yes/g"</span> /etc/ssh/sshd_config</span><br><span class="line">sed -i <span class="string">"s/^#PubkeyAuthentication.*/PubkeyAuthentication yes/g"</span> /etc/ssh/sshd_config</span><br><span class="line">sed -i <span class="string">"s/^#AuthorizedKeysFile.*/AuthorizedKeysFile .ssh\/authorized_keys/g"</span> /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><blockquote><p>重启 SSH 服务前建议多保留一个会话以防不测</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RHEL/CentOS 系统 </span></span><br><span class="line">service sshd restart</span><br><span class="line"><span class="comment"># Ubuntu 系统 </span></span><br><span class="line">service ssh restart</span><br><span class="line"><span class="comment"># Debian 系统 </span></span><br><span class="line">/etc/init.d/ssh restart</span><br></pre></td></tr></table></figure><h3 id="手动增加管理用户"><a href="#手动增加管理用户" class="headerlink" title="手动增加管理用户"></a>手动增加管理用户</h3><blockquote><p>可以在 == 后加入用户注释标识方便管理</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'ssh-rsa XXXX'</span> &gt;&gt;/root/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复查 </span></span><br><span class="line">cat /root/.ssh/authorized_keys</span><br></pre></td></tr></table></figure><h2 id="使用-Ansible-添加-ssh-信任关系"><a href="#使用-Ansible-添加-ssh-信任关系" class="headerlink" title="使用 Ansible 添加 ssh 信任关系"></a>使用 Ansible 添加 ssh 信任关系</h2><blockquote><p>使用 ansible authorized_key module 即可</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  gather_facts: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: authadd root</span><br><span class="line">      authorized_key:</span><br><span class="line">        user: root</span><br><span class="line">        state: present</span><br><span class="line">        key: <span class="string">"&#123;&#123; lookup('file','/root/.ssh/id_rsa.pub') &#125;&#125;"</span></span><br><span class="line">        path: /root/.ssh/authorized_keys</span><br><span class="line">        manage_dir: no</span><br><span class="line">      tags:</span><br><span class="line">        - root</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      ssh密钥登录是相对安全的登录管理方式
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
</feed>
