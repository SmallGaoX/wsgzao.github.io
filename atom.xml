<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>HelloDog</title>
  
  <subtitle>Keep Calm and Carry On</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://wsgzao.github.io/"/>
  <updated>2019-01-21T12:10:21.330Z</updated>
  <id>https://wsgzao.github.io/</id>
  
  <author>
    <name>wsgzao</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>泰国普吉岛和甲米的旅游经历分享</title>
    <link href="https://wsgzao.github.io/post/thailand/"/>
    <id>https://wsgzao.github.io/post/thailand/</id>
    <published>2019-01-20T06:59:49.000Z</published>
    <updated>2019-01-21T12:10:21.330Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>2017 年和 2018 年末分别去了泰国的普吉岛和甲米旅游，说实话泰国普吉岛的蜜月旅行也是我的第一次出国经历，当然没想到的是一年后我已经从上海飞到了新加坡，如果你对新加坡的工作和生活感兴趣可以搜索《从国内跳槽至新加坡工作的经验分享》。这篇文章算是对泰国之旅的补交作业吧，大部分以文字描述为主不做剧透，不吹不黑列举和点评自己购买的第三方服务体验感受，想去泰国旅游的朋友可以参考下。</p><blockquote><p>泰国普吉岛和甲米的旅游经历分享</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 01 月 20 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/thailand/">https://wsgzao.github.io/post/thailand/</a></p><p><strong> 扩展阅读 </strong></p><p>泰国国家旅游局 - <a href="http://amazingthailand.org.cn/" target="_blank" rel="noopener">http://amazingthailand.org.cn/</a></p><hr><h2 id="普吉岛-Phuket"><a href="#普吉岛-Phuket" class="headerlink" title="普吉岛. Phuket"></a>普吉岛. Phuket</h2><p>时间: 20171206-20171212<br>行程: 自由行<br>签证: 普通旅游签，爱游蜜月套餐<br>通信: Happy 卡，爱游蜜月套餐<br>人数: 2<br>天数: 7 天 5 晚<br>机票: 上海至泰国普吉岛直飞往返，吉祥航空，爱游蜜月套餐<br>酒店: 卡里玛水疗度假村 3 晚 + 卡塔塔尼海滩度假村 2 晚，爱游蜜月套餐</p><p>提前预定项目: 价格为 1 人单价</p><ul><li>爱游泰国旅游普吉岛自由行 7 天 5 星蜜月春节机票飞猪，￥8699.00</li><li>浦发龙腾出行礼宾车机场接送机</li><li>浪花朵朵旅行 普吉岛王权免税店一日游骑大象自助餐泰国 KingPower，￥9.79</li><li>浪花朵朵旅行泰国普吉岛素可 Sukko Spa 90 分钟蜜月套餐 泰式按摩，￥492.37</li><li>浪花朵朵旅行普吉岛一日游大小皇帝岛浮潜海钓泰国旅游女神号游艇，￥592.23</li><li>浪花朵朵旅行普吉岛绿洲 SPA 水疗馆 The Oasis Spa 泰国绿洲 泰式按摩，￥463.69</li></ul><p>当地购买项目: 行程比较紧凑，去了班赞海鲜市场也没有购买欲望</p><p>小结:</p><ol><li>首次出国就是蜜月旅行，在选择地点时也受到《欢乐颂》安迪最后选择去普吉岛，出于稳妥的考虑选择了半自由行 + 当地游的方式，缺点自然是花钱买省心。如果你往下看第二次去甲米的行程基本就是自由行 + 当地游，费用大幅减少而时间成本其实也没有增加很多</li><li>这次普吉岛只安排 1 天出海行程，我没有选择斯米兰因为不考虑深潜。结合下面甲米 2 次出海经历，我这里推荐大家尽可能选择靠谱的精致小团，在长时间坐游艇和游玩项目过程中体验会提升不少</li><li>普吉岛的整体商业化程度高体现在吃喝玩乐各个方面，而普吉岛 SPA 的 2 次体验都非常棒，尤其是最后一天绿洲 SPA 是目前我所接触过最舒服的一次双人 SPA，连洗澡都贴心的配置了 2 个花洒，安静且私密性极好，价格也没有很贵，非常值得二刷</li><li>虽然酒店是爱游搭配的，但是我现在可以理解 7 天行程住 2 种不同酒店的意义，高中搭配会带来新鲜的感受，成本上也会节约不少，就是中间牺牲更换酒店的时间有一点折腾</li><li>普吉岛的项目由于安排的有些紧凑导致没有太多睡到自然醒的休闲时间，毕竟出国一次也不容易想着到处多转转长长见识。如果条件允许推荐大家采用自由行 + 当地游的组合，出发前签证等重要材料一定要准备充分，不要辜负自己宝贵的假期哈</li></ol><h2 id="甲米-Krabi"><a href="#甲米-Krabi" class="headerlink" title="甲米. Krabi"></a>甲米. Krabi</h2><p>时间: 20181204-20181209<br>行程: 自由行<br>签证: 落地签，免费<br>通信: 华为天际通<br>人数: 2<br>天数: 6 天 5 晚<br>机票: 酷航 TR686 新加坡 - 甲米, TR689 甲米 - 新加坡, ￥1192.00, 飞猪<br>酒店: Sugar Marina CLIFFHANGER 池景高级房, ￥1992.25, 飞猪</p><p>提前预定项目: 价格为 1 人单价</p><ul><li>浪花朵朵旅行泰国甲米接送机接机送机机场接送服务中文可急单，￥245.69</li><li>浪花朵朵 甲米翡翠池一日游温泉瀑布虎窟寺 ATV 皮划艇骑大象半日游，￥340.92</li><li>浪花朵朵泰国曼谷 lets relax spa 普吉岛清迈芭提雅甲米泰式按摩，￥299.52</li><li>浪花朵朵旅行 甲米一日游皮皮岛 pp 岛竹子岛四岛兰塔岛 快艇浮潜，￥329.57</li><li>浪花朵朵 洛克岛一日游兰塔 Rok 哈岛 游艇浮潜水 泰国甲米旅游中文，￥494.35</li></ul><p>当地购买项目: 记不清楚价格，仅列举自己推荐的店</p><ul><li>奥南按摩角中心</li><li>Jungle Kitchen</li><li>Ton Ma Yom Thai Food Restaurant</li><li>Kodam Kitchen</li></ul><p>小结:</p><ol><li>如果我可以重新选择会去掉翡翠池，lets relax spa，2 天的出海。翡翠池和九寨沟相比就是小巫见大巫，关于出海我不喜欢深潜，所以浮潜的效果会差好多，而且非常容易晒伤皮肤，需要很早出发然后长时间航行，对于不喜欢坐船的小伙伴来说是挺难受的。</li><li>体验过奥南按摩角中心基本就不会再考虑其它按摩馆了，技师年龄加手法都很成熟，整过过程没有过多的闲聊和休息，做足了时长。</li><li>由于时间和路程原因没有体验甲米镇的夜市，奥南夜市很一般，还是推荐大家多体验我上面写的 3 家餐厅，对食物如果没有忌口可以从热门推荐菜开始尝试。</li><li>落地签需要稍微多花一些填表时间，不过我们没有被要求重新现场拍照，省去了 2000 泰铢签证费用还是很划算的。</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>2 次泰国旅游经历可以为将来更远的旅行打下扎实的基础</p></blockquote><ol><li>通过 2 次的泰国旅行，深潜和浮潜游可能都不是我的菜，美食和 SPA 的体验都非常棒</li><li>除了机票和酒店，推荐提前预定接送机，出海和 SPA 等项目，虽然一定比当地预定贵一丢丢，但节约了时间成本，辅助你规划行程，不过千万不要把行程安排的过于紧凑哈</li><li>旅行攻略除了国内的美团点评和小红书等以外，推荐 TripAdvisor，俗称猫头鹰</li><li>东南亚移动支付越来越普及，真的可以期待未来走出国门也无需带钱包那一刻到来</li><li>无论选择去哪里旅游切记人身安全才是第一位的，祝大家旅途愉快哈</li></ol>]]></content>
    
    <summary type="html">
    
      泰国普吉岛和甲米的旅游经历分享
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>CPU 优化建议使用 cpupower 设置 CPU Performance 模式</title>
    <link href="https://wsgzao.github.io/post/cpupower/"/>
    <id>https://wsgzao.github.io/post/cpupower/</id>
    <published>2019-01-18T06:59:49.000Z</published>
    <updated>2019-01-21T11:22:07.404Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>CPU 动态节能技术用于降低服务器功耗，通过选择系统空闲状态不同的电源管理策 略，可以实现不同程度降低服务器功耗，更低的功耗策略意味着 CPU 唤醒更慢对性能 影响更大。对于对时延和性能要求高的应用，建议关闭 CPU 的动态调节功能，禁止 CPU 休眠，并把 CPU 频率固定到最高。通常建议在服务器 BIOS 中修改电源管理为 Performance，如果发现 CPU 模式为 conservative 或者 powersave，可以使用 cpupower 设置 CPU Performance 模式，效果也是相当显著的。</p><blockquote><p>CPU 优化建议使用 cpupower 设置 CPU Performance 模式</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 01 月 18 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/cpupower/">https://wsgzao.github.io/post/cpupower/</a></p><p><strong> 扩展阅读 </strong></p><p>CPU frequency scaling - <a href="https://wiki.archlinux.org/index.php/CPU_frequency_scaling" target="_blank" rel="noopener">https://wiki.archlinux.org/index.php/CPU_frequency_scaling</a></p><hr><h2 id="cpufreq-的五种模式"><a href="#cpufreq-的五种模式" class="headerlink" title="cpufreq 的五种模式"></a>cpufreq 的五种模式</h2><p>cpufreq 是一个动态调整 cpu 频率的模块，系统启动时生成一个文件夹 / sys/devices/system/cpu/cpu0/cpufreq/，里面有几个文件，其中 scaling_min_freq 代表最低频率，scaling_max_freq 代表最高频率，scalin_governor 代表 cpu 频率调整模式，用它来控制 CPU 频率。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /sys/devices/system/cpu/cpu0/cpufreq/</span><br><span class="line"></span><br><span class="line">affected_cpus</span><br><span class="line">bios_limit</span><br><span class="line">cpuinfo_cur_freq</span><br><span class="line">cpuinfo_max_freq</span><br><span class="line">cpuinfo_min_freq</span><br><span class="line">cpuinfo_transition_latency</span><br><span class="line">freqdomain_cpus</span><br><span class="line">related_cpus</span><br><span class="line">scaling_available_frequencies</span><br><span class="line">scaling_available_governors</span><br><span class="line">scaling_cur_freq</span><br><span class="line">scaling_driver</span><br><span class="line">scaling_governor</span><br><span class="line">scaling_max_freq</span><br><span class="line">scaling_min_freq</span><br><span class="line">scaling_setspeed</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前的调节器</span></span><br><span class="line">cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor</span><br><span class="line">conservative</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看频率信息</span></span><br><span class="line">cpupower frequency-info</span><br><span class="line"></span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: acpi-cpufreq</span><br><span class="line">  CPUs <span class="built_in">which</span> run at the same hardware frequency: 0</span><br><span class="line">  CPUs <span class="built_in">which</span> need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency: 10.0 us</span><br><span class="line">  hardware limits: 800 MHz - 2.10 GHz</span><br><span class="line">  available frequency steps:  2.10 GHz, 2.10 GHz, 2.00 GHz, 1.90 GHz, 1.80 GHz, 1.70 GHz, 1.60 GHz, 1.50 GHz, 1.40 GHz, 1.30 GHz, 1.20 GHz, 1.10 GHz, 1000 MHz, 900 MHz, 800 MHz</span><br><span class="line">  available cpufreq governors: conservative userspace powersave ondemand performance</span><br><span class="line">  current policy: frequency should be within 800 MHz and 2.10 GHz.</span><br><span class="line">                  The governor <span class="string">"performance"</span> may decide <span class="built_in">which</span> speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: Unable to call hardware</span><br><span class="line">  current CPU frequency: 2.10 GHz (asserted by call to kernel)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: yes</span><br><span class="line">    Active: yes</span><br></pre></td></tr></table></figure><ol><li>performance: 顾名思义只注重效率，将 CPU 频率固定工作在其支持的最高运行频率上，而不动态调节。</li><li>Userspace: 最早的 cpufreq 子系统通过 userspace governor 为用户提供了这种灵活性。系统将变频策略的决策权交给了用户态应用程序，并提供了相应的接口供用户态应用程序调节 CPU 运行频率使用。也就是长期以来都在用的那个模式。可以通过手动编辑配置文件进行配置</li><li>powersave: 将 CPU 频率设置为最低的所谓 “省电” 模式，CPU 会固定工作在其支持的最低运行频率上。因此这两种 governors 都属于静态 governor，即在使用它们时 CPU 的运行频率不会根据系统运行时负载的变化动态作出调整。这两种 governors 对应的是两种极端的应用场景，使用 performance governor 是对系统高性能的最大追求，而使用 powersave governor 则是对系统低功耗的最大追求。</li><li>ondemand: 按需快速动态调整 CPU 频率， 一有 cpu 计算量的任务，就会立即达到最大频率运行，等执行完毕就立即回到最低频率；ondemand：userspace 是内核态的检测，用户态调整，效率低。而 ondemand 正是人们长期以来希望看到的一个完全在内核态下工作并且能够以更加细粒度的时间间隔对系统负载情况进行采样分析的 governor。 在 ondemand governor 监测到系统负载超过 up_threshold 所设定的百分比时，说明用户当前需要 CPU 提供更强大的处理能力，因此 ondemand governor 会将 CPU 设置在最高频率上运行。但是当 ondemand governor 监测到系统负载下降，可以降低 CPU 的运行频率时，到底应该降低到哪个频率呢？ ondemand governor 的最初实现是在可选的频率范围内调低至下一个可用频率，例如 CPU 支持三个可选频率，分别为 1.67GHz、1.33GHz 和 1GHz ，如果 CPU 运行在 1.67GHz 时 ondemand governor 发现可以降低运行频率，那么 1.33GHz 将被选作降频的目标频率。</li><li>conservative: 与 ondemand 不同，平滑地调整 CPU 频率，频率的升降是渐变式的, 会自动在频率上下限调整，和 ondemand 的区别在于它会按需分配频率，而不是一味追求最高频率；</li></ol><h2 id="cpupower-设置-performance"><a href="#cpupower-设置-performance" class="headerlink" title="cpupower 设置 performance"></a>cpupower 设置 performance</h2><blockquote><p>从 conservative 或者 powersave 切换到 performance 的效果还是杠杠的</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CentOS 安装 kernel-tools</span></span><br><span class="line">yum install kernel-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ubuntu 安装 CPU 模式无图形化切换器</span></span><br><span class="line">apt install cpufrequtils</span><br><span class="line"></span><br><span class="line"><span class="comment"># cpupower 设置 performance</span></span><br><span class="line">cpupower frequency-set -g performance</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前的调节器</span></span><br><span class="line">cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor</span><br><span class="line">performance</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建自启动服务</span></span><br><span class="line">cat &lt;&lt; EOF | sudo tee /etc/systemd/system/cpupower.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=CPU powersave</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">ExecStart=/usr/bin/cpupower -c all frequency-set -g powersave</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> cpupower.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># systemd.service — Service unit configuration</span></span><br><span class="line">https://www.freedesktop.org/software/systemd/man/systemd.service.html</span><br></pre></td></tr></table></figure><p><img src="https://wx3.sinaimg.cn/large/7207510dgy1fzat998mmvj21dc0ggdqx.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      CPU优化建议使用cpupower设置CPU Performance模式
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>使用 rpmbuild 制作 Nginx 的 RPM 包</title>
    <link href="https://wsgzao.github.io/post/rpmbuild/"/>
    <id>https://wsgzao.github.io/post/rpmbuild/</id>
    <published>2019-01-16T06:59:49.000Z</published>
    <updated>2019-01-18T08:26:01.679Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://wx2.sinaimg.cn/large/7207510dgy1fz8ebc174fj20o40i9dnd.jpg" alt=""></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>题图为 RPM 包制作原理图，有时候为了方便源码包的安装，和我们自己订制软件包的需求，我们会把一些源码包按照我们的需求来做成 rpm 包，当有了源码包就可以直接编译得到二进制安装包和其他任意包。spec file 是制作 rpm 包最核心的部分，rpm 包的制作就是根据 spec file 来实现的。在制作自定义 rpm 包的时候最好不要使用管理员进行, 因为管理员权限过大，如果一个命令写错了，结果可能是灾难性的，而制件一个 rpm 包普通用户完全可以实现。本文主要介绍使用 rpmbuild 制作 Nginx 的 RPM 包，大部分步骤已经使用 Bash Shell 自动化完成了，大家可以基于此重新定义。</p><blockquote><p>使用 rpmbuild 制作 Nginx 的 RPM 包</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 01 月 16 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/rpmbuild/">https://wsgzao.github.io/post/rpmbuild/</a></p><p><strong> 扩展阅读 </strong></p><p>Creating RPM packages - <a href="https://docs.fedoraproject.org/en-US/quick-docs/creating-rpm-packages/index.html" target="_blank" rel="noopener">https://docs.fedoraproject.org/en-US/quick-docs/creating-rpm-packages/index.html</a><br>How to create a GNU Hello RPM - <a href="https://fedoraproject.org/wiki/How_to_create_a_GNU_Hello_RPM_package/zh-cn" target="_blank" rel="noopener">https://fedoraproject.org/wiki/How_to_create_a_GNU_Hello_RPM_package/zh-cn</a><br>使用 rpm-build 制作 nginx 的 rpm 包 - <a href="http://blog.51cto.com/nmshuishui/1583117" target="_blank" rel="noopener">http://blog.51cto.com/nmshuishui/1583117</a></p><hr><h2 id="什么是-RPM"><a href="#什么是-RPM" class="headerlink" title="什么是 RPM"></a>什么是 RPM</h2><p>An RPM package is simply a file containing other files and information about them needed by the system. Specifically, an RPM package consists of the cpio archive, which contains the files, and the RPM header, which contains metadata about the package. The rpm package manager uses this metadata to determine dependencies, where to install files, and other information.</p><p>There are two types of RPM packages:</p><ul><li>source RPM (SRPM)</li><li>binary RPM</li></ul><p>SRPMs and binary RPMs share the file format and tooling, but have different contents and serve different purposes. An SRPM contains source code, optionally patches to it, and a SPEC file, which describes how to build the source code into a binary RPM. A binary RPM contains the binaries built from the sources and patches.</p><p>RPM 有五种基本的操作功能：安装、卸载、升级、查询和验证。</p><p>Linux 软件包分为两大类：</p><ol><li>二进制类包，包括 rpm 安装包（一般分为 i386 和 x86 等几种）</li><li>源码类包，源码包和开发包应该归位此类（.src.rpm）</li></ol><p>在 Redhat 下，rpm 包的默认制作路径在 /usr/src/redhat 下，这其中包含了 6 个目录（要求全部大写）。但 Centos 并没有该目录，因此我们不得不自定义工作车间，即使在 Redhat 下有该目录，一般也是自定义到普通用户的家目录下的</p><table><thead><tr><th>Directory</th><th>Usage</th></tr></thead><tbody><tr><td>BUILD</td><td>源代码解压以后放的位置，只需提供 BUILD 目录，具体里面放什么，不用我们管，所以真正的制作车间是 BUILD 目录</td></tr><tr><td>RPMS</td><td>制作完成后的 rpm 包存放目录，为特定平台指定子目录（i386,i686,ppc）</td></tr><tr><td>SOURCES</td><td>收集的源文件，源材料，补丁文件等存放位置    </td></tr><tr><td>SPECS</td><td>存放 spec 文件，作为制作 rpm 包的领岗文件，以 rpm 名. spec</td></tr><tr><td>SRPMS</td><td>src 格式的 rpm 包位置 ，既然是 src 格式的包，就没有平台的概念了           </td></tr><tr><td>BuiltRoot</td><td>假根，使用 install 临时安装到这个目录，把这个目录当作根来用的，所以在这个目录下的目录文件，才是真正的目录文件。当打包完成后，在清理阶段，这个目录将被删除</td></tr></tbody></table><p>更详细的介绍可以参考 <code>RPM Packaging Guide</code></p><p><a href="https://rpm-packaging-guide.github.io/" target="_blank" rel="noopener">https://rpm-packaging-guide.github.io/</a></p><h2 id="制作-rpm-包"><a href="#制作-rpm-包" class="headerlink" title="制作 rpm 包"></a>制作 rpm 包</h2><blockquote><p>如果你只关心如何使用可以直接跳过看下文，这里主要展示代码和配置文件</p></blockquote><h3 id="build-shell"><a href="#build-shell" class="headerlink" title="build shell"></a>build shell</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># luajit.sh</span></span><br><span class="line">LUAVER=2.0.5</span><br><span class="line">WKDIR=<span class="string">"/root/rpmbuild/SOURCES"</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line">wget http://luajit.org/download/LuaJIT-<span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line">tar zxf LuaJIT-<span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line">rm LuaJIT-<span class="variable">$LUAVER</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> LuaJIT-<span class="variable">$LUAVER</span></span><br><span class="line">make BUILDMODE=static</span><br><span class="line">make install</span><br><span class="line"><span class="built_in">export</span> LUAJIT_LIB=/usr/<span class="built_in">local</span>/lib</span><br><span class="line"><span class="built_in">export</span> LUAJIT_INC=/usr/<span class="built_in">local</span>/include/luajit-2.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># build.sh</span></span><br><span class="line">NGX_VER=1.14.1</span><br><span class="line">WKDIR=<span class="string">"/root/rpmbuild/SOURCES"</span></span><br><span class="line">CURRENTDIR=`dirname $(readlink -f <span class="string">"<span class="variable">$0</span>"</span>)`</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$CURRENTDIR</span></span><br><span class="line"><span class="built_in">export</span> LUAJIT_LIB=/usr/<span class="built_in">local</span>/lib</span><br><span class="line"><span class="built_in">export</span> LUAJIT_INC=/usr/<span class="built_in">local</span>/include/luajit-2.0</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line">wget http://nginx.org/download/nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line">tar xzf nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line">rm nginx-<span class="variable">$NGX_VER</span>.tar.gz</span><br><span class="line">mv nginx-<span class="variable">$NGX_VER</span> nginx-garena-<span class="variable">$NGX_VER</span></span><br><span class="line"><span class="built_in">cd</span> nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line"></span><br><span class="line">mkdir -p contrib</span><br><span class="line"><span class="built_in">cd</span> contrib/</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/bigplum/Nginx-limit-traffic-rate-module.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/agentzh/headers-more-nginx-module.git</span><br><span class="line"><span class="comment">#git clone git://github.com/gnosek/nginx-upstream-fair.git</span></span><br><span class="line">git <span class="built_in">clone</span> git://github.com/agentzh/<span class="built_in">echo</span>-nginx-module.git</span><br><span class="line"><span class="comment">#git clone git://github.com/arut/nginx-dav-ext-module.git</span></span><br><span class="line">git <span class="built_in">clone</span> git://github.com/r10r/ngx_http_auth_pam_module.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/FRiCKLE/ngx_cache_purge.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/simpl/ngx_devel_kit.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/openresty/lua-nginx-module.git</span><br><span class="line">git <span class="built_in">clone</span> git://github.com/nbs-system/naxsi.git</span><br><span class="line">rm -rf */.git</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"></span><br><span class="line">cp -r <span class="variable">$CURRENTDIR</span>/nginx-template/* <span class="variable">$WKDIR</span>/nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line">cp <span class="variable">$CURRENTDIR</span>/nginx-spec /root/rpmbuild/SPECS/</span><br><span class="line"><span class="comment">#cp /root/rules $WKDIR/nginx-garena-$NGX_VER/debian/</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$WKDIR</span></span><br><span class="line">tar zcf nginx-garena-<span class="variable">$NGX_VER</span>.tar.gz nginx-garena-<span class="variable">$NGX_VER</span>/</span><br><span class="line"><span class="built_in">cd</span> /root/rpmbuild/SPECS/</span><br><span class="line">rpmbuild -ba nginx-spec</span><br><span class="line"><span class="built_in">cd</span> /root/rpmbuild/RPMS/noarch</span><br></pre></td></tr></table></figure><h3 id="nginx-spec"><a href="#nginx-spec" class="headerlink" title="nginx-spec"></a>nginx-spec</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.The introduction section </span></span><br><span class="line">Name: nginx-garena                                      <span class="comment"># 软件包名称 </span></span><br><span class="line">Version: 1.14.1                                         <span class="comment"># 版本号 </span></span><br><span class="line">Release: 0                                              <span class="comment"># release 号 </span></span><br><span class="line">Summary: nginx garena rpm                               <span class="comment"># 简要描述信息 </span></span><br><span class="line">Source0: nginx-garena-1.14.1.tar.gz                     <span class="comment"># source 主要是引用一下自己定义好的脚本，配置文件之类的内容 </span></span><br><span class="line">License: GPL                                            <span class="comment"># 一定带上（最好是对方源码包的 License）BSD，GPL，GPLv2</span></span><br><span class="line">Group: Rahul                                            <span class="comment"># 要全用这里面的一个组：less /usr/share/doc/rpm-version/GROUPS</span></span><br><span class="line">BuildArch: noarch               </span><br><span class="line">BuildRoot: %&#123;_tmppath&#125;/%&#123;name&#125;-buildroot                </span><br><span class="line">%description                                            <span class="comment"># 软件包详述 </span></span><br><span class="line">Garena self-build Nginx.</span><br><span class="line">%define _binaries_in_noarch_packages_terminate_build   0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.The Prep section 准备阶段, 主要就是把源码包解压到 build 目录下，设置一下环境变量，并 cd 进去 </span></span><br><span class="line">%prep</span><br><span class="line">%setup -q %&#123;name&#125;-%&#123;version&#125;                            <span class="comment"># 这个宏的作用静默模式解压并 cd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.The Build Section 编译制作阶段，这一节主要用于编译源码 </span></span><br><span class="line">%build</span><br><span class="line">CFLAGS=<span class="string">"<span class="variable">$RPM_OPT_FLAGS</span>"</span> ./configure --prefix=/usr/share/nginx/ \</span><br><span class="line">                    --sbin-path=/usr/sbin/nginx \</span><br><span class="line">                    --conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">                    --error-log-path=/var/<span class="built_in">log</span>/nginx/error.log \</span><br><span class="line">                    --http-log-path=/var/<span class="built_in">log</span>/nginx/access.log \</span><br><span class="line">                    --pid-path=/var/run/nginx.pid \</span><br><span class="line">                    --lock-path=/var/lock/nginx.lock \</span><br><span class="line">                    --http-client-body-temp-path=/var/lib/nginx/body \</span><br><span class="line">                    --http-fastcgi-temp-path=/var/lib/nginx/fastcgi \</span><br><span class="line">                    --http-proxy-temp-path=/var/lib/nginx/proxy \</span><br><span class="line">                    --http-scgi-temp-path=/var/lib/nginx/scgi \</span><br><span class="line">                    --http-uwsgi-temp-path=/var/lib/nginx/uwsgi \</span><br><span class="line">                    --with-pcre-jit \</span><br><span class="line">                    --with-http_flv_module \</span><br><span class="line">                    --with-http_mp4_module \</span><br><span class="line">                    --with-file-aio \</span><br><span class="line">    --with-http_v2_module \</span><br><span class="line">    --with-stream \</span><br><span class="line">    --with-stream_ssl_module \</span><br><span class="line">                    --with-http_auth_request_module \</span><br><span class="line">    --with-http_slice_module \</span><br><span class="line">    --with-threads \</span><br><span class="line">                    --with-http_gunzip_module \</span><br><span class="line">    --with-http_random_index_module \</span><br><span class="line">    --with-http_secure_link_module \</span><br><span class="line">                    --with-http_geoip_module \</span><br><span class="line">                    --with-http_ssl_module \</span><br><span class="line">                    --with-openssl=/usr/<span class="built_in">local</span>/src/openssl-1.0.2p \</span><br><span class="line">                    --with-http_addition_module \</span><br><span class="line">                    --with-http_geoip_module \</span><br><span class="line">                    --with-http_gzip_static_module \</span><br><span class="line">                    --with-http_realip_module \</span><br><span class="line">                    --with-ipv6 \</span><br><span class="line">                    --without-mail_pop3_module \</span><br><span class="line">                    --without-mail_imap_module \</span><br><span class="line">                    --without-mail_smtp_module \</span><br><span class="line">                    --add-module=contrib/Nginx-limit-traffic-rate-module \</span><br><span class="line">                    --add-module=contrib/headers-more-nginx-module \</span><br><span class="line">                    --add-module=contrib/<span class="built_in">echo</span>-nginx-module \</span><br><span class="line">                    --add-module=contrib/ngx_http_auth_pam_module \</span><br><span class="line">                    --add-module=contrib/ngx_cache_purge \</span><br><span class="line">                    --add-module=contrib/ngx_devel_kit \</span><br><span class="line">                    --add-module=contrib/lua-nginx-module \</span><br><span class="line">                    --add-module=contrib/naxsi/naxsi_src</span><br><span class="line">make -j8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.Install section  这一节主要用于完成实际安装软件必须执行的命令，可包含 4 种类型脚本 </span></span><br><span class="line">%install</span><br><span class="line">[ <span class="string">"<span class="variable">$RPM_BUILD_ROOT</span>"</span> != <span class="string">"/"</span> ] &amp;&amp; rm -rf <span class="variable">$RPM_BUILD_ROOT</span></span><br><span class="line">make DESTDIR=<span class="variable">$RPM_BUILD_ROOT</span> install</span><br><span class="line">install -m 0755 -d <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/sites-enabled</span><br><span class="line">install -m 0755 -d <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/sites-available</span><br><span class="line">install -m 0755 -d <span class="variable">$RPM_BUILD_ROOT</span>/var/<span class="built_in">log</span>/nginx</span><br><span class="line">install -m 0755 -d <span class="variable">$RPM_BUILD_ROOT</span>/var/lib/nginx</span><br><span class="line">install -D -m 644 conf/sites-available/000_stub_status <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/sites-available/000_stub_status</span><br><span class="line">install -D -m 644 conf/django_fastcgi_params <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/django_fastcgi_params</span><br><span class="line">install -D -m 644 conf/naxsi_core.rules <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/naxsi_core.rules</span><br><span class="line">install -D -m 644 conf/sites-available/000_stub_status <span class="variable">$RPM_BUILD_ROOT</span>/etc/nginx/sites-enabled/000_stub_status</span><br><span class="line">install -D -m 644 logrotate.d/nginx <span class="variable">$RPM_BUILD_ROOT</span>/etc/logrotate.d/nginx</span><br><span class="line">install -D -m 644 nginx.service <span class="variable">$RPM_BUILD_ROOT</span>/usr/lib/systemd/system/nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.clean section 清理段，clean 的主要作用就是删除 BUILD</span></span><br><span class="line">%clean</span><br><span class="line">[ <span class="string">"<span class="variable">$RPM_BUILD_ROOT</span>"</span> != <span class="string">"/"</span> ] &amp;&amp; rm -rf <span class="variable">$RPM_BUILD_ROOT</span></span><br><span class="line">%post</span><br><span class="line">useradd -s /sbin/nologin -d /var/www www-data</span><br><span class="line">chown -R www-data.www-data /var/<span class="built_in">log</span>/nginx /var/lib/nginx</span><br><span class="line">systemctl <span class="built_in">enable</span> nginx</span><br><span class="line"><span class="built_in">echo</span> %&#123;name&#125;-%&#123;version&#125; is successfully installed.</span><br><span class="line">systemctl start nginx</span><br><span class="line"><span class="comment"># 6.file section 文件列表段，这个阶段是把前面已经编译好的内容要打包了 </span></span><br><span class="line">%files</span><br><span class="line">%defattr(-,root,root)</span><br><span class="line">%dir /etc/nginx</span><br><span class="line">/etc/nginx/*</span><br><span class="line">%dir /usr/src/debug/nginx-garena-1.14.1</span><br><span class="line">/usr/src/debug/nginx-garena-1.14.1/*</span><br><span class="line">/usr/sbin/nginx</span><br><span class="line">%dir /usr/share/nginx</span><br><span class="line">/usr/share/nginx/*</span><br><span class="line">/etc/logrotate.d/nginx</span><br><span class="line">/usr/lib/systemd/system/nginx.service</span><br><span class="line">/usr/lib/debug/*</span><br><span class="line">/usr/lib/debug/.build-id/*</span><br><span class="line">%dir /var/<span class="built_in">log</span>/nginx</span><br><span class="line">%dir /var/lib/nginx</span><br><span class="line">%config(noreplace) /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure><h3 id="nginx-template"><a href="#nginx-template" class="headerlink" title="nginx-template"></a>nginx-template</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line">nginx-template</span><br><span class="line">    ├── conf</span><br><span class="line">    │   ├── django_fastcgi_params</span><br><span class="line">    │   ├── naxsi_core.rules</span><br><span class="line">    │   └── sites-available</span><br><span class="line">    │       └── 000_stub_status</span><br><span class="line">    ├── logrotate.d</span><br><span class="line">    │   └── nginx</span><br><span class="line">    ├── nginx.conf</span><br><span class="line">    └── nginx.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/conf/django_fastcgi_params</span></span><br><span class="line">fastcgi_param  QUERY_STRING       <span class="variable">$query_string</span>;</span><br><span class="line">fastcgi_param  REQUEST_METHOD     <span class="variable">$request_method</span>;</span><br><span class="line">fastcgi_param  CONTENT_TYPE       <span class="variable">$content_type</span>;</span><br><span class="line">fastcgi_param  CONTENT_LENGTH     <span class="variable">$content_length</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_param  PATH_INFO          <span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">fastcgi_param  REQUEST_URI        <span class="variable">$request_uri</span>;</span><br><span class="line">fastcgi_param  DOCUMENT_URI       <span class="variable">$document_uri</span>;</span><br><span class="line">fastcgi_param  DOCUMENT_ROOT      <span class="variable">$document_root</span>;</span><br><span class="line">fastcgi_param  SERVER_PROTOCOL    <span class="variable">$server_protocol</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;</span><br><span class="line">fastcgi_param  SERVER_SOFTWARE    nginx/<span class="variable">$nginx_version</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_param  REMOTE_ADDR        <span class="variable">$remote_addr</span>;</span><br><span class="line">fastcgi_param  REMOTE_PORT        <span class="variable">$remote_port</span>;</span><br><span class="line">fastcgi_param  SERVER_ADDR        <span class="variable">$server_addr</span>;</span><br><span class="line">fastcgi_param  SERVER_PORT        <span class="variable">$server_port</span>;</span><br><span class="line">fastcgi_param  SERVER_NAME        <span class="variable">$server_name</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_param  HTTP_X_FORWARDED_PROTOCOL        <span class="variable">$scheme</span>;</span><br><span class="line"></span><br><span class="line">fastcgi_pass_header Authorization;</span><br><span class="line">fastcgi_intercept_errors off;</span><br><span class="line">fastcgi_keep_conn on;</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/conf/naxsi_core.rules</span></span><br><span class="line"><span class="comment">##################################</span></span><br><span class="line"><span class="comment">## INTERNAL RULES IDS:1-999     ##</span></span><br><span class="line"><span class="comment">##################################</span></span><br><span class="line"><span class="comment">#@MainRule "msg:weird request, unable to parse" id:1;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:request too big, stored on disk and not parsed" id:2;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:invalid hex encoding, null bytes" id:10;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:unknown content-type" id:11;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:invalid formatted url" id:12;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:invalid POST format" id:13;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:invalid POST boundary" id:14;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:invalid JSON" id:15;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:empty POST" id:16;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:libinjection_sql" id:17;</span></span><br><span class="line"><span class="comment">#@MainRule "msg:libinjection_xss" id:18;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##################################</span></span><br><span class="line"><span class="comment">## SQL Injections IDs:1000-1099 ##</span></span><br><span class="line"><span class="comment">##################################</span></span><br><span class="line">MainRule <span class="string">"rx:select|union|update|delete|insert|table|from|ascii|hex|unhex|drop"</span> <span class="string">"msg:sql keywords"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4"</span> id:1000;</span><br><span class="line">MainRule <span class="string">"str:\""</span> <span class="string">"msg:double quote"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:8,<span class="variable">$XSS</span>:8"</span> id:1001;</span><br><span class="line">MainRule <span class="string">"str:0x"</span> <span class="string">"msg:0x, possible hex encoding"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:2"</span> id:1002;</span><br><span class="line"><span class="comment">## Hardcore rules</span></span><br><span class="line">MainRule <span class="string">"str:/*"</span> <span class="string">"msg:mysql comment (/*)"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:8"</span> id:1003;</span><br><span class="line">MainRule <span class="string">"str:*/"</span> <span class="string">"msg:mysql comment (*/)"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:8"</span> id:1004;</span><br><span class="line">MainRule <span class="string">"str:|"</span> <span class="string">"msg:mysql keyword (|)"</span>  <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:8"</span> id:1005;</span><br><span class="line">MainRule <span class="string">"str:&amp;&amp;"</span> <span class="string">"msg:mysql keyword (&amp;&amp;)"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:8"</span> id:1006;</span><br><span class="line"><span class="comment">## end of hardcore rules</span></span><br><span class="line">MainRule <span class="string">"str:--"</span> <span class="string">"msg:mysql comment (--)"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4"</span> id:1007;</span><br><span class="line">MainRule <span class="string">"str:;"</span> <span class="string">"msg:semicolon"</span> <span class="string">"mz:BODY|URL|ARGS"</span> <span class="string">"s:<span class="variable">$SQL</span>:4,<span class="variable">$XSS</span>:8"</span> id:1008;</span><br><span class="line">MainRule <span class="string">"str:="</span> <span class="string">"msg:equal sign in var, probable sql/xss"</span> <span class="string">"mz:ARGS|BODY"</span> <span class="string">"s:<span class="variable">$SQL</span>:2"</span> id:1009;</span><br><span class="line">MainRule <span class="string">"str:("</span> <span class="string">"msg:open parenthesis, probable sql/xss"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4,<span class="variable">$XSS</span>:8"</span> id:1010;</span><br><span class="line">MainRule <span class="string">"str:)"</span> <span class="string">"msg:close parenthesis, probable sql/xss"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4,<span class="variable">$XSS</span>:8"</span> id:1011;</span><br><span class="line">MainRule <span class="string">"str:'"</span> <span class="string">"msg:simple quote"</span> <span class="string">"mz:ARGS|BODY|URL|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4,<span class="variable">$XSS</span>:8"</span> id:1013;</span><br><span class="line">MainRule <span class="string">"str:,"</span> <span class="string">"msg:comma"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4"</span> id:1015;</span><br><span class="line">MainRule <span class="string">"str:#"</span> <span class="string">"msg:mysql comment (#)"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4"</span> id:1016;</span><br><span class="line">MainRule <span class="string">"str:@@"</span> <span class="string">"msg:double arobase (@@)"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$SQL</span>:4"</span> id:1017;</span><br><span class="line"></span><br><span class="line"><span class="comment">###############################</span></span><br><span class="line"><span class="comment">## OBVIOUS RFI IDs:1100-1199 ##</span></span><br><span class="line"><span class="comment">###############################</span></span><br><span class="line">MainRule <span class="string">"str:http://"</span> <span class="string">"msg:http:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1100;</span><br><span class="line">MainRule <span class="string">"str:https://"</span> <span class="string">"msg:https:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1101;</span><br><span class="line">MainRule <span class="string">"str:ftp://"</span> <span class="string">"msg:ftp:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1102;</span><br><span class="line">MainRule <span class="string">"str:php://"</span> <span class="string">"msg:php:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1103;</span><br><span class="line">MainRule <span class="string">"str:sftp://"</span> <span class="string">"msg:sftp:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1104;</span><br><span class="line">MainRule <span class="string">"str:zlib://"</span> <span class="string">"msg:zlib:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1105;</span><br><span class="line">MainRule <span class="string">"str:data://"</span> <span class="string">"msg:data:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1106;</span><br><span class="line">MainRule <span class="string">"str:glob://"</span> <span class="string">"msg:glob:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1107;</span><br><span class="line">MainRule <span class="string">"str:phar://"</span> <span class="string">"msg:phar:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1108;</span><br><span class="line">MainRule <span class="string">"str:file://"</span> <span class="string">"msg:file:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1109;</span><br><span class="line">MainRule <span class="string">"str:gopher://"</span> <span class="string">"msg:gopher:// scheme"</span> <span class="string">"mz:ARGS|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$RFI</span>:8"</span> id:1110;</span><br><span class="line"></span><br><span class="line"><span class="comment">#######################################</span></span><br><span class="line"><span class="comment">## Directory traversal IDs:1200-1299 ##</span></span><br><span class="line"><span class="comment">#######################################</span></span><br><span class="line">MainRule <span class="string">"str:.."</span> <span class="string">"msg:double dot"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$TRAVERSAL</span>:4"</span> id:1200;</span><br><span class="line">MainRule <span class="string">"str:/etc/passwd"</span> <span class="string">"msg:obvious probe"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$TRAVERSAL</span>:4"</span> id:1202;</span><br><span class="line">MainRule <span class="string">"str:c:\\"</span> <span class="string">"msg:obvious windows path"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$TRAVERSAL</span>:4"</span> id:1203;</span><br><span class="line">MainRule <span class="string">"str:cmd.exe"</span> <span class="string">"msg:obvious probe"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$TRAVERSAL</span>:4"</span> id:1204;</span><br><span class="line">MainRule <span class="string">"str:\\"</span> <span class="string">"msg:backslash"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$TRAVERSAL</span>:4"</span> id:1205;</span><br><span class="line"><span class="comment">#MainRule "str:/" "msg:slash in args" "mz:ARGS|BODY|$HEADERS_VAR:Cookie" "s:$TRAVERSAL:2" id:1206;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">########################################</span></span><br><span class="line"><span class="comment">## Cross Site Scripting IDs:1300-1399 ##</span></span><br><span class="line"><span class="comment">########################################</span></span><br><span class="line">MainRule <span class="string">"str:&lt;"</span> <span class="string">"msg:html open tag"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$XSS</span>:8"</span> id:1302;</span><br><span class="line">MainRule <span class="string">"str:&gt;"</span> <span class="string">"msg:html close tag"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$XSS</span>:8"</span> id:1303;</span><br><span class="line">MainRule <span class="string">"str:["</span> <span class="string">"msg:open square backet ([), possible js"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$XSS</span>:4"</span> id:1310;</span><br><span class="line">MainRule <span class="string">"str:]"</span> <span class="string">"msg:close square bracket (]), possible js"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$XSS</span>:4"</span> id:1311;</span><br><span class="line">MainRule <span class="string">"str:~"</span> <span class="string">"msg:tilde (~) character"</span> <span class="string">"mz:BODY|URL|ARGS|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$XSS</span>:4"</span> id:1312;</span><br><span class="line">MainRule <span class="string">"str:`"</span>  <span class="string">"msg:grave accent (`)"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$XSS</span>:8"</span> id:1314;</span><br><span class="line">MainRule <span class="string">"rx:%[2|3]."</span>  <span class="string">"msg:double encoding"</span> <span class="string">"mz:ARGS|URL|BODY|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$XSS</span>:8"</span> id:1315;</span><br><span class="line"></span><br><span class="line"><span class="comment">####################################</span></span><br><span class="line"><span class="comment">## Evading tricks IDs: 1400-1500 ##</span></span><br><span class="line"><span class="comment">####################################</span></span><br><span class="line">MainRule <span class="string">"str:&amp;#"</span> <span class="string">"msg:utf7/8 encoding"</span> <span class="string">"mz:ARGS|BODY|URL|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$EVADE</span>:4"</span> id:1400;</span><br><span class="line">MainRule <span class="string">"str:%U"</span> <span class="string">"msg:M$ encoding"</span> <span class="string">"mz:ARGS|BODY|URL|<span class="variable">$HEADERS_VAR</span>:Cookie"</span> <span class="string">"s:<span class="variable">$EVADE</span>:4"</span> id:1401;</span><br><span class="line"></span><br><span class="line"><span class="comment">#############################</span></span><br><span class="line"><span class="comment">## File uploads: 1500-1600 ##</span></span><br><span class="line"><span class="comment">#############################</span></span><br><span class="line">MainRule <span class="string">"rx:\.ph|\.asp|\.ht"</span> <span class="string">"msg:asp/php file upload"</span> <span class="string">"mz:FILE_EXT"</span> <span class="string">"s:<span class="variable">$UPLOAD</span>:8"</span> id:1500;</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/logrotate.d/nginx</span></span><br><span class="line">/var/<span class="built_in">log</span>/nginx/*.<span class="built_in">log</span> /var/<span class="built_in">log</span>/nginx/*/*.<span class="built_in">log</span>&#123;</span><br><span class="line">daily</span><br><span class="line">missingok</span><br><span class="line">rotate 14</span><br><span class="line">compress</span><br><span class="line">delaycompress</span><br><span class="line">notifempty</span><br><span class="line">create 640 root adm</span><br><span class="line">sharedscripts</span><br><span class="line">postrotate</span><br><span class="line">[ ! -f /var/run/nginx.pid ] || <span class="built_in">kill</span> -USR1 `cat /var/run/nginx.pid`</span><br><span class="line">endscript</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/nginx.conf</span></span><br><span class="line">user www-data;</span><br><span class="line">worker_processes auto;</span><br><span class="line"></span><br><span class="line"><span class="comment">#worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000 10000000;</span></span><br><span class="line">worker_rlimit_nofile 655650;</span><br><span class="line"></span><br><span class="line">error_log  /var/<span class="built_in">log</span>/nginx/error.log;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">        worker_connections  10240;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"><span class="comment">#       include       /etc/nginx/naxsi_core.rules;</span></span><br><span class="line">        include       mime.types;</span><br><span class="line">        default_type  application/octet-stream;</span><br><span class="line">log_format garena <span class="string">'$remote_addr - $remote_user [$time_iso8601]"$request"$status $body_bytes_sent'</span></span><br><span class="line">                <span class="string">'"$http_referer" "$http_user_agent" $request_time $upstream_response_time "$http_x_forwarded_for" "$geoip_country_code" "$host"'</span>;</span><br><span class="line">        log_format garena_post <span class="string">'$remote_addr - $remote_user [$time_iso8601]"$request"$status $body_bytes_sent'</span></span><br><span class="line">                <span class="string">'"$http_referer" "$http_user_agent" $request_time $upstream_response_time "$http_x_forwarded_for" "$geoip_country_code" "$host" "$request_body"'</span>;</span><br><span class="line">log_format compact <span class="string">'$time_iso8601|$remote_addr|$geoip_country_code|$http_x_forwarded_for|$status|$request_time|$upstream_response_time|$request_length|$body_bytes_sent|$host|$request|$http_referer|$http_user_agent'</span>;</span><br><span class="line">log_format compact_post <span class="string">'$time_iso8601|$remote_addr|$geoip_country_code|$http_x_forwarded_for|$status|$request_time|$upstream_response_time|$request_length|$body_bytes_sent|$host|$request|$http_referer|$http_user_agent|$request_body'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#       access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">        sendfile        on;</span><br><span class="line"><span class="comment">#       tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">        keepalive_timeout  30;</span><br><span class="line">        fastcgi_keep_conn on;</span><br><span class="line">        tcp_nodelay        on;</span><br><span class="line"></span><br><span class="line">        gzip  on;</span><br><span class="line">        gzip_disable <span class="string">"MSIE [1-6]\.(?!.*SV1)"</span>;</span><br><span class="line">        gzip_proxied any;</span><br><span class="line">        gzip_buffers 16 8k;</span><br><span class="line">        gzip_types    text/plain application/javascript application/x-javascript text/javascript text/xml text/css application/json;</span><br><span class="line">        gzip_vary on;</span><br><span class="line">        include /etc/nginx/sites-enabled/*;</span><br><span class="line"></span><br><span class="line">set_real_ip_from 10.0.0.0/8;</span><br><span class="line">real_ip_header    X-Forwarded-For;</span><br><span class="line"><span class="comment">#real_ip_recursive on;</span></span><br><span class="line"><span class="comment">#geoip_country /usr/share/GeoIP/GeoIP.dat;</span></span><br><span class="line"></span><br><span class="line">        server_tokens off;         <span class="comment"># returns "Server: nginx"</span></span><br><span class="line">more_clear_headers Server; <span class="comment"># doesn't return"Server: "header at all</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx-rpmbuild-centos7/nginx-template/nginx.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=The nginx HTTP and reverse proxy server</span><br><span class="line">After=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/run/nginx.pid</span><br><span class="line">ExecStartPre=/usr/sbin/nginx -t</span><br><span class="line">ExecStart=/usr/sbin/nginx</span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">KillMode=process</span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">TimeoutStopSec=5</span><br><span class="line">PrivateTmp=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><h2 id="Initialize-rpmbuild-env"><a href="#Initialize-rpmbuild-env" class="headerlink" title="Initialize rpmbuild env"></a>Initialize rpmbuild env</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check current os version and kernel</span></span><br><span class="line">cat /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.5.1804 (Core)</span><br><span class="line">uname -r</span><br><span class="line">3.10.0-862.el7.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># install lua</span></span><br><span class="line">sh luajit.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># yum install dependencies</span></span><br><span class="line">yum install -y gcc pam-devel git rpm-build pcre-devel openssl openssl-devel geoip-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir</span></span><br><span class="line">mkdir -p /root/rpmbuild/SOURCES/</span><br><span class="line">mkdir -p /root/rpmbuild/SPECS/</span><br><span class="line">mkdir -p /root/rpmbuild/RPMS/noarch</span><br><span class="line"></span><br><span class="line"><span class="comment"># download openssl</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line">wget https://github.com/openssl/openssl/archive/OpenSSL_1_0_2p.tar.gz</span><br><span class="line">tar xf OpenSSL_1_0_2p.tar.gz</span><br><span class="line">mv openssl-OpenSSL_1_0_2p/ openssl-1.0.2p</span><br><span class="line"></span><br><span class="line"><span class="comment"># confirm these files are correct</span></span><br><span class="line">[root@localhost ~]<span class="comment"># tree nginx-rpmbuild-centos7/</span></span><br><span class="line">nginx-rpmbuild-centos7/</span><br><span class="line">├── build.sh</span><br><span class="line">├── conf_buid</span><br><span class="line">│   ├── conf</span><br><span class="line">│   │   ├── django_fastcgi_params</span><br><span class="line">│   │   ├── fastcgi.conf</span><br><span class="line">│   │   ├── fastcgi_params</span><br><span class="line">│   │   ├── koi-utf</span><br><span class="line">│   │   ├── koi-win</span><br><span class="line">│   │   ├── mime.types</span><br><span class="line">│   │   ├── naxsi_core.rules</span><br><span class="line">│   │   ├── nginx.conf</span><br><span class="line">│   │   ├── scgi_params</span><br><span class="line">│   │   ├── sites-available</span><br><span class="line">│   │   │   └── 000_stub_status</span><br><span class="line">│   │   ├── uwsgi_params</span><br><span class="line">│   │   └── win-utf</span><br><span class="line">│   ├── logrotate.d</span><br><span class="line">│   │   └── nginx</span><br><span class="line">│   ├── nginx.conf</span><br><span class="line">│   └── nginx.service</span><br><span class="line">├── luajit.sh</span><br><span class="line">├── nginx-spec</span><br><span class="line">└── nginx-template</span><br><span class="line">    ├── conf</span><br><span class="line">    │   ├── django_fastcgi_params</span><br><span class="line">    │   ├── naxsi_core.rules</span><br><span class="line">    │   └── sites-available</span><br><span class="line">    │       └── 000_stub_status</span><br><span class="line">    ├── logrotate.d</span><br><span class="line">    │   └── nginx</span><br><span class="line">    ├── nginx.conf</span><br><span class="line">    └── nginx.service</span><br><span class="line"></span><br><span class="line">8 directories, 24 files</span><br></pre></td></tr></table></figure><h2 id="How-to-build-Nginx-RPM"><a href="#How-to-build-Nginx-RPM" class="headerlink" title="How to build Nginx RPM"></a>How to build Nginx RPM</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check nginx stable version from official website</span></span><br><span class="line">http://nginx.org/en/download.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># check configuration</span></span><br><span class="line">vim build.sh</span><br><span class="line"></span><br><span class="line">NGX_VER=1.14.1</span><br><span class="line">WKDIR=<span class="string">"/root/rpmbuild/SOURCES"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check nginx version</span></span><br><span class="line">vim nginx-spec</span><br><span class="line"></span><br><span class="line">replace 1.14.1 to 1.14.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># run build.sh</span></span><br><span class="line">./build.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># RPM package</span></span><br><span class="line">Processing files: nginx-garena-1.14.2-0.noarch</span><br><span class="line">warning: File listed twice: /etc/nginx/nginx.conf</span><br><span class="line">Provides: config(nginx-garena) = 1.14.2-0 nginx-garena = 1.14.2-0</span><br><span class="line">Requires(interp): /bin/sh</span><br><span class="line">Requires(rpmlib): rpmlib(CompressedFileNames) &lt;= 3.0.4-1 rpmlib(FileDigests) &lt;= 4.6.0-1 rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1</span><br><span class="line">Requires(post): /bin/sh</span><br><span class="line">Requires: libGeoIP.so.1()(64bit) libc.so.6()(64bit) libc.so.6(GLIBC_2.10)(64bit) libc.so.6(GLIBC_2.11)(64bit) libc.so.6(GLIBC_2.14)(64bit) libc.so.6(GLIBC_2.17)(64bit) libc.so.6(GLIBC_2.2.5)(64bit) libc.so.6(GLIBC_2.3)(64bit) libc.so.6(GLIBC_2.3.2)(64bit) libc.so.6(GLIBC_2.3.4)(64bit) libc.so.6(GLIBC_2.4)(64bit) libc.so.6(GLIBC_2.7)(64bit) libcrypt.so.1()(64bit) libcrypt.so.1(GLIBC_2.2.5)(64bit) libdl.so.2()(64bit) libdl.so.2(GLIBC_2.2.5)(64bit) libgcc_s.so.1()(64bit) libgcc_s.so.1(GCC_3.0)(64bit) libgcc_s.so.1(GCC_3.3)(64bit) libm.so.6()(64bit) libm.so.6(GLIBC_2.2.5)(64bit) libpam.so.0()(64bit) libpam.so.0(LIBPAM_1.0)(64bit) libpcre.so.1()(64bit) libpthread.so.0()(64bit) libpthread.so.0(GLIBC_2.2.5)(64bit) libpthread.so.0(GLIBC_2.3.2)(64bit) libz.so.1()(64bit) rtld(GNU_HASH)</span><br><span class="line">warning: Arch dependent binaries <span class="keyword">in</span> noarch package</span><br><span class="line">Checking <span class="keyword">for</span> unpackaged file(s): /usr/lib/rpm/check-files /root/rpmbuild/BUILDROOT/nginx-garena-1.14.2-0.x86_64</span><br><span class="line">Wrote: /root/rpmbuild/SRPMS/nginx-garena-1.14.2-0.src.rpm</span><br><span class="line">Wrote: /root/rpmbuild/RPMS/noarch/nginx-garena-1.14.2-0.noarch.rpm</span><br><span class="line">Executing(%clean): /bin/sh -e /var/tmp/rpm-tmp.iR5dLd</span><br><span class="line">+ <span class="built_in">umask</span> 022</span><br><span class="line">+ <span class="built_in">cd</span> /root/rpmbuild/BUILD</span><br><span class="line">+ <span class="built_in">cd</span> nginx-garena-1.14.2</span><br><span class="line">+ <span class="string">'['</span> /root/rpmbuild/BUILDROOT/nginx-garena-1.14.2-0.x86_64 <span class="string">'!='</span> / <span class="string">']'</span></span><br><span class="line">+ rm -rf /root/rpmbuild/BUILDROOT/nginx-garena-1.14.2-0.x86_64</span><br><span class="line">+ <span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      使用rpmbuild制作Nginx的RPM包
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>使用 Exhibitor 监控管理 ZooKeeper</title>
    <link href="https://wsgzao.github.io/post/exhibitor/"/>
    <id>https://wsgzao.github.io/post/exhibitor/</id>
    <published>2019-01-07T06:59:49.000Z</published>
    <updated>2019-01-08T03:54:40.055Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Exhibitor 是 Netflix 开源的一个用于 ZooKeeper 配置监控和管理的系统。现在 Netflix Exhibitor 已经成为社区开源公共维护项目 Soabase Exhibitor。Exhibitor 是 ZooKeeper 实例监控，备份，恢复，清理和可视化工具，是 ZooKeeper 的监控管理系统。</p><blockquote><p>使用 Exhibitor 监控管理 ZooKeeper</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2019 年 01 月 07 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/exhibitor/">https://wsgzao.github.io/post/exhibitor/</a></p><p><strong> 扩展阅读 </strong></p><p>exhibitor - <a href="https://github.com/soabase/exhibitor" target="_blank" rel="noopener">https://github.com/soabase/exhibitor</a></p><hr><h2 id="exhibitor-简介"><a href="#exhibitor-简介" class="headerlink" title="exhibitor 简介"></a>exhibitor 简介</h2><p>ZooKeeper co-process for instance monitoring, backup/recovery, cleanup and visualization.</p><p>Exhibitor is a Java supervisor system for ZooKeeper. It provides a number of features:</p><ul><li>Watches a ZK instance and makes sure it is running</li><li>Performs periodic backups</li><li>Perform periodic cleaning of ZK log directory</li><li>A GUI explorer for viewing ZK nodes</li><li>A rich REST API</li></ul><p><a href="https://github.com/soabase/exhibitor/wiki" target="_blank" rel="noopener">https://github.com/soabase/exhibitor/wiki</a></p><h2 id="exhibitor-特性"><a href="#exhibitor-特性" class="headerlink" title="exhibitor 特性"></a>exhibitor 特性</h2><blockquote><p>Exhibitor 主要包括以下特性 / 功能：</p></blockquote><p>实例监控</p><p>Exhibitor 实例监控在同一服务器上运行的 ZooKeeper 服务器。如果 ZK 没有运行，Exhibitor 会写入 zoo.cfg 文件（请参阅下面的 ZK 集群配置）并启动它。如果 ZooKeeper 由于某种原因崩溃，Exhibitor 也会重新启动它。</p><p>日志清理</p><p>在 ZooKeeper 3.4.x 之前的版本中，日志文件需要维护，Exhibitor 会负责定期维护。</p><p>备份 / 还原</p><p>ZooKeeper 集群中的备份比传统数据存储（例如 RDBMS）更复杂。一般来说，ZooKeeper 中的大部分数据是短暂的。盲目恢复整个 ZooKeeper 数据集可能会造成更大危害，因此，需要选择性的恢复以防止对数据集的子集造成意外损坏。Exhibitor 提供了这一功能。</p><p>Exhibitor 会定期备份 ZooKeeper 的事务文件，备份后，就可以对这些事务文件建立索引。</p><p>集群配置</p><p>Exhibitor 为整个 Zookeeper 集群提供了一个独立的控制台，通过它所做的配置更改会对整个集群有效。以下是一些共享配置值：</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>ZooKeeper Install DirPath</td><td>to the ZooKeeper server installation</td></tr><tr><td>ZooKeeper Data Dir</td><td>Path where ZooKeeper should store its data</td></tr><tr><td>Log Index Dir</td><td>Path where indexed transaction logs should be kept</td></tr><tr><td>Servers</td><td>List of servers/server-ids in the ensemble</td></tr><tr><td>Additional Config</td><td>Additional fields/values to store in zoo.cfg</td></tr></tbody></table><p>集群滚动升级</p><p>Exhibitor 可以以滚动方式更新集群中的服务器，以便在进行更改时让 ZooKeeper 集群确保 Quorum 设定的最低服务能力。</p><p>自动实例管理</p><p>Exhibitor 可以配置为自动向集群中添加新实例，并删除陈旧的实例。这使得 ZooKeeper 集群可以实现 “无接触交钥匙管理”。</p><p>可视化</p><p>Exhibitor 为 ZooKeeper 提供了 ZNode 层次结构的图形树视图。</p><p>ZK 数据维护</p><p>启用后，维护人员可以在 ZooKeeper 的存储层次结构中创建 / 更新 / 删除节点。</p><p>死锁检测</p><p>当使用 Curator 的锁方案（或类似）时，Exhibitor 可以分析一组表示锁的 ZNode，并确定是否存在潜在的死锁。</p><p>Curator 集成</p><p>Exhibitor 和 Curator 可以集成工作，当集群中的信息变更时，Curator 实例可以同步更新。</p><p>REST API</p><p>Exhibitor 提供了一组用于程序集成的 REST API。</p><blockquote><p>重要事项</p></blockquote><ol><li>使用 Exhibitor 时，不要手动编辑 Zookeeper 的 zoo.cfg 和 myid 文件，因为 Exhibitor 会覆盖它们。</li><li>除了标准的 ZooKeeper 端口，防火墙必须打开 Exhibitor 使用的 HTTP 端口，因为每个 Exhibitor 实例需要与其他参与者通信传递状态。</li></ol><blockquote><p>使用</p></blockquote><p>Exhibitor 的部署构件可以从 Maven 仓库获取。构件分为两种：</p><table><thead><tr><th>GroupID/Org</th><th>ArtifactID/Name</th><th>Description</th></tr></thead><tbody><tr><td>com.netflix.exhibitor</td><td>exhibitor-standalone</td><td>自包含的，可执行的 Exhibitor 版本（可以是独立应用，也可以是 War）</td></tr><tr><td>com.netflix.exhibitor</td><td>exhibitor-core</td><td>类库的形式，可以嵌入到应用中</td></tr></tbody></table><h2 id="exhibitor-编译安装"><a href="#exhibitor-编译安装" class="headerlink" title="exhibitor 编译安装"></a>exhibitor 编译安装</h2><blockquote><p>官方分享了 Maven 和 Gradle 两种 build 方法，这里以 Maven 为例</p></blockquote><p><a href="https://github.com/soabase/exhibitor/wiki/Building-Exhibitor" target="_blank" rel="noopener">https://github.com/soabase/exhibitor/wiki/Building-Exhibitor</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install maven</span></span><br><span class="line">yum install -y maven</span><br><span class="line"></span><br><span class="line"><span class="comment"># build exhibitor</span></span><br><span class="line">mkdir exhibitor</span><br><span class="line"><span class="built_in">cd</span> exhibitor/</span><br><span class="line">wget https://github.com/soabase/exhibitor/archive/exhibitor-1.7.1.zip</span><br><span class="line">unzip exhibitor-1.7.1.zip</span><br><span class="line"><span class="built_in">cd</span> exhibitor-exhibitor-1.7.1/exhibitor-standalone/src/main/resources/buildscripts/standalone/maven</span><br><span class="line">mvn clean package</span><br><span class="line"></span><br><span class="line">[INFO] Replacing original artifact with shaded artifact.</span><br><span class="line">[INFO] Replacing /root/exhibitor/exhibitor-exhibitor-1.7.1/exhibitor-standalone/src/main/resources/buildscripts/standalone/maven/target/exhibitor-1.6.0.jar with /root/exhibitor/exhibitor-exhibitor-1.7.1/exhibitor-standalone/src/main/resources/buildscripts/standalone/maven/target/exhibitor-1.6.0-shaded.jar</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time: 44.624s</span><br><span class="line">[INFO] Finished at: Tue Jan 08 11:28:59 SGT 2019</span><br><span class="line">[INFO] Final Memory: 15M/94M</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">cp target/exhibitor-1.6.0.jar /tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Once built, Exhibitor is completely self-contained and can be run from the command line:</span></span><br><span class="line">java -jar &lt;path&gt;/exhibitor-xxx.jar -c file</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># java -jar exhibitor-1.6.0.jar -c file</span></span><br><span class="line">v1.6.0</span><br><span class="line">INFO  com.netflix.exhibitor.core.activity.ActivityLog  Exhibitor started [main]</span><br><span class="line">Jan 08, 2019 11:32:38 AM java.util.prefs.FileSystemPreferences<span class="variable">$1</span> run</span><br><span class="line">INFO: Created user preferences directory.</span><br><span class="line">INFO  org.mortbay.log  Logging to org.slf4j.impl.Log4jLoggerAdapter(org.mortbay.log) via org.mortbay.log.Slf4jLog [main]</span><br><span class="line">INFO  org.mortbay.log  jetty-1.6.0 [main]</span><br><span class="line">Jan 08, 2019 11:32:38 AM com.sun.jersey.server.impl.application.WebApplicationImpl _initiate</span><br><span class="line">INFO: Initiating Jersey application, version <span class="string">'Jersey: 1.18.3 12/01/2014 08:23 AM'</span></span><br><span class="line">INFO  org.mortbay.log  Started SocketConnector@0.0.0.0:8080 [main]</span><br><span class="line">Jan 08, 2019 11:33:00 AM java.util.prefs.FileSystemPreferences<span class="variable">$6</span> run</span><br><span class="line">WARNING: Prefs file removed <span class="keyword">in</span> background /root/.java/.userPrefs/prefs.xml</span><br><span class="line">INFO  com.netflix.exhibitor.core.activity.ActivityLog  State: latent [ActivityQueue-0]</span><br><span class="line"></span><br><span class="line"><span class="comment"># You can test that it’s running correctly by going to this URL in a browser: </span></span><br><span class="line">http://localhost:8080/exhibitor/v1/ui/index.html</span><br><span class="line">http://192.168.56.103:8080/exhibitor/v1/ui/index.html</span><br></pre></td></tr></table></figure><h2 id="管理-zookeeper-集群"><a href="#管理-zookeeper-集群" class="headerlink" title="管理 zookeeper 集群"></a>管理 zookeeper 集群</h2><blockquote><p>如果需要通过 Exhibitor 管理 zookeeper 集群需要在集群的每个机器上安装 Exhibitor</p></blockquote><p><a href="https://github.com/soabase/exhibitor/wiki/Configuration-UI" target="_blank" rel="noopener">https://github.com/soabase/exhibitor/wiki/Configuration-UI</a></p><p>重点提一下 Ensemble 中的 Servers 配置:</p><ul><li>服务器 IP 之间用逗号分隔，有两种类型：S 表示标准类型，O 表示 Observer 观察者</li><li>S:1:192.168.56.101,S:2:192.168.56.102,S:3:192.168.56.103</li></ul>]]></content>
    
    <summary type="html">
    
      使用 Exhibitor 监控管理 ZooKeeper
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>PyCharm 使用 autopep8 按 PEP8 风格自动排版 Python 代码</title>
    <link href="https://wsgzao.github.io/post/autopep8/"/>
    <id>https://wsgzao.github.io/post/autopep8/</id>
    <published>2018-12-27T08:40:53.000Z</published>
    <updated>2018-12-27T08:47:45.942Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>autopep8 是一个将 Python 代码自动排版为 PEP8 风格的小工具。它使用 pep8 工具来决定代码中的哪部分需要被排版。autopep8 可以修复大部分 pep8 工具中报告的排版问题。</p><blockquote><p>PyCharm 使用 autopep8 按 PEP8 风格自动排版 Python 代码</p></blockquote><h2 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h2><p>2018 年 12 月 27 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/autopep8/">https://wsgzao.github.io/post/autopep8/</a></p><p><strong> 扩展阅读 </strong></p><p>autopep8 - <a href="https://pypi.python.org/pypi/autopep8/" target="_blank" rel="noopener">https://pypi.python.org/pypi/autopep8/</a></p><h2 id="autopep8-简介"><a href="#autopep8-简介" class="headerlink" title="autopep8 简介"></a>autopep8 简介</h2><blockquote><p>使用 autopep8 前我们有必要先了解下 PEP 8 – Style Guide for Python Code</p></blockquote><p>autopep8 automatically formats Python code to conform to the PEP 8 style guide. It uses the pycodestyle utility to determine what parts of the code needs to be formatted. autopep8 is capable of fixing most of the formatting issues that can be reported by pycodestyle.</p><p><a href="https://www.python.org/dev/peps/pep-0008/" target="_blank" rel="noopener">https://www.python.org/dev/peps/pep-0008/</a></p><p><a href="https://pypi.python.org/pypi/autopep8/" target="_blank" rel="noopener">https://pypi.python.org/pypi/autopep8/</a></p><h2 id="安装和使用-autopep8"><a href="#安装和使用-autopep8" class="headerlink" title="安装和使用 autopep8"></a>安装和使用 autopep8</h2><p>autopep8 是一个开源的命令行工具，它能够将 Python 代码自动格式化为 PEP8 风格。autopep8 使用 pycodestyle 工具来决定代码中的哪部分需要被格式化，这能够修复大部分 pycodestyle 工具中报告的排版问题。autopep8 本身也是一个 Python 语言编写的工具，因此，我们可以直接使用 pip 进行安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">pip install autopep8</span><br><span class="line">autopep8 --<span class="keyword">in</span>-place optparse.py </span><br><span class="line"></span><br><span class="line"><span class="comment"># To modify a file in place (with aggressive level 2):</span></span><br><span class="line">autopep8 --<span class="keyword">in</span>-place --aggressive --aggressive &lt;filename&gt;</span><br><span class="line"></span><br><span class="line">usage: autopep8 [-h] [--version] [-v] [-d] [-i] [--global-config filename]</span><br><span class="line">                [--ignore-local-config] [-r] [-j n] [-p n] [-a]</span><br><span class="line">                [--experimental] [--exclude globs] [--list-fixes]</span><br><span class="line">                [--ignore errors] [--select errors] [--max-line-length n]</span><br><span class="line">                [--line-range line line] [--hang-closing] [--<span class="built_in">exit</span>-code]</span><br><span class="line">                [files [files ...]]</span><br><span class="line"></span><br><span class="line">Automatically formats Python code to conform to the PEP 8 style guide.</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  files                 files to format or <span class="string">'-'</span> <span class="keyword">for</span> standard <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --<span class="built_in">help</span>            show this <span class="built_in">help</span> message and <span class="built_in">exit</span></span><br><span class="line">  --version             show program<span class="string">'s version number and exit</span></span><br><span class="line"><span class="string">  -v, --verbose         print verbose messages; multiple -v result in more</span></span><br><span class="line"><span class="string">                        verbose messages</span></span><br><span class="line"><span class="string">  -d, --diff            print the diff for the fixed source</span></span><br><span class="line"><span class="string">  -i, --in-place        make changes to files in place</span></span><br><span class="line"><span class="string">  --global-config filename</span></span><br><span class="line"><span class="string">                        path to a global pep8 config file; if this file does</span></span><br><span class="line"><span class="string">                        not exist then this is ignored (default:</span></span><br><span class="line"><span class="string">                        ~/.config/pep8)</span></span><br><span class="line"><span class="string">  --ignore-local-config</span></span><br><span class="line"><span class="string">                        don'</span>t look <span class="keyword">for</span> and apply <span class="built_in">local</span> config files; <span class="keyword">if</span> not</span><br><span class="line">                        passed, defaults are updated with any config files <span class="keyword">in</span></span><br><span class="line">                        the project<span class="string">'s root directory</span></span><br><span class="line"><span class="string">  -r, --recursive       run recursively over directories; must be used with</span></span><br><span class="line"><span class="string">                        --in-place or --diff</span></span><br><span class="line"><span class="string">  -j n, --jobs n        number of parallel jobs; match CPU count if value is</span></span><br><span class="line"><span class="string">                        less than 1</span></span><br><span class="line"><span class="string">  -p n, --pep8-passes n</span></span><br><span class="line"><span class="string">                        maximum number of additional pep8 passes (default:</span></span><br><span class="line"><span class="string">                        infinite)</span></span><br><span class="line"><span class="string">  -a, --aggressive      enable non-whitespace changes; multiple -a result in</span></span><br><span class="line"><span class="string">                        more aggressive changes</span></span><br><span class="line"><span class="string">  --experimental        enable experimental fixes</span></span><br><span class="line"><span class="string">  --exclude globs       exclude file/directory names that match these comma-</span></span><br><span class="line"><span class="string">                        separated globs</span></span><br><span class="line"><span class="string">  --list-fixes          list codes for fixes; used by --ignore and --select</span></span><br><span class="line"><span class="string">  --ignore errors       do not fix these errors/warnings (default:</span></span><br><span class="line"><span class="string">                        E226,E24,W50,W690)</span></span><br><span class="line"><span class="string">  --select errors       fix only these errors/warnings (e.g. E4,W)</span></span><br><span class="line"><span class="string">  --max-line-length n   set maximum allowed line length (default: 79)</span></span><br><span class="line"><span class="string">  --line-range line line, --range line line</span></span><br><span class="line"><span class="string">                        only fix errors found within this inclusive range of</span></span><br><span class="line"><span class="string">                        line numbers (e.g. 1 99); line numbers are indexed at</span></span><br><span class="line"><span class="string">                        1</span></span><br><span class="line"><span class="string">  --hang-closing        hang-closing option passed to pycodestyle</span></span><br><span class="line"><span class="string">  --exit-code           change to behavior of exit code. default behavior of</span></span><br><span class="line"><span class="string">                        return value, 0 is no differences, 1 is error exit.</span></span><br><span class="line"><span class="string">                        return 2 when add this option. 2 is exists</span></span><br><span class="line"><span class="string">                        differences.</span></span><br></pre></td></tr></table></figure><p>–in-place 类似于 sed 命令的 - i 选项，如果不包含 –in-place 选项，则会将 autopep8 格式化以后的代码直接输出到控制台。我们可以使用这种方式检查 autopep8 的修改，使用 –in-place 则会直接将结果保存到源文件中。</p><p>我们来看一个完整的例子，本例中使用的代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, sys  </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>  </span><br><span class="line">    <span class="keyword">print</span> [item <span class="keyword">for</span> item <span class="keyword">in</span> os.listdir(<span class="string">'.'</span>) <span class="keyword">if</span> item.endswith(<span class="string">'.py'</span>)];  </span><br><span class="line">    <span class="keyword">print</span> sys.version  </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:  </span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>这段代码存在三个问题：</p><ol><li>导入的时候，应该每一行只导入一个包；</li><li>包导入和函数定义之间应该空两行；</li><li>Python 代码末尾不需要分号。</li></ol><p>接下来，我们将使用 pycodestyple 检查这段代码，然后使用 autopep8 将代码格式化成符合 PEP 8 风格的代码。</p><p>使用 pycodestyle 检查代码可检测到代码中有三个地方不符合 PEP 8 规范，如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pycodestyle hello.py  </span><br><span class="line">hello.py:1:10: E401 multiple imports on one line  </span><br><span class="line">hello.py:3:1: E302 expected 2 blank lines, found 1  </span><br><span class="line">hello.py:4:69: E703 statement ends with a semicolon</span><br></pre></td></tr></table></figure><p>使用 autopep8 格式能够转换 Python 代码。在这个例子中，autopep8 顺利地帮我们修复了所有问题，如下所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ autopep8 hello.py  </span><br><span class="line"><span class="keyword">import</span> os  </span><br><span class="line"><span class="keyword">import</span> sys  </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>  </span><br><span class="line">    <span class="keyword">print</span> [item <span class="keyword">for</span> item <span class="keyword">in</span> os.listdir(<span class="string">'.'</span>) <span class="keyword">if</span> item.endswith(<span class="string">'.py'</span>)]  </span><br><span class="line">    <span class="keyword">print</span> sys.version  </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:  </span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>这个时候如果查看源文件的话，会发现还是和原来一样，并没有修正为符合 PEP 8 规范的代码。前面说过，不指定 –in-place 选项，只会将结果输出到命令行。如果我们使用 –in-place 选项，将不会有任何输出，autopep8 会直接修改源文件。</p><pre><code>$ autopep8 --in-place hello.py </code></pre><p>autopep8 还存在 –aggressive 选项，使用该选项会执行更多实质性的更改，可以多次使用以达到更佳的效果。</p><p>以官网为例我们编写一个 test_autopep8.py</p><blockquote><p>Before running autopep8.</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math, sys;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">####This is a long comment. This should be wrapped to fit within 72 characters.</span></span><br><span class="line">    some_tuple=(   <span class="number">1</span>,<span class="number">2</span>, <span class="number">3</span>,<span class="string">'a'</span>  );</span><br><span class="line">    some_variable=&#123;<span class="string">'long'</span>:<span class="string">'Long code lines should be wrapped within 79 characters.'</span>,</span><br><span class="line">    <span class="string">'other'</span>:[math.pi, <span class="number">100</span>,<span class="number">200</span>,<span class="number">300</span>,<span class="number">9876543210</span>,<span class="string">'This is a long string that goes on'</span>],</span><br><span class="line">    <span class="string">'more'</span>:&#123;<span class="string">'inner'</span>:<span class="string">'This whole logical line should be wrapped.'</span>,some_tuple:[<span class="number">1</span>,</span><br><span class="line">    <span class="number">20</span>,<span class="number">300</span>,<span class="number">40000</span>,<span class="number">500000000</span>,<span class="number">60000000000000000</span>]&#125;&#125;</span><br><span class="line">    <span class="keyword">return</span> (some_tuple, some_variable)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example2</span><span class="params">()</span>:</span> <span class="keyword">return</span> &#123;<span class="string">'has_key() is deprecated'</span>:<span class="keyword">True</span>&#125;.has_key(&#123;<span class="string">'f'</span>:<span class="number">2</span>&#125;.has_key(<span class="string">''</span>));</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example3</span><span class="params">(   object )</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>    <span class="params">( self, bar )</span>:</span></span><br><span class="line">     <span class="comment">#Comments should have a space after the hash.</span></span><br><span class="line">     <span class="keyword">if</span> bar : bar+=<span class="number">1</span>;  bar=bar* bar   ; <span class="keyword">return</span> bar</span><br><span class="line">     <span class="keyword">else</span>:</span><br><span class="line">                    some_string = <span class="string">"""</span></span><br><span class="line"><span class="string">                       Indentation in multiline strings should not be touched.</span></span><br><span class="line"><span class="string">Only actual code should be reindented.</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">                    <span class="keyword">return</span> (sys.path, some_string)</span><br></pre></td></tr></table></figure><blockquote><p>After running autopep8.</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># This is a long comment. This should be wrapped to fit within 72</span></span><br><span class="line">    <span class="comment"># characters.</span></span><br><span class="line">    some_tuple = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="string">'a'</span>)</span><br><span class="line">    some_variable = &#123;</span><br><span class="line">        <span class="string">'long'</span>: <span class="string">'Long code lines should be wrapped within 79 characters.'</span>,</span><br><span class="line">        <span class="string">'other'</span>: [</span><br><span class="line">            math.pi,</span><br><span class="line">            <span class="number">100</span>,</span><br><span class="line">            <span class="number">200</span>,</span><br><span class="line">            <span class="number">300</span>,</span><br><span class="line">            <span class="number">9876543210</span>,</span><br><span class="line">            <span class="string">'This is a long string that goes on'</span>],</span><br><span class="line">        <span class="string">'more'</span>: &#123;</span><br><span class="line">            <span class="string">'inner'</span>: <span class="string">'This whole logical line should be wrapped.'</span>,</span><br><span class="line">            some_tuple: [</span><br><span class="line">                <span class="number">1</span>,</span><br><span class="line">                <span class="number">20</span>,</span><br><span class="line">                <span class="number">300</span>,</span><br><span class="line">                <span class="number">40000</span>,</span><br><span class="line">                <span class="number">500000000</span>,</span><br><span class="line">                <span class="number">60000000000000000</span>]&#125;&#125;</span><br><span class="line">    <span class="keyword">return</span> (some_tuple, some_variable)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">example2</span><span class="params">()</span>:</span> <span class="keyword">return</span> (<span class="string">''</span> <span class="keyword">in</span> &#123;<span class="string">'f'</span>: <span class="number">2</span>&#125;) <span class="keyword">in</span> &#123;<span class="string">'has_key() is deprecated'</span>: <span class="keyword">True</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example3</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, bar)</span>:</span></span><br><span class="line">        <span class="comment"># Comments should have a space after the hash.</span></span><br><span class="line">        <span class="keyword">if</span> bar:</span><br><span class="line">            bar += <span class="number">1</span></span><br><span class="line">            bar = bar * bar</span><br><span class="line">            <span class="keyword">return</span> bar</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            some_string = <span class="string">"""</span></span><br><span class="line"><span class="string">                       Indentation in multiline strings should not be touched.</span></span><br><span class="line"><span class="string">Only actual code should be reindented.</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">            <span class="keyword">return</span> (sys.path, some_string)</span><br></pre></td></tr></table></figure><h2 id="autopep8-可以修复的问题"><a href="#autopep8-可以修复的问题" class="headerlink" title="autopep8 可以修复的问题"></a>autopep8 可以修复的问题</h2><blockquote><p>autopep8 fixes the following issues reported by pycodestyle:</p></blockquote><p><a href="https://github.com/PyCQA/pycodestyle" target="_blank" rel="noopener">https://github.com/PyCQA/pycodestyle</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">E101 - Reindent all lines.</span><br><span class="line">E11  - Fix indentation.</span><br><span class="line">E121 - Fix indentation to be a multiple of four.</span><br><span class="line">E122 - Add absent indentation <span class="keyword">for</span> hanging indentation.</span><br><span class="line">E123 - Align closing bracket to match opening bracket.</span><br><span class="line">E124 - Align closing bracket to match visual indentation.</span><br><span class="line">E125 - Indent to distinguish line from next logical line.</span><br><span class="line">E126 - Fix over-indented hanging indentation.</span><br><span class="line">E127 - Fix visual indentation.</span><br><span class="line">E128 - Fix visual indentation.</span><br><span class="line">E129 - Fix visual indentation.</span><br><span class="line">E131 - Fix hanging indent <span class="keyword">for</span> unaligned continuation line.</span><br><span class="line">E133 - Fix missing indentation <span class="keyword">for</span> closing bracket.</span><br><span class="line">E20  - Remove extraneous whitespace.</span><br><span class="line">E211 - Remove extraneous whitespace.</span><br><span class="line">E22  - Fix extraneous whitespace around keywords.</span><br><span class="line">E224 - Remove extraneous whitespace around operator.</span><br><span class="line">E225 - Fix missing whitespace around operator.</span><br><span class="line">E226 - Fix missing whitespace around arithmetic operator.</span><br><span class="line">E227 - Fix missing whitespace around bitwise/<span class="built_in">shift</span> operator.</span><br><span class="line">E228 - Fix missing whitespace around modulo operator.</span><br><span class="line">E231 - Add missing whitespace.</span><br><span class="line">E241 - Fix extraneous whitespace around keywords.</span><br><span class="line">E242 - Remove extraneous whitespace around operator.</span><br><span class="line">E251 - Remove whitespace around parameter <span class="string">'='</span> sign.</span><br><span class="line">E252 - Missing whitespace around parameter equals.</span><br><span class="line">E26  - Fix spacing after comment <span class="built_in">hash</span> <span class="keyword">for</span> inline comments.</span><br><span class="line">E265 - Fix spacing after comment <span class="built_in">hash</span> <span class="keyword">for</span> block comments.</span><br><span class="line">E266 - Fix too many leading <span class="string">'#'</span> <span class="keyword">for</span> block comments.</span><br><span class="line">E27  - Fix extraneous whitespace around keywords.</span><br><span class="line">E301 - Add missing blank line.</span><br><span class="line">E302 - Add missing 2 blank lines.</span><br><span class="line">E303 - Remove extra blank lines.</span><br><span class="line">E304 - Remove blank line following <span class="keyword">function</span> decorator.</span><br><span class="line">E305 - Expected 2 blank lines after end of <span class="keyword">function</span> or class.</span><br><span class="line">E306 - Expected 1 blank line before a nested definition.</span><br><span class="line">E401 - Put imports on separate lines.</span><br><span class="line">E402 - Fix module level import not at top of file</span><br><span class="line">E501 - Try to make lines fit within --max-line-length characters.</span><br><span class="line">E502 - Remove extraneous escape of newline.</span><br><span class="line">E701 - Put colon-separated compound statement on separate lines.</span><br><span class="line">E70  - Put semicolon-separated compound statement on separate lines.</span><br><span class="line">E711 - Fix comparison with None.</span><br><span class="line">E712 - Fix comparison with boolean.</span><br><span class="line">E713 - Use <span class="string">'not in'</span> <span class="keyword">for</span> <span class="built_in">test</span> <span class="keyword">for</span> membership.</span><br><span class="line">E714 - Use <span class="string">'is not'</span> <span class="built_in">test</span> <span class="keyword">for</span> object identity.</span><br><span class="line">E721 - Use <span class="string">"isinstance()"</span> instead of comparing types directly.</span><br><span class="line">E722 - Fix bare except.</span><br><span class="line">E731 - Use a def when use <span class="keyword">do</span> not assign a lambda expression.</span><br><span class="line">W291 - Remove trailing whitespace.</span><br><span class="line">W292 - Add a single newline at the end of the file.</span><br><span class="line">W293 - Remove trailing whitespace on blank line.</span><br><span class="line">W391 - Remove trailing blank lines.</span><br><span class="line">W503 - Fix line <span class="built_in">break</span> before binary operator.</span><br><span class="line">W504 - Fix line <span class="built_in">break</span> after binary operator.</span><br><span class="line">W601 - Use <span class="string">"in"</span> rather than <span class="string">"has_key()"</span>.</span><br><span class="line">W602 - Fix deprecated form of raising exception.</span><br><span class="line">W603 - Use <span class="string">"!="</span> instead of <span class="string">"&lt;&gt;"</span></span><br><span class="line">W604 - Use <span class="string">"repr()"</span> instead of backticks.</span><br><span class="line">W605 - Fix invalid escape sequence <span class="string">'x'</span>.</span><br><span class="line">W690 - Fix various deprecated code (via lib2to3).</span><br></pre></td></tr></table></figure><h2 id="Pycharm-安装-autopep8"><a href="#Pycharm-安装-autopep8" class="headerlink" title="Pycharm 安装 autopep8"></a>Pycharm 安装 autopep8</h2><p>pip 安装 autopep8: pip install autopep8</p><p>PyCharm -&gt; Preferences -&gt; Tools -&gt; Extends Tools -&gt; 点击 + 加号</p><p>Name: autopep8<br>Tools settings:</p><ul><li>Programs: <code>autopep8</code></li><li>Parameters: <code>--in-place --aggressive --aggressive $FilePath$</code></li><li>Working directory: <code>$ProjectFileDir$</code></li><li>Advanced Options -&gt; Output Filters: <code>$FILE_PATH$\:$LINE$\:$COLUMN$\:.*</code></li></ul><h2 id="Python-之禅"><a href="#Python-之禅" class="headerlink" title="Python 之禅"></a>Python 之禅</h2><blockquote><p>最后以 Python 之禅作为结束语</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> wangao@wangao-MAC  ~  python3</span><br><span class="line">Python <span class="number">3.7</span><span class="number">.1</span> (default, Nov  <span class="number">6</span> <span class="number">2018</span>, <span class="number">18</span>:<span class="number">46</span>:<span class="number">03</span>)</span><br><span class="line">[Clang <span class="number">10.0</span><span class="number">.0</span> (clang<span class="number">-1000.11</span><span class="number">.45</span><span class="number">.5</span>)] on darwin</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> <span class="keyword">or</span> <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> this</span><br><span class="line">The Zen of Python, by Tim Peters</span><br><span class="line"></span><br><span class="line">Beautiful <span class="keyword">is</span> better than ugly.</span><br><span class="line">Explicit <span class="keyword">is</span> better than implicit.</span><br><span class="line">Simple <span class="keyword">is</span> better than complex.</span><br><span class="line">Complex <span class="keyword">is</span> better than complicated.</span><br><span class="line">Flat <span class="keyword">is</span> better than nested.</span><br><span class="line">Sparse <span class="keyword">is</span> better than dense.</span><br><span class="line">Readability counts.</span><br><span class="line">Special cases aren<span class="string">'t special enough to break the rules.</span></span><br><span class="line"><span class="string">Although practicality beats purity.</span></span><br><span class="line"><span class="string">Errors should never pass silently.</span></span><br><span class="line"><span class="string">Unless explicitly silenced.</span></span><br><span class="line"><span class="string">In the face of ambiguity, refuse the temptation to guess.</span></span><br><span class="line"><span class="string">There should be one-- and preferably only one --obvious way to do it.</span></span><br><span class="line"><span class="string">Although that way may not be obvious at first unless you'</span>re Dutch.</span><br><span class="line">Now <span class="keyword">is</span> better than never.</span><br><span class="line">Although never <span class="keyword">is</span> often better than *right* now.</span><br><span class="line">If the implementation <span class="keyword">is</span> hard to explain, it<span class="string">'s a bad idea.</span></span><br><span class="line"><span class="string">If the implementation is easy to explain, it may be a good idea.</span></span><br><span class="line"><span class="string">Namespaces are one honking great idea -- let'</span>s do more of those!</span><br></pre></td></tr></table></figure><blockquote><p>翻译</p></blockquote><p>美 优于 丑</p><p>明确 优于 隐晦 （1）</p><p>简单 优于 复杂</p><p>复杂 也好过 繁复 （2）</p><p>扁平 优于 嵌套</p><p>稀疏 优于 拥挤</p><p>可读性很重要（3）</p><p>固然代码实用与否 比洁癖更重要，</p><p>我们以为的特例也往往没有特殊到必须打破上述规则的程度</p><p>除非刻意地静默，</p><p>否则不要无故忽视异常（4）</p><p>如果遇到模棱两可的逻辑，请不要自作聪明地瞎猜。</p><p>应该提供一种，且最好只提供一种，一目了然的解决方案</p><p>当然这是没法一蹴而就的，除非你是荷兰人（5）</p><p>固然，立刻着手 好过 永远不做。</p><p>然而，永远不做 也好过 不审慎思考一撸袖子就莽着干</p><p>如果你的实现很难解释，它就一定不是个好主意</p><p>即使你的实现简单到爆，它也有可能是个好办法</p><p>命名空间大法好，不搞不是地球人！</p><blockquote><p>注释</p></blockquote><ol><li>该引入的包一个一个列出来不要合并；不要用星号；不要在方法里藏意想不到的的副作用，等等等等。还一个例子，另外一种著名的软件设计原则 Convention over Configuration（约定优于配置）如果做得不谨慎就会违背这条</li><li>SO: 必要的复杂逻辑是难免的，而繁复啰嗦的代码是不可接受的</li><li>Readability counts 不能翻译成可读性计数啊喂</li><li>实操中很多人不注意 catch 完就 log 一下 就不管了，这样不好。软件界一般都讲 Let it fail，学名为 Fail-fast 法则。简而言之就是整个项目周期中越早暴露的问题，其修复成本越低</li><li>本文作者 Tim peters 解释说这里的荷兰人指的是 Python 的作者 Guido van Rossum</li></ol>]]></content>
    
    <summary type="html">
    
      PyCharm使用Autopep8按PEP8风格自动排版Python代码
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>macOS Mojave 降级安装 MySQL 5.7</title>
    <link href="https://wsgzao.github.io/post/macos-mysql/"/>
    <id>https://wsgzao.github.io/post/macos-mysql/</id>
    <published>2018-12-17T06:59:49.000Z</published>
    <updated>2018-12-18T09:06:02.622Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>自从 macOS 升级至 Mojave 后小问题不断，现在使用 Homebrew 安装 MySQL 默认也是 8.0 版本，和 Python 类似我们依赖的组件可能还不支持高版本，新版本的某些更新和调整导致比如 Sequel Pro 和 mysqldb 不可用。当然我们也可以使用官方的 MySQLWorkbench，之前介绍了如何在 macOS 下安装多版本 Python，现在继续分享 macOS 如何降级 MySQL。</p><blockquote><p>macOS Mojave 降级安装 MySQL 5.7</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2018 年 12 月 17 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/macos-mysql/">https://wsgzao.github.io/post/macos-mysql/</a></p><p><strong> 扩展阅读 </strong></p><p>Install MySQL 5.7 on macOS Mojave - <a href="https://medium.com/@at0dd/install-mysql-5-7-on-mac-os-mojave-cd07ec936034" target="_blank" rel="noopener">https://medium.com/@at0dd/install-mysql-5-7-on-mac-os-mojave-cd07ec936034</a></p><hr><h2 id="正常安装"><a href="#正常安装" class="headerlink" title="正常安装"></a>正常安装</h2><blockquote><p>默认新版本是 MySQL 8.0</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">brew update</span><br><span class="line">brew install mysql</span><br><span class="line"></span><br><span class="line">We<span class="string">'ve installed your MySQL database without a root password. To secure it run:</span></span><br><span class="line"><span class="string">    mysql_secure_installation</span></span><br><span class="line"><span class="string">MySQL is configured to only allow connections from localhost by default</span></span><br><span class="line"><span class="string">To connect run:</span></span><br><span class="line"><span class="string">    mysql -uroot</span></span><br><span class="line"><span class="string">To have launchd start mysql now and restart at login:</span></span><br><span class="line"><span class="string">  brew services start mysql</span></span><br><span class="line"><span class="string">Or, if you don'</span>t want/need a background service you can just run:</span><br><span class="line">  mysql.server start</span><br></pre></td></tr></table></figure><h2 id="卸载现有版本"><a href="#卸载现有版本" class="headerlink" title="卸载现有版本"></a>卸载现有版本</h2><blockquote><p>无论是官方 dmg 还是 brew 都记得先备份重要数据后再清理</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正常关闭并删除 MySQL</span></span><br><span class="line">mysql.server stop</span><br><span class="line">brew services stop mysql</span><br><span class="line">brew remove mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 无法正常删除 MySQL</span></span><br><span class="line">ps -ax | grep mysql</span><br><span class="line">stop and <span class="built_in">kill</span> any MySQL processes</span><br><span class="line">brew remove mysql</span><br><span class="line">brew cleanup</span><br><span class="line">sudo rm /usr/<span class="built_in">local</span>/mysql</span><br><span class="line">sudo rm -rf /usr/<span class="built_in">local</span>/var/mysql</span><br><span class="line">sudo rm -rf /usr/<span class="built_in">local</span>/mysql*</span><br></pre></td></tr></table></figure><h2 id="安装-MySQL-指定版本"><a href="#安装-MySQL-指定版本" class="headerlink" title="安装 MySQL 指定版本"></a>安装 MySQL 指定版本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 MySQL 5.7</span></span><br><span class="line">brew install mysql@5.7</span><br><span class="line">brew link --force mysql@5.7</span><br><span class="line"></span><br><span class="line">We<span class="string">'ve installed your MySQL database without a root password. To secure it run:</span></span><br><span class="line"><span class="string">    mysql_secure_installation</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL is configured to only allow connections from localhost by default</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To connect run:</span></span><br><span class="line"><span class="string">    mysql -uroot</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mysql@5.7 is keg-only, which means it was not symlinked into /usr/local,</span></span><br><span class="line"><span class="string">because this is an alternate version of another formula.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">If you need to have mysql@5.7 first in your PATH run:</span></span><br><span class="line"><span class="string">  echo'</span><span class="built_in">export</span> PATH=<span class="string">"/usr/local/opt/mysql@5.7/bin:<span class="variable">$PATH</span>"</span><span class="string">'&gt;&gt; ~/.zshrc</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">For compilers to find mysql@5.7 you may need to set:</span></span><br><span class="line"><span class="string">  export LDFLAGS="-L/usr/local/opt/mysql@5.7/lib"</span></span><br><span class="line"><span class="string">  export CPPFLAGS="-I/usr/local/opt/mysql@5.7/include"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">For pkg-config to find mysql@5.7 you may need to set:</span></span><br><span class="line"><span class="string">  export PKG_CONFIG_PATH="/usr/local/opt/mysql@5.7/lib/pkgconfig"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To have launchd start mysql@5.7 now and restart at login:</span></span><br><span class="line"><span class="string">  brew services start mysql@5.7</span></span><br><span class="line"><span class="string">Or, if you don'</span>t want/need a background service you can just run:</span><br><span class="line">  /usr/<span class="built_in">local</span>/opt/mysql@5.7/bin/mysql.server start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开机自启动 </span></span><br><span class="line">brew services restart mysql@5.7</span><br><span class="line"><span class="comment"># 设置环境变量 </span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH="/usr/local/opt/mysql@5.7/bin:$PATH"'</span> &gt;&gt; ~/.zshrc</span><br><span class="line"><span class="comment"># 手动启动和关闭 </span></span><br><span class="line">/usr/<span class="built_in">local</span>/opt/mysql@5.7/bin/mysql.server start</span><br><span class="line">/usr/<span class="built_in">local</span>/opt/mysql@5.7/bin/mysql.server stop</span><br></pre></td></tr></table></figure><h2 id="安装-mysqldb"><a href="#安装-mysqldb" class="headerlink" title="安装 mysqldb"></a>安装 mysqldb</h2><p>Python 中最连接 Mysql 常用的驱动是:</p><ul><li>mysql-python ：mysql 的 C 语言的驱动</li><li>mysql-connector：msql 官方的驱动</li><li>pymysql：python 语言的驱动</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 MySQLdb ，但是提示 importerror no module named mysqldb</span></span><br><span class="line">brew install mysql-connector-c</span><br><span class="line">pip install mysql-python</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可能会出现以下错误，按照提示做即可 </span></span><br><span class="line">Error: Cannot install mysql because conflicting formulae are installed.</span><br><span class="line">  mysql-connector-c: because both install MySQL client libraries</span><br><span class="line"></span><br><span class="line">Please `brew unlink mysql-connector-c` before continuing.</span><br><span class="line"></span><br><span class="line">Unlinking removes a formula<span class="string">'s symlinks from /usr/local. You can</span></span><br><span class="line"><span class="string">link the formula again after the install finishes. You can --force this</span></span><br><span class="line"><span class="string">install, but the build may fail or cause obscure side-effects in the</span></span><br><span class="line"><span class="string">resulting software.</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      macOS Mojave 降级安装 MySQL 5.7
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>macOS 使用 pyenv 安装和管理多个 Python 版本</title>
    <link href="https://wsgzao.github.io/post/macos-pyenv/"/>
    <id>https://wsgzao.github.io/post/macos-pyenv/</id>
    <published>2018-12-16T06:59:49.000Z</published>
    <updated>2018-12-17T08:02:21.390Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前 Python 同时更新与维护 Python2 和 Python3，选择 Python2 还是选择 Python3，取决于当前要使用的库、框架支持哪个版本，所以经常会遇到切换版本的情况。那么 macOS 下应该怎样有效的更改呢？很多小伙伴一定会想到修改环境变量，指定 Python 的默认路径，这样当然可以，然而不够优雅。那么怎样的方法才算优雅呢？当然是一条命令了。这里通过 brew 安装 pyenv，再用 pyenv 安装管理 Python。</p><blockquote><p>macOS 使用 pyenv 安装和管理多个 Python 版本</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2018 年 12 月 16 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/macos-pyenv/">https://wsgzao.github.io/post/macos-pyenv/</a></p><p><strong> 扩展阅读 </strong></p><p>pyenv - <a href="https://github.com/pyenv/pyenv" target="_blank" rel="noopener">https://github.com/pyenv/pyenv</a></p><hr><h2 id="pyenv-简介"><a href="#pyenv-简介" class="headerlink" title="pyenv 简介"></a>pyenv 简介</h2><p>pyenv lets you easily switch between multiple versions of Python. It’s simple, unobtrusive, and follows the UNIX tradition of single-purpose tools that do one thing well.</p><p>This project was forked from <a href="https://github.com/rbenv/rbenv" target="_blank" rel="noopener">rbenv</a> and <a href="https://github.com/rbenv/ruby-build" target="_blank" rel="noopener">ruby-build</a>, and modified for Python.</p><p><img src="https://github.com/pyenv/pyenv/raw/master/terminal_output.png" alt="Terminal output example"></p><p>pyenv <em>does…</em></p><ul><li>Let you <strong>change the global Python version</strong> on a per-user basis.</li><li>Provide support for <strong>per-project Python versions</strong>.</li><li>Allow you to <strong>override the Python version</strong> with an environment variable.</li><li>Search commands from <strong>multiple versions of Python at a time</strong>.<br>This may be helpful to test across Python versions with <a href="https://pypi.python.org/pypi/tox" target="_blank" rel="noopener">tox</a>.</li></ul><p>In contrast with pythonbrew and pythonz, pyenv <em>does not…</em></p><ul><li><strong>Depend on Python itself.</strong> pyenv was made from pure shell scripts. There is no bootstrap problem of Python.</li><li><strong>Need to be loaded into your shell.</strong> Instead, pyenv’s shim approach works by adding a directory to your <code>$PATH</code>.</li><li><strong>Manage virtualenv.</strong> Of course, you can create <a href="https://pypi.python.org/pypi/virtualenv" target="_blank" rel="noopener">virtualenv</a> yourself, or <a href="https://github.com/pyenv/pyenv-virtualenv" target="_blank" rel="noopener">pyenv-virtualenv</a> to automate the process.</li></ul><h2 id="安装-pyenv"><a href="#安装-pyenv" class="headerlink" title="安装 pyenv"></a>安装 pyenv</h2><blockquote><p>Homebrew 是 macOS 下非常高效的命令行软件包管理器，mac 必安装工具之一</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 homebrew</span></span><br><span class="line">/usr/bin/ruby -e <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span></span><br><span class="line">brew -v</span><br><span class="line">Homebrew 1.8.5</span><br><span class="line">Homebrew/homebrew-core (git revision 497ca; last commit 2018-12-16)</span><br><span class="line">Homebrew/homebrew-cask (git revision 8be7c; last commit 2018-12-17)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 pyenv</span></span><br><span class="line">brew update</span><br><span class="line">brew install pyenv</span><br><span class="line">pyenv -v</span><br><span class="line">pyenv 1.2.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装管理多个 Python</span></span><br><span class="line">pyenv install --list</span><br><span class="line">Available versions:</span><br><span class="line">  2.1.3</span><br><span class="line">  2.2.3</span><br><span class="line">  2.3.7</span><br><span class="line">  2.4</span><br><span class="line">  2.4.1</span><br><span class="line">  2.4.2</span><br><span class="line">  2.4.3</span><br><span class="line">  2.4.4</span><br><span class="line">  2.4.5</span><br><span class="line">  2.4.6</span><br><span class="line">  2.5</span><br><span class="line">  2.5.1</span><br><span class="line">  2.5.2</span><br><span class="line">  2.5.3</span><br><span class="line">  2.5.4</span><br><span class="line">  2.5.5</span><br><span class="line">  2.5.6</span><br><span class="line">  2.6.6</span><br><span class="line">  2.6.7</span><br><span class="line">  2.6.8</span><br><span class="line">  2.6.9</span><br><span class="line">  2.7-dev</span><br><span class="line">  2.7</span><br><span class="line">  2.7.1</span><br><span class="line">  2.7.2</span><br><span class="line">  2.7.3</span><br><span class="line">  2.7.4</span><br><span class="line">  2.7.5</span><br><span class="line">  2.7.6</span><br><span class="line">  2.7.7</span><br><span class="line">  2.7.8</span><br><span class="line">  2.7.9</span><br><span class="line">  2.7.10</span><br><span class="line">  2.7.11</span><br><span class="line">  2.7.12</span><br><span class="line">  2.7.13</span><br><span class="line">  2.7.14</span><br><span class="line">  2.7.15</span><br><span class="line">  3.0.1</span><br><span class="line">  3.1</span><br><span class="line">  3.1.1</span><br><span class="line">  3.1.2</span><br><span class="line">  3.1.3</span><br><span class="line">  3.1.4</span><br><span class="line">  3.1.5</span><br><span class="line">  3.2</span><br><span class="line">  3.2.1</span><br><span class="line">  3.2.2</span><br><span class="line">  3.2.3</span><br><span class="line">  3.2.4</span><br><span class="line">  3.2.5</span><br><span class="line">  3.2.6</span><br><span class="line">  3.3.0</span><br><span class="line">  3.3.1</span><br><span class="line">  3.3.2</span><br><span class="line">  3.3.3</span><br><span class="line">  3.3.4</span><br><span class="line">  3.3.5</span><br><span class="line">  3.3.6</span><br><span class="line">  3.3.7</span><br><span class="line">  3.4.0</span><br><span class="line">  3.4-dev</span><br><span class="line">  3.4.1</span><br><span class="line">  3.4.2</span><br><span class="line">  3.4.3</span><br><span class="line">  3.4.4</span><br><span class="line">  3.4.5</span><br><span class="line">  3.4.6</span><br><span class="line">  3.4.7</span><br><span class="line">  3.4.8</span><br><span class="line">  3.4.9</span><br><span class="line">  3.5.0</span><br><span class="line">  3.5-dev</span><br><span class="line">  3.5.1</span><br><span class="line">  3.5.2</span><br><span class="line">  3.5.3</span><br><span class="line">  3.5.4</span><br><span class="line">  3.5.5</span><br><span class="line">  3.5.6</span><br><span class="line">  3.6.0</span><br><span class="line">  3.6-dev</span><br><span class="line">  3.6.1</span><br><span class="line">  3.6.2</span><br><span class="line">  3.6.3</span><br><span class="line">  3.6.4</span><br><span class="line">  3.6.5</span><br><span class="line">  3.6.6</span><br><span class="line">  3.6.7</span><br><span class="line">  3.7.0</span><br><span class="line">  3.7-dev</span><br><span class="line">  3.7.1</span><br><span class="line">  3.8-dev</span><br><span class="line">  activepython-2.7.14</span><br><span class="line">  activepython-3.5.4</span><br><span class="line">  activepython-3.6.0</span><br><span class="line">  anaconda-1.4.0</span><br><span class="line">  anaconda-1.5.0</span><br><span class="line">  anaconda-1.5.1</span><br><span class="line">  anaconda-1.6.0</span><br><span class="line">  anaconda-1.6.1</span><br><span class="line">  anaconda-1.7.0</span><br><span class="line">  anaconda-1.8.0</span><br><span class="line">  anaconda-1.9.0</span><br><span class="line">  anaconda-1.9.1</span><br><span class="line">  anaconda-1.9.2</span><br><span class="line">  anaconda-2.0.0</span><br><span class="line">  anaconda-2.0.1</span><br><span class="line">  anaconda-2.1.0</span><br><span class="line">  anaconda-2.2.0</span><br><span class="line">  anaconda-2.3.0</span><br><span class="line">  anaconda-2.4.0</span><br><span class="line">  anaconda-4.0.0</span><br><span class="line">  anaconda2-2.4.0</span><br><span class="line">  anaconda2-2.4.1</span><br><span class="line">  anaconda2-2.5.0</span><br><span class="line">  anaconda2-4.0.0</span><br><span class="line">  anaconda2-4.1.0</span><br><span class="line">  anaconda2-4.1.1</span><br><span class="line">  anaconda2-4.2.0</span><br><span class="line">  anaconda2-4.3.0</span><br><span class="line">  anaconda2-4.3.1</span><br><span class="line">  anaconda2-4.4.0</span><br><span class="line">  anaconda2-5.0.0</span><br><span class="line">  anaconda2-5.0.1</span><br><span class="line">  anaconda2-5.1.0</span><br><span class="line">  anaconda2-5.2.0</span><br><span class="line">  anaconda2-5.3.0</span><br><span class="line">  anaconda3-2.0.0</span><br><span class="line">  anaconda3-2.0.1</span><br><span class="line">  anaconda3-2.1.0</span><br><span class="line">  anaconda3-2.2.0</span><br><span class="line">  anaconda3-2.3.0</span><br><span class="line">  anaconda3-2.4.0</span><br><span class="line">  anaconda3-2.4.1</span><br><span class="line">  anaconda3-2.5.0</span><br><span class="line">  anaconda3-4.0.0</span><br><span class="line">  anaconda3-4.1.0</span><br><span class="line">  anaconda3-4.1.1</span><br><span class="line">  anaconda3-4.2.0</span><br><span class="line">  anaconda3-4.3.0</span><br><span class="line">  anaconda3-4.3.1</span><br><span class="line">  anaconda3-4.4.0</span><br><span class="line">  anaconda3-5.0.0</span><br><span class="line">  anaconda3-5.0.1</span><br><span class="line">  anaconda3-5.1.0</span><br><span class="line">  anaconda3-5.2.0</span><br><span class="line">  anaconda3-5.3.0</span><br><span class="line">  ironpython-dev</span><br><span class="line">  ironpython-2.7.4</span><br><span class="line">  ironpython-2.7.5</span><br><span class="line">  ironpython-2.7.6.3</span><br><span class="line">  ironpython-2.7.7</span><br><span class="line">  jython-dev</span><br><span class="line">  jython-2.5.0</span><br><span class="line">  jython-2.5-dev</span><br><span class="line">  jython-2.5.1</span><br><span class="line">  jython-2.5.2</span><br><span class="line">  jython-2.5.3</span><br><span class="line">  jython-2.5.4-rc1</span><br><span class="line">  jython-2.7.0</span><br><span class="line">  jython-2.7.1</span><br><span class="line">  micropython-dev</span><br><span class="line">  micropython-1.9.3</span><br><span class="line">  micropython-1.9.4</span><br><span class="line">  miniconda-latest</span><br><span class="line">  miniconda-2.2.2</span><br><span class="line">  miniconda-3.0.0</span><br><span class="line">  miniconda-3.0.4</span><br><span class="line">  miniconda-3.0.5</span><br><span class="line">  miniconda-3.3.0</span><br><span class="line">  miniconda-3.4.2</span><br><span class="line">  miniconda-3.7.0</span><br><span class="line">  miniconda-3.8.3</span><br><span class="line">  miniconda-3.9.1</span><br><span class="line">  miniconda-3.10.1</span><br><span class="line">  miniconda-3.16.0</span><br><span class="line">  miniconda-3.18.3</span><br><span class="line">  miniconda2-latest</span><br><span class="line">  miniconda2-3.18.3</span><br><span class="line">  miniconda2-3.19.0</span><br><span class="line">  miniconda2-4.0.5</span><br><span class="line">  miniconda2-4.1.11</span><br><span class="line">  miniconda2-4.3.14</span><br><span class="line">  miniconda2-4.3.21</span><br><span class="line">  miniconda2-4.3.27</span><br><span class="line">  miniconda2-4.3.30</span><br><span class="line">  miniconda3-latest</span><br><span class="line">  miniconda3-2.2.2</span><br><span class="line">  miniconda3-3.0.0</span><br><span class="line">  miniconda3-3.0.4</span><br><span class="line">  miniconda3-3.0.5</span><br><span class="line">  miniconda3-3.3.0</span><br><span class="line">  miniconda3-3.4.2</span><br><span class="line">  miniconda3-3.7.0</span><br><span class="line">  miniconda3-3.8.3</span><br><span class="line">  miniconda3-3.9.1</span><br><span class="line">  miniconda3-3.10.1</span><br><span class="line">  miniconda3-3.16.0</span><br><span class="line">  miniconda3-3.18.3</span><br><span class="line">  miniconda3-3.19.0</span><br><span class="line">  miniconda3-4.0.5</span><br><span class="line">  miniconda3-4.1.11</span><br><span class="line">  miniconda3-4.2.12</span><br><span class="line">  miniconda3-4.3.11</span><br><span class="line">  miniconda3-4.3.14</span><br><span class="line">  miniconda3-4.3.21</span><br><span class="line">  miniconda3-4.3.27</span><br><span class="line">  miniconda3-4.3.30</span><br><span class="line">  pypy-c-jit-latest</span><br><span class="line">  pypy-c-nojit-latest</span><br><span class="line">  pypy-dev</span><br><span class="line">  pypy-stm-2.3</span><br><span class="line">  pypy-stm-2.5.1</span><br><span class="line">  pypy-1.5-src</span><br><span class="line">  pypy-1.5</span><br><span class="line">  pypy-1.6</span><br><span class="line">  pypy-1.7</span><br><span class="line">  pypy-1.8</span><br><span class="line">  pypy-1.9</span><br><span class="line">  pypy-2.0-src</span><br><span class="line">  pypy-2.0</span><br><span class="line">  pypy-2.0.1-src</span><br><span class="line">  pypy-2.0.1</span><br><span class="line">  pypy-2.0.2-src</span><br><span class="line">  pypy-2.0.2</span><br><span class="line">  pypy-2.1-src</span><br><span class="line">  pypy-2.1</span><br><span class="line">  pypy-2.2-src</span><br><span class="line">  pypy-2.2</span><br><span class="line">  pypy-2.2.1-src</span><br><span class="line">  pypy-2.2.1</span><br><span class="line">  pypy-2.3-src</span><br><span class="line">  pypy-2.3</span><br><span class="line">  pypy-2.3.1-src</span><br><span class="line">  pypy-2.3.1</span><br><span class="line">  pypy-2.4.0-src</span><br><span class="line">  pypy-2.4.0</span><br><span class="line">  pypy-2.5.0-src</span><br><span class="line">  pypy-2.5.0</span><br><span class="line">  pypy-2.5.1-src</span><br><span class="line">  pypy-2.5.1</span><br><span class="line">  pypy-2.6.0-src</span><br><span class="line">  pypy-2.6.0</span><br><span class="line">  pypy-2.6.1-src</span><br><span class="line">  pypy-2.6.1</span><br><span class="line">  pypy-4.0.0-src</span><br><span class="line">  pypy-4.0.0</span><br><span class="line">  pypy-4.0.1-src</span><br><span class="line">  pypy-4.0.1</span><br><span class="line">  pypy-5.0.0-src</span><br><span class="line">  pypy-5.0.0</span><br><span class="line">  pypy-5.0.1-src</span><br><span class="line">  pypy-5.0.1</span><br><span class="line">  pypy-5.1-src</span><br><span class="line">  pypy-5.1</span><br><span class="line">  pypy-5.1.1-src</span><br><span class="line">  pypy-5.1.1</span><br><span class="line">  pypy-5.3-src</span><br><span class="line">  pypy-5.3</span><br><span class="line">  pypy-5.3.1-src</span><br><span class="line">  pypy-5.3.1</span><br><span class="line">  pypy-5.4-src</span><br><span class="line">  pypy-5.4</span><br><span class="line">  pypy-5.4.1-src</span><br><span class="line">  pypy-5.4.1</span><br><span class="line">  pypy-5.6.0-src</span><br><span class="line">  pypy-5.6.0</span><br><span class="line">  pypy-5.7.0-src</span><br><span class="line">  pypy-5.7.0</span><br><span class="line">  pypy-5.7.1-src</span><br><span class="line">  pypy-5.7.1</span><br><span class="line">  pypy2-5.3-src</span><br><span class="line">  pypy2-5.3</span><br><span class="line">  pypy2-5.3.1-src</span><br><span class="line">  pypy2-5.3.1</span><br><span class="line">  pypy2-5.4-src</span><br><span class="line">  pypy2-5.4</span><br><span class="line">  pypy2-5.4.1-src</span><br><span class="line">  pypy2-5.4.1</span><br><span class="line">  pypy2-5.6.0-src</span><br><span class="line">  pypy2-5.6.0</span><br><span class="line">  pypy2-5.7.0-src</span><br><span class="line">  pypy2-5.7.0</span><br><span class="line">  pypy2-5.7.1-src</span><br><span class="line">  pypy2-5.7.1</span><br><span class="line">  pypy2.7-5.8.0-src</span><br><span class="line">  pypy2.7-5.8.0</span><br><span class="line">  pypy2.7-5.9.0-src</span><br><span class="line">  pypy2.7-5.9.0</span><br><span class="line">  pypy2.7-5.10.0-src</span><br><span class="line">  pypy2.7-5.10.0</span><br><span class="line">  pypy2.7-6.0.0-src</span><br><span class="line">  pypy2.7-6.0.0</span><br><span class="line">  pypy3-dev</span><br><span class="line">  pypy3-2.3.1-src</span><br><span class="line">  pypy3-2.3.1</span><br><span class="line">  pypy3-2.4.0-src</span><br><span class="line">  pypy3-2.4.0</span><br><span class="line">  pypy3.3-5.2-alpha1-src</span><br><span class="line">  pypy3.3-5.2-alpha1</span><br><span class="line">  pypy3.3-5.5-alpha-src</span><br><span class="line">  pypy3.3-5.5-alpha</span><br><span class="line">  pypy3.5-c-jit-latest</span><br><span class="line">  pypy3.5-5.7-beta-src</span><br><span class="line">  pypy3.5-5.7-beta</span><br><span class="line">  pypy3.5-5.7.1-beta-src</span><br><span class="line">  pypy3.5-5.7.1-beta</span><br><span class="line">  pypy3.5-5.8.0-src</span><br><span class="line">  pypy3.5-5.8.0</span><br><span class="line">  pypy3.5-5.9.0-src</span><br><span class="line">  pypy3.5-5.9.0</span><br><span class="line">  pypy3.5-5.10.0-src</span><br><span class="line">  pypy3.5-5.10.0</span><br><span class="line">  pypy3.5-5.10.1-src</span><br><span class="line">  pypy3.5-5.10.1</span><br><span class="line">  pypy3.5-6.0.0-src</span><br><span class="line">  pypy3.5-6.0.0</span><br><span class="line">  pyston-0.5.1</span><br><span class="line">  pyston-0.6.0</span><br><span class="line">  pyston-0.6.1</span><br><span class="line">  stackless-dev</span><br><span class="line">  stackless-2.7-dev</span><br><span class="line">  stackless-2.7.2</span><br><span class="line">  stackless-2.7.3</span><br><span class="line">  stackless-2.7.4</span><br><span class="line">  stackless-2.7.5</span><br><span class="line">  stackless-2.7.6</span><br><span class="line">  stackless-2.7.7</span><br><span class="line">  stackless-2.7.8</span><br><span class="line">  stackless-2.7.9</span><br><span class="line">  stackless-2.7.10</span><br><span class="line">  stackless-2.7.11</span><br><span class="line">  stackless-2.7.12</span><br><span class="line">  stackless-2.7.14</span><br><span class="line">  stackless-3.2.2</span><br><span class="line">  stackless-3.2.5</span><br><span class="line">  stackless-3.3.5</span><br><span class="line">  stackless-3.3.7</span><br><span class="line">  stackless-3.4-dev</span><br><span class="line">  stackless-3.4.1</span><br><span class="line">  stackless-3.4.2</span><br><span class="line">  stackless-3.4.7</span><br><span class="line">  stackless-3.5.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择 Python 所需版本 </span></span><br><span class="line">pyenv install 2.7.15</span><br><span class="line">pyenv install 3.6.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line">pyenv init</span><br><span class="line"><span class="comment"># Load pyenv automatically by appending</span></span><br><span class="line"><span class="comment"># the following to ~/.zshrc:</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span> <span class="string">"<span class="variable">$(pyenv init -)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启 zsh</span></span><br><span class="line"><span class="built_in">exec</span> <span class="string">"<span class="variable">$SHELL</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换版本</span></span><br><span class="line">pyenv global 2.7.15</span><br><span class="line">pyenv shell 3.6.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">pyenv versions</span><br><span class="line">  system</span><br><span class="line">  2.7.15</span><br><span class="line">* 3.6.7 (<span class="built_in">set</span> by PYENV_VERSION environment variable)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pyenv 常用的命令说明</span></span><br><span class="line"></span><br><span class="line"> 使用方式: pyenv &lt; 命令 & gt; [&lt; 参数 & gt;]</span><br><span class="line"></span><br><span class="line">命令:</span><br><span class="line">   commands    查看所有命令</span><br><span class="line">   <span class="built_in">local</span>       设置或显示本地的 Python 版本</span><br><span class="line">   global      设置或显示全局 Python 版本</span><br><span class="line">   shell       设置或显示 shell 指定的 Python 版本</span><br><span class="line">   install     安装指定 Python 版本</span><br><span class="line">   uninstall   卸载指定 Python 版本)</span><br><span class="line">   version     显示当前的 Python 版本及其本地路径</span><br><span class="line">   versions    查看所有已经安装的版本</span><br><span class="line">   <span class="built_in">which</span>       显示安装路径</span><br><span class="line"></span><br><span class="line">pyenv</span><br><span class="line">pyenv 1.2.8</span><br><span class="line">Usage: pyenv &lt;<span class="built_in">command</span>&gt; [&lt;args&gt;]</span><br><span class="line"></span><br><span class="line">Some useful pyenv commands are:</span><br><span class="line">   commands    List all available pyenv commands</span><br><span class="line">   <span class="built_in">local</span>       Set or show the <span class="built_in">local</span> application-specific Python version</span><br><span class="line">   global      Set or show the global Python version</span><br><span class="line">   shell       Set or show the shell-specific Python version</span><br><span class="line">   install     Install a Python version using python-build</span><br><span class="line">   uninstall   Uninstall a specific Python version</span><br><span class="line">   <span class="built_in">rehash</span>      Rehash pyenv shims (run this after installing executables)</span><br><span class="line">   version     Show the current Python version and its origin</span><br><span class="line">   versions    List all Python versions available to pyenv</span><br><span class="line">   <span class="built_in">which</span>       Display the full path to an executable</span><br><span class="line">   <span class="built_in">whence</span>      List all Python versions that contain the given executable</span><br><span class="line"></span><br><span class="line">See `pyenv <span class="built_in">help</span> &lt;<span class="built_in">command</span>&gt;<span class="string">'for information on a specific command.</span></span><br><span class="line"><span class="string">For full documentation, see: https://github.com/pyenv/pyenv#readme</span></span><br></pre></td></tr></table></figure><h2 id="Mac-中安装-PySpider"><a href="#Mac-中安装-PySpider" class="headerlink" title="Mac 中安装 PySpider"></a>Mac 中安装 PySpider</h2><blockquote><p>在 PySpider 支持 Python3.7 之前只能暂时降级 Python</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 pyenv 切换 python 版本</span></span><br><span class="line">brew install pyenv</span><br><span class="line">pyenv install 3.6.7</span><br><span class="line">pyenv shell 3.6.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 PySpider 虚拟环境</span></span><br><span class="line">mkdir pyspider</span><br><span class="line"><span class="built_in">cd</span> pyspider</span><br><span class="line">python -m venv venv</span><br><span class="line"><span class="built_in">source</span> venv/bin/active</span><br><span class="line">pip install pyspider</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装期间出现 SSL 或 pycurl 错误</span></span><br><span class="line">__main__.ConfigurationError: Curl is configured to use SSL, but we have not been able to determine <span class="built_in">which</span> SSL backend it is using. Please see PycURL documentation <span class="keyword">for</span> how to specify the SSL backend manually.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解决方法</span></span><br><span class="line">pip uninstall pycurl</span><br><span class="line"><span class="built_in">export</span> PYCURL_SSL_LIBRARY=openssl</span><br><span class="line"><span class="built_in">export</span> LDFLAGS=-L/usr/<span class="built_in">local</span>/opt/openssl/lib;<span class="built_in">export</span> CPPFLAGS=-I/usr/<span class="built_in">local</span>/opt/openssl/include;pip install pycurl --compile --no-cache-dir</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新安装并运行 pyspider</span></span><br><span class="line">pip install pyspider</span><br><span class="line"></span><br><span class="line">pyspider</span><br><span class="line">[W 181217 15:23:35 run:413] phantomjs not found, <span class="built_in">continue</span> running without it.</span><br><span class="line">[I 181217 15:23:37 result_worker:49] result_worker starting...</span><br><span class="line">[I 181217 15:23:37 processor:211] processor starting...</span><br><span class="line">[I 181217 15:23:37 tornado_fetcher:638] fetcher starting...</span><br><span class="line">[I 181217 15:23:37 scheduler:647] scheduler starting...</span><br><span class="line">[I 181217 15:23:37 scheduler:782] scheduler.xmlrpc listening on 127.0.0.1:23333</span><br><span class="line">[I 181217 15:23:37 scheduler:586] <span class="keyword">in</span> 5m: new:0,success:0,retry:0,failed:0</span><br><span class="line">[I 181217 15:23:37 app:76] webui running on 0.0.0.0:5000</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      macOS 使用 pyenv 安装和管理多个 Python 版本
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>tcpdump 抓包使用小结</title>
    <link href="https://wsgzao.github.io/post/tcpdump/"/>
    <id>https://wsgzao.github.io/post/tcpdump/</id>
    <published>2018-12-11T06:59:49.000Z</published>
    <updated>2018-12-17T09:16:34.056Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>tcpdump 是一个很常用的网络包分析工具，可以用来显示通过网络传输到本系统的 TCP/IP 以及其他网络的数据包。tcpdump 使用 libpcap 库来抓取网络报，这个库在几乎在所有的 Linux/Unix 中都有。在 Windows 中我们通常会使用 Wireshark 进行图形化操作相当便捷，然而在 Linux 环境中如何巧妙应用 tcpdump 的命令来操作提升效率就显得尤为重要。在本文中，我们将会通过一些实例来演示如何使用 tcpdump 命令。</p><blockquote><p>tcpdump 是一款灵活、功能强大的抓包工具，能有效地帮助排查网络故障问题。</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2018 年 12 月 11 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/tcpdump/">https://wsgzao.github.io/post/tcpdump/</a></p><p><strong> 扩展阅读 </strong></p><p>Wireshark - <a href="https://www.wireshark.org/#download" target="_blank" rel="noopener">https://www.wireshark.org/#download</a><br>tcpdump - <a href="http://www.tcpdump.org/" target="_blank" rel="noopener">http://www.tcpdump.org/</a><br>在 Linux 命令行中使用 tcpdump 抓包 - <a href="https://linux.cn/article-10191-1.html" target="_blank" rel="noopener">https://linux.cn/article-10191-1.html</a></p><hr><h2 id="tcpdump-简介"><a href="#tcpdump-简介" class="headerlink" title="tcpdump 简介"></a>tcpdump 简介</h2><blockquote><p>tcpdump, a powerful command-line packet analyzer; and libpcap, a portable C/C++ library for network traffic capture.</p></blockquote><p>Tcpdump prints out a description of the contents of packets on a network interface that match the boolean expression; the description is preceded by a time stamp, printed, by default, as hours, minutes, seconds, and fractions of a second since midnight. It can also be run with the -w flag, which causes it to save the packet data to a file for later analysis, and/or with the -r flag, which causes it to read from a saved packet file rather than to read packets from a network interface. It can also be run with the -V flag, which causes it to read a list of saved packet files. In all cases, only packets that match expression will be processed by tcpdump.</p><p>tcpdump 是一款用于截取网络分组，并过滤输出分组内容的工具。tcpdump 凭借强大的功能和灵活的截取策略，使其成为类 UNIX 系统下用于网络分析和问题排查的首选工具。 tcpdump 提供了源代码，公开了接口，因此具备很强的可扩展性，对于网络维护和入侵者都是非常有用的工具。tcpdump 存在于基本的 Linux 系统中，由于它需要将网络界面设置为混杂模式，普通用户不能正常执行，但具备 root 权限的用户可以直接执行它来获取网络上的信息。因此系统中存在网络分析工具主要不是对本机安全的威胁，而是对网络上的其他计算机的安全存在威胁。tcpdump 可以将网络中传送的数据包的 “头” 完全截获下来提供分析。它支持针对网络层、协议、主机、网络或端口的过滤，并提供 and、or、not 等逻辑语句来帮助我们去掉无用的信息。</p><h2 id="tcpdump-安装"><a href="#tcpdump-安装" class="headerlink" title="tcpdump 安装"></a>tcpdump 安装</h2><blockquote><p>tcpdump 默认在几乎所有的 Linux 发行版中都可用，但若你的 Linux 上没有的话，使用下面方法进行安装。</p></blockquote><p>CentOS/RHEL<br>使用下面命令在 CentOS 和 RHEL 上安装 tcpdump，</p><pre><code>sudo yum install tcpdump*</code></pre><p>Fedora<br>使用下面命令在 Fedora 上安装 tcpdump：</p><pre><code>dnf install tcpdump</code></pre><p>Ubuntu/Debian/Linux Mint<br>在 Ubuntu/Debain/Linux Mint 上使用下面命令安装 tcpdump：</p><pre><code>apt-get install tcpdump</code></pre><h2 id="tcpdump-常用命令解释"><a href="#tcpdump-常用命令解释" class="headerlink" title="tcpdump 常用命令解释"></a>tcpdump 常用命令解释</h2><p>tcpdump [ 选项 ] [ -c 数量 ] [ -i 网络接口 ] [ -w 文件名 ] [ 表达式 ]</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">man tcpdump</span><br><span class="line">...</span><br><span class="line">tcpdump [ -AbdDefhHIJKlLnNOpqStuUvxX<span class="comment"># ] [ -B buffer_size ]</span></span><br><span class="line">        [ -c count ]</span><br><span class="line">        [ -C file_size ] [ -G rotate_seconds ] [ -F file ]</span><br><span class="line">        [ -i interface ] [ -j tstamp_type ] [ -m module ] [ -M secret ]</span><br><span class="line">        [ --number ] [ -Q <span class="keyword">in</span>|out|inout ]</span><br><span class="line">        [ -r file ] [ -V file ] [ -s snaplen ] [ -T <span class="built_in">type</span> ] [ -w file ]</span><br><span class="line">        [ -W filecount ]</span><br><span class="line">        [ -E spi@ipaddr algo:secret,...  ]</span><br><span class="line">        [ -y datalinktype ] [ -z postrotate-command ] [ -Z user ]</span><br><span class="line">        [ --time-stamp-precision=tstamp_precision ]</span><br><span class="line">        [ --immediate-mode ] [ --version ]</span><br><span class="line">        [ expression ]</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">选项翻译如下： </span><br><span class="line"></span><br><span class="line">-l：使标准输出变为缓冲行形式；</span><br><span class="line">-c：抓包次数；</span><br><span class="line">-nn：直接以 IP 及 Port Number 显示，而非主机名与服务名称；</span><br><span class="line">-s ：&lt; 数据包大小 & gt; 设置每个数据包的大小；</span><br><span class="line">-i：指定监听的网络接口；</span><br><span class="line">-r：从指定的文件中读取包；</span><br><span class="line">-w：输出信息保存到指定文件；</span><br><span class="line">-a：将网络地址和广播地址转变成名字；</span><br><span class="line">-d：将匹配信息包的代码以人们能够理解的汇编格式给出；</span><br><span class="line">-e：在输出行打印出数据链路层的头部信息；</span><br><span class="line">-f：将外部的 Internet 地址以数字的形式打印出来；</span><br><span class="line">-t：在输出的每一行不打印时间戳；</span><br><span class="line">-v ：输出稍微详细的报文信息；--vv 则输出更详细信息。</span><br></pre></td></tr></table></figure><p>表达式指正则表达式，tcpdump 利用它作为过滤报文的条件，如果一个报文满足表达式的条件，则会捕获该报文。如果没有给出任何条件，则会截获网络上所有的信息包。<br>在表达式中一般有如下几种类型的关键字： </p><ol><li>关于类型的关键字： </li></ol><p>主要包括 host，net，port，例如 host 210.27.48.2， 指明 210.27.48.2 是一台主机，net 202.0.0.0 指明 202.0.0.0 是一个网络地址，port 23 指明端口号是 23。如果没有指定类型，缺省的类型是 host。</p><ol start="2"><li>确定传输方向的关键字： </li></ol><p>主要包括 src，dst，dst or src，dst and src， 这些关键字指明了传输的方向。举例说明，src 210.27.48.2 ，指明 ip 包中源地址是 210.27.48.2 ， dst net 202.0.0.0 指明目的网络地址是 202.0.0.0。如果没有指明 方向关键字，则缺省是 src or dst 关键字。</p><ol start="3"><li>协议的关键字：</li></ol><p>主要包括 fddi，ip，arp，rarp，tcp，udp 等类型。Fddi 指明是在 FDDI (分布式光纤数据接口网络) 上的特定的网络协议，实际上它是”ether” 的别名，fddi 和 ether 具有类似的源地址和目的地址，所以可以将 fddi 协议包当作 ether 的包进行处理和分析。 其他的几个关键字就是指明了监听的包的协议内容。如果没有指定任何协议，则 tcpdump 将会 监听所有协议的信息包。</p><ol start="4"><li>三种逻辑运算： </li></ol><p>与运算是’and’,’&amp;&amp;’; 或运算是’or’ ,’||’； 非运算是’not’ ‘!’</p><ol start="5"><li>其他重要的关键字：</li></ol><p>gateway, broadcast, less（小于）, greater（大于）</p><h2 id="tcpdump-命令演示"><a href="#tcpdump-命令演示" class="headerlink" title="tcpdump 命令演示"></a>tcpdump 命令演示</h2><p>从所有网卡中捕获数据包<br>运行下面命令来从所有网卡中捕获数据包：</p><pre><code>tcpdump -i any</code></pre><p>从指定网卡中捕获数据包<br>要从指定网卡中捕获数据包，运行：</p><pre><code>tcpdump -i eth0</code></pre><p>将捕获的包写入文件<br>使用 -w 选项将所有捕获的包写入文件：</p><pre><code>tcpdump -i eth1 -w packets_file</code></pre><p>读取之前产生的 tcpdump 文件<br>使用下面命令从之前创建的 tcpdump 文件中读取内容：</p><pre><code>tcpdump -r packets_file</code></pre><p>获取更多的包信息，并且以可读的形式显示时间戳<br>要获取更多的包信息同时以可读的形式显示时间戳，使用：</p><pre><code>tcpdump -ttttnnvvS</code></pre><p>查看整个网络的数据包<br>要获取整个网络的数据包，在终端执行下面命令：</p><pre><code>tcpdump net 192.168.1.0/24</code></pre><p>根据 IP 地址查看报文<br>要获取指定 IP 的数据包，不管是作为源地址还是目的地址，使用下面命令：</p><pre><code>tcpdump host 192.168.1.100</code></pre><p>要指定 IP 地址是源地址或是目的地址则使用：</p><pre><code>tcpdump src 192.168.1.100tcpdump dst 192.168.1.100</code></pre><p>查看某个协议或端口号的数据包<br>要查看某个协议的数据包，运行下面命令：</p><pre><code>tcpdump ssh</code></pre><p>要捕获某个端口或一个范围的数据包，使用：</p><pre><code>tcpdump port 22tcpdump portrange 22-125</code></pre><p>我们也可以与 src 和 dst 选项连用来捕获指定源端口或指定目的端口的报文。</p><p>我们还可以使用 “与” （and，&amp;&amp;）、“或” （or，|| ) 和 “非”（not，!） 来将两个条件组合起来。当我们需要基于某些条件来分析网络报文是非常有用。</p><p>使用 “与”<br>可以使用 and 或者符号 &amp;&amp; 来将两个或多个条件组合起来。比如：</p><pre><code>tcpdump src 192.168.1.100 &amp;&amp; port 22 -w ssh_packets</code></pre><p>使用 “或”<br>“或” 会检查是否匹配命令所列条件中的其中一条，像这样：</p><pre><code>tcpdump src 192.168.1.100 or dst 192.168.1.50 &amp;&amp; port 22 -w ssh_packetstcpdump port 443 or 80 -w http_packets</code></pre><p>使用 “非”<br>当我们想表达不匹配某项条件时可以使用 “非”，像这样：</p><pre><code>tcpdump -i eth0 src port not 22</code></pre><p>这会捕获 eth0 上除了 22 号端口的所有通讯。</p><h2 id="tcpdump-抓包实践"><a href="#tcpdump-抓包实践" class="headerlink" title="tcpdump 抓包实践"></a>tcpdump 抓包实践</h2><p>使用 tcpdump 抓包，需要管理员权限，因此下面的示例中绝大多数命令都是以 sudo 开头。</p><p>首先，先用 tcpdump -D 命令列出可以抓包的网络接口：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -D</span><br><span class="line">1.eth0</span><br><span class="line">2.virbr0</span><br><span class="line">3.eth1</span><br><span class="line">4.any (Pseudo-device that captures on all interfaces)</span><br><span class="line">5.lo [Loopback]</span><br></pre></td></tr></table></figure><p>如上所示，可以看到我的机器中所有可以抓包的网络接口。其中特殊接口 any 可用于抓取所有活动的网络接口的数据包。</p><p>我们就用如下命令先对 any 接口进行抓包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">09:56:18.293641 IP rhel75.localdomain.ssh &gt; 192.168.64.1.56322: Flags [P.], seq 3770820720:3770820916, ack 3503648727, win 309, options [nop,nop,TS val 76577898 ecr 510770929], length 196</span><br><span class="line">09:56:18.293794 IP 192.168.64.1.56322 &gt; rhel75.localdomain.ssh: Flags [.], ack 196, win 391, options [nop,nop,TS val 510771017 ecr 76577898], length 0</span><br><span class="line">09:56:18.295058 IP rhel75.59883 &gt; gateway.domain: 2486+ PTR? 1.64.168.192.in-addr.arpa. (43)</span><br><span class="line">09:56:18.310225 IP gateway.domain &gt; rhel75.59883: 2486 NXDomain* 0/1/0 (102)</span><br><span class="line">09:56:18.312482 IP rhel75.49685 &gt; gateway.domain: 34242+ PTR? 28.64.168.192.in-addr.arpa. (44)</span><br><span class="line">09:56:18.322425 IP gateway.domain &gt; rhel75.49685: 34242 NXDomain* 0/1/0 (103)</span><br><span class="line">09:56:18.323164 IP rhel75.56631 &gt; gateway.domain: 29904+ PTR? 1.122.168.192.in-addr.arpa. (44)</span><br><span class="line">09:56:18.323342 IP rhel75.localdomain.ssh &gt; 192.168.64.1.56322: Flags [P.], seq 196:584, ack 1, win 309, options [nop,nop,TS val 76577928 ecr 510771017], length 388</span><br><span class="line">09:56:18.323563 IP 192.168.64.1.56322 &gt; rhel75.localdomain.ssh: Flags [.], ack 584, win 411, options [nop,nop,TS val 510771047 ecr 76577928], length 0</span><br><span class="line">09:56:18.335569 IP gateway.domain &gt; rhel75.56631: 29904 NXDomain* 0/1/0 (103)</span><br><span class="line">09:56:18.336429 IP rhel75.44007 &gt; gateway.domain: 61677+ PTR? 98.122.168.192.in-addr.arpa. (45)</span><br><span class="line">09:56:18.336655 IP gateway.domain &gt; rhel75.44007: 61677* 1/0/0 PTR rhel75. (65)</span><br><span class="line">09:56:18.337177 IP rhel75.localdomain.ssh &gt; 192.168.64.1.56322: Flags [P.], seq 584:1644, ack 1, win 309, options [nop,nop,TS val 76577942 ecr 510771047], length 1060</span><br><span class="line">---- SKIPPING LONG OUTPUT -----</span><br><span class="line">09:56:19.342939 IP 192.168.64.1.56322 &gt; rhel75.localdomain.ssh: Flags [.], ack 1752016, win 1444, options [nop,nop,TS val 510772067 ecr 76578948], length 0</span><br><span class="line">^C</span><br><span class="line">9003 packets captured</span><br><span class="line">9010 packets received by filter</span><br><span class="line">7 packets dropped by kernel</span><br><span class="line">$</span><br></pre></td></tr></table></figure><p>tcpdump 会持续抓包直到收到中断信号。你可以按 Ctrl+C 来停止抓包。正如上面示例所示，tcpdump 抓取了超过 9000 个数据包。在这个示例中，由于我是通过 ssh 连接到服务器，所以 tcpdump 也捕获了所有这类数据包。-c 选项可以用于限制 tcpdump 抓包的数量：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c 5</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">11:21:30.242740 IP rhel75.localdomain.ssh &gt; 192.168.64.1.56322: Flags [P.], seq 3772575680:3772575876, ack 3503651743, win 309, options [nop,nop,TS val 81689848 ecr 515883153], length 196</span><br><span class="line">11:21:30.242906 IP 192.168.64.1.56322 &gt; rhel75.localdomain.ssh: Flags [.], ack 196, win 1443, options [nop,nop,TS val 515883235 ecr 81689848], length 0</span><br><span class="line">11:21:30.244442 IP rhel75.43634 &gt; gateway.domain: 57680+ PTR? 1.64.168.192.in-addr.arpa. (43)</span><br><span class="line">11:21:30.244829 IP gateway.domain &gt; rhel75.43634: 57680 NXDomain 0/0/0 (43)</span><br><span class="line">11:21:30.247048 IP rhel75.33696 &gt; gateway.domain: 37429+ PTR? 28.64.168.192.in-addr.arpa. (44)</span><br><span class="line">5 packets captured</span><br><span class="line">12 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line">$</span><br></pre></td></tr></table></figure><p>如上所示，tcpdump 在抓取 5 个数据包后自动停止了抓包。这在有些场景中十分有用 —— 比如你只需要抓取少量的数据包用于分析。当我们需要使用过滤规则抓取特定的数据包（如下所示）时，-c 的作用就十分突出了。</p><p>在上面示例中，tcpdump 默认是将 IP 地址和端口号解析为对应的接口名以及服务协议名称。而通常在网络故障排查中，使用 IP 地址和端口号更便于分析问题；用 -n 选项显示 IP 地址，-nn 选项显示端口号：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c5 -nn</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">23:56:24.292206 IP 192.168.64.28.22 &gt; 192.168.64.1.35110: Flags [P.], seq 166198580:166198776, ack 2414541257, win 309, options [nop,nop,TS val 615664 ecr 540031155], length 196</span><br><span class="line">23:56:24.292357 IP 192.168.64.1.35110 &gt; 192.168.64.28.22: Flags [.], ack 196, win 1377, options [nop,nop,TS val 540031229 ecr 615664], length 0</span><br><span class="line">23:56:24.292570 IP 192.168.64.28.22 &gt; 192.168.64.1.35110: Flags [P.], seq 196:568, ack 1, win 309, options [nop,nop,TS val 615664 ecr 540031229], length 372</span><br><span class="line">23:56:24.292655 IP 192.168.64.1.35110 &gt; 192.168.64.28.22: Flags [.], ack 568, win 1400, options [nop,nop,TS val 540031229 ecr 615664], length 0</span><br><span class="line">23:56:24.292752 IP 192.168.64.28.22 &gt; 192.168.64.1.35110: Flags [P.], seq 568:908, ack 1, win 309, options [nop,nop,TS val 615664 ecr 540031229], length 340</span><br><span class="line">5 packets captured</span><br><span class="line">6 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure><p>如上所示，抓取的数据包中显示 IP 地址和端口号。这样还可以阻止 tcpdump 发出 DNS 查找，有助于在网络故障排查中减少数据流量。</p><p>现在你已经会抓包了，让我们来分析一下这些抓包输出的含义吧。</p><h3 id="理解抓取的报文"><a href="#理解抓取的报文" class="headerlink" title="理解抓取的报文"></a>理解抓取的报文</h3><p>tcpdump 能够抓取并解码多种协议类型的数据报文，如 TCP、UDP、ICMP 等等。虽然这里我们不可能介绍所有的数据报文类型，但可以分析下 TCP 类型的数据报文，来帮助你入门。更多有关 tcpdump 的详细介绍可以参考其 帮助手册。tcpdump 抓取的 TCP 报文看起来如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">08:41:13.729687 IP 192.168.64.28.22 &gt; 192.168.64.1.41916: Flags [P.], seq 196:568, ack 1, win 309, options [nop,nop,TS val 117964079 ecr 816509256], length 372</span><br></pre></td></tr></table></figure><p>具体的字段根据不同的报文类型会有不同，但上面这个例子是一般的格式形式。</p><p>第一个字段 08:41:13.729687 是该数据报文被抓取的系统本地时间戳。</p><p>然后，IP 是网络层协议类型，这里是 IPv4，如果是 IPv6 协议，该字段值是 IP6。</p><p>192.168.64.28.22 是源 ip 地址和端口号，紧跟其后的是目的 ip 地址和其端口号，这里是 192.168.64.1.41916。</p><p>在源 IP 和目的 IP 之后，可以看到是 TCP 报文标记段 Flags [P.]。该字段通常取值如下：</p><table><thead><tr><th>值</th><th>标志类型</th><th>描述</th></tr></thead><tbody><tr><td>S</td><td>SYN</td><td>Connection Start</td></tr><tr><td>F</td><td>FIN</td><td>Connection Finish</td></tr><tr><td>P</td><td>PUSH</td><td>Data push</td></tr><tr><td>R</td><td>RST</td><td>Connection reset</td></tr><tr><td>.</td><td>ACK</td><td>Acknowledgment</td></tr></tbody></table><p>该字段也可以是这些值的组合，例如 [S.] 代表 SYN-ACK 数据包。</p><p>接下来是该数据包中数据的序列号。对于抓取的第一个数据包，该字段值是一个绝对数字，后续包使用相对数值，以便更容易查询跟踪。例如此处 seq 196:568 代表该数据包包含该数据流的第 196 到 568 字节。</p><p>接下来是 ack 值：ack 1。该数据包是数据发送方，ack 值为 1。在数据接收方，该字段代表数据流上的下一个预期字节数据，例如，该数据流中下一个数据包的 ack 值应该是 568。</p><p>接下来字段是接收窗口大小 win 309，它表示接收缓冲区中可用的字节数，后跟 TCP 选项如 MSS（最大段大小）或者窗口比例值。更详尽的 TCP 协议内容请参考 Transmission Control Protocol(TCP) Parameters。</p><p>最后，length 372 代表数据包有效载荷字节长度。这个长度和 seq 序列号中字节数值长度是不一样的。</p><p>现在让我们学习如何过滤数据报文以便更容易的分析定位问题。</p><h3 id="过滤数据包"><a href="#过滤数据包" class="headerlink" title="过滤数据包"></a>过滤数据包</h3><p>正如上面所提，tcpdump 可以抓取很多种类型的数据报文，其中很多可能和我们需要查找的问题并没有关系。举个例子，假设你正在定位一个与 web 服务器连接的网络问题，就不必关系 SSH 数据报文，因此在抓包结果中过滤掉 SSH 报文可能更便于你分析问题。</p><p>tcpdump 有很多参数选项可以设置数据包过滤规则，例如根据源 IP 以及目的 IP 地址，端口号，协议等等规则来过滤数据包。下面就介绍一些最常用的过滤方法。</p><p>协议<br>在命令中指定协议便可以按照协议类型来筛选数据包。比方说用如下命令只要抓取 ICMP 报文：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c5 icmp</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">然后再打开一个终端，去 ping 另一台机器：</span><br><span class="line"></span><br><span class="line">$ ping opensource.com</span><br><span class="line">PING opensource.com (54.204.39.132) 56(84) bytes of data.</span><br><span class="line">64 bytes from ec2-54-204-39-132.compute-1.amazonaws.com (54.204.39.132): icmp_seq=1 ttl=47 time=39.6 ms</span><br><span class="line">回到运行 tcpdump 命令的终端中，可以看到它筛选出了 ICMP 报文。这里 tcpdump 并没有显示有关 opensource.com 的域名解析数据包：</span><br><span class="line"></span><br><span class="line">09:34:20.136766 IP rhel75 &gt; ec2-54-204-39-132.compute-1.amazonaws.com: ICMP <span class="built_in">echo</span> request, id 20361, seq 1, length 64</span><br><span class="line">09:34:20.176402 IP ec2-54-204-39-132.compute-1.amazonaws.com &gt; rhel75: ICMP <span class="built_in">echo</span> reply, id 20361, seq 1, length 64</span><br><span class="line">09:34:21.140230 IP rhel75 &gt; ec2-54-204-39-132.compute-1.amazonaws.com: ICMP <span class="built_in">echo</span> request, id 20361, seq 2, length 64</span><br><span class="line">09:34:21.180020 IP ec2-54-204-39-132.compute-1.amazonaws.com &gt; rhel75: ICMP <span class="built_in">echo</span> reply, id 20361, seq 2, length 64</span><br><span class="line">09:34:22.141777 IP rhel75 &gt; ec2-54-204-39-132.compute-1.amazonaws.com: ICMP <span class="built_in">echo</span> request, id 20361, seq 3, length 64</span><br><span class="line">5 packets captured</span><br><span class="line">5 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">主机 </span><br><span class="line"> 用 host 参数只抓取和特定主机相关的数据包：</span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">$ sudo tcpdump -i any -c5 -nn host 54.204.39.132</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">09:54:20.042023 IP 192.168.122.98.39326 &gt; 54.204.39.132.80: Flags [S], seq 1375157070, win 29200, options [mss 1460,sackOK,TS val 122350391 ecr 0,nop,wscale 7], length 0</span><br><span class="line">09:54:20.088127 IP 54.204.39.132.80 &gt; 192.168.122.98.39326: Flags [S.], seq 1935542841, ack 1375157071, win 28960, options [mss 1460,sackOK,TS val 522713542 ecr 122350391,nop,wscale 9], length 0</span><br><span class="line">09:54:20.088204 IP 192.168.122.98.39326 &gt; 54.204.39.132.80: Flags [.], ack 1, win 229, options [nop,nop,TS val 122350437 ecr 522713542], length 0</span><br><span class="line">09:54:20.088734 IP 192.168.122.98.39326 &gt; 54.204.39.132.80: Flags [P.], seq 1:113, ack 1, win 229, options [nop,nop,TS val 122350438 ecr 522713542], length 112: HTTP: GET / HTTP/1.1</span><br><span class="line">09:54:20.129733 IP 54.204.39.132.80 &gt; 192.168.122.98.39326: Flags [.], ack 113, win 57, options [nop,nop,TS val 522713552 ecr 122350438], length 0</span><br><span class="line">5 packets captured</span><br><span class="line">5 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line">如上所示，只抓取和显示与 54.204.39.132 有关的数据包。</span><br></pre></td></tr></table></figure><p>端口号<br>tcpdump 可以根据服务类型或者端口号来筛选数据包。例如，抓取和 HTTP 服务相关的数据包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c5 -nn port 80</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">09:58:28.790548 IP 192.168.122.98.39330 &gt; 54.204.39.132.80: Flags [S], seq 1745665159, win 29200, options [mss 1460,sackOK,TS val 122599140 ecr 0,nop,wscale 7], length 0</span><br><span class="line">09:58:28.834026 IP 54.204.39.132.80 &gt; 192.168.122.98.39330: Flags [S.], seq 4063583040, ack 1745665160, win 28960, options [mss 1460,sackOK,TS val 522775728 ecr 122599140,nop,wscale 9], length 0</span><br><span class="line">09:58:28.834093 IP 192.168.122.98.39330 &gt; 54.204.39.132.80: Flags [.], ack 1, win 229, options [nop,nop,TS val 122599183 ecr 522775728], length 0</span><br><span class="line">09:58:28.834588 IP 192.168.122.98.39330 &gt; 54.204.39.132.80: Flags [P.], seq 1:113, ack 1, win 229, options [nop,nop,TS val 122599184 ecr 522775728], length 112: HTTP: GET / HTTP/1.1</span><br><span class="line">09:58:28.878445 IP 54.204.39.132.80 &gt; 192.168.122.98.39330: Flags [.], ack 113, win 57, options [nop,nop,TS val 522775739 ecr 122599184], length 0</span><br><span class="line">5 packets captured</span><br><span class="line">5 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure><p>IP 地址 / 主机名<br>同样，你也可以根据源 IP 地址或者目的 IP 地址或者主机名来筛选数据包。例如抓取源 IP 地址为 192.168.122.98 的数据包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c5 -nn src 192.168.122.98</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">10:02:15.220824 IP 192.168.122.98.39436 &gt; 192.168.122.1.53: 59332+ A? opensource.com. (32)</span><br><span class="line">10:02:15.220862 IP 192.168.122.98.39436 &gt; 192.168.122.1.53: 20749+ AAAA? opensource.com. (32)</span><br><span class="line">10:02:15.364062 IP 192.168.122.98.39334 &gt; 54.204.39.132.80: Flags [S], seq 1108640533, win 29200, options [mss 1460,sackOK,TS val 122825713 ecr 0,nop,wscale 7], length 0</span><br><span class="line">10:02:15.409229 IP 192.168.122.98.39334 &gt; 54.204.39.132.80: Flags [.], ack 669337581, win 229, options [nop,nop,TS val 122825758 ecr 522832372], length 0</span><br><span class="line">10:02:15.409667 IP 192.168.122.98.39334 &gt; 54.204.39.132.80: Flags [P.], seq 0:112, ack 1, win 229, options [nop,nop,TS val 122825759 ecr 522832372], length 112: HTTP: GET / HTTP/1.1</span><br><span class="line">5 packets captured</span><br><span class="line">5 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line">注意此处示例中抓取了来自源 IP 地址 192.168.122.98 的 53 端口以及 80 端口的数据包，它们的应答包没有显示出来因为那些包的源 IP 地址已经变了。</span><br><span class="line"></span><br><span class="line">相对的，使用 dst 就是按目的 IP / 主机名来筛选数据包。</span><br><span class="line"></span><br><span class="line">$ sudo tcpdump -i any -c5 -nn dst 192.168.122.98</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">10:05:03.572931 IP 192.168.122.1.53 &gt; 192.168.122.98.47049: 2248 1/0/0 A 54.204.39.132 (48)</span><br><span class="line">10:05:03.572944 IP 192.168.122.1.53 &gt; 192.168.122.98.47049: 33770 0/0/0 (32)</span><br><span class="line">10:05:03.621833 IP 54.204.39.132.80 &gt; 192.168.122.98.39338: Flags [S.], seq 3474204576, ack 3256851264, win 28960, options [mss 1460,sackOK,TS val 522874425 ecr 122993922,nop,wscale 9], length 0</span><br><span class="line">10:05:03.667767 IP 54.204.39.132.80 &gt; 192.168.122.98.39338: Flags [.], ack 113, win 57, options [nop,nop,TS val 522874436 ecr 122993972], length 0</span><br><span class="line">10:05:03.672221 IP 54.204.39.132.80 &gt; 192.168.122.98.39338: Flags [P.], seq 1:643, ack 113, win 57, options [nop,nop,TS val 522874437 ecr 122993972], length 642: HTTP: HTTP/1.1 302 Found</span><br><span class="line">5 packets captured</span><br><span class="line">5 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure><p>多条件筛选<br>当然，可以使用多条件组合来筛选数据包，使用 and 以及 or 逻辑操作符来创建过滤规则。例如，筛选来自源 IP 地址 192.168.122.98 的 HTTP 数据包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c5 -nn src 192.168.122.98 and port 80</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">10:08:00.472696 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags [S], seq 2712685325, win 29200, options [mss 1460,sackOK,TS val 123170822 ecr 0,nop,wscale 7], length 0</span><br><span class="line">10:08:00.516118 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags [.], ack 268723504, win 229, options [nop,nop,TS val 123170865 ecr 522918648], length 0</span><br><span class="line">10:08:00.516583 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags [P.], seq 0:112, ack 1, win 229, options [nop,nop,TS val 123170866 ecr 522918648], length 112: HTTP: GET / HTTP/1.1</span><br><span class="line">10:08:00.567044 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags [.], ack 643, win 239, options [nop,nop,TS val 123170916 ecr 522918661], length 0</span><br><span class="line">10:08:00.788153 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags [F.], seq 112, ack 643, win 239, options [nop,nop,TS val 123171137 ecr 522918661], length 0</span><br><span class="line">5 packets captured</span><br><span class="line">5 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line">你也可以使用括号来创建更为复杂的过滤规则，但在 shell 中请用引号包含你的过滤规则以防止被识别为 shell 表达式：</span><br><span class="line"></span><br><span class="line">$ sudo tcpdump -i any -c5 -nn <span class="string">"port 80 and (src 192.168.122.98 or src 54.204.39.132)"</span></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">10:10:37.602214 IP 192.168.122.98.39346 &gt; 54.204.39.132.80: Flags [S], seq 871108679, win 29200, options [mss 1460,sackOK,TS val 123327951 ecr 0,nop,wscale 7], length 0</span><br><span class="line">10:10:37.650651 IP 54.204.39.132.80 &gt; 192.168.122.98.39346: Flags [S.], seq 854753193, ack 871108680, win 28960, options [mss 1460,sackOK,TS val 522957932 ecr 123327951,nop,wscale 9], length 0</span><br><span class="line">10:10:37.650708 IP 192.168.122.98.39346 &gt; 54.204.39.132.80: Flags [.], ack 1, win 229, options [nop,nop,TS val 123328000 ecr 522957932], length 0</span><br><span class="line">10:10:37.651097 IP 192.168.122.98.39346 &gt; 54.204.39.132.80: Flags [P.], seq 1:113, ack 1, win 229, options [nop,nop,TS val 123328000 ecr 522957932], length 112: HTTP: GET / HTTP/1.1</span><br><span class="line">10:10:37.692900 IP 54.204.39.132.80 &gt; 192.168.122.98.39346: Flags [.], ack 113, win 57, options [nop,nop,TS val 522957942 ecr 123328000], length 0</span><br><span class="line">5 packets captured</span><br><span class="line">5 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line">该例子中我们只抓取了来自源 IP 为 192.168.122.98 或者 54.204.39.132 的 HTTP （端口号 80）的数据包。使用该方法就很容易抓取到数据流中交互双方的数据包了。</span><br></pre></td></tr></table></figure><h3 id="检查数据包内容"><a href="#检查数据包内容" class="headerlink" title="检查数据包内容"></a>检查数据包内容</h3><p>在以上的示例中，我们只按数据包头部的信息来建立规则筛选数据包，例如源地址、目的地址、端口号等等。有时我们需要分析网络连接问题，可能需要分析数据包中的内容来判断什么内容需要被发送、什么内容需要被接收等。tcpdump 提供了两个选项可以查看数据包内容，-X 以十六进制打印出数据报文内容，-A 打印数据报文的 ASCII 值。</p><p>例如，HTTP 请求报文内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c10 -nn -A port 80</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">13:02:14.871803 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [S], seq 2546602048, win 29200, options [mss 1460,sackOK,TS val 133625221 ecr 0,nop,wscale 7], length 0</span><br><span class="line">E..&lt;..@.@.....zb6.<span class="string">'....P...@......r............</span></span><br><span class="line"><span class="string">............................</span></span><br><span class="line"><span class="string">13:02:14.910734 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags [S.], seq 1877348646, ack 2546602049, win 28960, options [mss 1460,sackOK,TS val 525532247 ecr 133625221,nop,wscale 9], length 0</span></span><br><span class="line"><span class="string">E..&lt;..@./..a6.'</span>...zb.P..o..&amp;...A..q a..........</span><br><span class="line">.R.W.......     ................</span><br><span class="line">13:02:14.910832 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [.], ack 1, win 229, options [nop,nop,TS val 133625260 ecr 525532247], length 0</span><br><span class="line">E..4..@.@.....zb6.<span class="string">'....P...Ao..'</span>...........</span><br><span class="line">.....R.W................</span><br><span class="line">13:02:14.911808 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [P.], seq 1:113, ack 1, win 229, options [nop,nop,TS val 133625261 ecr 525532247], length 112: HTTP: GET / HTTP/1.1</span><br><span class="line">E.....@.@..1..zb6.<span class="string">'....P...Ao..'</span>...........</span><br><span class="line">.....R.WGET / HTTP/1.1</span><br><span class="line">User-Agent: Wget/1.14 (linux-gnu)</span><br><span class="line">Accept: */*</span><br><span class="line">Host: opensource.com</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">................</span><br><span class="line">13:02:14.951199 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags [.], ack 113, win 57, options [nop,nop,TS val 525532257 ecr 133625261], length 0</span><br><span class="line">E..4.F@./..<span class="string">"6.'...zb.P..o..'.......9.2.....</span></span><br><span class="line"><span class="string">.R.a....................</span></span><br><span class="line"><span class="string">13:02:14.955030 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags [P.], seq 1:643, ack 113, win 57, options [nop,nop,TS val 525532258 ecr 133625261], length 642: HTTP: HTTP/1.1 302 Found</span></span><br><span class="line"><span class="string">E....G@./...6.'...zb.P..o..'.......9.......</span></span><br><span class="line"><span class="string">.R.b....HTTP/1.1 302 Found</span></span><br><span class="line"><span class="string">Server: nginx</span></span><br><span class="line"><span class="string">Date: Sun, 23 Sep 2018 17:02:14 GMT</span></span><br><span class="line"><span class="string">Content-Type: text/html; charset=iso-8859-1</span></span><br><span class="line"><span class="string">Content-Length: 207</span></span><br><span class="line"><span class="string">X-Content-Type-Options: nosniff</span></span><br><span class="line"><span class="string">Location: https://opensource.com/</span></span><br><span class="line"><span class="string">Cache-Control: max-age=1209600</span></span><br><span class="line"><span class="string">Expires: Sun, 07 Oct 2018 17:02:14 GMT</span></span><br><span class="line"><span class="string">X-Request-ID: v-6baa3acc-bf52-11e8-9195-22000ab8cf2d</span></span><br><span class="line"><span class="string">X-Varnish: 632951979</span></span><br><span class="line"><span class="string">Age: 0</span></span><br><span class="line"><span class="string">Via: 1.1 varnish (Varnish/5.2)</span></span><br><span class="line"><span class="string">X-Cache: MISS</span></span><br><span class="line"><span class="string">Connection: keep-alive</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE HTML PUBLIC"</span>-//IETF//DTD HTML 2.0//EN<span class="string">"&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;302 Found&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;Found&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;The document has moved &lt;a href="</span>https://opensource.com/<span class="string">"&gt;here&lt;/a&gt;.&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">................</span></span><br><span class="line"><span class="string">13:02:14.955083 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [.], ack 643, win 239, options [nop,nop,TS val 133625304 ecr 525532258], length 0</span></span><br><span class="line"><span class="string">E..4..@.@.....zb6.'....P....o..............</span></span><br><span class="line"><span class="string">.....R.b................</span></span><br><span class="line"><span class="string">13:02:15.195524 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [F.], seq 113, ack 643, win 239, options [nop,nop,TS val 133625545 ecr 525532258], length 0</span></span><br><span class="line"><span class="string">E..4..@.@.....zb6.'....P....o..............</span></span><br><span class="line"><span class="string">.....R.b................</span></span><br><span class="line"><span class="string">13:02:15.236592 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags [F.], seq 643, ack 114, win 57, options [nop,nop,TS val 525532329 ecr 133625545], length 0</span></span><br><span class="line"><span class="string">E..4.H@./.. 6.'...zb.P..o..........9.I.....</span></span><br><span class="line"><span class="string">.R......................</span></span><br><span class="line"><span class="string">13:02:15.236656 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [.], ack 644, win 239, options [nop,nop,TS val 133625586 ecr 525532329], length 0</span></span><br><span class="line"><span class="string">E..4..@.@.....zb6.'....P....o..............</span></span><br><span class="line"><span class="string">.....R..................</span></span><br><span class="line"><span class="string">10 packets captured</span></span><br><span class="line"><span class="string">10 packets received by filter</span></span><br><span class="line"><span class="string">0 packets dropped by kernel</span></span><br></pre></td></tr></table></figure><p>这对定位一些普通 HTTP 调用 API 接口的问题很有用。当然如果是加密报文，这个输出也就没多大用了。</p><h3 id="保存抓包数据"><a href="#保存抓包数据" class="headerlink" title="保存抓包数据"></a>保存抓包数据</h3><p>tcpdump 提供了保存抓包数据的功能以便后续分析数据包。例如，你可以夜里让它在那里抓包，然后早上起来再去分析它。同样当有很多数据包时，显示过快也不利于分析，将数据包保存下来，更有利于分析问题。</p><p>使用 -w 选项来保存数据包而不是在屏幕上显示出抓取的数据包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tcpdump -i any -c10 -nn -w webserver.pcap port 80</span><br><span class="line">[sudo] password <span class="keyword">for</span> ricardo:</span><br><span class="line">tcpdump: listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes</span><br><span class="line">10 packets captured</span><br><span class="line">10 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br></pre></td></tr></table></figure><p>该命令将抓取的数据包保存到文件 webserver.pcap。后缀名 pcap 表示文件是抓取的数据包格式。</p><p>正如示例中所示，保存数据包到文件中时屏幕上就没有任何有关数据报文的输出，其中 -c10 表示抓取到 10 个数据包后就停止抓包。如果想有一些反馈来提示确实抓取到了数据包，可以使用 -v 选项。</p><p>tcpdump 将数据包保存在二进制文件中，所以不能简单的用文本编辑器去打开它。使用 -r 选项参数来阅读该文件中的报文内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nn -r webserver.pcap</span><br><span class="line">reading from file webserver.pcap, link-type LINUX_SLL (Linux cooked)</span><br><span class="line">13:36:57.679494 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags [S], seq 3709732619, win 29200, options [mss 1460,sackOK,TS val 135708029 ecr 0,nop,wscale 7], length 0</span><br><span class="line">13:36:57.718932 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [S.], seq 1999298316, ack 3709732620, win 28960, options [mss 1460,sackOK,TS val 526052949 ecr 135708029,nop,wscale 9], length 0</span><br><span class="line">13:36:57.719005 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags [.], ack 1, win 229, options [nop,nop,TS val 135708068 ecr 526052949], length 0</span><br><span class="line">13:36:57.719186 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags [P.], seq 1:113, ack 1, win 229, options [nop,nop,TS val 135708068 ecr 526052949], length 112: HTTP: GET / HTTP/1.1</span><br><span class="line">13:36:57.756979 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [.], ack 113, win 57, options [nop,nop,TS val 526052959 ecr 135708068], length 0</span><br><span class="line">13:36:57.760122 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [P.], seq 1:643, ack 113, win 57, options [nop,nop,TS val 526052959 ecr 135708068], length 642: HTTP: HTTP/1.1 302 Found</span><br><span class="line">13:36:57.760182 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags [.], ack 643, win 239, options [nop,nop,TS val 135708109 ecr 526052959], length 0</span><br><span class="line">13:36:57.977602 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags [F.], seq 113, ack 643, win 239, options [nop,nop,TS val 135708327 ecr 526052959], length 0</span><br><span class="line">13:36:58.022089 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [F.], seq 643, ack 114, win 57, options [nop,nop,TS val 526053025 ecr 135708327], length 0</span><br><span class="line">13:36:58.022132 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags [.], ack 644, win 239, options [nop,nop,TS val 135708371 ecr 526053025], length 0</span><br><span class="line">$</span><br></pre></td></tr></table></figure><p>这里不需要管理员权限 sudo 了，因为此刻并不是在网络接口处抓包。</p><p>你还可以使用我们讨论过的任何过滤规则来过滤文件中的内容，就像使用实时数据一样。 例如，通过执行以下命令从源 IP 地址 54.204.39.132 检查文件中的数据包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nn -r webserver.pcap src 54.204.39.132</span><br><span class="line">reading from file webserver.pcap, link-type LINUX_SLL (Linux cooked)</span><br><span class="line">13:36:57.718932 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [S.], seq 1999298316, ack 3709732620, win 28960, options [mss 1460,sackOK,TS val 526052949 ecr 135708029,nop,wscale 9], length 0</span><br><span class="line">13:36:57.756979 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [.], ack 113, win 57, options [nop,nop,TS val 526052959 ecr 135708068], length 0</span><br><span class="line">13:36:57.760122 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [P.], seq 1:643, ack 113, win 57, options [nop,nop,TS val 526052959 ecr 135708068], length 642: HTTP: HTTP/1.1 302 Found</span><br><span class="line">13:36:58.022089 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags [F.], seq 643, ack 114, win 57, options [nop,nop,TS val 526053025 ecr 135708327], length 0</span><br></pre></td></tr></table></figure><h2 id="下一步做什么？"><a href="#下一步做什么？" class="headerlink" title="下一步做什么？"></a>下一步做什么？</h2><p>以上的基本功能已经可以帮助你使用强大的 tcpdump 抓包工具了。更多的内容请参考 tcpdump 网站以及它的帮助文件。</p><p><a href="https://hackertarget.com/tcpdump-examples/" target="_blank" rel="noopener">https://hackertarget.com/tcpdump-examples/</a></p><p>tcpdump 命令行工具为分析网络流量数据包提供了强大的灵活性。如果需要使用图形工具来抓包请参考 Wireshark。</p><p>Wireshark 还可以用来读取 tcpdump 保存的 pcap 文件。你可以使用 tcpdump 命令行在没有 GUI 界面的远程机器上抓包然后在 Wireshark 中分析数据包。</p><p>一站式学习 Wireshark<br><a href="https://community.emc.com/thread/194901" target="_blank" rel="noopener">https://community.emc.com/thread/194901</a><br><a href="https://www.w3cschool.cn/wireshark/" target="_blank" rel="noopener">https://www.w3cschool.cn/wireshark/</a></p>]]></content>
    
    <summary type="html">
    
      tcpdump 是一款灵活、功能强大的抓包工具，能有效地帮助排查网络故障问题。
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Zabbix MySQL Database Partitioning 表分区优化</title>
    <link href="https://wsgzao.github.io/post/zabbix-mysql-partition/"/>
    <id>https://wsgzao.github.io/post/zabbix-mysql-partition/</id>
    <published>2018-12-02T06:59:49.000Z</published>
    <updated>2018-12-03T08:26:22.049Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Zabbix 默认会启用 housekeeping 功能用于清理 history/trend 等历史数据，当监控服务器数量增加，保留时间有要求的情况下，housekeeping 的清理策略就会造成 Zabbix Server 性能下降，比如查询历史监控数据等。Zabbix 官方的建议是直接在数据库按照时间唯独创建分区表并定时清理，好处自然就是减少 Zabbix Server 的负担提升 Zabbix 应用对于数据库读写性能。Zabbix 3.4 之后的版本增加了对 Elasticsearch 的支持，个人也非常推荐大家尝试。</p><blockquote><p>Zabbix MySQL Database Partitioning 表分区优化禁用 housekeeping 提升历史数据清理性能</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2018 年 12 月 02 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/zabbix-mysql-partition/">https://wsgzao.github.io/post/zabbix-mysql-partition/</a></p><p><strong> 扩展阅读 </strong></p><p>MySQL Database Partitioning - <a href="https://www.zabbix.org/wiki/Docs/howto/mysql_partition" target="_blank" rel="noopener">https://www.zabbix.org/wiki/Docs/howto/mysql_partition</a></p><hr><h2 id="禁用-housekeeping"><a href="#禁用-housekeeping" class="headerlink" title="禁用 housekeeping"></a>禁用 housekeeping</h2><blockquote><p>Zabbix 2.2+ 版本请直接通过 UI 界面禁用 housekeeping</p></blockquote><p>Zabbix UI in the “Administration” -&gt; “General” section. Make sure you select “Housekeeping” in the drop-down in the upper right. </p><ul><li>Make sure that the checkboxes with the title “Enable internal housekeeping” are unchecked for both History and Trends.</li><li>Make sure that the checkboxes with the title “Override item &lt;trend/history&gt; period” are checked for both History and Trends.</li><li>Set the “Data storage period (in days)” box for history and trends to the amount of time you are retaining both. In the examples that were given, the correct values are 28 and 730 (as seen in the screenshot).</li></ul><h2 id="创建存储过程"><a href="#创建存储过程" class="headerlink" title="创建存储过程"></a>创建存储过程</h2><p>Zabbix 数据库优化</p><p>目的: 快速清理历史数据，并减少数据存储容量<br>方法: 历史表使用分区表 (删除分区表速度快)<br>Zabbix 版本: 3.2 + 以上版本，其它版本需要创建 Index 索引，请参考官方文档<br>涉及表项: 存储不同类型 item 的历史数据，最终 1 小时或者 1 天等段时间的绘图数据从其中获取 history、history_log、history_str、history_text、history_uint，存储不同类型 item 的历史趋势数据，每隔一小时从历史数据中统计一次，并计算统计区间的平均值，最大值，最小值 trends、trends_uint</p><p>Alright, let’s go ahead and add the necessary stored procedures to the Zabbix database. These procedures are documented in the Documentation section if you want more details about how they work. This section is going to look a little messy, but don’t be intimidated. Just copy/paste each section of SQL code. Due to weirdness in how the output will look, I can’t really show the”mysql&gt;”prompts here. As long as you see”Query OK, 0 rows affected (0.00 sec)”after running each section AND make sure the”DELIMITER ;”SQL actually runs (sometimes you’ll have to press ENTER), you’ll be fine.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"># login mysql</span><br><span class="line">mysql -uroot -p</span><br><span class="line">zabbix</span><br><span class="line"></span><br><span class="line">mysql&gt; use zabbix;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show variables like '%dir%';</span><br><span class="line">+<span class="comment">-----------------------------------------+-------------------------------------+</span></span><br><span class="line">| Variable_name                           | Value                               |</span><br><span class="line">+<span class="comment">-----------------------------------------+-------------------------------------+</span></span><br><span class="line">| basedir                                 | /usr/                               |</span><br><span class="line">| binlog_direct_non_transactional_updates | OFF                                 |</span><br><span class="line">| character_sets_dir                      | /usr/share/percona-server/charsets/ |</span><br><span class="line">| datadir                                 | /var/lib/mysql/                     |</span><br><span class="line">| ignore_db_dirs                          |                                     |</span><br><span class="line">| innodb_data_home_dir                    |                                     |</span><br><span class="line">| innodb_log_group_home_dir               | ./                                  |</span><br><span class="line">| innodb_max_dirty_pages_pct              | 75.000000                           |</span><br><span class="line">| innodb_max_dirty_pages_pct_lwm          | 0.000000                            |</span><br><span class="line">| innodb_tmpdir                           |                                     |</span><br><span class="line">| innodb_undo_directory                   | ./                                  |</span><br><span class="line">| lc_messages_dir                         | /usr/share/percona-server/          |</span><br><span class="line">| plugin_dir                              | /usr/lib64/mysql/plugin/            |</span><br><span class="line">| slave_load_tmpdir                       | /tmp                                |</span><br><span class="line">| tmpdir                                  | /tmp                                |</span><br><span class="line">+<span class="comment">-----------------------------------------+-------------------------------------+</span></span><br><span class="line">15 rows in <span class="keyword">set</span> (<span class="number">0.07</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br><span class="line"><span class="keyword">SELECT</span> table_name <span class="keyword">AS</span> <span class="string">"Tables"</span>,</span><br><span class="line"><span class="keyword">round</span>(((data_length + index_length) / <span class="number">1024</span> / <span class="number">1024</span>), <span class="number">2</span>) <span class="string">"Size in MB"</span></span><br><span class="line"><span class="keyword">FROM</span> information_schema.TABLES</span><br><span class="line"><span class="keyword">WHERE</span> table_schema = <span class="string">'zabbix'</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (data_length + index_length) <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line">+<span class="comment">----------------------------+------------+</span></span><br><span class="line">| Tables                     | Size in MB |</span><br><span class="line">+<span class="comment">----------------------------+------------+</span></span><br><span class="line">| history                    |  545043.75 |</span><br><span class="line">| history_uint               |   44729.66 |</span><br><span class="line">| trends                     |   13500.41 |</span><br><span class="line">| trends_uint                |    1666.66 |</span><br><span class="line">| history_text               |     650.31 |</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Zabbix &gt; 3.2, history 30, Trends 300</span><br><span class="line"></span><br><span class="line">#cat partition.sql</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`partition_create`</span>(SCHEMANAME <span class="built_in">varchar</span>(<span class="number">64</span>), TABLENAME <span class="built_in">varchar</span>(<span class="number">64</span>), PARTITIONNAME <span class="built_in">varchar</span>(<span class="number">64</span>), CLOCK <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           SCHEMANAME = The DB schema in which to make changes</span></span><br><span class="line"><span class="comment">           TABLENAME = The table with partitions to potentially delete</span></span><br><span class="line"><span class="comment">           PARTITIONNAME = The name of the partition to create</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Verify that the partition does not already exist</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">DECLARE</span> RETROWS <span class="built_in">INT</span>;</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="number">1</span>) <span class="keyword">INTO</span> RETROWS</span><br><span class="line">        <span class="keyword">FROM</span> information_schema.partitions</span><br><span class="line">        <span class="keyword">WHERE</span> table_schema = SCHEMANAME <span class="keyword">AND</span> table_name = TABLENAME <span class="keyword">AND</span> partition_description &gt;= CLOCK;</span><br><span class="line"></span><br><span class="line">        IF RETROWS = 0 THEN</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   1. Print a message indicating that a partition was created.</span></span><br><span class="line"><span class="comment">                   2. Create the SQL to create the partition.</span></span><br><span class="line"><span class="comment">                   3. Execute the SQL from #2.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>( <span class="string">"partition_create("</span>, SCHEMANAME, <span class="string">","</span>, TABLENAME, <span class="string">","</span>, PARTITIONNAME, <span class="string">","</span>, CLOCK, <span class="string">")"</span> ) <span class="keyword">AS</span> msg;</span><br><span class="line">                <span class="keyword">SET</span> @<span class="keyword">sql</span> = <span class="keyword">CONCAT</span>( <span class="string">'ALTER TABLE'</span>, SCHEMANAME, <span class="string">'.'</span>, TABLENAME, <span class="string">'ADD PARTITION (PARTITION'</span>, PARTITIONNAME, <span class="string">'VALUES LESS THAN ('</span>, CLOCK, <span class="string">'));'</span> );</span><br><span class="line">                <span class="keyword">PREPARE</span> STMT <span class="keyword">FROM</span> @<span class="keyword">sql</span>;</span><br><span class="line">                <span class="keyword">EXECUTE</span> STMT;</span><br><span class="line">                <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> STMT;</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`partition_drop`</span>(SCHEMANAME <span class="built_in">VARCHAR</span>(<span class="number">64</span>), TABLENAME <span class="built_in">VARCHAR</span>(<span class="number">64</span>), DELETE_BELOW_PARTITION_DATE <span class="built_in">BIGINT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           SCHEMANAME = The DB schema in which to make changes</span></span><br><span class="line"><span class="comment">           TABLENAME = The table with partitions to potentially delete</span></span><br><span class="line"><span class="comment">           DELETE_BELOW_PARTITION_DATE = Delete any partitions with names that are dates older than this one (yyyy-mm-dd)</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">DECLARE</span> done <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span>;</span><br><span class="line">        <span class="keyword">DECLARE</span> drop_part_name <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Get a list of all the partitions that are older than the date</span></span><br><span class="line"><span class="comment">           in DELETE_BELOW_PARTITION_DATE.  All partitions are prefixed with</span></span><br><span class="line"><span class="comment">           a "p", so use SUBSTRING TO get rid of that character.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">DECLARE</span> myCursor <span class="keyword">CURSOR</span> <span class="keyword">FOR</span></span><br><span class="line">                <span class="keyword">SELECT</span> partition_name</span><br><span class="line">                <span class="keyword">FROM</span> information_schema.partitions</span><br><span class="line">                <span class="keyword">WHERE</span> table_schema = SCHEMANAME <span class="keyword">AND</span> table_name = TABLENAME <span class="keyword">AND</span> <span class="keyword">CAST</span>(<span class="keyword">SUBSTRING</span>(partition_name <span class="keyword">FROM</span> <span class="number">2</span>) <span class="keyword">AS</span> <span class="keyword">UNSIGNED</span>) &lt; DELETE_BELOW_PARTITION_DATE;</span><br><span class="line">        <span class="keyword">DECLARE</span> CONTINUE <span class="keyword">HANDLER</span> <span class="keyword">FOR</span> <span class="keyword">NOT</span> <span class="keyword">FOUND</span> <span class="keyword">SET</span> done = <span class="literal">TRUE</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Create the basics for when we need to drop the partition.  Also, create</span></span><br><span class="line"><span class="comment">           @drop_partitions to hold a comma-delimited list of all partitions that</span></span><br><span class="line"><span class="comment">           should be deleted.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">SET</span> @alter_header = <span class="keyword">CONCAT</span>(<span class="string">"ALTER TABLE"</span>, SCHEMANAME, <span class="string">"."</span>, TABLENAME, <span class="string">"DROP PARTITION"</span>);</span><br><span class="line">        <span class="keyword">SET</span> @drop_partitions = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           Start looping through all the partitions that are too old.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        OPEN myCursor;</span><br><span class="line">        read_loop: LOOP</span><br><span class="line">                FETCH myCursor INTO drop_part_name;</span><br><span class="line">                IF done THEN</span><br><span class="line">                        LEAVE read_loop;</span><br><span class="line">                <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line">                <span class="keyword">SET</span> @drop_partitions = <span class="keyword">IF</span>(@drop_partitions = <span class="string">""</span>, drop_part_name, <span class="keyword">CONCAT</span>(@drop_partitions, <span class="string">","</span>, drop_part_name));</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line">        IF @drop_partitions != ""THEN</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   1. Build the SQL to drop all the necessary partitions.</span></span><br><span class="line"><span class="comment">                   2. Run the SQL to drop the partitions.</span></span><br><span class="line"><span class="comment">                   3. Print out the table partitions that were deleted.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">SET</span> @full_sql = <span class="keyword">CONCAT</span>(@alter_header, @drop_partitions, <span class="string">";"</span>);</span><br><span class="line">                <span class="keyword">PREPARE</span> STMT <span class="keyword">FROM</span> @full_sql;</span><br><span class="line">                <span class="keyword">EXECUTE</span> STMT;</span><br><span class="line">                <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> STMT;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(SCHEMANAME, <span class="string">"."</span>, TABLENAME) <span class="keyword">AS</span> <span class="string">`table`</span>, @drop_partitions <span class="keyword">AS</span> <span class="string">`partitions_deleted`</span>;</span><br><span class="line">        ELSE</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   No partitions are being deleted, so print out"N/A"(Not applicable) to indicate</span></span><br><span class="line"><span class="comment">                   that no changes were made.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(SCHEMANAME, <span class="string">"."</span>, TABLENAME) <span class="keyword">AS</span> <span class="string">`table`</span>, <span class="string">"N/A"</span> <span class="keyword">AS</span> <span class="string">`partitions_deleted`</span>;</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`partition_maintenance`</span>(SCHEMA_NAME <span class="built_in">VARCHAR</span>(<span class="number">32</span>), TABLE_NAME <span class="built_in">VARCHAR</span>(<span class="number">32</span>), KEEP_DATA_DAYS <span class="built_in">INT</span>, HOURLY_INTERVAL <span class="built_in">INT</span>, CREATE_NEXT_INTERVALS <span class="built_in">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">DECLARE</span> OLDER_THAN_PARTITION_DATE <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> PARTITION_NAME <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> OLD_PARTITION_NAME <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> LESS_THAN_TIMESTAMP <span class="built_in">INT</span>;</span><br><span class="line">        <span class="keyword">DECLARE</span> CUR_TIME <span class="built_in">INT</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">CALL</span> partition_verify(SCHEMA_NAME, TABLE_NAME, HOURLY_INTERVAL);</span><br><span class="line">        <span class="keyword">SET</span> CUR_TIME = <span class="keyword">UNIX_TIMESTAMP</span>(<span class="keyword">DATE_FORMAT</span>(<span class="keyword">NOW</span>(), <span class="string">'%Y-%m-%d 00:00:00'</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SET</span> @__interval = <span class="number">1</span>;</span><br><span class="line">        create_loop: LOOP</span><br><span class="line">                IF @__interval &gt; CREATE_NEXT_INTERVALS THEN</span><br><span class="line">                        LEAVE create_loop;</span><br><span class="line">                <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">SET</span> LESS_THAN_TIMESTAMP = CUR_TIME + (HOURLY_INTERVAL * @__interval * <span class="number">3600</span>);</span><br><span class="line">                <span class="keyword">SET</span> PARTITION_NAME = FROM_UNIXTIME(CUR_TIME + HOURLY_INTERVAL * (@__interval - <span class="number">1</span>) * <span class="number">3600</span>, <span class="string">'p%Y%m%d%H00'</span>);</span><br><span class="line">                IF(PARTITION_NAME != OLD_PARTITION_NAME) THEN</span><br><span class="line">                        <span class="keyword">CALL</span> partition_create(SCHEMA_NAME, TABLE_NAME, PARTITION_NAME, LESS_THAN_TIMESTAMP);</span><br><span class="line">                <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line">                <span class="keyword">SET</span> @__interval=@__interval+<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">SET</span> OLD_PARTITION_NAME = PARTITION_NAME;</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SET</span> OLDER_THAN_PARTITION_DATE=<span class="keyword">DATE_FORMAT</span>(<span class="keyword">DATE_SUB</span>(<span class="keyword">NOW</span>(), <span class="built_in">INTERVAL</span> KEEP_DATA_DAYS <span class="keyword">DAY</span>), <span class="string">'%Y%m%d0000'</span>);</span><br><span class="line">        <span class="keyword">CALL</span> partition_drop(SCHEMA_NAME, TABLE_NAME, OLDER_THAN_PARTITION_DATE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> <span class="string">`partition_verify`</span>(SCHEMANAME <span class="built_in">VARCHAR</span>(<span class="number">64</span>), TABLENAME <span class="built_in">VARCHAR</span>(<span class="number">64</span>), HOURLYINTERVAL <span class="built_in">INT</span>(<span class="number">11</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">DECLARE</span> PARTITION_NAME <span class="built_in">VARCHAR</span>(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> RETROWS <span class="built_in">INT</span>(<span class="number">11</span>);</span><br><span class="line">        <span class="keyword">DECLARE</span> FUTURE_TIMESTAMP <span class="keyword">TIMESTAMP</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Check if any partitions exist for the given SCHEMANAME.TABLENAME.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="number">1</span>) <span class="keyword">INTO</span> RETROWS</span><br><span class="line">        <span class="keyword">FROM</span> information_schema.partitions</span><br><span class="line">        <span class="keyword">WHERE</span> table_schema = SCHEMANAME <span class="keyword">AND</span> table_name = TABLENAME <span class="keyword">AND</span> partition_name <span class="keyword">IS</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If partitions do not exist, go ahead and partition the table</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        IF RETROWS = 1 THEN</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Take the current date at 00:00:00 and add HOURLYINTERVAL to it.  This is the timestamp below which we will store values.</span></span><br><span class="line"><span class="comment">                 * We begin partitioning based on the beginning of a day.  This is because we don't want to generate a random partition</span></span><br><span class="line"><span class="comment">                 * that won't necessarily fall in line with the desired partition naming (ie: if the hour interval is 24 hours, we could</span></span><br><span class="line"><span class="comment">                 * end up creating a partition now named"p201403270600"when all other partitions will be like"p201403280000").</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">SET</span> FUTURE_TIMESTAMP = <span class="keyword">TIMESTAMPADD</span>(<span class="keyword">HOUR</span>, HOURLYINTERVAL, <span class="keyword">CONCAT</span>(<span class="keyword">CURDATE</span>(), <span class="string">" "</span>, <span class="string">'00:00:00'</span>));</span><br><span class="line">                <span class="keyword">SET</span> PARTITION_NAME = <span class="keyword">DATE_FORMAT</span>(<span class="keyword">CURDATE</span>(), <span class="string">'p%Y%m%d%H00'</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">-- Create the partitioning query</span></span><br><span class="line">                <span class="keyword">SET</span> @__PARTITION_SQL = <span class="keyword">CONCAT</span>(<span class="string">"ALTER TABLE "</span>, SCHEMANAME, <span class="string">"."</span>, TABLENAME, <span class="string">" PARTITION BY RANGE(`clock`)"</span>);</span><br><span class="line">                <span class="keyword">SET</span> @__PARTITION_SQL = <span class="keyword">CONCAT</span>(@__PARTITION_SQL, <span class="string">"(PARTITION "</span>, PARTITION_NAME, <span class="string">" VALUES LESS THAN ("</span>, <span class="keyword">UNIX_TIMESTAMP</span>(FUTURE_TIMESTAMP), <span class="string">"));"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">-- Run the partitioning query</span></span><br><span class="line">                <span class="keyword">PREPARE</span> STMT <span class="keyword">FROM</span> @__PARTITION_SQL;</span><br><span class="line">                <span class="keyword">EXECUTE</span> STMT;</span><br><span class="line">                <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> STMT;</span><br><span class="line">        <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span><span class="string">`partition_maintenance_all`</span>(SCHEMA_NAME <span class="built_in">VARCHAR</span>(<span class="number">32</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history_log'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history_str'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history_text'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'history_uint'</span>, <span class="number">30</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'trends'</span>, <span class="number">120</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line">               <span class="keyword">CALL</span> partition_maintenance(SCHEMA_NAME, <span class="string">'trends_uint'</span>, <span class="number">120</span>, <span class="number">24</span>, <span class="number">14</span>);</span><br><span class="line"><span class="keyword">END</span>$$</span><br></pre></td></tr></table></figure><p>There are four functions in the stored procedures:</p><ol><li>partition_create - This will create a partition on the given table in the given schema.</li><li>partition_drop - This will drop partitions older than the given timestamp on the given table in the given schema.</li><li>partition_maintenance - This function is what is called by users. It is responsible for parsing the given parameters and then creating/dropping partitions as needed.</li><li>partition_verify - Checks if partitioning is enabled on the given table in the given schema. If it is not enable, it creates a single partition.</li></ol><p>存储过程执行后将可以使用命令对想要分区的表进行表分区了，其中的参数我这里解释一下。</p><pre><code>CALL partition_maintenance(&apos;&lt;zabbix_db_name&gt;&apos;, &apos;&lt;table_name&gt;&apos;, &lt;days_to_keep_data&gt;, &lt;hourly_interval&gt;, &lt;num_future_intervals_to_create&gt;)</code></pre><p>这是举例：</p><pre><code>CALL partition_maintenance(zabbix, &apos;history_uint&apos;, 31, 24, 14);</code></pre><p>zabbix_db_name：库名<br>table_name：表名<br>days_to_keep_data：保存多少天的数据<br>hourly_interval：每隔多久生成一个分区<br>num_future_intervals_to_create：本次一共生成多少个分区</p><p>这个例子就是 history_uint 表最多保存 31 天的数据，每隔 24 小时生成一个分区，这次一共生成 14 个分区</p><p>这里可以将上面四个存储过程保存为一个文件，导入到数据库中，文件我稍后将会放在附件中，这里使用的命令是</p><pre><code>mysql -uzabbix -pzabbix zabbix &lt; partition_call.sql</code></pre><p>然后可以将 CALL 统一调用也做成一个文件</p><h2 id="创建定时任务"><a href="#创建定时任务" class="headerlink" title="创建定时任务"></a>创建定时任务</h2><ul><li>cronjob 里的脚本包括了建新表和删除旧表，用 mysql 的 procedure 控制，删除旧表可以释放空间</li><li>想要修改短一点，需要修改 procedure partition_maintenance_all 里规定的时间</li><li>我的做法是 Drop 旧 procedure 再创建新的</li></ul><ol><li>login mysql zabbix</li><li>DROP PROCEDURE IF EXISTS partition_maintenance_all</li><li>根据需要修改括号内第三列的时间，估计得改成 45 或者 30 了。每列的定义请参照最上面给的链接</li><li>再手动跑下 cronjob 内的那个指令就好</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">[root@sg-gop-10-65-200-90 mysql]<span class="comment"># grep -Ev '^$|#' /etc/zabbix/zabbix_server.conf</span></span><br><span class="line">LogFile=/var/<span class="built_in">log</span>/zabbix/zabbix_server.log</span><br><span class="line">LogFileSize=0</span><br><span class="line">PidFile=/var/run/zabbix/zabbix_server.pid</span><br><span class="line">SocketDir=/var/run/zabbix</span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br><span class="line">StartPollers=500</span><br><span class="line">StartPingers=50</span><br><span class="line">SNMPTrapperFile=/var/<span class="built_in">log</span>/snmptrap/snmptrap.log</span><br><span class="line">CacheSize=8G</span><br><span class="line">TrendCacheSize=1G</span><br><span class="line">Timeout=15</span><br><span class="line">AlertScriptsPath=/usr/lib/zabbix/alertscripts</span><br><span class="line">ExternalScripts=/usr/lib/zabbix/externalscripts</span><br><span class="line">LogSlowQueries=3000</span><br><span class="line"></span><br><span class="line">[root@sg-gop-10-65-200-90 percona-server.conf.d]<span class="comment"># grep -Ev '^$|#' /etc/percona-server.conf.d/mysqld.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line">max_connections=1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># import partition.sql</span></span><br><span class="line">mysql -u<span class="string">'zabbix'</span> -p<span class="string">'zabbix'</span> zabbix  &lt; partition.sql</span><br><span class="line"><span class="comment"># run</span></span><br><span class="line">nohup mysql -u<span class="string">'zabbix'</span> -p<span class="string">'zabbix'</span> <span class="string">'zabbix'</span> -e <span class="string">"CALL partition_maintenance_all('zabbix')"</span> &amp;&gt; /root/partition.log&amp;</span><br><span class="line">tail -f /root/partition.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看过程逻辑 </span></span><br><span class="line">show create procedure partition_maintenance_all \G;</span><br><span class="line"><span class="comment"># 删除存储过程 </span></span><br><span class="line">drop procedure <span class="keyword">if</span> exists partition_maintenance_all; </span><br><span class="line"><span class="comment"># 查看存储过程 </span></span><br><span class="line">show procedure status like <span class="string">'partition_maintenance%'</span> \G;</span><br><span class="line"><span class="comment"># 查看 </span></span><br><span class="line">show create table <span class="built_in">history</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># crontab</span></span><br><span class="line">[root@sg-gop-10-65-200-90 wangao]<span class="comment"># cat /etc/crontab</span></span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line"></span><br><span class="line"><span class="comment"># For details see man 4 crontabs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example of job definition:</span></span><br><span class="line"><span class="comment"># .---------------- minute (0 - 59)</span></span><br><span class="line"><span class="comment"># |  .------------- hour (0 - 23)</span></span><br><span class="line"><span class="comment"># |  |  .---------- day of month (1 - 31)</span></span><br><span class="line"><span class="comment"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span></span><br><span class="line"><span class="comment"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span></span><br><span class="line"><span class="comment"># |  |  |  |  |</span></span><br><span class="line"><span class="comment"># *  *  *  *  * user-name  command to be executed</span></span><br><span class="line"></span><br><span class="line">15 3 * * * root bash /opt/sa_scripts/zabbix_partitioning.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># create script</span></span><br><span class="line">[root@sg-gop-10-65-200-90 wangao]<span class="comment"># cat /opt/sa_scripts/zabbix_partitioning.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">user=<span class="string">'zabbix'</span></span><br><span class="line">password=<span class="string">'zabbix'</span></span><br><span class="line">database=<span class="string">'zabbix'</span></span><br><span class="line"></span><br><span class="line">mysql -u<span class="variable">$&#123;user&#125;</span> -p<span class="variable">$password</span> <span class="variable">$database</span> -e <span class="string">"CALL partition_maintenance_all('zabbix');"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mod</span></span><br><span class="line">chmod 755 /opt/sa_scripts/zabbix_partitioning.sh</span><br><span class="line">service crond restart</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="https://www.zabbix.org/wiki/Docs/howto/mysql_partition" target="_blank" rel="noopener">https://www.zabbix.org/wiki/Docs/howto/mysql_partition</a><br><a href="https://cloud.tencent.com/developer/article/1006301" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1006301</a><br><a href="https://wsgzao.github.io/post/zabbix-mysql-partition/">https://wsgzao.github.io/post/zabbix-mysql-partition/</a></p>]]></content>
    
    <summary type="html">
    
      Zabbix MySQL Database Partitioning 表分区优化禁用housekeeping提升历史数据清理性能
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Redis 主从同步配置实践</title>
    <link href="https://wsgzao.github.io/post/redis/"/>
    <id>https://wsgzao.github.io/post/redis/</id>
    <published>2018-11-29T06:59:49.000Z</published>
    <updated>2018-12-03T08:30:15.991Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Redis 是一个高性能的 key-value 数据库，作为一个典型的内存数据库，高速读写性能并支持数据持久化是大多数人选择 Redis 的原因，当然 Redis 也有很多局限，即使现在升级至 5.0 在技术圈仍有很多不同的声音。Redis 监控可以通过 Keepalived 结合简单的脚本实现，也可以基于 Redis Sentinel 监控，如果需要横向扩展使用 Codis 或许是更加成熟稳定的方案。</p><blockquote><p>Redis 主备同步配置实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2018 年 11 月 29 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/redis/">https://wsgzao.github.io/post/redis/</a></p><p><strong> 扩展阅读 </strong></p><p>Redis - <a href="https://redis.io/" target="_blank" rel="noopener">https://redis.io/</a></p><hr><h2 id="Redis-简介"><a href="#Redis-简介" class="headerlink" title="Redis 简介"></a>Redis 简介</h2><p>Redis is often referred as a <em>data structures</em> server. What this means is that Redis provides access to mutable data structures via a set of commands, which are sent using a <em>server-client</em> model with TCP sockets and a simple protocol. So different processes can query and modify the same data structures in a shared way.</p><p>Data structures implemented into Redis have a few special properties:</p><ul><li>Redis cares to store them on disk, even if they are always served and modified into the server memory. This means that Redis is fast, but that is also non-volatile.</li><li>Implementation of data structures stress on memory efficiency, so data structures inside Redis will likely use less memory compared to the same data structure modeled using an high level programming language.</li><li>Redis offers a number of features that are natural to find in a database, like replication, tunable levels of durability, cluster, high availability.</li></ul><p>Another good example is to think of Redis as a more complex version of memcached, where the operations are not just SETs and GETs, but operations to work with complex data types like Lists, Sets, ordered data structures, and so forth.</p><p>If you want to know more, this is a list of selected starting points:</p><ul><li>Introduction to Redis data types. <a href="http://redis.io/topics/data-types-intro" target="_blank" rel="noopener">http://redis.io/topics/data-types-intro</a></li><li>Try Redis directly inside your browser. <a href="http://try.redis.io" target="_blank" rel="noopener">http://try.redis.io</a></li><li>The full list of Redis commands. <a href="http://redis.io/commands" target="_blank" rel="noopener">http://redis.io/commands</a></li><li>There is much more inside the Redis official documentation. <a href="http://redis.io/documentation" target="_blank" rel="noopener">http://redis.io/documentation</a></li></ul><h2 id="Documentation"><a href="#Documentation" class="headerlink" title="Documentation"></a>Documentation</h2><blockquote><p>Latest stable version tar ball</p></blockquote><p><a href="http://download.redis.io/redis-stable.tar.gz" target="_blank" rel="noopener">http://download.redis.io/redis-stable.tar.gz</a></p><p><a href="http://download.redis.io/releases/redis-5.0.2.tar.gz" target="_blank" rel="noopener">http://download.redis.io/releases/redis-5.0.2.tar.gz</a></p><p><a href="http://download.redis.io/releases/redis-3.2.10.tar.gz" target="_blank" rel="noopener">http://download.redis.io/releases/redis-3.2.10.tar.gz</a></p><blockquote><p>Browse source code</p></blockquote><p><a href="http://download.redis.io/redis-stable/" target="_blank" rel="noopener">http://download.redis.io/redis-stable/</a></p><p><a href="http://download.redis.io/redis-stable/README.md" target="_blank" rel="noopener">http://download.redis.io/redis-stable/README.md</a></p><h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># download</span></span><br><span class="line">wget http://download.redis.io/redis-stable.tar.gz</span><br><span class="line">tar xf redis-stable.tar.gz</span><br><span class="line"><span class="built_in">cd</span> redis-stable</span><br><span class="line"><span class="comment"># check packages</span></span><br><span class="line">yum -y install gcc gcc-c++ tcl</span><br><span class="line"><span class="comment"># check version</span></span><br><span class="line">./src/redis-cli -v</span><br><span class="line">redis-cli 5.0.2</span><br><span class="line"><span class="comment"># start redis server</span></span><br><span class="line">./src/redis-server redis.conf</span><br><span class="line"><span class="comment"># test</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ./redis-stable/src/redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> foo bar</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get foo</span><br><span class="line"><span class="string">"bar"</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure><h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><blockquote><p>不理解的配置参数可以参考官方文档或者下面的中文翻译</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create directory</span></span><br><span class="line">mkdir -p /data/running/redis-6389</span><br><span class="line">mkdir -p /var/<span class="built_in">log</span>/redis/</span><br><span class="line"></span><br><span class="line"><span class="comment"># copy custom scripts</span></span><br><span class="line">-rwxr-xr-x 1 root root    266 Nov 28 19:11 change_redis.py</span><br><span class="line">-rwxr-xr-x 1 root root    323 Nov 28 19:11 check_redis.sh</span><br><span class="line">-rwxr-xr-x 1 root root     20 Nov 28 19:11 connect_redis.sh</span><br><span class="line">-rw-r--r-- 1 root root     74 Nov 28 19:11 keep_alived_state</span><br><span class="line">-rwxr-xr-x 1 root root    829 Nov 28 19:11 keepalived.state.sh</span><br><span class="line">-rwxr-xr-x 1 root root 173376 Nov 28 19:11 redis-cli</span><br><span class="line">-rw-r----- 1 root root  46666 Nov 28 19:11 redis.conf</span><br><span class="line">-rwxr-xr-x 1 root root 979464 Nov 28 19:11 redis-server</span><br><span class="line">-rwxr-xr-x 1 root root     74 Nov 28 19:11 start_redis.sh</span><br><span class="line">-rwxr-xr-x 1 root root     38 Nov 28 19:11 stop_redis.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># set custom values</span></span><br><span class="line">[root@sg-gop-10-71-12-78 redis-6389]<span class="comment"># grep -Ev "^$|#" redis.conf</span></span><br><span class="line">protected-mode no</span><br><span class="line">port 6389</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize yes</span><br><span class="line">supervised no</span><br><span class="line">pidfile /var/run/redis_6389.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis-6389.log</span><br><span class="line">databases 16</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir /data/running/redis-6389</span><br><span class="line">slave-serve-stale-data yes</span><br><span class="line">slave-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">slave-priority 100</span><br><span class="line">maxclients 50000</span><br><span class="line">maxmemory 400gb</span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events <span class="string">""</span></span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-entries 512</span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line"><span class="built_in">set</span>-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit slave 0 0 0</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># set slave</span></span><br><span class="line">telnet 127.0.0.1 6389</span><br><span class="line">slaveof 10.71.12.70 6389</span><br><span class="line"><span class="comment"># cancel slave</span></span><br><span class="line">slaveof no one</span><br><span class="line">info</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=10.71.12.71,port=6389,state=online,offset=2283,lag=1</span><br><span class="line">master_repl_offset:2283</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:2</span><br><span class="line">repl_backlog_histlen:2282</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:10.71.12.70</span><br><span class="line">master_port:6389</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:5</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:2059</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_repl_offset:0</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure><h2 id="redis-conf-配置英文原版"><a href="#redis-conf-配置英文原版" class="headerlink" title="redis.conf 配置英文原版"></a>redis.conf 配置英文原版</h2><blockquote><p>最简单的模式只需要修改 daemonize yes，然后备机使用 slaveof 命令设置即可</p></blockquote><p><a href="http://download.redis.io/redis-stable/redis.conf" target="_blank" rel="noopener">http://download.redis.io/redis-stable/redis.conf</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis 默认配置</span></span><br><span class="line">[root@localhost redis-stable]<span class="comment"># grep -Ev "^$|#" redis.conf</span></span><br><span class="line"><span class="built_in">bind</span> 127.0.0.1</span><br><span class="line">protected-mode yes</span><br><span class="line">port 6379</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize no</span><br><span class="line">supervised no</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile <span class="string">""</span></span><br><span class="line">databases 16</span><br><span class="line">always-show-logo yes</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line">dir ./</span><br><span class="line">replica-serve-stale-data yes</span><br><span class="line">replica-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">replica-priority 100</span><br><span class="line">lazyfree-lazy-eviction no</span><br><span class="line">lazyfree-lazy-expire no</span><br><span class="line">lazyfree-lazy-server-del no</span><br><span class="line">replica-lazy-flush no</span><br><span class="line">appendonly no</span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">aof-use-rdb-preamble yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events <span class="string">""</span></span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-entries 512</span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line"><span class="built_in">set</span>-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">stream-node-max-bytes 4096</span><br><span class="line">stream-node-max-entries 100</span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit replica 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">dynamic-hz yes</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br><span class="line">rdb-save-incremental-fsync yes</span><br></pre></td></tr></table></figure><h2 id="redis-conf-配置中文翻译"><a href="#redis-conf-配置中文翻译" class="headerlink" title="redis.conf 配置中文翻译"></a>redis.conf 配置中文翻译</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#redis.conf</span></span><br><span class="line"><span class="comment"># Redis configuration file example.</span></span><br><span class="line"><span class="comment"># ./redis-server /path/to/redis.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################## INCLUDES ###################################</span></span><br><span class="line"><span class="comment"># 这在你有标准配置模板但是每个 redis 服务器又需要个性设置的时候很有用。</span></span><br><span class="line">include /path/to/local.conf</span><br><span class="line">include /path/to/other.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">################################ GENERAL #####################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否在后台执行，yes：后台运行；no：不是后台运行（老版本默认）</span></span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.2 里的参数，是否开启保护模式，默认开启。要是配置里没有指定 bind 和密码。开启该参数后，redis 只会本地进行访问，拒绝外部访问。要是开启了密码   和 bind，可以开启。否   则最好关闭，设置为 no。</span></span><br><span class="line">protected-mode yes</span><br><span class="line"></span><br><span class="line"><span class="comment">#redis 的进程文件 </span></span><br><span class="line">pidfile /var/run/redis/redis-server.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">#redis 监听的端口号。</span></span><br><span class="line">port 6379</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此参数确定了 TCP 连接中已完成队列(完成三次握手之后) 的长度， 当然此值必须不大于 Linux 系统定义的 / proc/sys/net/core/somaxconn 值，默认是 511，而 Linux 的默认参数值是 128。当系统并发量大并且客户端速度缓慢的时候，可以将这二个参数一起参考设定。该内核参数默认值一般是 128，对于负载很大的服务程序来说大大的不够。一般会将它修改为 2048 或者更大。在 / etc/sysctl.conf 中添加: net.core.somaxconn = 2048，然后在终端中执行 sysctl -p。</span></span><br><span class="line">tcp-backlog 511</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定 redis 只接收来自于该 IP 地址的请求，如果不进行设置，那么将处理所有请求 </span></span><br><span class="line"><span class="built_in">bind</span> 127.0.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 unix socket 来让 redis 支持监听本地连接。</span></span><br><span class="line"><span class="comment"># unixsocket /var/run/redis/redis.sock</span></span><br><span class="line"><span class="comment"># 配置 unix socket 使用文件的权限</span></span><br><span class="line"><span class="comment"># unixsocketperm 700</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 此参数为设置客户端空闲超过 timeout，服务端会断开连接，为 0 则服务端不会主动断开连接，不能小于 0。</span></span><br><span class="line">timeout 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#tcp keepalive 参数。如果设置不为 0，就使用配置 tcp 的 SO_KEEPALIVE 值，使用 keepalive 有两个好处: 检测挂掉的对端。降低中间设备出问题而导致网络看似连接却已经与对端端口的问题。在 Linux 内核中，设置了 keepalive，redis 会定时给对端发送 ack。检测到对端关闭需要两倍的设置值。</span></span><br><span class="line">tcp-keepalive 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定了服务端日志的级别。级别包括：debug（很多信息，方便开发、测试），verbose（许多有用的信息，但是没有 debug 级别信息多），notice（适当的日志级别，适合生产环境），warn（只有非常重要的信息）</span></span><br><span class="line">loglevel notice</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定了记录日志的文件。空字符串的话，日志会打印到标准输出设备。后台运行的 redis 标准输出是 / dev/null。</span></span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis-server.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否打开记录 syslog 功能</span></span><br><span class="line"><span class="comment"># syslog-enabled no</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#syslog 的标识符。</span></span><br><span class="line"><span class="comment"># syslog-ident redis</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志的来源、设备</span></span><br><span class="line"><span class="comment"># syslog-facility local0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库的数量，默认使用的数据库是 DB 0。可以通过”SELECT “命令选择一个 db</span></span><br><span class="line">databases 16</span><br><span class="line"></span><br><span class="line"><span class="comment">################################ SNAPSHOTTING ################################</span></span><br><span class="line"><span class="comment"># 快照配置</span></span><br><span class="line"><span class="comment"># 注释掉“save” 这一行配置项就可以让保存数据库功能失效 </span></span><br><span class="line"><span class="comment"># 设置 sedis 进行数据库镜像的频率。</span></span><br><span class="line"><span class="comment"># 900 秒（15 分钟）内至少 1 个 key 值改变（则进行数据库保存 -- 持久化） </span></span><br><span class="line"><span class="comment"># 300 秒（5 分钟）内至少 10 个 key 值改变（则进行数据库保存 -- 持久化） </span></span><br><span class="line"><span class="comment"># 60 秒（1 分钟）内至少 10000 个 key 值改变（则进行数据库保存 -- 持久化）</span></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当 RDB 持久化出现错误后，是否依然进行继续进行工作，yes：不能进行工作，no：可以继续进行工作，可以通过 info 中的 rdb_last_bgsave_status 了解 RDB 持久化是否有错误</span></span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用压缩 rdb 文件，rdb 文件压缩使用 LZF 压缩算法，yes：压缩，但是需要一些 cpu 的消耗。no：不压缩，需要更多的磁盘空间</span></span><br><span class="line">rdbcompression yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否校验 rdb 文件。从 rdb 格式的第五个版本开始，在 rdb 文件的末尾会带上 CRC64 的校验和。这跟有利于文件的容错性，但是在保存 rdb 文件的时候，会有大概 10% 的性能损耗，所以如果你追求高性能，可以关闭该配置。</span></span><br><span class="line">rdbchecksum yes</span><br><span class="line"></span><br><span class="line"><span class="comment">#rdb 文件的名称</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据目录，数据库的写入会在这个目录。rdb、aof 文件也会写在这个目录</span></span><br><span class="line">dir /var/lib/redis</span><br><span class="line"></span><br><span class="line"><span class="comment">################################# REPLICATION #################################</span></span><br><span class="line"><span class="comment"># 复制选项，slave 复制对应的 master。</span></span><br><span class="line"><span class="comment"># slaveof &lt;masterip&gt; &lt;masterport&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果 master 设置了 requirepass，那么 slave 要连上 master，需要有 master 的密码才行。masterauth 就是用来配置 master 的密码，这样可以在连上 master 后进行认证。</span></span><br><span class="line"><span class="comment"># masterauth &lt;master-password&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当从库同主机失去连接或者复制正在进行，从机库有两种运行方式：1) 如果 slave-serve-stale-data 设置为 yes(默认设置)，从库会继续响应客户端的请求。2) 如果 slave-serve-stale-data 设置为 no，除去 INFO 和 SLAVOF 命令之外的任何请求都会返回一个错误”SYNC with master in progress”。</span></span><br><span class="line">slave-serve-stale-data yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 作为从服务器，默认情况下是只读的（yes），可以修改成 NO，用于写（不建议）。</span></span><br><span class="line">slave-read-only yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否使用 socket 方式复制数据。目前 redis 复制提供两种方式，disk 和 socket。如果新的 slave 连上来或者重连的 slave 无法部分同步，就会执行全量同步，master 会生成 rdb 文件。有 2 种方式：disk 方式是 master 创建一个新的进程把 rdb 文件保存到磁盘，再把磁盘上的 rdb 文件传递给 slave。socket 是 master 创建一个新的进程，直接把 rdb 文件以 socket 的方式发给 slave。disk 方式的时候，当一个 rdb 保存的过程中，多个 slave 都能共享这个 rdb 文件。socket 的方式就的一个个 slave 顺序复制。在磁盘速度缓慢，网速快的情况下推荐用 socket 方式。</span></span><br><span class="line">repl-diskless-sync no</span><br><span class="line"></span><br><span class="line"><span class="comment">#diskless 复制的延迟时间，防止设置为 0。一旦复制开始，节点不会再接收新 slave 的复制请求直到下一个 rdb 传输。所以最好等待一段时间，等更多的 slave 连上来。</span></span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line"></span><br><span class="line"><span class="comment">#slave 根据指定的时间间隔向服务器发送 ping 请求。时间间隔可以通过 repl_ping_slave_period 来设置，默认 10 秒。</span></span><br><span class="line"><span class="comment"># repl-ping-slave-period 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制连接超时时间。master 和 slave 都有超时时间的设置。master 检测到 slave 上次发送的时间超过 repl-timeout，即认为 slave 离线，清除该 slave 信息。slave 检测到上次和 master 交互的时间超过 repl-timeout，则认为 master 离线。需要注意的是 repl-timeout 需要设置一个比 repl-ping-slave-period 更大的值，不然会经常检测到超时。</span></span><br><span class="line"><span class="comment"># repl-timeout 60</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否禁止复制 tcp 链接的 tcp nodelay 参数，可传递 yes 或者 no。默认是 no，即使用 tcp nodelay。如果 master 设置了 yes 来禁止 tcp nodelay 设置，在把数据复制给 slave 的时候，会减少包的数量和更小的网络带宽。但是这也可能带来数据的延迟。默认我们推荐更小的延迟，但是在数据量传输很大的场景下，建议选择 yes。</span></span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制缓冲区大小，这是一个环形复制缓冲区，用来保存最新复制的命令。这样在 slave 离线的时候，不需要完全复制 master 的数据，如果可以执行部分同步，只需要把缓冲区的部分数据复制给 slave，就能恢复正常复制状态。缓冲区的大小越大，slave 离线的时间可以更长，复制缓冲区只有在有 slave 连接的时候才分配内存。没有 slave 的一段时间，内存会被释放出来，默认 1m。</span></span><br><span class="line"><span class="comment"># repl-backlog-size 5mb</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#master 没有 slave 一段时间会释放复制缓冲区的内存，repl-backlog-ttl 用来设置该时间长度。单位为秒。</span></span><br><span class="line"><span class="comment"># repl-backlog-ttl 3600</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当 master 不可用，Sentinel 会根据 slave 的优先级选举一个 master。最低的优先级的 slave，当选 master。而配置成 0，永远不会被选举。</span></span><br><span class="line">slave-priority 100</span><br><span class="line"></span><br><span class="line"><span class="comment">#redis 提供了可以让 master 停止写入的方式，如果配置了 min-slaves-to-write，健康的 slave 的个数小于 N，mater 就禁止写入。master 最少得有多少个健康的 slave 存活才能执行写命令。这个配置虽然不能保证 N 个 slave 都一定能接收到 master 的写操作，但是能避免没有足够健康的 slave 的时候，master 不能写入来避免数据丢失。设置为 0 是关闭该功能。</span></span><br><span class="line"><span class="comment"># min-slaves-to-write 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 延迟小于 min-slaves-max-lag 秒的 slave 才认为是健康的 slave。</span></span><br><span class="line"><span class="comment"># min-slaves-max-lag 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 1 或另一个设置为 0 禁用这个特性。</span></span><br><span class="line"><span class="comment"># Setting one or the other to 0 disables the feature.</span></span><br><span class="line"><span class="comment"># By default min-slaves-to-write is set to 0 (feature disabled) and</span></span><br><span class="line"><span class="comment"># min-slaves-max-lag is set to 10.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################## SECURITY ###################################</span></span><br><span class="line"><span class="comment">#requirepass 配置可以让用户使用 AUTH 命令来认证密码，才能使用其他命令。这让 redis 可以使用在不受信任的网络中。为了保持向后的兼容性，可以注释该命令，因为大部分用户也不需要认证。使用 requirepass 的时候需要注意，因为 redis 太快了，每秒可以认证 15w 次密码，简单的密码很容易被攻破，所以最好使用一个更复杂的密码。</span></span><br><span class="line"><span class="comment"># requirepass foobared</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把危险的命令给修改成其他名称。比如 CONFIG 命令可以重命名为一个很难被猜到的命令，这样用户不能使用，而内部工具还能接着使用。</span></span><br><span class="line"><span class="comment"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置成一个空的值，可以禁止一个命令</span></span><br><span class="line"><span class="comment"># rename-command CONFIG ""</span></span><br><span class="line"><span class="comment">################################### LIMITS ####################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置能连上 redis 的最大客户端连接数量。默认是 10000 个客户端连接。由于 redis 不区分连接是客户端连接还是内部打开文件或者和 slave 连接等，所以 maxclients 最小建议设置到 32。如果超过了 maxclients，redis 会给新的连接发送’max number of clients reached’，并关闭连接。</span></span><br><span class="line"><span class="comment"># maxclients 10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#redis 配置的最大内存容量。当内存满了，需要配合 maxmemory-policy 策略进行处理。注意 slave 的输出缓冲区是不计算在 maxmemory 内的。所以为了防止主机内存使用完，建议设置的 maxmemory 需要更小一些。</span></span><br><span class="line"><span class="comment"># maxmemory &lt;bytes&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存容量超过 maxmemory 后的处理策略。</span></span><br><span class="line"><span class="comment">#volatile-lru：利用 LRU 算法移除设置过过期时间的 key。</span></span><br><span class="line"><span class="comment">#volatile-random：随机移除设置过过期时间的 key。</span></span><br><span class="line"><span class="comment">#volatile-ttl：移除即将过期的 key，根据最近过期时间来删除（辅以 TTL）</span></span><br><span class="line"><span class="comment">#allkeys-lru：利用 LRU 算法移除任何 key。</span></span><br><span class="line"><span class="comment">#allkeys-random：随机移除任何 key。</span></span><br><span class="line"><span class="comment">#noeviction：不移除任何 key，只是返回一个写错误。</span></span><br><span class="line"><span class="comment"># 上面的这些驱逐策略，如果 redis 没有合适的 key 驱逐，对于写命令，还是会返回错误。redis 将不再接收写请求，只接收 get 请求。写命令包括：set setnx setex append incr decr rpush lpush rpushx lpushx linsert lset rpoplpush sadd sinter sinterstore sunion sunionstore sdiff sdiffstore zadd zincrby zunionstore zinterstore hset hsetnx hmset hincrby incrby decrby getset mset msetnx exec sort。</span></span><br><span class="line"><span class="comment"># maxmemory-policy noeviction</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#lru 检测的样本数。使用 lru 或者 ttl 淘汰算法，从需要淘汰的列表中随机选择 sample 个 key，选出闲置时间最长的 key 移除。</span></span><br><span class="line"><span class="comment"># maxmemory-samples 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################## APPEND ONLY MODE ###############################</span></span><br><span class="line"><span class="comment"># 默认 redis 使用的是 rdb 方式持久化，这种方式在许多应用中已经足够用了。但是 redis 如果中途宕机，会导致可能有几分钟的数据丢失，根据 save 来策略进行持久化，Append Only File 是另一种持久化方式，可以提供更好的持久化特性。Redis 会把每次写入的数据在接收后都写入 appendonly.aof 文件，每次启动时 Redis 都会先把这个文件的数据读入内存里，先忽略 RDB 文件。</span></span><br><span class="line">appendonly no</span><br><span class="line"></span><br><span class="line"><span class="comment">#aof 文件名</span></span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#aof 持久化策略的配置</span></span><br><span class="line"><span class="comment">#no 表示不执行 fsync，由操作系统保证数据同步到磁盘，速度最快。</span></span><br><span class="line"><span class="comment">#always 表示每次写入都执行 fsync，以保证数据同步到磁盘。</span></span><br><span class="line"><span class="comment">#everysec 表示每秒执行一次 fsync，可能会导致丢失这 1s 数据。</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 aof 重写或者写入 rdb 文件的时候，会执行大量 IO，此时对于 everysec 和 always 的 aof 模式来说，执行 fsync 会造成阻塞过长时间，no-appendfsync-on-rewrite 字段设置为默认设置为 no。如果对延迟要求很高的应用，这个字段可以设置为 yes，否则还是设置为 no，这样对持久化特性来说这是更安全的选择。设置为 yes 表示 rewrite 期间对新写操作不 fsync, 暂时存在内存中, 等 rewrite 完成后再写入，默认为 no，建议 yes。Linux 的默认 fsync 策略是 30 秒。可能丢失 30 秒数据。</span></span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line"></span><br><span class="line"><span class="comment">#aof 自动重写配置。当目前 aof 文件大小超过上一次重写的 aof 文件大小的百分之多少进行重写，即当 aof 文件增长到一定大小的时候 Redis 能够调用 bgrewriteaof 对日志文件进行重写。当前 AOF 文件大小是上次日志重写得到 AOF 文件大小的二倍（设置为 100）时，自动启动新的日志重写过程。</span></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line"><span class="comment"># 设置允许重写的最小 aof 文件大小，避免了达到约定百分比但尺寸仍然很小的情况还要重写</span></span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"></span><br><span class="line"><span class="comment">#aof 文件可能在尾部是不完整的，当 redis 启动的时候，aof 文件的数据被载入内存。重启可能发生在 redis 所在的主机操作系统宕机后，尤其在 ext4 文件系统没有加上 data=ordered 选项（redis 宕机或者异常终止不会造成尾部不完整现象。）出现这种现象，可以选择让 redis 退出，或者导入尽可能多的数据。如果选择的是 yes，当截断的 aof 文件被导入的时候，会自动发布一个 log 给客户端然后 load。如果是 no，用户必须手动 redis-check-aof 修复 AOF 文件才可以。</span></span><br><span class="line">aof-load-truncated yes</span><br><span class="line"></span><br><span class="line"><span class="comment">################################ LUA SCRIPTING ###############################</span></span><br><span class="line"><span class="comment"># 如果达到最大时间限制（毫秒），redis 会记个 log，然后返回 error。当一个脚本超过了最大时限。只有 SCRIPT KILL 和 SHUTDOWN NOSAVE 可以用。第一个可以杀没有调 write 命令的东西。要是已经调用了 write，只能用第二个命令杀。</span></span><br><span class="line">lua-time-limit 5000</span><br><span class="line"></span><br><span class="line"><span class="comment">################################ REDIS CLUSTER ###############################</span></span><br><span class="line"><span class="comment"># 集群开关，默认是不开启集群模式。</span></span><br><span class="line"><span class="comment"># cluster-enabled yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群配置文件的名称，每个节点都有一个集群相关的配置文件，持久化保存集群的信息。这个文件并不需要手动配置，这个配置文件有 Redis 生成并更新，每个 Redis 集群节点需要一个单独的配置文件，请确保与实例运行的系统中配置文件名称不冲突</span></span><br><span class="line"><span class="comment"># cluster-config-file nodes-6379.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 节点互连超时的阀值。集群节点超时毫秒数</span></span><br><span class="line"><span class="comment"># cluster-node-timeout 15000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在进行故障转移的时候，全部 slave 都会请求申请为 master，但是有些 slave 可能与 master 断开连接一段时间了，导致数据过于陈旧，这样的 slave 不应该被提升为 master。该参数就是用来判断 slave 节点与 master 断线的时间是否过长。判断方法是：</span></span><br><span class="line"><span class="comment"># 比较 slave 断开连接的时间和(node-timeout * slave-validity-factor) + repl-ping-slave-period</span></span><br><span class="line"><span class="comment"># 如果节点超时时间为三十秒, 并且 slave-validity-factor 为 10, 假设默认的 repl-ping-slave-period 是 10 秒，即如果超过 310 秒 slave 将不会尝试进行故障转移 </span></span><br><span class="line"><span class="comment"># cluster-slave-validity-factor 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#master 的 slave 数量大于该值，slave 才能迁移到其他孤立 master 上，如这个参数若被设为 2，那么只有当一个主节点拥有 2 个可工作的从节点时，它的一个从节点会尝试迁移。</span></span><br><span class="line"><span class="comment"># cluster-migration-barrier 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认情况下，集群全部的 slot 有节点负责，集群状态才为 ok，才能提供服务。设置为 no，可以在 slot 没有全部分配的时候提供服务。不建议打开该配置，这样会造成分区的时候，小分区的 master 一直在接受写请求，而造成很长时间数据不一致。</span></span><br><span class="line"><span class="comment"># cluster-require-full-coverage yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################## SLOW LOG ###################################</span></span><br><span class="line"><span class="comment">###slog log 是用来记录 redis 运行中执行比较慢的命令耗时。当命令的执行超过了指定时间，就记录在 slow log 中，slog log 保存在内存中，所以没有 IO 操作。</span></span><br><span class="line"><span class="comment"># 执行时间比 slowlog-log-slower-than 大的请求记录到 slowlog 里面，单位是微秒，所以 1000000 就是 1 秒。注意，负数时间会禁用慢查询日志，而 0 则会强制记录所有命令。</span></span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 慢查询日志长度。当一个新的命令被写进日志的时候，最老的那个记录会被删掉。这个长度没有限制。只要有足够的内存就行。你可以通过 SLOWLOG RESET 来释放内存。</span></span><br><span class="line">slowlog-max-len 128</span><br><span class="line"></span><br><span class="line"><span class="comment">################################ LATENCY MONITOR ##############################</span></span><br><span class="line"><span class="comment"># 延迟监控功能是用来监控 redis 中执行比较缓慢的一些操作，用 LATENCY 打印 redis 实例在跑命令时的耗时图表。只记录大于等于下边设置的值的操作。0 的话，就是关闭监视。默认延迟监控功能是关闭的，如果你需要打开，也可以通过 CONFIG SET 命令动态设置。</span></span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# EVENT NOTIFICATION ##############################</span></span><br><span class="line"><span class="comment"># 键空间通知使得客户端可以通过订阅频道或模式，来接收那些以某种方式改动了 Redis 数据集的事件。因为开启键空间通知功能需要消耗一些 CPU ，所以在默认配置下，该功能处于关闭状态。</span></span><br><span class="line"><span class="comment">#notify-keyspace-events 的参数可以是以下字符的任意组合，它指定了服务器该发送哪些类型的通知：</span></span><br><span class="line"><span class="comment">##K 键空间通知，所有通知以 __keyspace@__ 为前缀</span></span><br><span class="line"><span class="comment">##E 键事件通知，所有通知以 __keyevent@__ 为前缀</span></span><br><span class="line"><span class="comment">##g DEL 、 EXPIRE 、 RENAME 等类型无关的通用命令的通知</span></span><br><span class="line"><span class="comment">##$ 字符串命令的通知</span></span><br><span class="line"><span class="comment">##l 列表命令的通知</span></span><br><span class="line"><span class="comment">##s 集合命令的通知</span></span><br><span class="line"><span class="comment">##h 哈希命令的通知</span></span><br><span class="line"><span class="comment">##z 有序集合命令的通知</span></span><br><span class="line"><span class="comment">##x 过期事件：每当有过期键被删除时发送</span></span><br><span class="line"><span class="comment">##e 驱逐(evict) 事件：每当有键因为 maxmemory 政策而被删除时发送</span></span><br><span class="line"><span class="comment">##A 参数 g$lshzxe 的别名</span></span><br><span class="line"><span class="comment"># 输入的参数中至少要有一个 K 或者 E，否则的话，不管其余的参数是什么，都不会有任何 通知被分发。详细使用可以参考 http://redis.io/topics/notifications</span></span><br><span class="line"></span><br><span class="line">notify-keyspace-events <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################### ADVANCED CONFIG ###############################</span></span><br><span class="line"><span class="comment"># 数据量小于等于 hash-max-ziplist-entries 的用 ziplist，大于 hash-max-ziplist-entries 用 hash</span></span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-entries 512</span><br><span class="line"><span class="comment">#value 大小小于等于 hash-max-ziplist-value 的用 ziplist，大于 hash-max-ziplist-value 用 hash。</span></span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-value 64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据量小于等于 list-max-ziplist-entries 用 ziplist，大于 list-max-ziplist-entries 用 list。</span></span><br><span class="line">list-max-ziplist-entries 512</span><br><span class="line"><span class="comment">#value 大小小于等于 list-max-ziplist-value 的用 ziplist，大于 list-max-ziplist-value 用 list。</span></span><br><span class="line">list-max-ziplist-value 64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据量小于等于 set-max-intset-entries 用 iniset，大于 set-max-intset-entries 用 set。</span></span><br><span class="line"><span class="built_in">set</span>-max-intset-entries 512</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据量小于等于 zset-max-ziplist-entries 用 ziplist，大于 zset-max-ziplist-entries 用 zset。</span></span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line"><span class="comment">#value 大小小于等于 zset-max-ziplist-value 用 ziplist，大于 zset-max-ziplist-value 用 zset。</span></span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line"></span><br><span class="line"><span class="comment">#value 大小小于等于 hll-sparse-max-bytes 使用稀疏数据结构（sparse），大于 hll-sparse-max-bytes 使用稠密的数据结构（dense）。一个比 16000 大的 value 是几乎没用的，建议的 value 大概为 3000。如果对 CPU 要求不高，对空间要求较高的，建议设置到 10000 左右。</span></span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line"></span><br><span class="line"><span class="comment">#Redis 将在每 100 毫秒时使用 1 毫秒的 CPU 时间来对 redis 的 hash 表进行重新 hash，可以降低内存的使用。当你的使用场景中，有非常严格的实时性需要，不能够接受 Redis 时不时的对请求有 2 毫秒的延迟的话，把这项配置为 no。如果没有这么严格的实时性要求，可以设置为 yes，以便能够尽可能快的释放内存。</span></span><br><span class="line">activerehashing yes</span><br><span class="line"></span><br><span class="line"><span class="comment">## 对客户端输出缓冲进行限制可以强迫那些不从服务器读取数据的客户端断开连接，用来强制关闭传输缓慢的客户端。</span></span><br><span class="line"><span class="comment"># 对于 normal client，第一个 0 表示取消 hard limit，第二个 0 和第三个 0 表示取消 soft limit，normal client 默认取消限制，因为如果没有寻问，他们是不会接收数据的。</span></span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line"><span class="comment"># 对于 slave client 和 MONITER client，如果 client-output-buffer 一旦超过 256mb，又或者超过 64mb 持续 60 秒，那么服务器就会立即断开客户端连接。</span></span><br><span class="line">client-output-buffer-limit slave 256mb 64mb 60</span><br><span class="line"><span class="comment"># 对于 pubsub client，如果 client-output-buffer 一旦超过 32mb，又或者超过 8mb 持续 60 秒，那么服务器就会立即断开客户端连接。</span></span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line"></span><br><span class="line"><span class="comment">#redis 执行任务的频率为 1s 除以 hz。</span></span><br><span class="line">hz 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 aof 重写的时候，如果打开了 aof-rewrite-incremental-fsync 开关，系统会每 32MB 执行一次 fsync。这对于把文件写入磁盘是有帮助的，可以避免过大的延迟峰值。</span></span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure><h2 id="自定义脚本"><a href="#自定义脚本" class="headerlink" title="自定义脚本"></a>自定义脚本</h2><blockquote><p>使用 keepalived 做最基本的高可用</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">[root@sg-gop-10-71-12-78 redis-6389]<span class="comment"># cat start_redis.sh</span></span><br><span class="line">/data/running/redis-6389/redis-server /data/running/redis-6389/redis.conf</span><br><span class="line"></span><br><span class="line">[root@sg-gop-10-71-12-78 redis-6389]<span class="comment"># cat connect_redis.sh</span></span><br><span class="line">./redis-cli -p 6389</span><br><span class="line"></span><br><span class="line">[root@sg-gop-10-71-12-78 redis-6389]<span class="comment"># cat stop_redis.sh</span></span><br><span class="line"><span class="built_in">kill</span> -9 `cat /var/run/redis_6389.pid`</span><br><span class="line"></span><br><span class="line">[root@sg-gop-10-71-12-78 redis-6389]<span class="comment"># cat check_redis.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Check if redis is running, return 1 if not.</span></span><br><span class="line"><span class="comment"># Used by keepalived to initiate a failover in case redis is down</span></span><br><span class="line"></span><br><span class="line">REDIS_STATUS=$(telnet 127.0.0.1 6389 &lt; /dev/null | grep <span class="string">"Connected"</span> )</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$REDIS_STATUS</span>"</span> != <span class="string">""</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  logger <span class="string">"REDIS is NOT running. Setting keepalived state to FAULT."</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">[root@sg-gop-10-71-12-78 redis-6389]<span class="comment"># cat change_redis.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"></span><br><span class="line">import redis</span><br><span class="line">import re</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line"><span class="comment">#main</span></span><br><span class="line">status=sys.argv[1]</span><br><span class="line">r = redis.StrictRedis(host=<span class="string">'localhost'</span>, port=6389, db=0)</span><br><span class="line"><span class="built_in">print</span> r.info().get(<span class="string">"role"</span>)</span><br><span class="line"><span class="keyword">if</span> status == <span class="string">'master'</span>:</span><br><span class="line">        r.slaveof()</span><br><span class="line">        r.config_set(<span class="string">"save"</span>, <span class="string">""</span>)</span><br><span class="line"><span class="built_in">print</span> r.info().get(<span class="string">"role"</span>)</span><br><span class="line"></span><br><span class="line">[root@sg-gop-10-71-12-78 redis-6389]<span class="comment"># cat keepalived.state.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">TYPE=<span class="variable">$1</span> <span class="comment">#GROUP or INSTANCE</span></span><br><span class="line">NAME=<span class="variable">$2</span> <span class="comment">#name of group or instance</span></span><br><span class="line">STATE=<span class="variable">$3</span> <span class="comment">#MASTER, BACKUP FAULT</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$STATE</span> <span class="keyword">in</span></span><br><span class="line">        <span class="string">"MASTER"</span>) <span class="built_in">echo</span> $(date)<span class="string">':'</span><span class="variable">$STATE</span> &gt;&gt; /data/running/redis-6389/keep_alived_state <span class="comment">#Become redis master</span></span><br><span class="line">                  python /data/running/redis-6389/change_redis.py master</span><br><span class="line">                  <span class="built_in">exit</span> 0</span><br><span class="line">                  ;;</span><br><span class="line">        <span class="string">"BACKUP"</span>) <span class="built_in">echo</span> $(date)<span class="string">':'</span><span class="variable">$STATE</span> &gt;&gt; /data/running/redis-6389/keep_alived_state <span class="comment">#Become redis slave</span></span><br><span class="line">                  python /data/running/redis-6389/change_redis.py slave</span><br><span class="line">                  <span class="built_in">exit</span> 0</span><br><span class="line">                  ;;</span><br><span class="line">        <span class="string">"FAULT"</span>)  <span class="built_in">echo</span> $(date)<span class="string">':'</span><span class="variable">$STATE</span> &gt;&gt; /data/running/redis-6389/keep_alived_state <span class="comment">#restart and become redis slave</span></span><br><span class="line">                  <span class="built_in">exit</span> 0</span><br><span class="line">                  ;;</span><br><span class="line">        *)        <span class="built_in">echo</span> <span class="string">"unknown state"</span></span><br><span class="line">                  <span class="built_in">exit</span> 1</span><br><span class="line">                  ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@sg-gop-10-71-12-77 wangao]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">vrrp_script check_redis &#123;</span><br><span class="line">    script <span class="string">"/data/running/redis-6389/check_redis.sh"</span></span><br><span class="line">    interval 2</span><br><span class="line">    fall 2</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_sync_group NC-MAIN-HA &#123;</span><br><span class="line">    group &#123;</span><br><span class="line">        NC-MAIN-HA-PRI</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance NC-MAIN-HA-PRI &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface bond0</span><br><span class="line">    virtual_router_id 77</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.71.13.77/23 dev bond0</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_redis</span><br><span class="line">    &#125;</span><br><span class="line">    notify /data/running/redis-6389/keepalived.state.sh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      Redis主备同步配置实践
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>使用 Ansible 管理 Windows</title>
    <link href="https://wsgzao.github.io/post/ansible-windows/"/>
    <id>https://wsgzao.github.io/post/ansible-windows/</id>
    <published>2018-11-27T02:59:49.000Z</published>
    <updated>2018-11-27T10:41:58.405Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文主要介绍在如何使用 Ansible 管理 Windows 客户端，Ansible 官方提供了一个很方便的安装脚本，对于外网用户来说安装真的很轻松，可惜我遇到的问题是如何在内网部署，有相同烦恼的小伙伴不妨参考下</p><blockquote><p>轻轻松松使用 Ansible 管理 Windows 客户端</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2018 年 11 月 27 日 - 更新 macOS 使用 ansible 管理 windows<br>2018 年 05 月 21 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/ansible-windows/">https://wsgzao.github.io/post/ansible-windows/</a></p><p><strong> 扩展阅读 </strong></p><p>Ansible Windows Guides - <a href="http://docs.ansible.com/ansible/latest/user_guide/windows.html" target="_blank" rel="noopener">http://docs.ansible.com/ansible/latest/user_guide/windows.html</a></p><hr><h2 id="Ansible-Windows-Support"><a href="#Ansible-Windows-Support" class="headerlink" title="Ansible Windows Support"></a>Ansible Windows Support</h2><blockquote><p>Ansible 在 2.3 版本之前对于 Windows 支持的并不算很友好，从 2.4 版本开始已经可以使用原生模块实现很多需求</p></blockquote><p>Because Windows is a non-POSIX-compliant operating system, there are differences between how Ansible interacts with them and the way Windows works. These guides will highlight some of the differences between Linux/Unix hosts and hosts running Windows.</p><ul><li>Ansible’s supported Windows versions generally match those under current and extended support from Microsoft. Supported desktop OSs include Windows 7, 8.1, and 10, and supported server OSs are Windows Server 2008, 2008 R2, 2012, 2012 R2, and - 2016.</li><li>Ansible requires PowerShell 3.0 or newer and at least .NET 4.0 to be installed on the Windows host.</li><li>A WinRM listener should be created and activated. More details for this can be found below.</li></ul><p><img src="http://ws1.sinaimg.cn/large/7207510dgy1frixssianuj20w30ecwfi.jpg" alt="image"></p><blockquote><p>Ansible does not support managing Windows XP or Server 2003 hosts. The supported operating system versions are:</p></blockquote><p>Windows Server 2008<br>Windows Server 2008 R2<br>Windows Server 2012<br>Windows Server 2012 R2<br>Windows Server 2016<br>Windows 7<br>Windows 8.1<br>Windows 10</p><ol><li>在官方文档中已经提到了在 Windows 中使用 Ansible 的最要前提，WinRM</li><li>WinRM 依赖 Powershell 3.0 以上版本的支持，牵扯出 PowerShell 2.0 to PowerShell 3.0/5.0 的问题</li><li>而 Powershell 升级则带来. Net Framework 是否跟随升级至 4.6.2/4.7.2 的选择</li><li>关于 WinRM 的参数配置可以参考下面的链接 Setting up a Windows Host</li></ol><p><a href="https://github.com/ansible/ansible/blob/devel/examples/scripts/upgrade_to_ps3.ps1" target="_blank" rel="noopener">https://github.com/ansible/ansible/blob/devel/examples/scripts/upgrade_to_ps3.ps1</a><br><a href="https://github.com/ansible/ansible/blob/devel/examples/scripts/ConfigureRemotingForAnsible.ps1" target="_blank" rel="noopener">https://github.com/ansible/ansible/blob/devel/examples/scripts/ConfigureRemotingForAnsible.ps1</a></p><p>Setting up a Windows Host<br><a href="http://docs.ansible.com/ansible/latest/user_guide/windows_setup.html" target="_blank" rel="noopener">http://docs.ansible.com/ansible/latest/user_guide/windows_setup.html</a></p><p>.NET Framework 4.7.2/4.6.2<br><a href="https://www.microsoft.com/net/download/dotnet-framework-runtime" target="_blank" rel="noopener">https://www.microsoft.com/net/download/dotnet-framework-runtime</a></p><p>Powershell 3.0<br><a href="https://www.microsoft.com/en-us/download/details.aspx?id=34595" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=34595</a></p><p>Powershell 5.1<br><a href="https://www.microsoft.com/en-us/download/details.aspx?id=54616" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=54616</a></p><blockquote><p>我个人目前的建议是 Win7/2008 升级至 Powershell 3.0，.Net Framework 升级至 4.6.2，其他情况需要可以参考官方文档后做决定</p></blockquote><p>Ansible Windows Guides - <a href="http://docs.ansible.com/ansible/latest/user_guide/windows.html" target="_blank" rel="noopener">http://docs.ansible.com/ansible/latest/user_guide/windows.html</a></p><h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><ol><li>客户端配置 windows 主机, 以管理员身份打开 powershell, 并查看当前 ps 版本<br>get-host</li><li>系统自带的 powershell 版本是 2.0，需要更新至 powershell 3 以上版本<br><a href="https://www.microsoft.com/net/download/dotnet-framework-runtime" target="_blank" rel="noopener">https://www.microsoft.com/net/download/dotnet-framework-runtime</a><br><a href="https://www.microsoft.com/en-us/download/details.aspx?id=34595" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=34595</a></li><li>安装完重启服务器查看 powershell 版本</li></ol><p>.NET Framework 4.6 以上版本无法建立到信任根颁发机构的证书链<br>原因：系统缺少信任 Microsoft Root Certificate Authority 2011 根证书<br>下载：MicrosoftRootCertificateAuthority2011.cer<br><a href="http://go.microsoft.com/fwlink/?LinkID=747875&amp;clcid=0x409" target="_blank" rel="noopener">http://go.microsoft.com/fwlink/?LinkID=747875&amp;clcid=0x409</a><br>运行 certmgr.msc<br>导入证书到 “受信任的根证书颁发机构”</p><p><img src="http://ws4.sinaimg.cn/large/7207510dgy1frizys458dj20b109k3yq.jpg" alt="image"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 winrm</span></span><br><span class="line">mkdir C:\temp</span><br><span class="line"><span class="built_in">cd</span> C:\temp</span><br><span class="line"><span class="comment"># 下载 ConfigureRemotingForAnsible.ps1</span></span><br><span class="line">https://raw.githubusercontent.com/ansible/ansible/devel/examples/scripts/ConfigureRemotingForAnsible.ps1</span><br><span class="line"><span class="comment"># 开启 WinRM 服务 </span></span><br><span class="line">powershell -ExecutionPolicy RemoteSigned .\ConfigureRemotingForAnsible.ps1 -SkipNetworkProfileCheck</span><br></pre></td></tr></table></figure><h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端使用 pip 安装 pywinrm</span></span><br><span class="line">pip install pywinrm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 功能测试，配置 ansible 控制机 </span></span><br><span class="line">vi /etc/ansible/hosts</span><br><span class="line"></span><br><span class="line">[windows]</span><br><span class="line">192.168.67.139</span><br><span class="line">[windows:vars]</span><br><span class="line">ansible_user=Administrator</span><br><span class="line">ansible_password=Admin123</span><br><span class="line">ansible_port=5986</span><br><span class="line">ansible_connection=winrm</span><br><span class="line">ansible_winrm_server_cert_validation=ignore  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 要注意的是端口方面 ssl 即 https 方式的使用 5986，http 使用 5985</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 ping 通信 </span></span><br><span class="line">ansible windows -m win_ping </span><br><span class="line"><span class="comment"># 查看 ip 地址 </span></span><br><span class="line">ansible windows -m win_command -a <span class="string">"ipconfig"</span></span><br></pre></td></tr></table></figure><h2 id="网盘下载"><a href="#网盘下载" class="headerlink" title="网盘下载"></a>网盘下载</h2><blockquote><p>Windows 作为客户端所需的软件包我上传到百度网盘，.Net Framework 安装失败提示证书错误记得手动导入 MicrosoftRootCertificateAuthority2011.cer</p></blockquote><p><a href="https://pan.baidu.com/s/1JNV2pXjwUn14ojAtdEH_Sg" target="_blank" rel="noopener">https://pan.baidu.com/s/1JNV2pXjwUn14ojAtdEH_Sg</a></p><ol><li>安装 .Net Framework 4.6.2（NDP462-KB3151800-x86-x64-AllOS-ENU.exe）</li><li>升级 Windows 7 SP1 和 Windows 2008 R2 SP1 的 PowerShell 版本从 2.0 至 3.0（Windows6.1-KB2506143-x64.msu）</li><li><p>执行.\ConfigureRemotingForAnsible.ps1 脚本开启 WinRM 远程管理服务</p><p> powershell -ExecutionPolicy RemoteSigned .\ConfigureRemotingForAnsible.ps1 -SkipNetworkProfileCheck</p></li></ol><h2 id="macOS-配置"><a href="#macOS-配置" class="headerlink" title="macOS 配置"></a>macOS 配置</h2><blockquote><p>macOS 使用 ansible 管理 windows 里有一个小坑</p></blockquote><p>Ansible Error – “NSPlaceholderDate initialize may have been in progress in another thread when fork() was called”</p><p>If you have came across the same error as I did  (error below) then solving this might be easier than you think</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">objc[6763]: +[__NSPlaceholderDate initialize] may have been <span class="keyword">in</span> progress <span class="keyword">in</span> another thread when fork() was called.</span><br><span class="line">objc[6763]: +[__NSPlaceholderDate initialize] may have been <span class="keyword">in</span> progress <span class="keyword">in</span> another thread when fork() was called. We cannot safely call it or ignore it <span class="keyword">in</span> the fork() child process. Crashing instead. Set a breakpoint on objc_initializeAfterForkError to debug.</span><br><span class="line"></span><br><span class="line"><span class="comment"># run this export</span></span><br><span class="line"><span class="built_in">export</span> OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES</span><br></pre></td></tr></table></figure><p>You just need to run the following ( <a href="https://github.com/ansible/ansible/issues/31869" target="_blank" rel="noopener">https://github.com/ansible/ansible/issues/31869</a> )</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># download the script</span></span><br><span class="line">(New-Object System.Net.WebClient).DownloadFile(<span class="string">'https://raw.githubusercontent.com/ansible/ansible/devel/examples/scripts/ConfigureRemotingForAnsible.ps1'</span>, <span class="string">'./ConfigureRemotingForAnsible.ps1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># execute the script</span></span><br><span class="line">./ConfigureRemotingForAnsible.ps1</span><br><span class="line"></span><br><span class="line"><span class="comment"># macOS ansible</span></span><br><span class="line">python3 -m venv ansible</span><br><span class="line">pip install ansible pywinrm</span><br><span class="line"></span><br><span class="line"><span class="comment"># config win_hosts file</span></span><br><span class="line">vi win_hosts</span><br><span class="line"></span><br><span class="line">[windows:vars]</span><br><span class="line">ansible_user=ox</span><br><span class="line">ansible_password=ox</span><br><span class="line">ansible_port=5986</span><br><span class="line">ansible_connection=winrm</span><br><span class="line">ansible_winrm_server_cert_validation=ignore</span><br><span class="line"></span><br><span class="line">[windows]</span><br><span class="line">192.168.56.101</span><br><span class="line"></span><br><span class="line"><span class="comment"># run test</span></span><br><span class="line">ansible -i win_hosts windows -m win_ping -vvv</span><br><span class="line"></span><br><span class="line">ansible 2.7.0</span><br><span class="line">  config file = /Users/wangao/Documents/git/wangao/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [u<span class="string">'/Users/wangao/.ansible/plugins/modules'</span>, u<span class="string">'/usr/share/ansible/plugins/modules'</span>]</span><br><span class="line">  ansible python module location = /usr/<span class="built_in">local</span>/lib/python2.7/site-packages/ansible</span><br><span class="line">  executable location = /usr/<span class="built_in">local</span>/bin/ansible</span><br><span class="line">  python version = 2.7.15 (default, Jul 23 2018, 21:27:06) [GCC 4.2.1 Compatible Apple LLVM 9.1.0 (clang-902.0.39.2)]</span><br><span class="line">Using /Users/wangao/Documents/git/wangao/ansible/ansible.cfg as config file</span><br><span class="line">Parsed /Users/wangao/Documents/git/wangao/ansible/win_hosts inventory <span class="built_in">source</span> with ini plugin</span><br><span class="line">META: ran handlers</span><br><span class="line">Using module file /usr/<span class="built_in">local</span>/lib/python2.7/site-packages/ansible/modules/windows/win_ping.ps1</span><br><span class="line">&lt;192.168.56.101&gt; ESTABLISH WINRM CONNECTION FOR USER: ox on PORT 5986 TO 192.168.56.101</span><br><span class="line">objc[63337]: +[__NSPlaceholderDate initialize] may have been <span class="keyword">in</span> progress <span class="keyword">in</span> another thread when fork() was called.</span><br><span class="line">objc[63337]: +[__NSPlaceholderDate initialize] may have been <span class="keyword">in</span> progress <span class="keyword">in</span> another thread when fork() was called. We cannot safely call it or ignore it <span class="keyword">in</span> the fork() child process. Crashing instead. Set a breakpoint on objc_initializeAfterForkError to debug.</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fixed this on High Sierra and Mojave.</span></span><br><span class="line"><span class="built_in">export</span> OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES</span><br><span class="line"></span><br><span class="line">ansible -i win_hosts windows -m win_ping -vvv</span><br><span class="line"></span><br><span class="line">ansible 2.7.0</span><br><span class="line">  config file = /Users/wangao/Documents/git/wangao/ansible/ansible.cfg</span><br><span class="line">  configured module search path = [u<span class="string">'/Users/wangao/.ansible/plugins/modules'</span>, u<span class="string">'/usr/share/ansible/plugins/modules'</span>]</span><br><span class="line">  ansible python module location = /usr/<span class="built_in">local</span>/lib/python2.7/site-packages/ansible</span><br><span class="line">  executable location = /usr/<span class="built_in">local</span>/bin/ansible</span><br><span class="line">  python version = 2.7.15 (default, Jul 23 2018, 21:27:06) [GCC 4.2.1 Compatible Apple LLVM 9.1.0 (clang-902.0.39.2)]</span><br><span class="line">Using /Users/wangao/Documents/git/wangao/ansible/ansible.cfg as config file</span><br><span class="line">Parsed /Users/wangao/Documents/git/wangao/ansible/win_hosts inventory <span class="built_in">source</span> with ini plugin</span><br><span class="line">META: ran handlers</span><br><span class="line">Using module file /usr/<span class="built_in">local</span>/lib/python2.7/site-packages/ansible/modules/windows/win_ping.ps1</span><br><span class="line">&lt;192.168.56.101&gt; ESTABLISH WINRM CONNECTION FOR USER: ox on PORT 5986 TO 192.168.56.101</span><br><span class="line">EXEC (via pipeline wrapper)</span><br><span class="line">192.168.56.101 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      轻轻松松使用Ansible管理Windows客户端
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>使用 csshX 同步管理多个 SSH 会话</title>
    <link href="https://wsgzao.github.io/post/csshx/"/>
    <id>https://wsgzao.github.io/post/csshx/</id>
    <published>2018-11-26T06:59:49.000Z</published>
    <updated>2018-11-26T12:12:39.902Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>终端登录管理方案非常成熟除了耳熟能详的跨平台付费方案 SeureCRT，Windows 有 Xshell，macOS 有 iTerm2，不过在 macOS 下想用到类似 SecureCRT 和 Xshell 一样的 Send to all 功能可能就没有这么方便了，而 csshX 正好可以满足批量管理操作的需求</p><blockquote><p>使用 csshX 同步管理多个 SSH 会话</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2018 年 11 月 26 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/csshx/">https://wsgzao.github.io/post/csshx/</a></p><p><strong> 扩展阅读 </strong></p><p>csshx - <a href="https://github.com/brockgr/csshx" target="_blank" rel="noopener">https://github.com/brockgr/csshx</a></p><hr><h2 id="csshx-简介"><a href="#csshx-简介" class="headerlink" title="csshx 简介"></a>csshx 简介</h2><p>As csshX is a command line tool, no special installation is needed. It may<br>be copied into a directory in your path, (e.g. /usr/local/bin) for your<br>convenience.</p><p>The software has been tested on Mac OS X 10.5, 10.6 and 10.7 with the default<br>Perl installation - no additional Perl modules are required.</p><p>DOCUMENTATION:</p><p>The documentation for csshX is self contained. Please run:</p><pre><code>csshX --man</code></pre><h2 id="使用-brew-安装-csshx"><a href="#使用-brew-安装-csshx" class="headerlink" title="使用 brew 安装 csshx"></a>使用 brew 安装 csshx</h2><p>Name: csshx<br>Use: Cluster ssh tool for Terminal.app<br>URL: <a href="https://github.com/brockgr/csshx" target="_blank" rel="noopener">https://github.com/brockgr/csshx</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 homebrew</span></span><br><span class="line">ruby -e <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span> &lt; /dev/null 2&gt; /dev/null</span><br><span class="line"><span class="comment"># 安装 csshx</span></span><br><span class="line">brew install csshx</span><br></pre></td></tr></table></figure><h2 id="csshx-使用"><a href="#csshx-使用" class="headerlink" title="csshx 使用"></a>csshx 使用</h2><p>当我们管理数十台或更多 Linux 服务器的时候，往往需要在每台服务器上执行同样的命令，比如我们想一次查看 10 台服务器（node）上系统负载情况，或者想知道哪台服务器有剩余内存可以分给新客户，又或者想执行 df 命令看看哪个服务器上还有多的硬盘空间等等，除了可以用脚本或工具统一收集这些信息外，我们还可以考虑使用一些同步管理多个 SSH 会话的小工具来帮助管理多台服务器，节省时间提高管理效率。在 Linux 上可以用 pdsh、ClusterSSH 和 mussh；在 Mac 上可以用 csshX.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 csshX 很简单，如果要同时 ssh 到 4 个服务器可以直接传递 IP</span></span><br><span class="line">csshX 192.168.0.1 192.168.0.2 192.168.0.3 192.168.0.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以把这些要 ssh 管理的 IP 写到一个文件里，然后加载这个文件 </span></span><br><span class="line">vi hosts</span><br><span class="line">192.168.0.1</span><br><span class="line">192.168.0.2</span><br><span class="line">192.168.0.3</span><br><span class="line">192.168.0.4</span><br><span class="line"></span><br><span class="line">csshX --hosts hosts</span><br></pre></td></tr></table></figure><h2 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h2><p>csshx is not working in New Mac OS Release MacOS Mojave</p><p><a href="https://github.com/brockgr/csshx/issues/94" target="_blank" rel="noopener">https://github.com/brockgr/csshx/issues/94</a></p><pre><code>brew install parera10/csshx/csshx</code></pre>]]></content>
    
    <summary type="html">
    
      使用csshX同步管理多个SSH会话
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Splunk 官方培训笔记</title>
    <link href="https://wsgzao.github.io/post/splunk/"/>
    <id>https://wsgzao.github.io/post/splunk/</id>
    <published>2018-11-21T08:22:32.000Z</published>
    <updated>2018-11-21T09:05:20.030Z</updated>
    
    <content type="html"><![CDATA[<p><img src="//i.v2ex.co/0kvIE02gl.jpeg" alt=""></p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Splunk 作为一款成熟的商业化日志处理分析产品无论在功能上还是用户体验上都是令人满意的，而开源方案 ELK(Elasticsearch+Logstash+Kibana) 相信也有很多朋友考虑或者正在使用，我在这里不想讨论孰优孰劣因为不同的业务场景出发点不同，共存也是不错的选择。文章通过 1 天的 Splunk 官方培训记录相关基础概念和动手实验，Splunk 上手速度灰常快不过也需要掌握正则表达式，欢迎大家一起学习哈。</p><blockquote><p>Splunk 智能运维，挖掘数据的价值</p></blockquote><h2 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h2><p>2018 年 11 月 21 日 - 增加与 Ansible 结合的用法<br>2016 年 03 月 22 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/splunk/">https://wsgzao.github.io/post/splunk/</a></p><p><strong> 扩展阅读 </strong></p><p>Splunk - <a href="http://www.splunk.com/" target="_blank" rel="noopener">http://www.splunk.com/</a><br>正则表达式 30 分钟入门教程 - <a href="http://deerchao.net/tutorials/regex/regex.htm" target="_blank" rel="noopener">http://deerchao.net/tutorials/regex/regex.htm</a></p><h2 id="机器数据"><a href="#机器数据" class="headerlink" title="机器数据"></a>机器数据</h2><p>机器数据中包含客户、用户、交易、应用程序、服务器、网络和手机设备所有活动和行为的明确记录。不仅仅包含日志。还包括配置、API 中的数据、消息队列、更改事件、诊断命令输出、工业系统呼叫详细信息记录和传感器数据等。</p><p>计算机数以未知格式的阵列存储，监测和分析工具的传统集并未为多样性、速率、数据量、可变性设计。一个专为此独特类型数据设计的全新方法，必须可以快速诊断服务问题、检测复杂信息安全威胁、远程设备的健康状况和性能，以及说明合规性。</p><h3 id="机器数据源"><a href="#机器数据源" class="headerlink" title="机器数据源"></a>机器数据源</h3><blockquote><p>每个环境都有独特的机器数据空间，以下是一些示例。</p></blockquote><table><thead><tr><th>数据类型</th><th>位置</th><th>它可以告诉您什么</th></tr></thead><tbody><tr><td>应用日志</td><td>本地日志文件、log4j、log4net、Weblogic、WebSphere、JBoss、.NET、PHP</td><td>用户活动、欺诈检测、应用性能</td></tr><tr><td>业务流程日志</td><td>业务流程管理日志</td><td>跨渠道客户活动、购买、帐户变更以及问题报表</td></tr><tr><td>呼叫详细信息记录</td><td>呼叫详细信息记录 (CDR)、计费数据记录、事件数据记录均由电信和网络交换机所记录。</td><td>计费、收入保证、客户保证、合作伙伴结算，营销智能</td></tr><tr><td>点击流数据</td><td>Web 服务器、路由器、代理服务器和广告服务器</td><td>可用性分析、数字市场营销和一般调查</td></tr><tr><td>配置文件</td><td>系统配置文件</td><td>如何设置基础设施、调试故障、后门攻击、”定时炸弹” 病毒</td></tr><tr><td>数据库审计日志</td><td>数据库日志文件、审计表</td><td>如何根据时间修改数据库数据以及如何确定修改人</td></tr><tr><td>文件系统审计日志</td><td>敏感数据存储在共享文件系统中</td><td>监测并审计敏感数据读取权限</td></tr><tr><td>管理并记录 API</td><td>通过 OPSEC Log Export API (OPSEC LEA) 和其他 VMware 和 Citrix 供应商特定 API 的 Checkpoint 防火墙</td><td>管理数据和日志事件</td></tr><tr><td>消息队列</td><td>JMS、RabbitMQ 和 AquaLogic</td><td>调试复杂应用中的问题，并作为记录应用架构基础</td></tr><tr><td>操作系统度量、状态和诊断命令</td><td>通过命令行实用程序（例如 Unix 和 Linux 上的 ps 与 iostat 以及 Windows 上的性能监视器）显示的 CPU、内存利用率和状态信息</td><td>故障排除、分析趋势以发现潜在问题并调查安全事件</td></tr><tr><td>数据包 / 流量数据</td><td>tcpdump 和 tcpflow 可生成 pcap 或流量数据以及其他有用的数据包级和会话级信息</td><td>性能降级、超时、瓶颈或可疑活动可表明网络被入侵或者受到远程攻击</td></tr><tr><td>SCADA 数据</td><td>监视控制与数据采集 (SCADA)</td><td>识别 SCADA 基础结构中的趋势、模式和异常情况，并用于实现客户价值</td></tr><tr><td>传感器数据</td><td>传感器设备可以根据监测环境条件生成数据，例如气温、声音、压力、功率以及水位</td><td>水位监测、机器健康状态监测和智能家居监测</td></tr><tr><td>Syslog</td><td>路由器、交换机和网络设备上的 Syslog</td><td>故障排除、分析、安全审计</td></tr><tr><td>Web 访问日志</td><td>Web 访问日志会报告 Web 服务器处理的每个请求</td><td>Web 市场营销分析报表</td></tr><tr><td>Web 代理日志</td><td>Web 代理记录用户通过代理发出的每个 Web 请求</td><td>监测并调查服务条款以及数据泄露事件</td></tr><tr><td>Windows 事件</td><td>Windows 应用、安全和系统事件日志</td><td>使用业务关键应用、安全信息和使用模式检测问题。</td></tr><tr><td>线上数据</td><td>DNS 查找和记录，协议级信息，包括标头、内容以及流记录</td><td>主动监测应用性能和可用性、最终客户体验、事件调查、网络、威胁检测、监控和合规性</td></tr></tbody></table><h2 id="实验准备"><a href="#实验准备" class="headerlink" title="实验准备"></a>实验准备</h2><blockquote><p>免费版每天最多可对 500 MB 数据建立索引</p></blockquote><p>Splunk Enterprise - <a href="http://www.splunk.com/zh-hans_cn/download/splunk-enterprise.html" target="_blank" rel="noopener">http://www.splunk.com/zh-hans_cn/download/splunk-enterprise.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">file://C:\Users\wsgzao\Desktop\splunk_workshop  (2 folders, 3 files, 26.20 MB, 48.25 MB <span class="keyword">in</span> total.)</span><br><span class="line">│  sampledata-selected.zip   323.36 KB</span><br><span class="line">│  splunk.pdf    24.02 MB</span><br><span class="line">│  tutorialdata.zip  1.86 MB</span><br><span class="line">├─sampledata-selected   (0 folders, 3 files, 4.07 MB, 4.07 MB <span class="keyword">in</span> total.)</span><br><span class="line">│      access.log  4.06 MB</span><br><span class="line">│      http_status.csv 1.34 KB</span><br><span class="line">│      prices.csv  630 bytes</span><br><span class="line">└─tutorialdata  (5 folders, 0 files, 0 bytes, 17.99 MB <span class="keyword">in</span> total.)</span><br><span class="line">    ├─mailsv  (0 folders, 1 files, 1.06 MB, 1.06 MB <span class="keyword">in</span> total.)</span><br><span class="line">    │      secure.log    1.06 MB</span><br><span class="line">    ├─vendor_sales    (0 folders, 1 files, 1.96 MB, 1.96 MB <span class="keyword">in</span> total.)</span><br><span class="line">    │      vendor_sales.log  1.96 MB</span><br><span class="line">    ├─www1    (0 folders, 2 files, 5.18 MB, 5.18 MB <span class="keyword">in</span> total.)</span><br><span class="line">    │      access.log    4.06 MB</span><br><span class="line">    │      secure.log    1.12 MB</span><br><span class="line">    ├─www2    (0 folders, 2 files, 4.87 MB, 4.87 MB <span class="keyword">in</span> total.)</span><br><span class="line">    │      access.log    3.85 MB</span><br><span class="line">    │      secure.log    1.02 MB</span><br><span class="line">    └─www3    (0 folders, 2 files, 4.91 MB, 4.91 MB <span class="keyword">in</span> total.)</span><br><span class="line">            access.log    3.86 MB</span><br><span class="line">            secure.log    1.05 MB</span><br></pre></td></tr></table></figure><iframe src="https://www.slideshare.net/slideshow/embed_code/key/dQlrUNPu3JNYjp" width="427" height="356" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe> <h2 id="动手实验"><a href="#动手实验" class="headerlink" title="动手实验"></a>动手实验</h2><blockquote><p>安装 Splunk 极其简单，这里以 Windows 为例</p></blockquote><p><a href="http://localhost:8000/zh-CN/" target="_blank" rel="noopener">http://localhost:8000/zh-CN/</a><br><a href="http://localhost:8000/en-US/" target="_blank" rel="noopener">http://localhost:8000/en-US/</a></p><p>Search App：数据导入，了解 splunk 搜索界面，执行基本搜索<br>Field：了解 Splunk 字段含义；字段提取；字段对照<br>SPL：使用 SPL（SplunkSearchProcessingLanguage）指令实现目标场景<br>Businessused cases：场景实现，自定义仪表盘制作</p><blockquote><p>Objectives of workshop</p></blockquote><ul><li>Learn how to start indexing machine data in Splunk.</li><li>Leverage these machine data for reporting and learn some of the common reporting commands.</li><li>Learn to use searches to pull out data of importance.</li><li>Get an idea on an unique Splunk feature called “schema-on-the-fly”, and understand how to apply such “Fields” to machine data to make IT and business sense.</li><li>Learn how to build and share dashboards during the class.</li><li>Get an idea how to create data model and create pivot reports*</li><li>You can re-run the whole workshop after this session anywhere</li><li>Q&amp;A</li></ul><blockquote><p>实验过程</p></blockquote><p>我觉得操作都很简单，大家可以多参考官方的 Splunk Documentation</p><p><a href="http://docs.splunk.com/Documentation" target="_blank" rel="noopener">http://docs.splunk.com/Documentation</a><br><a href="http://docs.splunk.com/Documentation/Splunk/latest/Translated/SimplifiedChinesemanuals" target="_blank" rel="noopener">http://docs.splunk.com/Documentation/Splunk/latest/Translated/SimplifiedChinesemanuals</a></p><p>正则表达式 30 分钟入门教程 - <a href="http://deerchao.net/tutorials/regex/regex.htm" target="_blank" rel="noopener">http://deerchao.net/tutorials/regex/regex.htm</a></p><h2 id="高级参数"><a href="#高级参数" class="headerlink" title="高级参数"></a>高级参数</h2><blockquote><p>举个栗子</p></blockquote><p>编辑来源类型： _json</p><ul><li>MAX_ EVENTS: 99999</li><li>TRUNCATE: 99999999</li></ul>]]></content>
    
    <summary type="html">
    
      Splunk智能运维，挖掘数据的价值
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>在命令行内获取公网 IP 的几种简单方法</title>
    <link href="https://wsgzao.github.io/post/myip/"/>
    <id>https://wsgzao.github.io/post/myip/</id>
    <published>2018-11-20T06:59:49.000Z</published>
    <updated>2018-11-21T03:58:02.213Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>不管是在家里还是办公室，或者是公司的主机，很多时候都是在内网中，也就是说很多都是通过 NAT 上网的，有时候需要查询下出口的公网 IP，如果有浏览器可以用百度或者 Google 搜索 ip 这个关键词得到公网 IP，那要是在命令行下呢？下面给大家分享下自己整理的几种方案</p><blockquote><p>Extract your external IP using command line tools</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2018 年 11 月 20 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/myip/">https://wsgzao.github.io/post/myip/</a></p><p><strong> 扩展阅读 </strong></p><p><a href="https://support.opendns.com/hc/en-us/search?utf8=%E2%9C%93&amp;query=myip.opendns.com" target="_blank" rel="noopener">https://support.opendns.com/hc/en-us/search?utf8=%E2%9C%93&amp;query=myip.opendns.com</a></p><hr><h2 id="dig"><a href="#dig" class="headerlink" title="dig"></a>dig</h2><blockquote><p>目前广受中外网友好评简单快速的查询公网 IP 方案，OpenDNS 支持 IPv4 和 IPv6</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># IPv4</span></span><br><span class="line">dig -4 +short myip.opendns.com. @resolver1.opendns.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># IPv6</span></span><br><span class="line">dig -6 +short myip.opendns.com. @resolver1.opendns.com</span><br></pre></td></tr></table></figure><h2 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl whatismyip.akamai.com</span><br><span class="line">curl ifconfig.me</span><br><span class="line">curl ipecho.net/plain</span><br><span class="line">curl icanhazip.com</span><br></pre></td></tr></table></figure><h2 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl ipinfo.io</span><br><span class="line">curl https://api.myip.com</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      Extract your external IP using command line tools
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>CentOS7 平滑升级 MariaDB 5.5 到 10.x 新版本实践</title>
    <link href="https://wsgzao.github.io/post/mariadb-upgrade/"/>
    <id>https://wsgzao.github.io/post/mariadb-upgrade/</id>
    <published>2018-11-14T06:59:49.000Z</published>
    <updated>2018-11-15T03:43:45.054Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>自从 CentOS 7 开始，自带的数据库就变成 MariaDB 了，yum 安装之后的默认版本是 5.5，但是这个数据版本已经比较老了，无论是安装全新的 Percona 还是升级 MariaDB 第一步始终是不要忘记备份。</p><blockquote><p>CentOS7 平滑升级 MariaDB 5.5 到 10.x 新版本实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2018 年 11 月 14 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/mariadb-upgrade/">https://wsgzao.github.io/post/mariadb-upgrade/</a></p><p><strong> 扩展阅读 </strong></p><p>MariaDB - <a href="https://mariadb.org/" target="_blank" rel="noopener">https://mariadb.org/</a></p><hr><h2 id="备份数据库"><a href="#备份数据库" class="headerlink" title="备份数据库"></a>备份数据库</h2><blockquote><p>重要的事情说三遍，备份，备份，备份</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份数据库，如果升级顺利是不要实施备份还原的 </span></span><br><span class="line">mysqldump -u root -p --all-databases &gt; alldb.sql</span><br><span class="line"><span class="comment"># 如果想保留自己的 my.cof 配置，则备份一下这个文件 </span></span><br><span class="line">cp /etc/my.cnf /etc/my.cnf.bak</span><br><span class="line"><span class="comment"># 停止数据库运行 </span></span><br><span class="line">systemctl stop mariadb</span><br><span class="line"><span class="comment"># 卸载 MariaDB 老版本 </span></span><br><span class="line">yum remove mariadb mariadb-server</span><br></pre></td></tr></table></figure><h2 id="添加-MariaDB-Yum-库"><a href="#添加-MariaDB-Yum-库" class="headerlink" title="添加 MariaDB Yum 库"></a>添加 MariaDB Yum 库</h2><blockquote><p>建议使用 MariaDB 官方推荐的 stable 稳定版，</p></blockquote><p><a href="https://downloads.mariadb.org/mariadb/" target="_blank" rel="noopener">https://downloads.mariadb.org/mariadb/</a><br><a href="http://yum.mariadb.org/" target="_blank" rel="noopener">http://yum.mariadb.org/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加 MariaDB 官方源 </span></span><br><span class="line">vi /etc/yum.repos.d/MariaDB.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># MariaDB 10.3 CentOS repository list</span></span><br><span class="line"><span class="comment"># http://downloads.mariadb.org/mariadb/repositories/</span></span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = http://yum.mariadb.org/10.3/centos7-amd64</span><br><span class="line">gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除 yum 缓存 </span></span><br><span class="line">yum clean all </span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure><h2 id="升级已有数据库"><a href="#升级已有数据库" class="headerlink" title="升级已有数据库"></a>升级已有数据库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 MariaDB 新版本 </span></span><br><span class="line">yum install mariadb mariadb-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动新版 MariaDB</span></span><br><span class="line">systemctl start mariadb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级已有数据库 </span></span><br><span class="line">mysql_upgrade -uroot -p </span><br><span class="line"></span><br><span class="line">[root@sg-gop-10-71-12-89 tmp]<span class="comment"># mysql_upgrade -uroot -p</span></span><br><span class="line">Enter password:</span><br><span class="line">Phase 1/7: Checking and upgrading mysql database</span><br><span class="line">Processing databases</span><br><span class="line">mysql</span><br><span class="line">mysql.columns_priv                                 OK</span><br><span class="line">mysql.db                                           OK</span><br><span class="line">mysql.event                                        OK</span><br><span class="line">mysql.func                                         OK</span><br><span class="line">mysql.help_category                                OK</span><br><span class="line">mysql.help_keyword                                 OK</span><br><span class="line">mysql.help_relation                                OK</span><br><span class="line">mysql.help_topic                                   OK</span><br><span class="line">mysql.host                                         OK</span><br><span class="line">mysql.ndb_binlog_index                             OK</span><br><span class="line">mysql.plugin                                       OK</span><br><span class="line">mysql.proc                                         OK</span><br><span class="line">mysql.procs_priv                                   OK</span><br><span class="line">mysql.proxies_priv                                 OK</span><br><span class="line">mysql.servers                                      OK</span><br><span class="line">mysql.tables_priv                                  OK</span><br><span class="line">mysql.time_zone                                    OK</span><br><span class="line">mysql.time_zone_leap_second                        OK</span><br><span class="line">mysql.time_zone_name                               OK</span><br><span class="line">mysql.time_zone_transition                         OK</span><br><span class="line">mysql.time_zone_transition_type                    OK</span><br><span class="line">mysql.user                                         OK</span><br><span class="line">Upgrading from a version before MariaDB-10.1</span><br><span class="line">Phase 2/7: Installing used storage engines</span><br><span class="line">Checking <span class="keyword">for</span> tables with unknown storage engine</span><br><span class="line">Phase 3/7: Fixing views</span><br><span class="line">Phase 4/7: Running <span class="string">'mysql_fix_privilege_tables'</span></span><br><span class="line">Phase 5/7: Fixing table and database names</span><br><span class="line">Phase 6/7: Checking and upgrading tables</span><br><span class="line">Processing databases</span><br><span class="line">information_schema</span><br><span class="line">performance_schema</span><br><span class="line">zabbix</span><br><span class="line">zabbix.acknowledges                                OK</span><br><span class="line">zabbix.actions                                     OK</span><br><span class="line">zabbix.alerts                                      OK</span><br><span class="line">zabbix.application_discovery                       OK</span><br><span class="line">zabbix.application_prototype                       OK</span><br><span class="line">zabbix.application_template                        OK</span><br><span class="line">zabbix.applications                                OK</span><br><span class="line">zabbix.auditlog                                    OK</span><br><span class="line">zabbix.auditlog_details                            OK</span><br><span class="line">zabbix.autoreg_host                                OK</span><br><span class="line">zabbix.conditions                                  OK</span><br><span class="line">zabbix.config                                      OK</span><br><span class="line">zabbix.corr_condition                              OK</span><br><span class="line">zabbix.corr_condition_group                        OK</span><br><span class="line">zabbix.corr_condition_tag                          OK</span><br><span class="line">zabbix.corr_condition_tagpair                      OK</span><br><span class="line">zabbix.corr_condition_tagvalue                     OK</span><br><span class="line">zabbix.corr_operation                              OK</span><br><span class="line">zabbix.correlation                                 OK</span><br><span class="line">zabbix.dashboard                                   OK</span><br><span class="line">zabbix.dashboard_user                              OK</span><br><span class="line">zabbix.dashboard_usrgrp                            OK</span><br><span class="line">zabbix.dbversion                                   OK</span><br><span class="line">zabbix.dchecks                                     OK</span><br><span class="line">zabbix.dhosts                                      OK</span><br><span class="line">zabbix.drules                                      OK</span><br><span class="line">zabbix.dservices                                   OK</span><br><span class="line">zabbix.escalations                                 OK</span><br><span class="line">zabbix.event_recovery                              OK</span><br><span class="line">zabbix.event_suppress                              OK</span><br><span class="line">zabbix.event_tag                                   OK</span><br><span class="line">zabbix.events                                      OK</span><br><span class="line">zabbix.expressions                                 OK</span><br><span class="line">zabbix.functions                                   OK</span><br><span class="line">zabbix.globalmacro                                 OK</span><br><span class="line">zabbix.globalvars                                  OK</span><br><span class="line">zabbix.graph_discovery                             OK</span><br><span class="line">zabbix.graph_theme                                 OK</span><br><span class="line">zabbix.graphs                                      OK</span><br><span class="line">zabbix.graphs_items                                OK</span><br><span class="line">zabbix.group_discovery                             OK</span><br><span class="line">zabbix.group_prototype                             OK</span><br><span class="line">zabbix.history                                     OK</span><br><span class="line">zabbix.history_log                                 OK</span><br><span class="line">zabbix.history_str                                 OK</span><br><span class="line">zabbix.history_text                                OK</span><br><span class="line">zabbix.history_uint                                OK</span><br><span class="line">zabbix.host_discovery                              OK</span><br><span class="line">zabbix.host_inventory                              OK</span><br><span class="line">zabbix.hostmacro                                   OK</span><br><span class="line">zabbix.hosts                                       OK</span><br><span class="line">zabbix.hosts_groups                                OK</span><br><span class="line">zabbix.hosts_templates                             OK</span><br><span class="line">zabbix.housekeeper                                 OK</span><br><span class="line">zabbix.hstgrp                                      OK</span><br><span class="line">zabbix.httpstep                                    OK</span><br><span class="line">zabbix.httpstep_field                              OK</span><br><span class="line">zabbix.httpstepitem                                OK</span><br><span class="line">zabbix.httptest                                    OK</span><br><span class="line">zabbix.httptest_field                              OK</span><br><span class="line">zabbix.httptestitem                                OK</span><br><span class="line">zabbix.icon_map                                    OK</span><br><span class="line">zabbix.icon_mapping                                OK</span><br><span class="line">zabbix.ids                                         OK</span><br><span class="line">zabbix.images                                      OK</span><br><span class="line">zabbix.interface                                   OK</span><br><span class="line">zabbix.interface_discovery                         OK</span><br><span class="line">zabbix.item_application_prototype                  OK</span><br><span class="line">zabbix.item_condition                              OK</span><br><span class="line">zabbix.item_discovery                              OK</span><br><span class="line">zabbix.item_preproc                                OK</span><br><span class="line">zabbix.items                                       OK</span><br><span class="line">zabbix.items_applications                          OK</span><br><span class="line">zabbix.maintenance_tag                             OK</span><br><span class="line">zabbix.maintenances                                OK</span><br><span class="line">zabbix.maintenances_groups                         OK</span><br><span class="line">zabbix.maintenances_hosts                          OK</span><br><span class="line">zabbix.maintenances_windows                        OK</span><br><span class="line">zabbix.mappings                                    OK</span><br><span class="line">zabbix.media                                       OK</span><br><span class="line">zabbix.media_type                                  OK</span><br><span class="line">zabbix.opcommand                                   OK</span><br><span class="line">zabbix.opcommand_grp                               OK</span><br><span class="line">zabbix.opcommand_hst                               OK</span><br><span class="line">zabbix.opconditions                                OK</span><br><span class="line">zabbix.operations                                  OK</span><br><span class="line">zabbix.opgroup                                     OK</span><br><span class="line">zabbix.opinventory                                 OK</span><br><span class="line">zabbix.opmessage                                   OK</span><br><span class="line">zabbix.opmessage_grp                               OK</span><br><span class="line">zabbix.opmessage_usr                               OK</span><br><span class="line">zabbix.optemplate                                  OK</span><br><span class="line">zabbix.problem                                     OK</span><br><span class="line">zabbix.problem_tag                                 OK</span><br><span class="line">zabbix.profiles                                    OK</span><br><span class="line">zabbix.proxy_autoreg_host                          OK</span><br><span class="line">zabbix.proxy_dhistory                              OK</span><br><span class="line">zabbix.proxy_history                               OK</span><br><span class="line">zabbix.regexps                                     OK</span><br><span class="line">zabbix.rights                                      OK</span><br><span class="line">zabbix.screen_user                                 OK</span><br><span class="line">zabbix.screen_usrgrp                               OK</span><br><span class="line">zabbix.screens                                     OK</span><br><span class="line">zabbix.screens_items                               OK</span><br><span class="line">zabbix.scripts                                     OK</span><br><span class="line">zabbix.service_alarms                              OK</span><br><span class="line">zabbix.services                                    OK</span><br><span class="line">zabbix.services_links                              OK</span><br><span class="line">zabbix.services_times                              OK</span><br><span class="line">zabbix.sessions                                    OK</span><br><span class="line">zabbix.slides                                      OK</span><br><span class="line">zabbix.slideshow_user                              OK</span><br><span class="line">zabbix.slideshow_usrgrp                            OK</span><br><span class="line">zabbix.slideshows                                  OK</span><br><span class="line">zabbix.sysmap_element_trigger                      OK</span><br><span class="line">zabbix.sysmap_element_url                          OK</span><br><span class="line">zabbix.sysmap_shape                                OK</span><br><span class="line">zabbix.sysmap_url                                  OK</span><br><span class="line">zabbix.sysmap_user                                 OK</span><br><span class="line">zabbix.sysmap_usrgrp                               OK</span><br><span class="line">zabbix.sysmaps                                     OK</span><br><span class="line">zabbix.sysmaps_elements                            OK</span><br><span class="line">zabbix.sysmaps_link_triggers                       OK</span><br><span class="line">zabbix.sysmaps_links                               OK</span><br><span class="line">zabbix.tag_filter                                  OK</span><br><span class="line">zabbix.task                                        OK</span><br><span class="line">zabbix.task_acknowledge                            OK</span><br><span class="line">zabbix.task_check_now                              OK</span><br><span class="line">zabbix.task_close_problem                          OK</span><br><span class="line">zabbix.task_remote_command                         OK</span><br><span class="line">zabbix.task_remote_command_result                  OK</span><br><span class="line">zabbix.timeperiods                                 OK</span><br><span class="line">zabbix.trends                                      OK</span><br><span class="line">zabbix.trends_uint                                 OK</span><br><span class="line">zabbix.trigger_depends                             OK</span><br><span class="line">zabbix.trigger_discovery                           OK</span><br><span class="line">zabbix.trigger_tag                                 OK</span><br><span class="line">zabbix.triggers                                    OK</span><br><span class="line">zabbix.users                                       OK</span><br><span class="line">zabbix.users_groups                                OK</span><br><span class="line">zabbix.usrgrp                                      OK</span><br><span class="line">zabbix.valuemaps                                   OK</span><br><span class="line">zabbix.widget                                      OK</span><br><span class="line">zabbix.widget_field                                OK</span><br><span class="line">Phase 7/7: Running <span class="string">'FLUSH PRIVILEGES'</span></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置服务自启动 </span></span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录数据库验证 </span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级过程遇到错误记得先查看日志分析 </span></span><br></pre></td></tr></table></figure><h2 id="MariaDB-官方升级文档"><a href="#MariaDB-官方升级文档" class="headerlink" title="MariaDB 官方升级文档"></a>MariaDB 官方升级文档</h2><p>Upgrading from MariaDB 5.5 to MariaDB 10.0<br><a href="https://mariadb.com/kb/en/library/upgrading-from-mariadb-55-to-mariadb-100/" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/upgrading-from-mariadb-55-to-mariadb-100/</a></p>]]></content>
    
    <summary type="html">
    
      CentOS7平滑升级MariaDB 5.5到10.x新版本实践
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>macOS 使用 homebrew-bundle 优雅的备份和恢复软件列表</title>
    <link href="https://wsgzao.github.io/post/homebrew-bundle/"/>
    <id>https://wsgzao.github.io/post/homebrew-bundle/</id>
    <published>2018-11-07T06:59:49.000Z</published>
    <updated>2018-11-07T10:50:52.494Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>每个人都会积累一套自己习惯使用的 App。如果平时习惯使用 Time Machine 备份，那么在重装系统时，直接用它还原倒是一个不错的办法，不必再手动安装一个个 App。但是有些时候，我们可能想要一个更加「干净」的新系统，此时就需要依次手动安装。这显然不是个高效、省心的方法，可能还需要一个个回忆之前用的 App。这时候，我们往往希望有一份属于自己的 App 清单，最好还能在重装时一键安装，省心省力。无论是 Windows 还是 macOS 下我们都希望实现一键装机，而 homebrew-bundle 正是这样一款 Mac 下的备份恢复利器。</p><blockquote><p>macOS 使用 homebrew-bundle 优雅的备份和恢复软件列表</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2018 年 11 月 07 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/homebrew-bundle/">https://wsgzao.github.io/post/homebrew-bundle/</a></p><p><strong> 扩展阅读 </strong></p><p>定期自动云备份 macOS 软件列表，维护一份属于自己的必备 App 清单 - <a href="https://sspai.com/post/43265" target="_blank" rel="noopener">https://sspai.com/post/43265</a><br>狡兔三窟——云备份软件列表与相应配置，补充 Time Machine - <a href="https://sspai.com/post/43479" target="_blank" rel="noopener">https://sspai.com/post/43479</a></p><hr><h2 id="Time-Machine"><a href="#Time-Machine" class="headerlink" title="Time Machine"></a>Time Machine</h2><p>macOS 自带的 Time Machine 无疑是备份与还原的利器。无论是重装系统，还是新机配置，Time Machine 用起来都十分方便、省心。但是它存在以下不足：</p><ol><li>如果直接在本机硬盘上备份，Time Machine 动辄百 G 的硬盘占用，令小硬盘电脑用户望而却步。而且一般情况下，电脑内只有一块硬盘，如果系统和备份在同一硬盘上，那么硬盘挂了就两者皆挂。</li><li>如果使用网络备份，带宽和网络空间费用可能都是问题。</li><li>如果使用 NAS 或者使用树莓派架设 Time Capsule，则需要有一定的计算机相关基础和折腾能力。</li></ol><p>即使上述情况对你来说都不是问题，多一种备份方式也是多一份安全和保障。</p><h2 id="homebrew-bundle"><a href="#homebrew-bundle" class="headerlink" title="homebrew-bundle"></a>homebrew-bundle</h2><blockquote><p>Bundler for non-Ruby dependencies from Homebrew</p></blockquote><p>homebrew-bundle - <a href="https://github.com/Homebrew/homebrew-bundle" target="_blank" rel="noopener">https://github.com/Homebrew/homebrew-bundle</a></p><ol><li>Mac 上非常常用的包管理器 Homebrew, 我们经常用它来安装其他的软件包</li><li>还有 Homebrew-cask, 可以用来安装图形界面的 App</li><li>homebrew-bundle 类似 node 中的 package.json 或者 Cocoapods 中的 Podfile</li><li>我们将需要的包和 App, 声明在一个 Brewfile 中, 然后执行 brew bundle 即可安装所有包</li></ol><h3 id="homebrew-bundle-如何备份"><a href="#homebrew-bundle-如何备份" class="headerlink" title="homebrew-bundle 如何备份"></a>homebrew-bundle 如何备份</h3><p>备份列表包含:</p><ol><li>brew tap 中的软件库</li><li>brew 安装的命令行工具</li><li>brew cask 安装的 App</li><li>Mac App Store 安装的 App</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行 brew bundle dump 备份命令 </span></span><br><span class="line">brew bundle dump --describe --force --file=<span class="string">"~/Desktop/Brewfile"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数说明 </span></span><br><span class="line">--describe：为列表中的命令行工具加上说明性文字。</span><br><span class="line">--force：直接覆盖之前生成的 Brewfile 文件。如果没有该参数，则询问你是否覆盖。</span><br><span class="line">--file=<span class="string">"~/Desktop/Brewfile"</span>：在指定位置生成文件。如果没有该参数，则在当前目录生成 Brewfile 文件。</span><br><span class="line"></span><br><span class="line"><span class="comment"># 该命令会在桌面上生成 Brewfile 文件，双击打开查看，其内容类似于 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 该部分是 brew 中的 tap，相当于一个个软件库 </span></span><br><span class="line">tap <span class="string">"homebrew/bundle"</span></span><br><span class="line">tap <span class="string">"homebrew/cask"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 该部分是 brew 安装的命令行工具 </span></span><br><span class="line"><span class="comment"># Mac App Store command-line interface</span></span><br><span class="line">brew <span class="string">"mas"</span></span><br><span class="line"><span class="comment"># UNIX shell (command interpreter)</span></span><br><span class="line">brew <span class="string">"zsh"</span></span><br><span class="line"><span class="comment"># Fish shell like syntax highlighting for zsh</span></span><br><span class="line">brew <span class="string">"zsh-syntax-highlighting"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 该部分是 brew cask 安装的 app</span></span><br><span class="line">cask <span class="string">"mounty"</span></span><br><span class="line">cask <span class="string">"dteoh/sqa/slowquitapps"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 该部分是 Mac App Store 安装的 app</span></span><br><span class="line">mas <span class="string">"ting_en"</span>, id: 734383760</span><br><span class="line">mas <span class="string">"Xcode"</span>, id: 497799835</span><br></pre></td></tr></table></figure><h3 id="homebrew-bundle-如何恢复"><a href="#homebrew-bundle-如何恢复" class="headerlink" title="homebrew-bundle 如何恢复"></a>homebrew-bundle 如何恢复</h3><blockquote><p>通过备份的软件列表文件批量安装软件</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 Homebrew</span></span><br><span class="line">/usr/bin/ruby -e <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span></span><br><span class="line"><span class="comment"># 安装 mas</span></span><br><span class="line">brew install mas</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量安装软件 </span></span><br><span class="line">brew bundle --file=<span class="string">"~/Desktop/Brewfile"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里分享一份自己的真实备份文件 </span></span><br><span class="line">wangao@wangao-MAC ~/Desktop <span class="comment"># cat Brewfile</span></span><br><span class="line">tap <span class="string">"buo/cask-upgrade"</span></span><br><span class="line">tap <span class="string">"dteoh/sqa"</span></span><br><span class="line">tap <span class="string">"homebrew/bundle"</span></span><br><span class="line">tap <span class="string">"homebrew/cask"</span></span><br><span class="line">tap <span class="string">"homebrew/core"</span></span><br><span class="line">tap <span class="string">"homebrew/services"</span></span><br><span class="line"><span class="comment"># GNU compiler collection</span></span><br><span class="line">brew <span class="string">"gcc"</span></span><br><span class="line"><span class="comment"># Distributed revision control system</span></span><br><span class="line">brew <span class="string">"git"</span>, link: <span class="literal">false</span></span><br><span class="line"><span class="comment"># Improved top (interactive process viewer)</span></span><br><span class="line">brew <span class="string">"htop"</span></span><br><span class="line"><span class="comment"># Mac App Store command-line interface</span></span><br><span class="line">brew <span class="string">"mas"</span></span><br><span class="line"><span class="comment"># MySQL database connector for C applications</span></span><br><span class="line">brew <span class="string">"mysql-connector-c"</span></span><br><span class="line"><span class="comment"># Platform built on V8 to build network applications</span></span><br><span class="line">brew <span class="string">"node"</span></span><br><span class="line"><span class="comment"># Perl compatible regular expressions library</span></span><br><span class="line">brew <span class="string">"pcre"</span></span><br><span class="line"><span class="comment"># Password generator</span></span><br><span class="line">brew <span class="string">"pwgen"</span></span><br><span class="line"><span class="comment"># Interpreted, interactive, object-oriented programming language</span></span><br><span class="line">brew <span class="string">"python"</span></span><br><span class="line"><span class="comment"># Interpreted, interactive, object-oriented programming language</span></span><br><span class="line">brew <span class="string">"python@2"</span></span><br><span class="line">brew <span class="string">"sshpass"</span></span><br><span class="line"><span class="comment"># User interface to the TELNET protocol (built from macOS Sierra sources)</span></span><br><span class="line">brew <span class="string">"telnet"</span></span><br><span class="line"><span class="comment"># Display directories as trees (with optional color/HTML output)</span></span><br><span class="line">brew <span class="string">"tree"</span></span><br><span class="line"><span class="comment"># Internet file retriever</span></span><br><span class="line">brew <span class="string">"wget"</span></span><br><span class="line"><span class="comment"># UNIX shell (command interpreter)</span></span><br><span class="line">brew <span class="string">"zsh"</span></span><br><span class="line"><span class="comment"># Fish shell like syntax highlighting for zsh</span></span><br><span class="line">brew <span class="string">"zsh-syntax-highlighting"</span></span><br><span class="line">cask <span class="string">"java"</span></span><br><span class="line">cask <span class="string">"mounty"</span></span><br><span class="line">cask <span class="string">"xquartz"</span></span><br><span class="line">cask <span class="string">"dteoh/sqa/slowquitapps"</span></span><br><span class="line">mas <span class="string">"GarageBand"</span>, id: 682658836</span><br><span class="line">mas <span class="string">"iMovie"</span>, id: 408981434</span><br><span class="line">mas <span class="string">"Keynote"</span>, id: 409183694</span><br><span class="line">mas <span class="string">"Microsoft Remote Desktop"</span>, id: 1295203466</span><br><span class="line">mas <span class="string">"Numbers"</span>, id: 409203825</span><br><span class="line">mas <span class="string">"Pages"</span>, id: 409201541</span><br><span class="line">mas <span class="string">"ting_en"</span>, id: 734383760</span><br><span class="line">mas <span class="string">"Xcode"</span>, id: 497799835</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      macOS 使用 homebrew-bundle 优雅的备份和恢复软件列表
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Zabbix 常见问题整理</title>
    <link href="https://wsgzao.github.io/post/zabbix-faq/"/>
    <id>https://wsgzao.github.io/post/zabbix-faq/</id>
    <published>2018-11-02T06:59:49.000Z</published>
    <updated>2018-11-07T11:09:30.317Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>根据安装和使用 Zabbix 中遇到的常见报错提示，结合 Zabbix 官网和 Google 到的一些解决方案，简单做下分享</p><blockquote><p>Zabbix 常见问题整理</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2018 年 11 月 02 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/zabbix-faq/">https://wsgzao.github.io/post/zabbix-faq/</a></p><p><strong> 扩展阅读 </strong></p><p>Zabbix - <a href="https://www.zabbix.com/" target="_blank" rel="noopener">https://www.zabbix.com/</a></p><hr><h2 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h2><p>Frequently asked questions / Troubleshooting</p><p><a href="https://www.zabbix.org/wiki/Troubleshooting" target="_blank" rel="noopener">https://www.zabbix.org/wiki/Troubleshooting</a><br><a href="https://www.zabbix.com/documentation/current/manual/appendix/faq" target="_blank" rel="noopener">https://www.zabbix.com/documentation/current/manual/appendix/faq</a></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><blockquote><p>常见错误建议先查看 log，常见的问题通常由权限，防火墙，数据库，参数错误，性能瓶颈等问题导致</p></blockquote><p>1.zabbix_get [7189]: Check access restrictions in Zabbix agent configuration<br>zabbix 的服务器端与客户端连接的主要工具就是 zabbix 里 bin 文件夹下的 zabbix_get 文件，这个命令只能在 zabbix 的 server 端使用</p><p>2.Assuming that agent dropped connection because of access permissions（由于访问权限导致 agent 连接失败）<br>问题实现：zabbix_server 和 zabbix_agent 在同一台机器，server 监听全网地址，agent 监听内网地址。导致上面的报错发生<br>解决方案：把 zabbix_agentd.conf 中 的 server 把 zabbix_server 的公网和内网地址都加行。然后 agent 就可以正常获取到值了</p><ol start="3"><li>解决 zabbix 中文乱码问题</li></ol><p>方法一：下载文泉驿字体<br>yum -y install wqy-microhei-fonts<br>cp /usr/share/fonts/wqy-microhei/wqy-microhei.ttc /usr/share/fonts/dejavu/DejaVuSans.ttf</p><p>方法二：从 Windows 中拷贝<br>cd /usr/share/zabbix/fonts<br>从 windows 拷贝 simhei.ttf 字体到当前目录<br>替换配置文件<br>vim /usr/share/zabbix/include/defines.inc.php<br>define(‘ZBX_GRAPH_FONT_NAME’,           ‘simhei’)</p><p>4.Zabbix 报 No route to host<br>原来是被客户端的防火墙档掉了，关闭客户端防火墙或者配置相应规则即可</p><p>5.No active checks on server: host [] not found<br>查看监控机上的 / tmp/zabbix_server.log，显示日志：<br>cannot send list of active checks to [192.168.0.1]: host [Zabbix server] not found<br>查看被监控机上的 / tmp/zabbix_agentd.log，显示日志：<br>No active checks on server: host [Zabbix server] not found<br>这是因为通过 zabbix dashboard 页面配置的被监控主机名跟被监控主机上 zabbix_agentd.conf 中配置的 Hostname 不一致。修改为一致的名字后，重启 zabbix_agentd 即可。</p>]]></content>
    
    <summary type="html">
    
      Zabbix常见问题整理
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Zabbix Proxy 分布式监控安装和配置实践</title>
    <link href="https://wsgzao.github.io/post/zabbix-proxy/"/>
    <id>https://wsgzao.github.io/post/zabbix-proxy/</id>
    <published>2018-11-02T06:59:49.000Z</published>
    <updated>2018-11-02T09:18:16.286Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Zabbix 最简单的监控模式莫过于 Zabbix Server -&gt; Zabbix Agent, 默认的监控类型是 Zabbix agent(俗称被动模式)。但是在监控服务器数量越来越多，且地理位置分散在全球各个角落的时候，孤零零的 Zabbix Server 就显得力不从心了，这时候就轮到 Zabbix Proxy 闪亮登场。</p><blockquote><p>Zabbix Proxy 分布式监控安装和配置实践</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2018 年 11 月 02 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/zabbix-proxy/">https://wsgzao.github.io/post/zabbix-proxy/</a></p><p><strong> 扩展阅读 </strong></p><p>Zabbix - <a href="https://www.zabbix.com/" target="_blank" rel="noopener">https://www.zabbix.com/</a></p><hr><h2 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h2><p><a href="https://www.zabbix.com/documentation/current/manual/concepts/proxy" target="_blank" rel="noopener">https://www.zabbix.com/documentation/current/manual/concepts/proxy</a><br><a href="https://www.zabbix.com/documentation/3.4/zh/manual/concepts/proxy" target="_blank" rel="noopener">https://www.zabbix.com/documentation/3.4/zh/manual/concepts/proxy</a><br><a href="https://www.zabbix.com/download" target="_blank" rel="noopener">https://www.zabbix.com/download</a></p><h2 id="Zabbix-Proxy-介绍"><a href="#Zabbix-Proxy-介绍" class="headerlink" title="Zabbix Proxy 介绍"></a>Zabbix Proxy 介绍</h2><p>Zabbix Proxy 可以代替 Zabbix Server 检索客户端的数据，然后把数据汇报给 Zabbix Server，<br>并且在一定程度上分担了 Zabbix Server 的压力。Zabbix Proxy 可以非常简便的实现了集中式、分布式监控。</p><p>Zabbix Proxy 使用场景:</p><ol><li>监控远程区域设备</li><li>监控本地网络不稳定区域</li><li>当 Zabbix 监控上千设备时，使用它来减轻 Server 的压力</li><li>简化 Zabbix 的维护</li></ol><p>Zabbix Proxy 仅仅需要一条 TCP 连接到 Zabbix Server，所以防火墙上仅仅需要加上一条规则即可。<br>Zabbix Proxy 数据库必须和 Zabbix Server 分开，否则数据会被破坏，毕竟这两个数据库的表大部分都相同。<br>总之记住，数据库分开即可。<br>Zabbix Proxy 收集到数据之后，首先将数据缓存在本地，然后在一定的时间之后传递给 Zabbix Server。<br>这个时间由 Zabbix Proxy 配置文件中参数 ProxyLocalBuffer and ProxyOfflineBuffer 决定。    </p><p>Zabbix Proxy 是一个数据收集器，它不计算触发器、不处理事件、不发送报警。</p><h2 id="Zabbix-Proxy-安装"><a href="#Zabbix-Proxy-安装" class="headerlink" title="Zabbix Proxy 安装"></a>Zabbix Proxy 安装</h2><p>Zabbix Proxy 架构变化其实很简单，通常在每个机房搭建一台，最终把数据汇总到 Zabbix Server</p><ol><li>Zabbix Server -&gt; Zabbix Proxy -&gt; Zabbix Agent</li><li>Items 变为 Zabbix agent(active)，俗称主动模式</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zabbix proxy 的依赖就只有数据库了，用于存储配置信息 </span></span><br><span class="line">yum install -y mariadb-server mariadb</span><br><span class="line"><span class="comment"># 启动 mariadb 服务 </span></span><br><span class="line">systemctl start mariadb.service</span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb.service</span><br><span class="line"><span class="comment"># 初始化 mysql 数据库，并配置 root 用户密码 </span></span><br><span class="line">mysql_secure_installation</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 zabbix_proxy 数据库 </span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line">mysql&gt; create database zabbix_proxy character <span class="built_in">set</span> utf8 collate utf8_bin;</span><br><span class="line">mysql&gt; grant all privileges on zabbix_proxy.* to zabbix@localhost identified by <span class="string">'zabbix'</span>;</span><br><span class="line">mysql&gt; quit;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署 zabbix_proxy</span></span><br><span class="line">rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm</span><br><span class="line">yum install -y zabbix-proxy-mysql</span><br><span class="line">zcat /usr/share/doc/zabbix-proxy-mysql*/schema.sql.gz | mysql -uzabbix -p zabbix_proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据库用户及密码 </span></span><br><span class="line">vim /etc/zabbix/zabbix_proxy.conf</span><br><span class="line">Server=192.168.56.103</span><br><span class="line">Hostname=zabbix_proxy</span><br><span class="line">DBName=zabbix_proxy</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 Zabbix Server Proxy</span></span><br><span class="line">Administration -&gt; Proxies -&gt; Create proxy</span><br><span class="line">Proxy name: zabbix_proxy</span><br><span class="line">Proxy mode: Active</span><br><span class="line">Proxy address: 192.168.56.101</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 zabbix_proxy</span></span><br><span class="line">systemctl restart zabbix-proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 zabbix_agent 配置指向 zabbix_proxy</span></span><br><span class="line">vim /etc/zabbix/zabbix_agentd.conf</span><br><span class="line">Server=192.168.56.101,192.168.56.103</span><br><span class="line">ServerActive=192.168.56.101</span><br><span class="line">Hostname=192.168.56.101</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 zabbix_proxy 服务 </span></span><br><span class="line">systemctl <span class="built_in">enable</span> zabbix-proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 zabbix_server 中添加代理主机 </span></span><br><span class="line">Configuration -&gt; Hosts -&gt; Create host</span><br><span class="line">Monitored by proxy: zabbix_proxy</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      Zabbix Proxy分布式监控安装和配置实践
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Zabbix 3.x 升级到 Zabbix 4.x</title>
    <link href="https://wsgzao.github.io/post/zabbix-upgrade/"/>
    <id>https://wsgzao.github.io/post/zabbix-upgrade/</id>
    <published>2018-11-01T06:59:49.000Z</published>
    <updated>2018-11-02T02:28:43.643Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Zabbix 目前已经发布 4.0 LTS 长期支持版，虽然很多插件还停留在 3.4 版本比如 Grafana，但是还是要提前做好准备。生产环境建议暂时保持在 3.4 版本，因为在 4.0 版本中很多语法发生改变，建议仔细评估。最重要的事情提醒三遍，不要忘记备份，不要忘记备份，不要忘记备份。</p><blockquote><p>Zabbix 3.x 升级到 Zabbix 4.x</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2018 年 11 月 01 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/zabbix-upgrade/">https://wsgzao.github.io/post/zabbix-upgrade/</a></p><p><strong> 扩展阅读 </strong></p><p>Zabbix - <a href="https://www.zabbix.com/" target="_blank" rel="noopener">https://www.zabbix.com/</a></p><hr><h2 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h2><p><a href="https://www.zabbix.com/documentation/4.0/manual/installation/upgrade_notes_400" target="_blank" rel="noopener">https://www.zabbix.com/documentation/4.0/manual/installation/upgrade_notes_400</a><br><a href="https://www.zabbix.com/documentation/3.4/zh/manual/installation/upgrade" target="_blank" rel="noopener">https://www.zabbix.com/documentation/3.4/zh/manual/installation/upgrade</a><br><a href="https://www.zabbix.com/download" target="_blank" rel="noopener">https://www.zabbix.com/download</a></p><h2 id="Zabbix-升级步骤"><a href="#Zabbix-升级步骤" class="headerlink" title="Zabbix 升级步骤"></a>Zabbix 升级步骤</h2><h3 id="备份数据库"><a href="#备份数据库" class="headerlink" title="备份数据库"></a>备份数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据库全备时间比较长且文件交大，建议压缩或者使用 xtrabackup</span></span><br><span class="line">mysqldump -uzabbix -pzabbix --opt --skip-lock-tables --database zabbix &gt; zabbix.sql</span><br><span class="line">mysqldump -uzabbix -pzabbix --opt --skip-lock-tables --database zabbix | gzip &gt; zabbix_`date +<span class="string">'%Y%m%d%H%M%S'</span>`.sql.gz</span><br></pre></td></tr></table></figure><h3 id="CentOS"><a href="#CentOS" class="headerlink" title="CentOS"></a>CentOS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止服务 </span></span><br><span class="line">service zabbix-server stop</span><br><span class="line">service zabbix-agent stop</span><br><span class="line">service httpd stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份 zabbix 文件 </span></span><br><span class="line">mkdir /opt/zabbix-backup/</span><br><span class="line">cp /etc/zabbix/zabbix_server.conf /opt/zabbix-backup/</span><br><span class="line">cp /etc/httpd/conf.d/zabbix.conf  /opt/zabbix-backup/</span><br><span class="line">cp -R /usr/share/zabbix/ /opt/zabbix-backup/</span><br><span class="line">cp -R /usr/share/doc/zabbix-* /opt/zabbix-backup/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级 zabbix 源 </span></span><br><span class="line">rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm</span><br><span class="line"><span class="comment"># 升级 zabbix</span></span><br><span class="line"><span class="comment"># yum upgrade zabbix-server-mysql zabbix-web-mysql zabbix-agent zabbix-proxy-mysql</span></span><br><span class="line">yum clean all</span><br><span class="line">yum upgrade zabbix-server-mysql zabbix-web-mysql zabbix-agent </span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 zabbix</span></span><br><span class="line">service zabbix-server start</span><br><span class="line">service zabbix-agent start</span><br><span class="line">service httpd start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查升级日志 </span></span><br><span class="line">tail -f /var/<span class="built_in">log</span>/zabbix/zabbix_server.log</span><br><span class="line"></span><br><span class="line">5044:20181101:212148.975 Starting Zabbix Server. Zabbix 4.0.1 (revision 86073).</span><br><span class="line">  5044:20181101:212149.173 ****** Enabled features ******</span><br><span class="line">  5044:20181101:212149.173 SNMP monitoring:           YES</span><br><span class="line">  5044:20181101:212149.173 IPMI monitoring:           YES</span><br><span class="line">  5044:20181101:212149.173 Web monitoring:            YES</span><br><span class="line">  5044:20181101:212149.173 VMware monitoring:         YES</span><br><span class="line">  5044:20181101:212149.173 SMTP authentication:       YES</span><br><span class="line">  5044:20181101:212149.173 Jabber notifications:      YES</span><br><span class="line">  5044:20181101:212149.173 Ez Texting notifications:  YES</span><br><span class="line">  5044:20181101:212149.173 ODBC:                      YES</span><br><span class="line">  5044:20181101:212149.173 SSH2 support:              YES</span><br><span class="line">  5044:20181101:212149.173 IPv6 support:              YES</span><br><span class="line">  5044:20181101:212149.173 TLS support:               YES</span><br><span class="line">  5044:20181101:212149.173 ******************************</span><br><span class="line">  5044:20181101:212149.173 using configuration file: /etc/zabbix/zabbix_server.conf</span><br><span class="line">  5044:20181101:212149.276 current database version (mandatory/optional): 03040000/03040007</span><br><span class="line">  5044:20181101:212149.360 required mandatory version: 04000000</span><br><span class="line">  5044:20181101:212149.361 starting automatic database upgrade</span><br><span class="line">  5044:20181101:212149.774 completed 0% of database upgrade</span><br><span class="line">  5044:20181101:212149.775 completed 1% of database upgrade</span><br><span class="line">  5044:20181101:212149.865 completed 2% of database upgrade</span><br><span class="line">  5044:20181101:212149.867 completed 3% of database upgrade</span><br><span class="line">  5044:20181101:212149.871 completed 4% of database upgrade</span><br><span class="line">  5044:20181101:212149.874 completed 5% of database upgrade</span><br><span class="line">  5044:20181101:212149.922 completed 6% of database upgrade</span><br><span class="line">  5044:20181101:212150.015 completed 7% of database upgrade</span><br><span class="line">  5044:20181101:212150.169 completed 8% of database upgrade</span><br><span class="line">  5044:20181101:212150.314 completed 9% of database upgrade</span><br><span class="line">  5044:20181101:212150.469 completed 10% of database upgrade</span><br><span class="line">  5044:20181101:212150.523 completed 11% of database upgrade</span><br><span class="line">  5044:20181101:212150.563 completed 12% of database upgrade</span><br><span class="line">  5044:20181101:212150.565 completed 13% of database upgrade</span><br><span class="line">  5044:20181101:212150.574 completed 14% of database upgrade</span><br><span class="line">  5044:20181101:212150.621 completed 15% of database upgrade</span><br><span class="line">  5044:20181101:212150.715 completed 16% of database upgrade</span><br><span class="line">  5044:20181101:212150.809 completed 17% of database upgrade</span><br><span class="line">  5044:20181101:212150.818 completed 18% of database upgrade</span><br><span class="line">  5044:20181101:212150.867 completed 19% of database upgrade</span><br><span class="line">  5044:20181101:212150.871 completed 20% of database upgrade</span><br><span class="line">  5044:20181101:212150.959 completed 21% of database upgrade</span><br><span class="line">  5044:20181101:212151.124 completed 22% of database upgrade</span><br><span class="line">  5044:20181101:212151.209 completed 23% of database upgrade</span><br><span class="line">  5044:20181101:212151.272 completed 24% of database upgrade</span><br><span class="line">  5044:20181101:212151.275 completed 25% of database upgrade</span><br><span class="line">  5044:20181101:212151.314 completed 26% of database upgrade</span><br><span class="line">  5044:20181101:212152.118 completed 27% of database upgrade</span><br><span class="line">  5044:20181101:212152.613 completed 28% of database upgrade</span><br><span class="line">  5044:20181101:212153.271 completed 29% of database upgrade</span><br><span class="line">  5044:20181101:212153.570 completed 30% of database upgrade</span><br><span class="line">  5044:20181101:212154.869 completed 31% of database upgrade</span><br><span class="line">  5044:20181101:212156.368 completed 32% of database upgrade</span><br><span class="line">  5044:20181101:212156.665 completed 33% of database upgrade</span><br><span class="line">  5044:20181101:212157.465 completed 34% of database upgrade</span><br><span class="line">  5044:20181101:212157.820 completed 35% of database upgrade</span><br><span class="line">  5044:20181101:212158.509 completed 36% of database upgrade</span><br><span class="line">  5044:20181101:212200.662 completed 37% of database upgrade</span><br><span class="line">  5044:20181101:212200.710 completed 38% of database upgrade</span><br><span class="line">  5044:20181101:212200.715 completed 39% of database upgrade</span><br><span class="line">  5044:20181101:212200.761 completed 40% of database upgrade</span><br><span class="line">  5044:20181101:212200.807 completed 41% of database upgrade</span><br><span class="line">  5044:20181101:212200.810 completed 42% of database upgrade</span><br><span class="line">  5044:20181101:212200.811 completed 43% of database upgrade</span><br><span class="line">  5044:20181101:212200.813 completed 44% of database upgrade</span><br><span class="line">  5044:20181101:212200.815 completed 45% of database upgrade</span><br><span class="line">  5044:20181101:212200.818 completed 46% of database upgrade</span><br><span class="line">  5044:20181101:212200.913 completed 47% of database upgrade</span><br><span class="line">  5044:20181101:212200.960 completed 48% of database upgrade</span><br><span class="line">  5044:20181101:212201.013 completed 49% of database upgrade</span><br><span class="line">  5044:20181101:212201.116 completed 50% of database upgrade</span><br><span class="line">  5044:20181101:212201.119 completed 51% of database upgrade</span><br><span class="line">  5044:20181101:212201.157 completed 52% of database upgrade</span><br><span class="line">  5044:20181101:212201.160 completed 53% of database upgrade</span><br><span class="line">  5044:20181101:212201.164 completed 54% of database upgrade</span><br><span class="line">  5044:20181101:212201.166 completed 55% of database upgrade</span><br><span class="line">  5044:20181101:212201.169 completed 56% of database upgrade</span><br><span class="line">  5044:20181101:212201.206 completed 57% of database upgrade</span><br><span class="line">  5044:20181101:212201.208 completed 58% of database upgrade</span><br><span class="line">  5044:20181101:212201.305 completed 59% of database upgrade</span><br><span class="line">  5044:20181101:212201.308 completed 60% of database upgrade</span><br><span class="line">  5044:20181101:212201.311 completed 61% of database upgrade</span><br><span class="line">  5044:20181101:212201.356 completed 62% of database upgrade</span><br><span class="line">  5044:20181101:212201.363 completed 63% of database upgrade</span><br><span class="line">  5044:20181101:212201.413 completed 64% of database upgrade</span><br><span class="line">  5044:20181101:212201.414 completed 65% of database upgrade</span><br><span class="line">  5044:20181101:212201.465 completed 66% of database upgrade</span><br><span class="line">  5044:20181101:212201.517 completed 67% of database upgrade</span><br><span class="line">  5044:20181101:212201.562 completed 68% of database upgrade</span><br><span class="line">  5044:20181101:212201.656 completed 69% of database upgrade</span><br><span class="line">  5044:20181101:212201.666 completed 70% of database upgrade</span><br><span class="line">  5044:20181101:212201.719 completed 71% of database upgrade</span><br><span class="line">  5044:20181101:212201.758 completed 72% of database upgrade</span><br><span class="line">  5044:20181101:212201.760 completed 73% of database upgrade</span><br><span class="line">  5044:20181101:212201.764 completed 74% of database upgrade</span><br><span class="line">  5044:20181101:212201.766 completed 75% of database upgrade</span><br><span class="line">  5044:20181101:212201.817 completed 76% of database upgrade</span><br><span class="line">  5044:20181101:212201.862 completed 77% of database upgrade</span><br><span class="line">  5044:20181101:212202.054 completed 78% of database upgrade</span><br><span class="line">  5044:20181101:212202.112 completed 79% of database upgrade</span><br><span class="line">  5044:20181101:212202.158 completed 80% of database upgrade</span><br><span class="line">  5044:20181101:212202.210 completed 81% of database upgrade</span><br><span class="line">  5044:20181101:212202.261 completed 82% of database upgrade</span><br><span class="line">  5044:20181101:212202.315 completed 83% of database upgrade</span><br><span class="line">  5044:20181101:212202.566 completed 84% of database upgrade</span><br><span class="line">  5044:20181101:212202.609 completed 85% of database upgrade</span><br><span class="line">  5044:20181101:212202.619 completed 86% of database upgrade</span><br><span class="line">  5044:20181101:212202.656 completed 87% of database upgrade</span><br><span class="line">  5044:20181101:212202.659 completed 88% of database upgrade</span><br><span class="line">  5044:20181101:212202.661 completed 89% of database upgrade</span><br><span class="line">  5044:20181101:212202.669 completed 90% of database upgrade</span><br><span class="line">  5044:20181101:212202.761 completed 91% of database upgrade</span><br><span class="line">  5044:20181101:212203.214 completed 92% of database upgrade</span><br><span class="line">  5044:20181101:212203.360 completed 93% of database upgrade</span><br><span class="line">  5044:20181101:212203.365 completed 94% of database upgrade</span><br><span class="line">  5044:20181101:212203.403 completed 95% of database upgrade</span><br><span class="line">  5044:20181101:212203.417 completed 96% of database upgrade</span><br><span class="line">  5044:20181101:212203.467 completed 97% of database upgrade</span><br><span class="line">  5044:20181101:212203.508 completed 98% of database upgrade</span><br><span class="line">  5044:20181101:212203.564 completed 99% of database upgrade</span><br><span class="line">  5044:20181101:212203.566 completed 100% of database upgrade</span><br><span class="line">  5044:20181101:212203.566 database upgrade fully completed</span><br><span class="line">  5044:20181101:212203.660 starting event name update forced by database upgrade</span><br><span class="line">  5044:20181101:212203.706 completed 1% of event name update</span><br><span class="line">  5044:20181101:212203.706 completed 2% of event name update</span><br><span class="line">  5044:20181101:212203.706 completed 3% of event name update</span><br><span class="line">  5044:20181101:212203.706 completed 4% of event name update</span><br><span class="line">  5044:20181101:212203.706 completed 5% of event name update</span><br><span class="line">  5044:20181101:212203.706 completed 6% of event name update</span><br><span class="line">  5044:20181101:212203.706 completed 7% of event name update</span><br><span class="line">  5044:20181101:212203.706 completed 8% of event name update</span><br><span class="line">  5044:20181101:212203.706 completed 9% of event name update</span><br><span class="line">  5044:20181101:212203.706 completed 10% of event name update</span><br><span class="line">  5044:20181101:212203.706 completed 11% of event name update</span><br><span class="line">  5044:20181101:212203.706 completed 12% of event name update</span><br><span class="line">  5044:20181101:212203.707 completed 13% of event name update</span><br><span class="line">  5044:20181101:212203.707 completed 14% of event name update</span><br><span class="line">  5044:20181101:212203.707 completed 15% of event name update</span><br><span class="line">  5044:20181101:212203.707 completed 16% of event name update</span><br><span class="line">  5044:20181101:212203.707 completed 17% of event name update</span><br><span class="line">  5044:20181101:212203.707 completed 18% of event name update</span><br><span class="line">  5044:20181101:212203.707 completed 19% of event name update</span><br><span class="line">  5044:20181101:212203.707 completed 20% of event name update</span><br><span class="line">  5044:20181101:212203.707 completed 21% of event name update</span><br><span class="line">  5044:20181101:212203.707 completed 22% of event name update</span><br><span class="line">  5044:20181101:212203.707 completed 23% of event name update</span><br><span class="line">  5044:20181101:212203.707 completed 24% of event name update</span><br><span class="line">  5044:20181101:212203.707 completed 25% of event name update</span><br><span class="line">  5044:20181101:212203.708 completed 26% of event name update</span><br><span class="line">  5044:20181101:212203.708 completed 27% of event name update</span><br><span class="line">  5044:20181101:212203.708 completed 28% of event name update</span><br><span class="line">  5044:20181101:212203.708 completed 29% of event name update</span><br><span class="line">  5044:20181101:212203.708 completed 30% of event name update</span><br><span class="line">  5044:20181101:212203.708 completed 31% of event name update</span><br><span class="line">  5044:20181101:212203.708 completed 32% of event name update</span><br><span class="line">  5044:20181101:212203.710 completed 33% of event name update</span><br><span class="line">  5044:20181101:212203.712 completed 34% of event name update</span><br><span class="line">  5044:20181101:212203.714 completed 35% of event name update</span><br><span class="line">  5044:20181101:212203.717 completed 36% of event name update</span><br><span class="line">  5044:20181101:212203.717 completed 37% of event name update</span><br><span class="line">  5044:20181101:212203.717 completed 38% of event name update</span><br><span class="line">  5044:20181101:212203.717 completed 39% of event name update</span><br><span class="line">  5044:20181101:212203.718 completed 40% of event name update</span><br><span class="line">  5044:20181101:212203.718 completed 41% of event name update</span><br><span class="line">  5044:20181101:212203.718 completed 42% of event name update</span><br><span class="line">  5044:20181101:212203.718 completed 43% of event name update</span><br><span class="line">  5044:20181101:212203.718 completed 44% of event name update</span><br><span class="line">  5044:20181101:212203.718 completed 45% of event name update</span><br><span class="line">  5044:20181101:212203.718 completed 46% of event name update</span><br><span class="line">  5044:20181101:212203.718 completed 47% of event name update</span><br><span class="line">  5044:20181101:212203.718 completed 48% of event name update</span><br><span class="line">  5044:20181101:212203.719 completed 49% of event name update</span><br><span class="line">  5044:20181101:212203.719 completed 50% of event name update</span><br><span class="line">  5044:20181101:212203.758 completed 51% of event name update</span><br><span class="line">  5044:20181101:212203.804 completed 52% of event name update</span><br><span class="line">  5044:20181101:212203.804 completed 53% of event name update</span><br><span class="line">  5044:20181101:212203.804 completed 54% of event name update</span><br><span class="line">  5044:20181101:212203.804 completed 55% of event name update</span><br><span class="line">  5044:20181101:212203.805 completed 56% of event name update</span><br><span class="line">  5044:20181101:212203.805 completed 57% of event name update</span><br><span class="line">  5044:20181101:212203.805 completed 58% of event name update</span><br><span class="line">  5044:20181101:212203.805 completed 59% of event name update</span><br><span class="line">  5044:20181101:212203.805 completed 60% of event name update</span><br><span class="line">  5044:20181101:212203.805 completed 61% of event name update</span><br><span class="line">  5044:20181101:212203.805 completed 62% of event name update</span><br><span class="line">  5044:20181101:212203.805 completed 63% of event name update</span><br><span class="line">  5044:20181101:212203.805 completed 64% of event name update</span><br><span class="line">  5044:20181101:212203.805 completed 65% of event name update</span><br><span class="line">  5044:20181101:212203.805 completed 66% of event name update</span><br><span class="line">  5044:20181101:212203.806 completed 67% of event name update</span><br><span class="line">  5044:20181101:212203.806 completed 68% of event name update</span><br><span class="line">  5044:20181101:212203.806 completed 69% of event name update</span><br><span class="line">  5044:20181101:212203.807 completed 70% of event name update</span><br><span class="line">  5044:20181101:212203.807 completed 71% of event name update</span><br><span class="line">  5044:20181101:212203.807 completed 72% of event name update</span><br><span class="line">  5044:20181101:212203.807 completed 73% of event name update</span><br><span class="line">  5044:20181101:212203.807 completed 74% of event name update</span><br><span class="line">  5044:20181101:212203.807 completed 75% of event name update</span><br><span class="line">  5044:20181101:212203.807 completed 76% of event name update</span><br><span class="line">  5044:20181101:212203.807 completed 77% of event name update</span><br><span class="line">  5044:20181101:212203.808 completed 78% of event name update</span><br><span class="line">  5044:20181101:212203.808 completed 79% of event name update</span><br><span class="line">  5044:20181101:212203.808 completed 80% of event name update</span><br><span class="line">  5044:20181101:212203.808 completed 81% of event name update</span><br><span class="line">  5044:20181101:212203.808 completed 82% of event name update</span><br><span class="line">  5044:20181101:212203.808 completed 83% of event name update</span><br><span class="line">  5044:20181101:212203.808 completed 84% of event name update</span><br><span class="line">  5044:20181101:212203.808 completed 85% of event name update</span><br><span class="line">  5044:20181101:212203.809 completed 86% of event name update</span><br><span class="line">  5044:20181101:212203.809 completed 87% of event name update</span><br><span class="line">  5044:20181101:212203.810 completed 88% of event name update</span><br><span class="line">  5044:20181101:212203.810 completed 89% of event name update</span><br><span class="line">  5044:20181101:212203.810 completed 90% of event name update</span><br><span class="line">  5044:20181101:212203.810 completed 91% of event name update</span><br><span class="line">  5044:20181101:212203.810 completed 92% of event name update</span><br><span class="line">  5044:20181101:212203.810 completed 93% of event name update</span><br><span class="line">  5044:20181101:212203.810 completed 94% of event name update</span><br><span class="line">  5044:20181101:212203.811 completed 95% of event name update</span><br><span class="line">  5044:20181101:212203.811 completed 96% of event name update</span><br><span class="line">  5044:20181101:212203.811 completed 97% of event name update</span><br><span class="line">  5044:20181101:212203.811 completed 98% of event name update</span><br><span class="line">  5044:20181101:212203.811 completed 99% of event name update</span><br><span class="line">  5044:20181101:212203.811 completed 100% of event name update</span><br><span class="line">  5044:20181101:212205.304 event name update completed</span><br></pre></td></tr></table></figure><h3 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止服务 </span></span><br><span class="line">service zabbix-server stop</span><br><span class="line">service zabbix-agent stop</span><br><span class="line">service apache2 stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份 zabbix 文件 </span></span><br><span class="line">mkdir /opt/zabbix-backup/</span><br><span class="line">cp /etc/zabbix/zabbix_server.conf /opt/zabbix-backup/</span><br><span class="line">cp /etc/apache2/conf-enabled/zabbix.conf /opt/zabbix-backup/</span><br><span class="line">cp -R /usr/share/zabbix/ /opt/zabbix-backup/ </span><br><span class="line">cp -R /usr/share/doc/zabbix-* /opt/zabbix-backup/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级 zabbix 源 </span></span><br><span class="line">rm -Rf /etc/apt/sources.list.d/zabbix.list</span><br><span class="line">wget https://repo.zabbix.com/zabbix/4.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_4.0-2+bionic_all.deb</span><br><span class="line">dpkg -i zabbix-release_4.0-2+xenial_all.deb</span><br><span class="line">apt-get update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加时出现问题：dpkg: error: dpkg status database is locked by another process</span></span><br><span class="line">rm /var/lib/dpkg/lock</span><br><span class="line">dpkg --configure -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级 zabbix</span></span><br><span class="line"><span class="comment"># apt-get install --only-upgrade zabbix-server-mysql zabbix-frontend-php zabbix-agent zabbix-proxy-mysql</span></span><br><span class="line">apt-get install --only-upgrade zabbix-server-mysql zabbix-frontend-php zabbix-agent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 zabbix</span></span><br><span class="line">service zabbix-server start</span><br><span class="line">service zabbix-agent start</span><br><span class="line">service apache2 start</span><br></pre></td></tr></table></figure><h3 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h3><ol><li>拉取最新镜像</li><li>停止并删除当前运行容器</li><li>用最新镜像重新创建容器</li><li>All Done</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查找当前系统中使用的镜像 </span></span><br><span class="line">docker images</span><br><span class="line"><span class="comment"># 拉取最新镜像 </span></span><br><span class="line">docker pull zabbix/zabbix-web-nginx-mysql</span><br><span class="line">docker pull zabbix/zabbix-server-mysql</span><br><span class="line"><span class="comment"># 查找容器 ID</span></span><br><span class="line">docker ps</span><br><span class="line"><span class="comment"># 导出之前的容器配置信息 </span></span><br><span class="line">docker inspect 14fd67405076</span><br><span class="line"><span class="comment"># 停止容器 </span></span><br><span class="line">docker stop 14fd67405076</span><br><span class="line">docker <span class="built_in">kill</span> 14fd67405076</span><br><span class="line"><span class="comment"># 删除容器 </span></span><br><span class="line">docker rm 14fd67405076</span><br><span class="line"><span class="comment"># 用最新镜像重新创建容器 </span></span><br><span class="line">docker run --name zabbix-server-mysql -t \</span><br><span class="line">--link mysql-server:mysql \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">"mysql-server"</span> \</span><br><span class="line">-e MYSQL_DATABASE=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=<span class="string">"zabbix"</span> \</span><br><span class="line">-v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">-v /data/docker/zabbix/alertscripts:/usr/lib/zabbix/alertscripts \</span><br><span class="line">-v /data/docker/zabbix/externalscripts:/usr/lib/zabbix/externalscripts \</span><br><span class="line">-p 10051:10051 \</span><br><span class="line">-d \</span><br><span class="line">zabbix/zabbix-server-mysql</span><br><span class="line"></span><br><span class="line">docker run --name zabbix-web-nginx-mysql -t \</span><br><span class="line">--link mysql-server:mysql \</span><br><span class="line">--link zabbix-server-mysql:zabbix-server \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">"mysql-server"</span> \</span><br><span class="line">-e MYSQL_DATABASE=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=<span class="string">"zabbix"</span> \</span><br><span class="line">-e PHP_TZ=<span class="string">"Asia/Singapore"</span> \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-d \</span><br><span class="line">zabbix/zabbix-web-nginx-mysql</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      Zabbix 3.x 升级到 Zabbix 4.x
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
  <entry>
    <title>Zabbix 安装和使用配置小结</title>
    <link href="https://wsgzao.github.io/post/zabbix/"/>
    <id>https://wsgzao.github.io/post/zabbix/</id>
    <published>2018-11-01T06:59:49.000Z</published>
    <updated>2018-12-03T07:51:11.608Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Zabbix 是目前最为主流的开源监控方案之一，部署本身并不困难，难的是深入理解。根据在生产环境的实践从新版 Zabbix 4.0 LTS 开始全部使用 Docker 部署，我相信未来越来越多的开源组件都会以容器化的形式呈现在我们面前。</p><blockquote><p>Zabbix 安装和使用配置小结</p></blockquote><h2 id="更新历史"><a href="#更新历史" class="headerlink" title="更新历史"></a>更新历史</h2><p>2018 年 11 月 01 日 - 更新官方 LAMP 部署过程<br>2018 年 10 月 16 日 - 更新 Docker 部署 Zabbix 4.0<br>2018 年 08 月 06 日 - 初稿</p><p>阅读原文 - <a href="https://wsgzao.github.io/post/zabbix/">https://wsgzao.github.io/post/zabbix/</a></p><p><strong> 扩展阅读 </strong></p><p>Zabbix - <a href="https://www.zabbix.com/" target="_blank" rel="noopener">https://www.zabbix.com/</a></p><hr><h2 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h2><p><a href="https://www.zabbix.com/download" target="_blank" rel="noopener">https://www.zabbix.com/download</a><br><a href="https://www.zabbix.com/documentation" target="_blank" rel="noopener">https://www.zabbix.com/documentation</a></p><h2 id="Zabbix-Server"><a href="#Zabbix-Server" class="headerlink" title="Zabbix Server"></a>Zabbix Server</h2><blockquote><p>基于官方的 LAMP 架构，按照最简单的原生方式来部署，不做任何多余优化</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装必要依赖包 </span></span><br><span class="line">yum install -y httpd mariadb-server mariadb php php-mysql php-gd libjpeg* php-ldap php-odbc php-pear php-xml php-xmlrpc php-mhash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 apache 配置 </span></span><br><span class="line">vi /etc/httpd/conf/httpd.conf</span><br><span class="line">ServerName 192.168.56.103</span><br><span class="line">DirectoryIndex index.html index.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 php 时区 </span></span><br><span class="line">vi /etc/php.ini</span><br><span class="line">date.timezone = Asia/Singapore</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 httpd 服务 </span></span><br><span class="line">systemctl start httpd.service</span><br><span class="line"><span class="comment"># 启动 mariadb 服务 </span></span><br><span class="line">systemctl start mariadb.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 mysql 数据库，并配置 root 用户密码 </span></span><br><span class="line">mysql_secure_installation</span><br><span class="line"></span><br><span class="line"><span class="comment"># 万一新版本忘记随机密码可以通过日志获取 </span></span><br><span class="line">grep <span class="string">'temporary password'</span> /var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个测试页，测试 LAMP 是否搭建成功 </span></span><br><span class="line">cat &gt; /var/www/html/index.php &lt;&lt; EOF</span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 zabbix 数据库 </span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line">mysql&gt; create database zabbix character <span class="built_in">set</span> utf8 collate utf8_bin;</span><br><span class="line">mysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by <span class="string">'zabbix'</span>;</span><br><span class="line">mysql&gt; quit;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署 zabbix</span></span><br><span class="line">rpm -i https://repo.zabbix.com/zabbix/3.4/rhel/7/x86_64/zabbix-release-3.4-2.el7.noarch.rpm</span><br><span class="line">yum install -y zabbix-server-mysql zabbix-web-mysql zabbix-agent</span><br><span class="line">zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p zabbix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置数据库用户及密码 </span></span><br><span class="line">vim /etc/zabbix/zabbix_server.conf</span><br><span class="line">DBPassword=zabbix</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改时区 </span></span><br><span class="line">vim /etc/httpd/conf.d/zabbix.conf</span><br><span class="line">php_value date.timezone Asia/Singapore</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 zabbix 并设置自启动服务 </span></span><br><span class="line">systemctl restart zabbix-server zabbix-agent httpd</span><br><span class="line">systemctl <span class="built_in">enable</span> zabbix-server zabbix-agent httpd mariadb</span><br></pre></td></tr></table></figure><blockquote><p>以下是基于 LNMP 手动编译安装 Zabbix 的过程，仅供参考</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># hostname</span></span><br><span class="line">hostnamectl <span class="built_in">set</span>-hostname &lt;host-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># firewall</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># selinux</span></span><br><span class="line">getenforce</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># epel</span></span><br><span class="line">yum install epel-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx</span></span><br><span class="line">yum install nginx</span><br><span class="line">systemctl <span class="built_in">enable</span> nginx</span><br><span class="line">systemctl start nginx</span><br><span class="line">systemctl status nginx</span><br><span class="line">nginx -s reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># mysql | mariadb</span></span><br><span class="line">yum -y install mariadb mariadb-server</span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb.service</span><br><span class="line">systemctl start mariadb.service</span><br><span class="line">mysql_secure_installation</span><br><span class="line"></span><br><span class="line"><span class="comment"># php</span></span><br><span class="line">wget http://cn2.php.net/distributions/php-7.2.8.tar.gz</span><br><span class="line">tar xf php-7.2.8.tar.gz </span><br><span class="line"><span class="built_in">cd</span> ./php-7.2.8/</span><br><span class="line">yum install -y libxml2 libxml2-devel openssl openssl-devel bzip2 bzip2-devel libcurl libcurl-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel </span><br><span class="line">yum install -y libmcrypt libmcrypt-devel gcc</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/php --with-config-file-path=/etc --<span class="built_in">enable</span>-fpm --with-fpm-user=nginx  --with-fpm-group=nginx --<span class="built_in">enable</span>-inline-optimization --<span class="built_in">disable</span>-debug --<span class="built_in">disable</span>-rpath --<span class="built_in">enable</span>-shared  --<span class="built_in">enable</span>-soap --with-libxml-dir --with-xmlrpc --with-openssl --with-mcrypt --with-mhash --with-pcre-regex --with-sqlite3 --with-zlib --<span class="built_in">enable</span>-bcmath  --with-iconv --with-bz2 --<span class="built_in">enable</span>-calendar --with-curl --with-cdb --<span class="built_in">enable</span>-dom --<span class="built_in">enable</span>-exif --<span class="built_in">enable</span>-fileinfo --<span class="built_in">enable</span>-filter --with-pcre-dir --<span class="built_in">enable</span>-ftp --with-gd --with-openssl-dir  --with-jpeg-dir --with-png-dir --with-zlib-dir --with-freetype-dir --<span class="built_in">enable</span>-gd-native-ttf --<span class="built_in">enable</span>-gd-jis-conv --with-gettext --with-gmp --with-mhash --<span class="built_in">enable</span>-json --<span class="built_in">enable</span>-mbstring --<span class="built_in">enable</span>-mbregex --<span class="built_in">enable</span>-mbregex-backtrack --with-libmbfl --with-onig --<span class="built_in">enable</span>-pdo --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-zlib-dir --with-pdo-sqlite --with-readline --<span class="built_in">enable</span>-session --<span class="built_in">enable</span>-shmop --<span class="built_in">enable</span>-simplexml --<span class="built_in">enable</span>-sockets  --<span class="built_in">enable</span>-sysvmsg --<span class="built_in">enable</span>-sysvsem --<span class="built_in">enable</span>-sysvshm --<span class="built_in">enable</span>-wddx --with-libxml-dir --with-xsl --<span class="built_in">enable</span>-zip --<span class="built_in">enable</span>-mysqlnd-compression-support --with-pear --<span class="built_in">enable</span>-opcache</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line">PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/php/bin</span><br><span class="line"><span class="built_in">export</span> PATH</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$PATH</span></span><br><span class="line">php -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># php-fpm </span></span><br><span class="line">cp ./php.ini-production /etc/php.ini</span><br><span class="line">cp /usr/<span class="built_in">local</span>/php/etc/php-fpm.conf.default /usr/<span class="built_in">local</span>/php/etc/php-fpm.conf</span><br><span class="line">cp /usr/<span class="built_in">local</span>/php/etc/php-fpm.d/www.conf.default /usr/<span class="built_in">local</span>/php/etc/php-fpm.d/www.conf</span><br><span class="line">cp sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm</span><br><span class="line">chmod +x /etc/init.d/php-fpm</span><br><span class="line"></span><br><span class="line">vi /etc/php.ini</span><br><span class="line"></span><br><span class="line">max_execution_time = 300</span><br><span class="line">max_input_time = 300</span><br><span class="line">memory_limit = 128M</span><br><span class="line">post_max_size = 16M</span><br><span class="line">date.timezone = Asia/Singapore</span><br><span class="line"></span><br><span class="line">/etc/init.d/php-fpm start</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx</span></span><br><span class="line">vi /etc/nginx/conf.d/default.conf</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    root /data/www;</span><br><span class="line">    location / &#123;</span><br><span class="line">        index  index.php index.html index.htm;</span><br><span class="line">        <span class="keyword">if</span> (!-e <span class="variable">$request_filename</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            rewrite ^/(.*)$ /index.php/<span class="variable">$1</span>;</span><br><span class="line">            <span class="comment">#rewrite ^/subdir/(.*)$ /subdir/index.php/$1;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#proxy the php scripts to php-fpm</span></span><br><span class="line">    location ~ \.php &#123;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$path_info</span> <span class="string">""</span>;</span><br><span class="line">        <span class="built_in">set</span> <span class="variable">$real_script_name</span> <span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$fastcgi_script_name</span> ~ <span class="string">"^(.+?\.php)(/.+)$"</span>) &#123;</span><br><span class="line">            <span class="built_in">set</span> <span class="variable">$real_script_name</span> <span class="variable">$1</span>;</span><br><span class="line">            <span class="built_in">set</span> <span class="variable">$path_info</span> <span class="variable">$2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$real_script_name</span>;</span><br><span class="line">        fastcgi_param SCRIPT_NAME <span class="variable">$real_script_name</span>;</span><br><span class="line">        fastcgi_param PATH_INFO <span class="variable">$path_info</span>;</span><br><span class="line">        fastcgi_intercept_errors on;</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nginx -s reload</span><br><span class="line"></span><br><span class="line">vi /data/www/info.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">    phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">http://127.0.0.1/info.php </span><br><span class="line"></span><br><span class="line"><span class="comment"># zabbix-server</span></span><br><span class="line">rpm -ivh http://repo.zabbix.com/zabbix/3.4/rhel/7/x86_64/zabbix-release-3.4-2.el7.noarch.rpm</span><br><span class="line">yum -y install zabbix-server-mysql zabbix-agent</span><br><span class="line"></span><br><span class="line"><span class="comment"># create zabbix in db</span></span><br><span class="line">mysql -u root -p</span><br><span class="line">create database zabbix character <span class="built_in">set</span> utf8 collate utf8_bin;</span><br><span class="line">grant all privileges on zabbix.* to <span class="string">'zabbix'</span>@<span class="string">'%'</span> identified by <span class="string">'zabbix'</span>;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/share/doc/zabbix-server-mysql-3.4.11/</span><br><span class="line">zcat create.sql.gz | mysql -u root -p zabbix</span><br><span class="line"></span><br><span class="line">vi /etc/zabbix/zabbix_server.conf</span><br><span class="line"></span><br><span class="line">DBHost=localhost</span><br><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br><span class="line"></span><br><span class="line">chown -R zabbix:zabbix /etc/zabbix</span><br><span class="line">chown -R zabbix:zabbix /usr/lib/zabbix</span><br><span class="line">systemctl <span class="built_in">enable</span> zabbix-server</span><br><span class="line">systemctl start zabbix-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># zabbix-web</span></span><br><span class="line">wget -O zabbix-3.4.11.tar.gz https://excellmedia.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/3.4.11/zabbix-3.4.11.tar.gz</span><br><span class="line">tar zxvf zabbix-3.4.11.tar.gz</span><br><span class="line">cp -rf ./zabbix-3.4.11/frontends/php/ /data/www/zabbix</span><br><span class="line">mv /data/www/zabbix/conf/zabbix.conf.php.example /data/www/zabbix/conf/zabbix.conf.php </span><br><span class="line">vi /data/www/zabbix/conf/zabbix.conf.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">// Zabbix GUI configuration file.</span><br><span class="line">global <span class="variable">$DB</span>, <span class="variable">$HISTORY</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'TYPE'</span>]                             = <span class="string">'MYSQL'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'SERVER'</span>]                   = <span class="string">'127.0.0.1'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'PORT'</span>]                             = <span class="string">'0'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'DATABASE'</span>]                 = <span class="string">'zabbix'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'USER'</span>]                             = <span class="string">'zabbix'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'PASSWORD'</span>]                 = <span class="string">'zabbix'</span>;</span><br><span class="line">// Schema name. Used <span class="keyword">for</span> IBM DB2 and PostgreSQL.</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'SCHEMA'</span>]                   = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ZBX_SERVER</span>                             = <span class="string">'localhost'</span>;</span><br><span class="line"><span class="variable">$ZBX_SERVER_PORT</span>                = <span class="string">'10051'</span>;</span><br><span class="line"><span class="variable">$ZBX_SERVER_NAME</span>                = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$IMAGE_FORMAT_DEFAULT</span>   = IMAGE_FORMAT_PNG;</span><br><span class="line"></span><br><span class="line">// Elasticsearch url (can be string <span class="keyword">if</span> same url is used <span class="keyword">for</span> all types).</span><br><span class="line"><span class="variable">$HISTORY</span>[<span class="string">'url'</span>]   = [</span><br><span class="line">                <span class="string">'uint'</span> =&gt; <span class="string">'http://127.0.0.1:9200'</span>,</span><br><span class="line">                <span class="string">'text'</span> =&gt; <span class="string">'http://127.0.0.1:9200'</span></span><br><span class="line">];</span><br><span class="line">// Value types stored <span class="keyword">in</span> Elasticsearch.</span><br><span class="line"><span class="variable">$HISTORY</span>[<span class="string">'types'</span>] = [<span class="string">'uint'</span>, <span class="string">'text'</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http://127.0.0.1/zabbix</span><br><span class="line"></span><br><span class="line"><span class="comment">## zabbix-agent</span></span><br><span class="line">rpm -ivh http://repo.zabbix.com/zabbix/3.4/rhel/7/x86_64/zabbix-release-3.4-2.el7.noarch.rpm</span><br><span class="line">yum -y install zabbix-agent</span><br><span class="line">vi /etc/zabbix/zabbix_agentd.conf</span><br><span class="line"></span><br><span class="line">Server=127.0.0.1</span><br><span class="line">ServerActive=127.0.0.1</span><br><span class="line">Hostname=Zabbix server</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> zabbix-agent</span><br><span class="line">systemctl start zabbix-agent</span><br><span class="line"></span><br><span class="line"><span class="comment"># CPU test</span></span><br><span class="line"></span><br><span class="line">CPU use percent gt 80%</span><br><span class="line">&#123;Template OS Linux:system.cpu.util[,idle].avg(1m)&#125;&lt;80</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"scale=5000; 4*a(1)"</span> | bc -l -q</span><br></pre></td></tr></table></figure><h2 id="Zabbix-表分区优化"><a href="#Zabbix-表分区优化" class="headerlink" title="Zabbix 表分区优化"></a>Zabbix 表分区优化</h2><p>Zabbix MySQL Database Partitioning 表分区优化禁用 housekeeping 提升历史数据清理性能</p><p><a href="https://wsgzao.github.io/post/zabbix-mysql-partition/">https://wsgzao.github.io/post/zabbix-mysql-partition/</a></p><h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><p><a href="https://www.zabbix.com/documentation/3.4/zh/manual/installation/containers" target="_blank" rel="noopener">https://www.zabbix.com/documentation/3.4/zh/manual/installation/containers</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install docker-ce</span></span><br><span class="line">sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">sudo yum install -y docker-ce</span><br><span class="line">sudo systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker: Error response from daemon: Get https://registry-1.docker.io/v2/: x509: certificate has expired or is not yet valid.</span></span><br><span class="line">ntpdate 0.pool.ntp.org</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install mysql, zabbix, nginx in docker </span></span><br><span class="line">docker run --name mysql-server -t \</span><br><span class="line">-e MYSQL_DATABASE=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=<span class="string">"zabbix"</span> \</span><br><span class="line">-p 127.0.0.1:3306:3306 \</span><br><span class="line">-d mysql:5.7 \</span><br><span class="line">--character-set-server=utf8 --collation-server=utf8_bin</span><br><span class="line"></span><br><span class="line">docker run --name zabbix-server-mysql -t \</span><br><span class="line">--link mysql-server:mysql \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">"mysql-server"</span> \</span><br><span class="line">-e MYSQL_DATABASE=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=<span class="string">"zabbix"</span> \</span><br><span class="line">-p 10051:10051 \</span><br><span class="line">-d \</span><br><span class="line">zabbix/zabbix-server-mysql:centos-4.0-latest</span><br><span class="line"></span><br><span class="line">docker run --name zabbix-web-nginx-mysql -t \</span><br><span class="line">--link mysql-server:mysql \</span><br><span class="line">--link zabbix-server-mysql:zabbix-server \</span><br><span class="line">-e DB_SERVER_HOST=<span class="string">"mysql-server"</span> \</span><br><span class="line">-e MYSQL_DATABASE=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_USER=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_PASSWORD=<span class="string">"zabbix"</span> \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=<span class="string">"zabbix"</span> \</span><br><span class="line">-e PHP_TZ=<span class="string">"Asia/Singapore"</span> \</span><br><span class="line">-p 80:80 \</span><br><span class="line">-d \</span><br><span class="line">zabbix/zabbix-web-nginx-mysql:centos-4.0-latest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@zabbix_server ~]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID        IMAGE                                  COMMAND                  CREATED              STATUS              PORTS                           NAMES</span><br><span class="line">98cbe8d8a6bd        zabbix/zabbix-web-nginx-mysql:latest   <span class="string">"docker-entrypoint.sh"</span>   6 seconds ago        Up 5 seconds        443/tcp, 0.0.0.0:8080-&gt;80/tcp   zabbix-web-nginx-mysql</span><br><span class="line">de040d43d60f        zabbix/zabbix-server-mysql:latest      <span class="string">"docker-entrypoint.sh"</span>   59 seconds ago       Up 59 seconds       0.0.0.0:10051-&gt;10051/tcp        zabbix-server-mysql</span><br><span class="line">3276f18def8d        mysql:5.7                              <span class="string">"docker-entrypoint.s…"</span>   About a minute ago   Up About a minute   3306/tcp                        mysql-server</span><br><span class="line"></span><br><span class="line">[root@zabbix_server ~]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                      TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">zabbix/zabbix-web-nginx-mysql   latest              4db891b4393a        10 hours ago        177MB</span><br><span class="line">zabbix/zabbix-server-mysql      latest              f5e58dafe9ac        10 hours ago        62.2MB</span><br><span class="line">mysql                           5.7                 f0f3956a9dd8        7 days ago          409MB</span><br><span class="line"></span><br><span class="line">http://127.0.0.1:8080</span><br><span class="line"></span><br><span class="line">Admin/zabbix</span><br></pre></td></tr></table></figure><h2 id="Zabbix-自定义监控"><a href="#Zabbix-自定义监控" class="headerlink" title="Zabbix 自定义监控"></a>Zabbix 自定义监控</h2><blockquote><p>以监控文件系统目录的权限为例</p></blockquote><p>Zabbix 用户自定义参数<br><a href="https://www.zabbix.com/documentation/3.4/zh/manual/config/items/userparameters" target="_blank" rel="noopener">https://www.zabbix.com/documentation/3.4/zh/manual/config/items/userparameters</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新建自定义监控配置文件 userparameter</span></span><br><span class="line"><span class="built_in">cd</span> /etc/zabbix/zabbix_agentd.d</span><br><span class="line">vi userparameter_tmp.conf</span><br><span class="line">UserParameter=check.tmp[*],<span class="built_in">stat</span> -c %a /tmp</span><br><span class="line"><span class="comment"># 重启 zabbix agent</span></span><br><span class="line">service zabbix-agent restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Zabbix Server 服务端验证 </span></span><br><span class="line">zabbix_get -s 10.65.200.90 -k check.tmp</span><br><span class="line">1777</span><br><span class="line">zabbix_get -s 10.65.200.90 -k agent.version</span><br><span class="line">3.0.9</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 WebUI 中创建新的 Template 或者使用已有新增 Items</span></span><br><span class="line">Items: Key 为 check.tmp</span><br><span class="line">Triggers: 定义 Serverity，Expression 如下所示 </span><br><span class="line">&#123;Template Sea Ops WangAo:check.tmp.last()&#125;&lt;&gt;1777</span><br><span class="line"></span><br><span class="line"><span class="comment"># 点击 Monitoring Latest data 查看 Item 最新数据 </span></span><br><span class="line">Moniroting -&gt; Latest data -&gt; Hosts -&gt; check /tmp permission</span><br></pre></td></tr></table></figure><p>如果需要配置 Actions 可以查看 Zabbix 使用企业微信告警配置小结</p><p><a href="https://wsgzao.github.io/post/zabbix-alert-wechat/">https://wsgzao.github.io/post/zabbix-alert-wechat/</a></p><h2 id="Zabbix-备份恢复"><a href="#Zabbix-备份恢复" class="headerlink" title="Zabbix 备份恢复"></a>Zabbix 备份恢复</h2><p>mysql 数据库备份通常使用 mysqldump 或者 xtrabackup</p><p>因为一般历史数据较大，如果需要保留所有数据可以考虑主从同步，如果不需要保留数据直接过滤历史数据备份相关的告警配置即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前版本 Zabbix 的数据库表结构 </span></span><br><span class="line">mysql -uzabbix -pzabbix zabbix -e <span class="string">"show tables"</span>|egrep -v <span class="string">"(Tables_in_zabbix)"</span></span><br><span class="line">mysql -uzabbix -pzabbix zabbix -e <span class="string">"show tables"</span>|egrep -v <span class="string">"(Tables_in_zabbix|history*|trends*|acknowledges|alerts|auditlog|events|service_alarms)"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下表中标记 + 号为需要过滤的表 </span></span><br><span class="line">+acknowledges</span><br><span class="line">actions</span><br><span class="line">+alerts</span><br><span class="line">application_discovery</span><br><span class="line">application_prototype</span><br><span class="line">application_template</span><br><span class="line">applications</span><br><span class="line">+auditlog</span><br><span class="line">+auditlog_details</span><br><span class="line">autoreg_host</span><br><span class="line">conditions</span><br><span class="line">config</span><br><span class="line">corr_condition</span><br><span class="line">corr_condition_group</span><br><span class="line">corr_condition_tag</span><br><span class="line">corr_condition_tagpair</span><br><span class="line">corr_condition_tagvalue</span><br><span class="line">corr_operation</span><br><span class="line">correlation</span><br><span class="line">dashboard</span><br><span class="line">dashboard_user</span><br><span class="line">dashboard_usrgrp</span><br><span class="line">dbversion</span><br><span class="line">dchecks</span><br><span class="line">dhosts</span><br><span class="line">drules</span><br><span class="line">dservices</span><br><span class="line">escalations</span><br><span class="line">event_recovery</span><br><span class="line">event_tag</span><br><span class="line">+events</span><br><span class="line">expressions</span><br><span class="line"><span class="built_in">functions</span></span><br><span class="line">globalmacro</span><br><span class="line">globalvars</span><br><span class="line">graph_discovery</span><br><span class="line">graph_theme</span><br><span class="line">graphs</span><br><span class="line">graphs_items</span><br><span class="line">group_discovery</span><br><span class="line">group_prototype</span><br><span class="line">groups</span><br><span class="line">+<span class="built_in">history</span></span><br><span class="line">+history_log</span><br><span class="line">+history_str</span><br><span class="line">+history_text</span><br><span class="line">+history_uint</span><br><span class="line">host_discovery</span><br><span class="line">host_inventory</span><br><span class="line">hostmacro</span><br><span class="line">hosts</span><br><span class="line">hosts_groups</span><br><span class="line">hosts_templates</span><br><span class="line">housekeeper</span><br><span class="line">httpstep</span><br><span class="line">httpstep_field</span><br><span class="line">httpstepitem</span><br><span class="line">httptest</span><br><span class="line">httptest_field</span><br><span class="line">httptestitem</span><br><span class="line">icon_map</span><br><span class="line">icon_mapping</span><br><span class="line">ids</span><br><span class="line">images</span><br><span class="line">interface</span><br><span class="line">interface_discovery</span><br><span class="line">item_application_prototype</span><br><span class="line">item_condition</span><br><span class="line">item_discovery</span><br><span class="line">item_preproc</span><br><span class="line">items</span><br><span class="line">items_applications</span><br><span class="line">maintenances</span><br><span class="line">maintenances_groups</span><br><span class="line">maintenances_hosts</span><br><span class="line">maintenances_windows</span><br><span class="line">mappings</span><br><span class="line">media</span><br><span class="line">media_type</span><br><span class="line">opcommand</span><br><span class="line">opcommand_grp</span><br><span class="line">opcommand_hst</span><br><span class="line">opconditions</span><br><span class="line">operations</span><br><span class="line">opgroup</span><br><span class="line">opinventory</span><br><span class="line">opmessage</span><br><span class="line">opmessage_grp</span><br><span class="line">opmessage_usr</span><br><span class="line">optemplate</span><br><span class="line">problem</span><br><span class="line">problem_tag</span><br><span class="line">profiles</span><br><span class="line">proxy_autoreg_host</span><br><span class="line">+proxy_dhistory</span><br><span class="line">+proxy_history</span><br><span class="line">regexps</span><br><span class="line">rights</span><br><span class="line">screen_user</span><br><span class="line">screen_usrgrp</span><br><span class="line">screens</span><br><span class="line">screens_items</span><br><span class="line">scripts</span><br><span class="line">+service_alarms</span><br><span class="line">services</span><br><span class="line">services_links</span><br><span class="line">services_times</span><br><span class="line">sessions</span><br><span class="line">slides</span><br><span class="line">slideshow_user</span><br><span class="line">slideshow_usrgrp</span><br><span class="line">slideshows</span><br><span class="line">sysmap_element_trigger</span><br><span class="line">sysmap_element_url</span><br><span class="line">sysmap_shape</span><br><span class="line">sysmap_url</span><br><span class="line">sysmap_user</span><br><span class="line">sysmap_usrgrp</span><br><span class="line">sysmaps</span><br><span class="line">sysmaps_elements</span><br><span class="line">sysmaps_link_triggers</span><br><span class="line">sysmaps_links</span><br><span class="line">task</span><br><span class="line">task_acknowledge</span><br><span class="line">task_close_problem</span><br><span class="line">task_remote_command</span><br><span class="line">task_remote_command_result</span><br><span class="line">timeperiods</span><br><span class="line">+trends</span><br><span class="line">+trends_uint</span><br><span class="line">trigger_depends</span><br><span class="line">trigger_discovery</span><br><span class="line">trigger_tag</span><br><span class="line">triggers</span><br><span class="line">users</span><br><span class="line">users_groups</span><br><span class="line">usrgrp</span><br><span class="line">valuemaps</span><br><span class="line">widget</span><br><span class="line">widget_field</span><br><span class="line"></span><br><span class="line"><span class="comment"># 我们直接提取需要过滤的表 </span></span><br><span class="line">acknowledges</span><br><span class="line">alerts</span><br><span class="line">auditlog</span><br><span class="line">auditlog_details</span><br><span class="line">events</span><br><span class="line"><span class="built_in">history</span></span><br><span class="line">history_log</span><br><span class="line">history_str</span><br><span class="line">history_text</span><br><span class="line">history_uint</span><br><span class="line">proxy_dhistory</span><br><span class="line">proxy_history</span><br><span class="line">service_alarms</span><br><span class="line">trends</span><br><span class="line">trends_uint</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 --ignore-table 跳过不需要备份的表 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 过滤最简单的表只需要 history * 和 trends*</span></span><br><span class="line">mysqldump -uzabbix -pzabbix --databases zabbix \</span><br><span class="line">--ignore-table=zabbix.history \</span><br><span class="line">--ignore-table=zabbix.history_log \</span><br><span class="line">--ignore-table=zabbix.history_str \</span><br><span class="line">--ignore-table=zabbix.history_text \</span><br><span class="line">--ignore-table=zabbix.history_uint \</span><br><span class="line">--ignore-table=zabbix.trends \</span><br><span class="line">--ignore-table=zabbix.trends_uint &gt; /tmp/zabbix_config.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果需要做更细化的过滤，可以参考下面的过滤表 </span></span><br><span class="line">mysqldump -uzabbix -pzabbix --databases zabbix \</span><br><span class="line">--ignore-table=zabbix.acknowledges \</span><br><span class="line">--ignore-table=zabbix.alerts \</span><br><span class="line">--ignore-table=zabbix.auditlog \</span><br><span class="line">--ignore-table=zabbix.auditlog_details \</span><br><span class="line">--ignore-table=zabbix.events \</span><br><span class="line">--ignore-table=zabbix.history \</span><br><span class="line">--ignore-table=zabbix.history_log \</span><br><span class="line">--ignore-table=zabbix.history_str \</span><br><span class="line">--ignore-table=zabbix.history_text \</span><br><span class="line">--ignore-table=zabbix.history_uint \</span><br><span class="line">--ignore-table=zabbix.proxy_dhistory \</span><br><span class="line">--ignore-table=zabbix.proxy_history \</span><br><span class="line">--ignore-table=zabbix.service_alarms \</span><br><span class="line">--ignore-table=zabbix.services_times \</span><br><span class="line">--ignore-table=zabbix.trends \</span><br><span class="line">--ignore-table=zabbix.trends_uint &gt; /tmp/zabbix_config.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果数据量交大，可以考虑使用 gzip 压缩 </span></span><br><span class="line">--ignore-table=zabbix.trends_uint | gzip &gt; zabbix_`date +<span class="string">'%Y%m%d%H%M%S'</span>`.sql.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传至新的数据库执行导入 </span></span><br><span class="line">mysql -uzabbix -pzabbix zabbix &lt; zabbix_config.sql</span><br></pre></td></tr></table></figure><p>itnihao 的书中分享了一部分代码，可以做些许参考吧<br><a href="https://github.com/itnihao/zabbix-book/tree/master/03-chapter" target="_blank" rel="noopener">https://github.com/itnihao/zabbix-book/tree/master/03-chapter</a></p>]]></content>
    
    <summary type="html">
    
      学习使用Zabbix
    
    </summary>
    
      <category term="学习 | Study" scheme="https://wsgzao.github.io/categories/%E5%AD%A6%E4%B9%A0-Study/"/>
    
    
  </entry>
  
</feed>
